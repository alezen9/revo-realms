import{T as ve,D as Pe,G as Ee,C as Ie,L as de,a as Ce,P as Be,F as x,p as Ne,b as De,W as Re,c as Fe,A as Oe,S as Ue,d as Ge,e as ke,V as S,H as He,f as ze,O as Ve,t as y,v as O,g as f,M as z,h as E,u,i as I,j as D,N as re,k as p,l as We,I as le,m as ce,n as R,o as C,q as j,r as v,s as B,w as K,x as we,y as P,z as ye,B as Te,E as be,J as Ze,K as te,Q as _e,R as ne,U as G,X as je,Y as ae,Z as Ke,_ as xe,$ as ue,a0 as qe,a1 as he,a2 as k,a3 as oe,a4 as Ae,a5 as Ye,a6 as se,a7 as Je,a8 as Xe,a9 as $e,aa as me,ab as Qe,ac as et,ad as ie,ae as pe,af as tt,ag as st,ah as ot}from"./three-B8iZgjCS.js";import{World as rt,RigidBodyDesc as W,ColliderDesc as Z,HeightFieldFlags as nt,Ray as at,__tla as __tla_0}from"./@dimforge-Tx9Ov1ko.js";import{P as it}from"./tweakpane-BXg6ZhiP.js";import{S as fe}from"./stats-gl-C2M3amu4.js";import{e as lt}from"./tseep-DsfRTLTM.js";Promise.all([(()=>{try{return __tla_0}catch{}})()]).then(async()=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();const ct="/revo-realms/models/realm.glb",ut="/revo-realms/textures/environment/px.webp",dt="/revo-realms/textures/environment/nx.webp",ht="/revo-realms/textures/environment/py.webp",mt="/revo-realms/textures/environment/ny.webp",pt="/revo-realms/textures/environment/pz.webp",ft="/revo-realms/textures/environment/nz.webp",gt="/revo-realms/textures/noise/noise.webp",wt="/revo-realms/textures/realm/terrainType.webp",yt="/revo-realms/textures/realm/sandNormal.webp",Tt="/revo-realms/textures/realm/grassNormal.webp",bt="/revo-realms/textures/realm/grassDiffuse.webp",_t="/revo-realms/textures/realm/terrainShadowAo.webp",xt="/revo-realms/textures/realm/waterLiliesDiffuse.webp",At="/revo-realms/textures/realm/waterLiliesAlpha.webp",Lt="/revo-realms/textures/realm/stoneDiffuse.webp",St="/revo-realms/textures/realm/stoneMossyDiffuse.webp",Mt="/revo-realms/textures/realm/stoneNormalAo.webp",vt="/revo-realms/textures/realm/stoneMossyNormalAo.webp",Pt="/revo-realms/textures/realm/barkDiffuse.webp",Et="/revo-realms/textures/realm/barkNormal.webp",It="/revo-realms/textures/realm/canopyDiffuse.webp",Ct="/revo-realms/textures/realm/canopyNormal.webp",Bt="/revo-realms/textures/realm/axeDiffuse.webp",Nt="/revo-realms/textures/realm/axeEmissive.webp",Dt="/revo-realms/textures/realm/trunkDiffuse.webp",Rt="/revo-realms/textures/realm/trunkNormal.webp";class Ft{textureLoader;gltfLoader;cubeTextureLoader;realmModel;noiseTexture;envMapTexture;terrainTypeMap;terrainShadowAo;grassDiffuse;sandNormal;grassNormal;canopyDiffuse;canopyNormal;barkDiffuse;barkNormal;stoneDiffuse;stoneMossyDiffuse;stoneNormalAo;stoneMossyNormalAo;waterLiliesTexture;waterLiliesAlphaTexture;axeDiffuse;axeEmissive;trunkDiffuse;trunkNormal;constructor(){const e=this.createLoadingManager();this.textureLoader=new ve(e);const t=new Pe(e);t.setDecoderPath("/revo-realms/draco/"),this.gltfLoader=new Ee(e),this.gltfLoader.setDRACOLoader(t),this.cubeTextureLoader=new Ie(e)}createLoadingManager(){const e=new Ce;e.onStart=function(t,o,s){console.log("Started loading file: "+t+`.
Loaded `+o+" of "+s+" files.")},e.onLoad=function(){console.log("Loading complete!")},e.onProgress=function(t,o,s){console.log("Loading file: "+t+`.
Loaded `+o+" of "+s+" files.")},e.onError=function(t){console.log("There was an error loading "+t)}}async initAsync(){const e=await Promise.all([this.gltfLoader.loadAsync(ct),l.cubeTextureLoader.loadAsync([ut,dt,ht,mt,pt,ft]),this.textureLoader.loadAsync(gt),this.textureLoader.loadAsync(wt),this.textureLoader.loadAsync(bt),this.textureLoader.loadAsync(Tt),this.textureLoader.loadAsync(yt),this.textureLoader.loadAsync(_t),this.textureLoader.loadAsync(xt),this.textureLoader.loadAsync(At),this.textureLoader.loadAsync(Lt),this.textureLoader.loadAsync(St),this.textureLoader.loadAsync(Mt),this.textureLoader.loadAsync(vt),this.textureLoader.loadAsync(It),this.textureLoader.loadAsync(Ct),this.textureLoader.loadAsync(Pt),this.textureLoader.loadAsync(Et),this.textureLoader.loadAsync(Bt),this.textureLoader.loadAsync(Nt),this.textureLoader.loadAsync(Dt),this.textureLoader.loadAsync(Rt)]);this.realmModel=e[0],this.envMapTexture=e[1],this.envMapTexture.generateMipmaps=!1,this.noiseTexture=e[2],this.terrainTypeMap=e[3],this.terrainTypeMap.flipY=!1,this.grassDiffuse=e[4],this.grassNormal=e[5],this.sandNormal=e[6],this.terrainShadowAo=e[7],this.terrainShadowAo.colorSpace=de,this.terrainShadowAo.flipY=!1,this.waterLiliesTexture=e[8],this.waterLiliesTexture.flipY=!1,this.waterLiliesAlphaTexture=e[9],this.waterLiliesAlphaTexture.flipY=!1,this.waterLiliesAlphaTexture.colorSpace=de,this.stoneDiffuse=e[10],this.stoneMossyDiffuse=e[11],this.stoneNormalAo=e[12],this.stoneMossyNormalAo=e[13],this.canopyDiffuse=e[14],this.canopyDiffuse.flipY=!1,this.canopyNormal=e[15],this.canopyNormal.flipY=!1,this.barkDiffuse=e[16],this.barkDiffuse.flipY=!1,this.barkNormal=e[17],this.barkNormal.flipY=!1,this.axeDiffuse=e[18],this.axeDiffuse.flipY=!1,this.axeEmissive=e[19],this.axeEmissive.flipY=!1,this.trunkDiffuse=e[20],this.trunkDiffuse.flipY=!1,this.trunkNormal=e[21],this.trunkNormal.flipY=!1}}const l=new Ft,Ot="modulepreload",Ut=function(d){return"/revo-realms/"+d},ge={},Gt=function(e,t,o){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),a=n?.nonce||n?.getAttribute("nonce");s=Promise.allSettled(t.map(i=>{if(i=Ut(i),i in ge)return;ge[i]=!0;const c=i.endsWith(".css"),h=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${h}`))return;const m=document.createElement("link");if(m.rel=c?"stylesheet":Ot,c||(m.as="script"),m.crossOrigin="",m.href=i,a&&m.setAttribute("nonce",a),document.head.appendChild(m),c)return new Promise((w,g)=>{m.addEventListener("load",w),m.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${i}`)))})}))}function r(n){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=n,window.dispatchEvent(a),!a.defaultPrevented)throw n}return s.then(n=>{for(const a of n||[])a.status==="rejected"&&r(a.reason);return e().catch(r)})};class kt{world;constructor(){}async init(){return Gt(()=>import("./@dimforge-Tx9Ov1ko.js").then(async m=>{await m.__tla;return m}),[]).then(()=>{this.world=new rt({x:0,y:-9.81,z:0})})}update(){this.world.step()}}const L=new kt;class Ht{async initAsync(){await Promise.all([L.init(),l.initAsync()])}}class zt{keysPressed;keyDownListeners;keyUpListeners;constructor(){this.keysPressed=new Set,this.keyDownListeners=new Map,this.keyUpListeners=new Map,window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this))}handleKeyDown(e){const t=e.key.toLowerCase();this.keysPressed.has(t)||(this.keysPressed.add(t),this.keyDownListeners.get(t)?.())}handleKeyUp(e){const t=e.key.toLowerCase();this.keysPressed.delete(t),this.keyUpListeners.get(t)?.()}isKeyPressed(e){return e==="*"?this.keysPressed.size>0:this.keysPressed.has(e.toLowerCase())}onKeyDown(e,t){this.keyDownListeners.set(e.toLowerCase(),t)}onKeyUp(e,t){this.keyUpListeners.set(e.toLowerCase(),t)}dispose(){window.removeEventListener("keydown",this.handleKeyDown.bind(this)),window.removeEventListener("keyup",this.handleKeyUp.bind(this))}}const U=new zt;class Vt{panel;constructor(){this.panel=new it({title:"Revo Realms"}),this.panel.hidden=!0,this.panel.element.parentElement.style.zIndex="1",this.panel.element.parentElement.style.width="340px"}setVisibility(e){this.panel.hidden=!e}}const H=new Vt;class Wt{stats;lastSecond=performance.now();drawCallsPanel;trianglesPanel;constructor(e){const t=new fe({trackGPU:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,horizontal:!1,precision:2});e&&document.body.appendChild(t.dom),this.stats=t,this.drawCallsPanel=this.createNumberPanel("# DRAW CALLS","#fff","#333"),this.trianglesPanel=this.createNumberPanel("# TRIANGLES","#ffdab9","#163843")}createNumberPanel(e,t,o){const s=this.stats.addPanel(new fe.Panel(e,t,o));return s.update=r=>{const n=s.canvas.getContext("2d");if(!n)return;const{width:a,height:i}=s.canvas;n.clearRect(0,0,a,i),n.fillStyle=o,n.fillRect(0,0,a,i),n.fillStyle=t;const c=n.font;n.textAlign="left",n.textBaseline="top",n.fillText(s.name,4,4),n.font="bold 20px Arial",n.textAlign="center",n.textBaseline="middle";const h=Zt.format(r);n.fillText(`${h}`,a/2,i/1.65),n.font=c},s}updateCustomPanels(){const e=performance.now();if(e-this.lastSecond<1e3)return;const{render:t}=V.renderer.info;this.drawCallsPanel.update(t.drawCalls,0),this.trianglesPanel.update(t.triangles,0),this.lastSecond=e}}const Zt=new Intl.NumberFormat("en-US",{notation:"compact"});class jt{composer;constructor(){this.composer=new Be(V.renderer),this.composer.outputNode=this.getPasses()}getPasses=x(()=>{const e=Ne(A.scene,A.renderCamera),t=e.getTextureNode();return De(t,.25,.1,.5).add(e)})}class Kt{renderer;canvas;monitoringManager;postprocessingManager;POSTPROCESSING_ENABLED=!1;MONITORING_ENABLED=!1;DEBUGGING_ENABLED=!1;constructor(){const e=document.createElement("canvas");e.classList.add("revo-realms"),document.body.appendChild(e),this.canvas=e;const t=new Re({canvas:e,antialias:!0,trackTimestamp:!1,powerPreference:"high-performance",stencil:!1,depth:!0});t.shadowMap.enabled=!0,t.shadowMap.type=Fe,t.toneMapping=Oe,t.outputColorSpace=Ue,t.setClearColor(0,1),t.toneMappingExposure=1.5,this.renderer=t,this.monitoringManager=new Wt(this.MONITORING_ENABLED),H.setVisibility(this.DEBUGGING_ENABLED)}async init(){this.postprocessingManager=new jt,this.MONITORING_ENABLED&&await this.monitoringManager.stats.init(this.renderer)}async renderAsync(){this.MONITORING_ENABLED&&await this.renderer.resolveTimestampsAsync("compute"),this.POSTPROCESSING_ENABLED?await this.postprocessingManager.composer.renderAsync():await this.renderer.renderAsync(A.scene,A.renderCamera),this.MONITORING_ENABLED&&(this.monitoringManager.updateCustomPanels(),await this.renderer.resolveTimestampsAsync("render"),this.monitoringManager.stats.update())}}const V=new Kt;class qt{scene;camera;renderCamera;cameraHelper;controls;orbitControlsCamera;constructor(){const e=new Ge;this.scene=e;const t=window.innerWidth,o=window.innerHeight,s=t/o,r=new ke(45,s,.01,150);r.position.set(0,5,10),this.camera=r,e.add(r),this.renderCamera=r}debugScene(){if(!this.controls)return;H.panel.addFolder({title:"\uD83C\uDFA5 View"}).addBinding(this.controls,"enabled",{label:"Enable orbit controls"}).on("change",({value:t})=>{!this.cameraHelper||!this.orbitControlsCamera||(this.renderCamera=t?this.orbitControlsCamera:this.camera,this.cameraHelper.visible=t)})}update(){this.controls?.enabled&&this.controls.update()}}const A=new qt,q=new lt.EventEmitter,Y={LIGHT_POSITION_OFFSET:new S(10,10,10)};class Yt{directionalLight;hemisphereLight;constructor(){this.directionalLight=this.setupDirectionalLighting(),A.scene.add(this.directionalLight),this.hemisphereLight=this.setupHemisphereLight(),A.scene.add(this.hemisphereLight),q.on("update",this.update.bind(this)),this.debugLight()}setupHemisphereLight(){const e=new He;return e.color.setRGB(.6,.4,.5),e.groundColor.setRGB(.3,.2,.2),e.intensity=.5,e.position.copy(Y.LIGHT_POSITION_OFFSET),e}setupDirectionalLighting(){const e=new ze;e.intensity=.9,e.color.setRGB(.85,.75,.7),e.position.copy(Y.LIGHT_POSITION_OFFSET),e.target=new Ve,e.castShadow=!0,e.shadow.mapSize.set(64,64);const t=1;return e.shadow.intensity=.85,e.shadow.camera.left=-t,e.shadow.camera.right=t,e.shadow.camera.top=t,e.shadow.camera.bottom=-t,e.shadow.camera.near=.01,e.shadow.camera.far=30,e.shadow.normalBias=.1,e.shadow.bias=-.001,e}getTerrainShadowFactor=x(([e=O(0)])=>y(l.terrainShadowAo,e).r);debugLight(){const e=H.panel.addFolder({title:"\uD83D\uDCA1 Light"});e.expanded=!1,e.addBinding(Y.LIGHT_POSITION_OFFSET,"x",{label:"Sun position X"}),e.addBinding(Y.LIGHT_POSITION_OFFSET,"z",{label:"Sun position Z"}),e.addBinding(Y.LIGHT_POSITION_OFFSET,"y",{label:"Sun height"}),e.addBinding(this.directionalLight,"color",{label:"Directional Color",view:"color",color:{type:"float"}}),e.addBinding(this.directionalLight,"intensity",{min:0,max:5,label:"Directional intensity"}),e.addBinding(this.hemisphereLight,"color",{label:"Hemisphere sky color",view:"color",color:{type:"float"}}),e.addBinding(this.hemisphereLight,"groundColor",{label:"Hemisphere ground color",view:"color",color:{type:"float"}}),e.addBinding(this.hemisphereLight,"intensity",{min:0,max:1,label:"Hemisphere intensity"})}material_computeIllumination=x(()=>f(0));setTarget(e){this.directionalLight.target=e}update(e){const{player:t}=e;this.directionalLight.position.copy(t.position).add(Y.LIGHT_POSITION_OFFSET)}}const Le=new Yt;class Jt extends z{constructor(){super(),this.precision="lowp",this.flatShading=!1,this.map=l.trunkDiffuse,this.normalMap=l.trunkNormal}}class Xt extends z{constructor(){super(),this.precision="lowp",this.flatShading=!1,this.map=l.axeDiffuse,this.emissiveMap=l.axeEmissive,this.emissiveIntensity=2,this.emissive=new E("lightblue")}}class $t{constructor(){const e=l.realmModel.scene.getObjectByName("kratos_axe");e.material=new Xt;const t=l.realmModel.scene.getObjectByName("tree_trunk");t.material=new Jt,A.scene.add(e,t);const o=l.realmModel.scene.getObjectByName("axe_collider"),s=W.fixed().setTranslation(...o.position.toArray()).setRotation(o.quaternion),r=L.world.createRigidBody(s),n=o.geometry.boundingBox.max,a=Z.cuboid(n.x,n.y,n.z).setRestitution(.15);L.world.createCollider(a,r);const i=l.realmModel.scene.getObjectByName("trunk_collider"),{x:c,y:h}=i.geometry.boundingBox.max,m=W.fixed().setTranslation(...i.position.toArray()).setRotation(i.quaternion),w=L.world.createRigidBody(m),g=c,T=h/2,M=Z.capsule(T,g).setRestitution(.15);L.world.createCollider(M,w)}}class Qt{constructor(){new $t}}const Se={uBaseColor:u(new E),uRandom:u(0)};class es extends z{_uniforms;constructor(e){super(),this._uniforms={...Se,...e},this.createMaterial()}setRandomSeed(e){this._uniforms.uRandom.value=e}createMaterial(){this.precision="lowp",this.flatShading=!1;const e=I(D().mul(2).add(this._uniforms.uRandom)),t=y(l.stoneDiffuse,e);this.colorNode=t.mul(1.5);const o=y(l.stoneNormalAo,e);this.normalNode=new re(o.rgb,p(.5)),this.aoNode=o.a}}class ts{uniforms=Se;constructor(){const e=new es(this.uniforms),t=l.realmModel.scene.children.filter(({name:s})=>s.endsWith("_monument"));t.forEach((s,r)=>{const n=We.seededRandom(r);s.material=e,s.receiveShadow=!0,s.onBeforeRender=(a,i,c,h,m)=>{m.setRandomSeed(n)}}),A.scene.add(...t),l.realmModel.scene.children.filter(({name:s})=>s.startsWith("monument_collider")).forEach(s=>{const r=W.fixed().setTranslation(...s.position.toArray()).setRotation(s.quaternion),n=L.world.createRigidBody(r),a=.5*s.scale.x,i=.5*s.scale.y,c=.5*s.scale.z,h=Z.cuboid(a,i,c).setRestitution(.25);L.world.createCollider(h,n)}),this.debugMonuments()}debugMonuments(){const e=H.panel.addFolder({title:"\uD83D\uDDFD Monuments"});e.expanded=!1,e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base color",view:"color",color:{type:"float"}})}}const ss=20;class os extends z{_noiseBuffer;constructor(){super(),this._noiseBuffer=ce(ss,"float"),this._noiseBuffer.setPBO(!0),this.precision="lowp",this.flatShading=!1;const e=Q.computeMapUvByPosition(R.xz),t=C(e),o=j(v),s=y(l.noiseTexture,t),r=B(.5,s.r),n=p(1).sub(r),a=I(D().mul(3.6).add(o)),i=I(D().mul(1.5).add(o)),c=y(l.stoneDiffuse,a).mul(r),h=y(l.stoneMossyDiffuse,i).mul(n),m=c.add(h);this.colorNode=m.rgb;const w=y(l.stoneNormalAo,a).mul(r),g=y(l.stoneMossyNormalAo,i).mul(n),T=w.add(g);this.normalNode=new re(T.rgb,p(3)),this.aoNode=T.a}}class rs{constructor(){const e=l.realmModel.scene.getObjectByName("stone"),t=l.realmModel.scene.children.filter(({name:r})=>r.startsWith("stone_collider")),o=new os,s=new le(e.geometry,o,t.length);s.receiveShadow=!0,t.forEach((r,n)=>{s.setMatrixAt(n,r.matrix);const a=W.fixed().setTranslation(...r.position.toArray()).setRotation(r.quaternion),i=L.world.createRigidBody(a);r.geometry.computeBoundingBox();const c=r.geometry.boundingBox.max.x*r.scale.x,h=Z.ball(c).setRestitution(.15);L.world.createCollider(h,i)}),A.scene.add(s)}}const ns={uTime:u(0),uGrassTerrainColor:u(new E),uWaterSandColor:u(new E),uPathSandColor:u(new E)};class as extends z{_uniforms;constructor(e){super(),this._uniforms={...ns,...e},this.createMaterial()}computeCausticsDiffuse=x(([e=O(0,0),t=p(0),o=f(0,0,0)])=>{const s=this._uniforms.uTime.mul(.1),r=p(15),n=e.mul(r),a=I(n.add(O(s,0))),i=I(n.add(O(0,s.negate()))),c=y(l.noiseTexture,a,1).g,h=y(l.noiseTexture,i,2).g,m=c.add(h),w=K(-1,10,t),g=we(m,3).mul(p(1).sub(w)),T=f(.6,.8,1).mul(.3);return P(o,T,g)});computeWaterDiffuse=x(([e=p(0),t=O(0,0)])=>{const o=p(8),s=p(.001),r=K(0,o.add(s),e),n=this._uniforms.uWaterSandColor,a=f(.35,.45,.55).mul(.65),i=this.computeCausticsDiffuse(t,e),c=K(0,1.5,e),h=f(1,.9,.7).mul(.1).mul(c);return P(n,a,r).add(h).add(i)});createMaterial(){this.flatShading=!1;const e=Q.computeMapUvByPosition(R.xz),t=C(e),o=y(l.terrainShadowAo,t.clamp());this.aoNode=o.g;const s=y(l.terrainTypeMap,t,2.5),r=s.g,n=s.b,i=p(1).sub(r).sub(n),c=y(l.sandNormal,I(t.mul(30))),h=I(t.mul(30)),w=y(l.grassNormal,h).dot(c).mul(.65),g=y(l.grassDiffuse,h),T=p(1).sub(g.a),M=this._uniforms.uGrassTerrainColor.mul(T).add(g).mul(r).mul(.85),F=this._uniforms.uPathSandColor.mul(1.2).mul(i),J=C(R.y.negate()),$=this.computeWaterDiffuse(J,t).mul(n),ee=M.add(F.mul(w)).add($.mul(w).mul(.5));this.colorNode=ee.mul(o.r)}}class is{constructor(e){const t=this.createFloor();t.material=e,A.scene.add(t)}createFloor(){const e=l.realmModel.scene.getObjectByName("floor");return e.receiveShadow=!0,this.createFloorPhysics(),e}getFloorDisplacementData(){const e=l.realmModel.scene.getObjectByName("heightfield"),t=e.geometry.attributes._displacement.array[0],o=e.geometry.attributes.position;e.geometry.boundingBox||e.geometry.computeBoundingBox();const s=e.geometry.boundingBox,r=o.count,n=Math.sqrt(r),a=s.max.x,i=new Float32Array(r);for(let c=0;c<r;c++){const h=o.array[c*3+0],m=o.array[c*3+1],w=o.array[c*3+2],g=Math.round((h/(a*2)+.5)*(n-1)),M=Math.round((w/(a*2)+.5)*(n-1))+g*n;i[M]=m}return{rowsCount:n,heights:i,displacement:t}}createFloorPhysics(){const e=this.getFloorDisplacementData(),{rowsCount:t,heights:o,displacement:s}=e,r=W.fixed().setTranslation(0,-s,0),n=L.world.createRigidBody(r),a=Z.heightfield(t-1,t-1,o,{x:N.MAP_SIZE,y:1,z:N.MAP_SIZE},nt.FIX_INTERNAL_EDGES).setFriction(1).setRestitution(.2);L.world.createCollider(a,n)}}class ls{outerFloor;kintoun;kintounPosition=new S;constructor(e){this.outerFloor=this.createOuterFloorVisual(),this.outerFloor.material=e,this.kintoun=this.createKintoun(),A.scene.add(this.outerFloor)}createOuterFloorVisual(){const e=l.realmModel.scene.getObjectByName("outer_world");return e.receiveShadow=!0,e}createKintoun(){const e=W.kinematicPositionBased().setTranslation(0,-20,0),t=L.world.createRigidBody(e),o=2,s=Z.cuboid(o,N.HALF_FLOOR_THICKNESS,o).setFriction(1).setRestitution(.2);return L.world.createCollider(s,t),t}useKintoun(e){this.kintounPosition.copy(e).setY(-N.HALF_FLOOR_THICKNESS),this.kintoun.setTranslation(this.kintounPosition,!0)}update(e){const{player:t}=e,o=N.HALF_MAP_SIZE-Math.abs(t.position.x)<N.KINTOUN_ACTIVATION_THRESHOLD,s=N.HALF_MAP_SIZE-Math.abs(t.position.z)<N.KINTOUN_ACTIVATION_THRESHOLD;(o||s)&&this.useKintoun(t.position);const r=N.MAP_SIZE,n=Math.abs(t.position.x),a=Math.sign(t.position.x),i=Math.abs(t.position.z),c=Math.sign(t.position.z),h=n>r?n-r:0,m=i>r?i-r:0;this.outerFloor.position.set(h*a,0,m*c)}}class cs{outerTerrain;uniforms={uTime:u(0),uGrassTerrainColor:u(new E().setRGB(.21,.26,.05)),uWaterSandColor:u(new E().setRGB(.54,.39,.2)),uPathSandColor:u(new E().setRGB(.65,.49,.27))};constructor(){const e=new as(this.uniforms);new is(e),this.outerTerrain=new ls(e),q.on("update",this.update.bind(this)),this.debugTerrain()}debugTerrain(){const e=H.panel.addFolder({title:"⛰️ Terrain"});e.expanded=!1,e.addBinding(this.uniforms.uPathSandColor,"value",{label:"Path color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWaterSandColor,"value",{label:"Water bed color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGrassTerrainColor,"value",{label:"Grass terrain color",view:"color",color:{type:"float"}})}update(e){const{clock:t}=e;this.uniforms.uTime.value=t.getElapsedTime(),this.outerTerrain.update(e)}}const us=()=>({BLADE_WIDTH:.065,BLADE_HEIGHT:1.25,BLADE_BOUNDING_SPHERE_RADIUS:1.25,TILE_SIZE:150,TILE_HALF_SIZE:150/2,BLADES_PER_SIDE:650,COUNT:650*650,SPACING:150/650}),b=us(),Me={uTime:u(0),uPlayerPosition:u(new S(0,0,0)),uCameraMatrix:u(new ye),uBladeMinScale:u(.5),uBladeMaxScale:u(1.25),uTrailGrowthRate:u(.004),uTrailMinScale:u(.25),uTrailRaius:u(.65),uTrailRaiusSquared:u(.65*.65),uGlowRadius:u(2),uGlowRadiusSquared:u(4),uGlowFadeIn:u(.05),uGlowFadeOut:u(.01),uGlowColor:u(new E().setRGB(.49,.3,.07)),uBladeMaxBendAngle:u(Math.PI*.15),uWindStrength:u(.6),uBaseColor:u(new E().setRGB(.1,.1,.02)),uTipColor:u(new E().setRGB(.17,.16,.05)),uDelta:u(new Te(0,0))};class ds extends _e{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...Me,...e},this._buffer1=ce(b.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=ce(b.COUNT,"vec4"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createGrassMaterial()}computeInit=x(()=>{const e=this._buffer1.element(v),t=ne(p(v).div(b.BLADES_PER_SIDE)),o=p(v).mod(b.BLADES_PER_SIDE),s=j(v.add(4321)),r=j(v.add(1234)),n=o.mul(b.SPACING).sub(b.TILE_HALF_SIZE).add(s.mul(b.SPACING*.5)),a=t.mul(b.SPACING).sub(b.TILE_HALF_SIZE).add(r.mul(b.SPACING*.5)),i=f(n,0,a).xz.add(b.TILE_HALF_SIZE).div(b.TILE_SIZE).abs(),c=y(l.noiseTexture,i),h=c.b.sub(.5).mul(30),m=c.g.sub(.5).mul(10);e.x=n.add(h),e.y=a.add(m);const g=f(e.x,0,e.y).xz.add(b.TILE_HALF_SIZE).div(b.TILE_SIZE),T=p(20),M=I(g.mul(T)),J=y(l.noiseTexture,M,1).b.sub(.5).mul(p(Math.PI*2));e.z=J;const X=this._buffer2.element(v),$=this._uniforms.uBladeMaxScale.sub(this._uniforms.uBladeMinScale),ee=j(v.add(100)).mul($).add(this._uniforms.uBladeMinScale);X.x=ee,X.y=ee})().compute(b.COUNT);computeVisibility=x(([e=f(0)])=>{const t=this._uniforms.uCameraMatrix.mul(G(e,1)),o=t.xyz.div(t.w),s=b.BLADE_BOUNDING_SPHERE_RADIUS,r=p(1);return B(r.negate().sub(s),o.x).mul(B(o.x,r.add(s))).mul(B(r.negate().sub(s),o.y)).mul(B(o.y,r.add(s))).mul(B(0,o.z)).mul(B(o.z,r))});computeBending=x(([e=G(0,0,0,0),t=f(0,0,0)])=>{const o=t.xz.add(this._uniforms.uTime.mul(.25)).mul(.5),s=I(o),n=y(l.noiseTexture,s,5).r.mul(this._uniforms.uWindStrength);return e.w.add(n.sub(e.w).mul(.1))});computeAlpha=x(([e=f(0)])=>{const t=Q.computeMapUvByPosition(e.xz);return y(l.terrainTypeMap,t).g});computeTrailScale=x(([e=G(0),t=p(0)])=>{const o=e.x.add(this._uniforms.uTrailGrowthRate),s=p(1).sub(t),r=this._uniforms.uTrailMinScale.mul(t).add(o.mul(s));return je(r,e.y)});computeTrailGlow=x(([e=G(0),t=p(0),o=p(0),s=p(0)])=>{const r=K(this._uniforms.uGlowRadiusSquared,p(0),t),n=100,a=ne(ae(this._uniforms.uDelta.x).mul(n)),i=ne(ae(this._uniforms.uDelta.y).mul(n)),c=B(1,a.add(i)),h=r.mul(p(1).sub(o)).mul(s),m=Ke(c,e.w).mul(h),w=m.mul(this._uniforms.uGlowFadeIn),g=p(1).sub(m).mul(this._uniforms.uGlowFadeOut),T=p(1).sub(c).mul(this._uniforms.uGlowFadeOut).mul(e.w);return xe(e.w.add(w).sub(g).sub(T),0,1)});computeUpdate=x(()=>{const e=this._buffer1.element(v),t=this._buffer2.element(v),o=ue(e.x.sub(this._uniforms.uDelta.x).add(b.TILE_HALF_SIZE),b.TILE_SIZE).sub(b.TILE_HALF_SIZE),s=ue(e.y.sub(this._uniforms.uDelta.y).add(b.TILE_HALF_SIZE),b.TILE_SIZE).sub(b.TILE_HALF_SIZE),r=f(o,0,s);e.x=o,e.y=s;const n=r.add(this._uniforms.uPlayerPosition),a=this.computeVisibility(n);t.z=a,qe(a,()=>{const i=O(this._uniforms.uDelta.x,this._uniforms.uDelta.y),c=r.xz.sub(i),h=c.dot(c),m=B(.1,p(1).sub(this._uniforms.uPlayerPosition.y)),w=B(h,this._uniforms.uTrailRaiusSquared).mul(m);t.x=this.computeTrailScale(t,w),t.z=this.computeAlpha(n),e.w=this.computeBending(e,n),t.w=this.computeTrailGlow(t,h,w,m)})})().compute(b.COUNT);computePosition=x(([e=G(0),t=G(0)])=>{const o=f(e.x,0,e.y),s=e.z,r=e.w,n=t.x,a=r.mul(D().y),c=he(k,f(a,0,0)).mul(f(1,n,1)),h=he(c,f(0,s,0)),m=j(v).mul(6.28),w=oe(this._uniforms.uTime.mul(5).add(e.w).add(m)).mul(.1),g=D().y.mul(t.w),T=w.mul(g);return h.add(o).add(f(T))});computeDiffuseColor=x(([e=G(0)])=>{const t=we(D().y,1.5),o=P(this._uniforms.uBaseColor,this._uniforms.uTipColor,t),s=j(v).mul(.05).sub(.025),r=e.w;return P(o.add(s),this._uniforms.uGlowColor.mul(.5),r)});computeAO=x(([e=G(0)])=>{const t=ae(oe(e.z)).mul(.5);return K(-2.5,1.25,D().y).mul(p(1).sub(t))});createGrassMaterial(){this.precision="lowp",this.side=Ae;const e=this._buffer1.element(v),t=this._buffer2.element(v);Ye(t.z.equal(0)),this.positionNode=this.computePosition(e,t),this.opacityNode=t.z,this.alphaTest=.25,this.aoNode=this.computeAO(e),this.colorNode=this.computeDiffuseColor(t)}async updateAsync(){await V.renderer.computeAsync(this.computeUpdate)}}class hs{material;grassField;uniforms={...Me,uDelta:u(new Te(0,0)),uPlayerPosition:u(new S(0,0,0)),uCameraMatrix:u(new ye),uTime:u(0)};constructor(){const e=this.createBladeGeometry();e.instanceCount=b.COUNT,this.material=new ds(this.uniforms),this.grassField=new be(e,this.material),A.scene.add(this.grassField),q.on("update",this.updateAsync.bind(this)),this.debugGrass()}debugGrass(){const e=H.panel.addFolder({title:"\uD83C\uDF31 Grass"});e.expanded=!1,e.addBinding(this.uniforms.uTipColor,"value",{label:"Tip Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGlowColor,"value",{label:"Glow Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWindStrength,"value",{label:"Wind strength",min:0,max:Math.PI/2,step:.1})}createBladeGeometry(){const e=b.BLADE_WIDTH/2,t=e/2,o=b.BLADE_HEIGHT/2,s=new Float32Array([-e,0,0,e,0,0,-t,o*1,0,t,o*1,0,0,o*2,0]),r=new Float32Array([0,0,1,0,.25,o*1,.75,o*1,.5,o*2]),n=new Uint16Array([0,1,3,0,3,2,2,3,4]),i=25*Math.PI/180,c=Math.cos(i),h=Math.sin(i),w=15*Math.PI/180,g=Math.cos(w),T=Math.sin(w),M=new Float32Array([-c,h,0,c,h,0,-g,T,0,g,T,0,0,1,0]),F=new Ze;return F.setAttribute("position",new te(s,3)),F.setAttribute("uv",new te(r,2)),F.setIndex(new te(n,1)),F.setAttribute("normal",new te(M,3)),F}async updateAsync(e){const{player:t,clock:o}=e,s=t.position.x-this.grassField.position.x,r=t.position.z-this.grassField.position.z;this.uniforms.uDelta.value.set(s,r),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(A.camera.projectionMatrix).multiply(A.camera.matrixWorldInverse),this.uniforms.uTime.value=o.getElapsedTime(),this.grassField.position.copy(t.position).setY(0),await this.material.updateAsync()}}class ms{uTime=u(0);constructor(){const e=l.realmModel.scene.getObjectByName("water_lilies");e.material=this.createMaterial(),A.scene.add(e),q.on("update",this.update.bind(this))}createMaterial(){const e=new z;e.precision="lowp",e.transparent=!0,e.map=l.waterLiliesTexture,e.alphaTest=.5,e.alphaMap=l.waterLiliesAlphaTexture;const t=this.uTime.mul(5e-4),o=R.x.mul(.1),s=y(l.noiseTexture,I(R.xz.add(t).mul(o))).b.mul(.5),r=oe(s);return e.positionNode=k.add(r),e}update(e){const{clock:t}=e;this.uTime.value=t.getElapsedTime()}}class ps extends z{constructor(){super(),this.precision="lowp",this.flatShading=!1;const e=I(D().mul(7)),t=y(l.barkDiffuse,e);this.colorNode=t;const o=y(l.barkNormal,e);this.normalNode=new re(o)}}class fs extends z{constructor(){super(),this.precision="lowp",this.flatShading=!1,this.transparent=!0,this.side=Ae;const e=Q.computeMapUvByPosition(R.xz),t=y(l.noiseTexture,e),o=j(v.add(t.b)),s=y(l.canopyDiffuse,D()),r=P(f(.889,.095,0),f(1,.162,.009),.5),n=P(f(1,.254,.052),f(1,.767,.004),.5),a=P(r,n,o);this.colorNode=P(s.mul(1.25),a,t.b);const i=y(l.canopyNormal,D());this.normalNode=new re(i,p(2)),this.alphaTest=.9}}class gs{constructor(){const e=l.realmModel.scene.getObjectByName("tree"),t=l.realmModel.scene.children.filter(({name:g})=>g.startsWith("tree_collider")),o=new ps,s=new fs,[r,n]=e.children,a=new le(r.geometry,o,t.length);a.receiveShadow=!0;const i=new le(n.geometry,s,t.length),h=l.realmModel.scene.getObjectByName("base_tree_collider").geometry.boundingBox,m=h.max.x,w=h.max.y/2;t.forEach((g,T)=>{a.setMatrixAt(T,g.matrix),i.setMatrixAt(T,g.matrix);const M=W.fixed().setTranslation(...g.position.toArray()).setRotation(g.quaternion),F=L.world.createRigidBody(M),J=m*g.scale.x,X=w*g.scale.y,$=Z.capsule(X,J).setRestitution(.15);L.world.createCollider($,F)}),A.scene.add(a,i)}}class ws{constructor(){new hs,new ms,new gs}}const ys={uTime:u(0),uWavesSpeed:u(.02),uWavesAmplitude:u(.05),uWavesFrequency:u(2.68),uTroughColor:u(new E().setRGB(.16,.16,.16)),uSurfaceColor:u(new E().setRGB(.07,.08,.09)),uPeakColor:u(new E().setRGB(.46,.27,.18)),uPeakThreshold:u(.5),uPeakTransition:u(.5),uTroughThreshold:u(-.1),uTroughTransition:u(.35),uFresnelScale:u(.35)};class Ts extends _e{_uniforms;debugFolder;constructor(e){super(),this._uniforms={...ys,...e},this.createWaterMaterial(),this.debugFolder=H.panel.addFolder({title:"\uD83C\uDF0A Water"}),this.debugFolder.expanded=!1,this.debugWaves(),this.debugColor(),this.debugFresnel()}computeElevation=x(([e=O(0,0)])=>{const t=this._uniforms.uTime.mul(this._uniforms.uWavesSpeed).mul(.1),o=ue(e.mul(this._uniforms.uWavesFrequency).add(t),1),s=y(l.noiseTexture,I(o.mul(10)),2),r=P(s.r,s.g,.5);return P(r,s.b,.5).mul(this._uniforms.uWavesAmplitude).mul(.001)});computePosition=x(([e=p(0)])=>{const t=e.mul(10);return f(k.x,k.y.add(t),k.z)});computeNormal=x(([e=p(0)])=>{const t=p(.001),o=this.computeElevation(O(k.x.sub(t),k.z)),s=this.computeElevation(O(k.x,k.z.sub(t))),r=se(f(t,o.sub(e),0)),n=se(f(0,s.sub(e),t)),a=f(1e-4);return se(Je(r,n)).add(a)});computeFresnel=x(([e=C(f(0,0,0)),t=f(0,0,0)])=>{const o=Xe($e(p(1).sub(xe(me(t,e),0,1))));return this._uniforms.uFresnelScale.mul(o)});computeReflectionColor=x(([e=C(f(0,0,0)),t=f(0,0,0)])=>{const o=Qe(t,e);return et(l.envMapTexture,o)});computeColor=x(([e=C(f(0,0,0)),t=C(f(0,0,0)),o=C(f(0,0,0))])=>{const s=se(o.sub(ie)),r=this.computeReflectionColor(e,s),n=this.computeFresnel(e,s),a=pe(t.y.sub(this._uniforms.uTroughThreshold).div(this._uniforms.uTroughTransition.mul(2))),i=P(this._uniforms.uTroughColor,this._uniforms.uSurfaceColor,a),c=pe(t.y.sub(this._uniforms.uPeakThreshold).div(this._uniforms.uPeakTransition.mul(2))),h=P(i,this._uniforms.uPeakColor,c),m=P(h,r.rgb,n),w=me(o.xz.sub(ie.xz),o.xz.sub(ie.xz)),g=10,T=55,M=P(.1,.75,K(g*g,T*T,w));return G(m,M)});createWaterMaterial(){this.precision="lowp";const e=this.computeElevation(D()).mul(1e3),t=this.computePosition(e),o=this.computeNormal(e),s=C(t,"vPosition"),r=C(o,"vNormal"),n=C(R,"vWorldPosition"),a=this.computeColor(r,s,n);this.transparent=!0,this.colorNode=a,this.positionNode=t}debugWaves(){const e=this.debugFolder.addFolder({title:"Waves"});e.addBinding(this._uniforms.uWavesAmplitude,"value",{min:0,max:.1,label:"Amplitude"}),e.addBinding(this._uniforms.uWavesFrequency,"value",{min:.1,max:10,label:"Frequency"}),e.addBinding(this._uniforms.uWavesSpeed,"value",{min:0,max:1,label:"Speed"})}debugColor(){const e=this.debugFolder.addFolder({title:"Color"});e.addBinding(this._uniforms.uTroughColor,"value",{label:"Trough Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uSurfaceColor,"value",{label:"Surface Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakColor,"value",{label:"Peak Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakThreshold,"value",{min:0,max:.5,label:"Peak Threshold"}),e.addBinding(this._uniforms.uPeakTransition,"value",{min:0,max:.5,label:"Peak Transition"}),e.addBinding(this._uniforms.uTroughThreshold,"value",{min:-.5,max:0,label:"Trough Threshold"}),e.addBinding(this._uniforms.uTroughTransition,"value",{min:0,max:.5,label:"Trough Transition"})}debugFresnel(){this.debugFolder.addFolder({title:"Fresnel"}).addBinding(this._uniforms.uFresnelScale,"value",{min:0,max:1,label:"Scale"})}}class bs{uTime=u(0);constructor(){const e=this.createWater();A.scene.add(e),q.on("update",this.update.bind(this))}createWater(){const e=l.realmModel.scene.getObjectByName("water"),t=new Ts({uTime:this.uTime});return e.material=t,e}update(e){const{clock:t}=e;this.uTime.value=t.getElapsedTime()}}const _s=()=>Object.freeze({MAP_SIZE:256,HALF_MAP_SIZE:256/2,KINTOUN_ACTIVATION_THRESHOLD:2,HALF_FLOOR_THICKNESS:.3,OUTER_MAP_SIZE:256*3,OUTER_HALF_MAP_SIZE:256*1.5}),N=_s();class xs{constructor(){new cs,new ts,new bs,new ws,new rs,new Qt}}class As{computeMapUvByPosition=x(([e=O(0)])=>e.add(N.HALF_MAP_SIZE).div(N.MAP_SIZE))}const Q=new As,Ls=()=>({JUMP_BUFFER_DURATION_IN_SECONDS:.2,MAX_CONSECUTIVE_JUMPS:2,JUMP_CUT_MULTIPLIER:.25,FALL_MULTIPLIER:2.75,MAX_UPWARD_VELOCITY:6,LINEAR_DAMPING:.35,ANGULAR_DAMPING:.6,JUMP_IMPULSE:new S(0,75,0),LIN_VEL_STRENGTH:35,ANG_VEL_STRENGTH:25,RADIUS:.5,PLAYER_INITIAL_POSITION:new S(0,5,0),CAMERA_OFFSET:new S(0,11,17),CAMERA_LERP_FACTOR:7.5,UP:new S(0,1,0),DOWN:new S(0,-1,0),FORWARD:new S(0,0,-1)}),_=Ls();class Ss{mesh;rigidBody;smoothedCameraPosition=new S;desiredCameraPosition=new S;smoothedCameraTarget=new S;desiredTargetPosition=new S;yawInRadians=0;prevYawInRadians=-1;yawQuaternion=new tt;newLinVel=new S;newAngVel=new S;torqueAxis=new S;forwardVec=new S;isOnGround=!1;jumpCount=0;wasJumpHeld=!1;jumpBufferTimer=0;rayOrigin=new S;ray=new at(this.rayOrigin,_.DOWN);uTime=u(0);uOffsetShadow=u(0);constructor(){this.mesh=this.createCharacterMesh(),A.scene.add(this.mesh),Le.setTarget(this.mesh),this.rigidBody=L.world.createRigidBody(this.createRigidBodyDesc()),L.world.createCollider(this.createColliderDesc(),this.rigidBody),q.on("update",this.update.bind(this)),H.panel.addBinding(_.CAMERA_OFFSET,"y",{label:"Main camera height"}),H.panel.addBinding(_.CAMERA_OFFSET,"z",{label:"Main camera distance"})}createCharacterMesh(){const e=new st(_.RADIUS,2),t=new Ms({uTime:this.uTime,uOffsetShadow:this.uOffsetShadow}),o=new be(e,t);return o.castShadow=!0,o.position.copy(_.PLAYER_INITIAL_POSITION),o}createRigidBodyDesc(){const{x:e,y:t,z:o}=_.PLAYER_INITIAL_POSITION;return W.dynamic().setTranslation(e,t,o).setLinearDamping(_.LINEAR_DAMPING).setAngularDamping(_.ANGULAR_DAMPING)}createColliderDesc(){return Z.ball(_.RADIUS).setRestitution(.2).setFriction(1).setMass(3)}update(e){const{clock:t}=e,o=t.getDelta();this.uTime.value=t.getElapsedTime(),this.prevYawInRadians!==this.yawInRadians&&(this.yawQuaternion.setFromAxisAngle(_.UP,this.yawInRadians),this.prevYawInRadians=this.yawInRadians),this.updateVerticalMovement(o),this.updateHorizontalMovement(o),this.updateCameraPosition(o)}updateVerticalMovement(e){const t=U.isKeyPressed(" ");this.isOnGround=this.checkIfGrounded(),this.isOnGround&&(this.jumpCount=0),t&&!this.wasJumpHeld?this.jumpBufferTimer=_.JUMP_BUFFER_DURATION_IN_SECONDS:this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),this.jumpBufferTimer>0&&this.canJump()&&(this.performJump(),this.jumpBufferTimer=0);const s=this.rigidBody.linvel();this.handleJumpCut(t,s),this.handleFastFall(e,s,L.world.gravity.y),this.clampUpwardVelocity(s),this.rigidBody.setLinvel(s,!0),this.wasJumpHeld=t}checkIfGrounded(){this.rayOrigin.copy(this.rigidBody.translation()),this.rayOrigin.y-=_.RADIUS+.01;const e=.2,t=L.world.castRay(this.ray,e,!0);return t?t.timeOfImpact*e<.01:!1}canJump(){return this.isOnGround?!0:this.jumpCount<_.MAX_CONSECUTIVE_JUMPS}performJump(){this.rigidBody.applyImpulse(_.JUMP_IMPULSE,!0),this.jumpCount+=1}handleJumpCut(e,t){!(!e&&this.wasJumpHeld)||t.y<=0||(t.y*=_.JUMP_CUT_MULTIPLIER)}handleFastFall(e,t,o){if(t.y>=0)return;const s=_.FALL_MULTIPLIER*Math.abs(o)*e;t.y-=s}clampUpwardVelocity(e){e.y<=_.MAX_UPWARD_VELOCITY||(e.y=_.MAX_UPWARD_VELOCITY)}updateHorizontalMovement(e){const t=U.isKeyPressed("w")||U.isKeyPressed("arrowup"),o=U.isKeyPressed("s")||U.isKeyPressed("arrowdown"),s=U.isKeyPressed("a")||U.isKeyPressed("arrowleft"),r=U.isKeyPressed("d")||U.isKeyPressed("arrowright"),n=2;s&&(this.yawInRadians+=n*e),r&&(this.yawInRadians-=n*e),this.forwardVec.copy(_.FORWARD).applyQuaternion(this.yawQuaternion),this.torqueAxis.crossVectors(_.UP,this.forwardVec).normalize(),this.newLinVel.copy(this.rigidBody.linvel()),this.newAngVel.copy(this.rigidBody.angvel());const a=_.LIN_VEL_STRENGTH*e,i=_.ANG_VEL_STRENGTH*e;t&&(this.newLinVel.addScaledVector(this.forwardVec,a),this.newAngVel.addScaledVector(this.torqueAxis,i)),o&&(this.newLinVel.addScaledVector(this.forwardVec,-a),this.newAngVel.addScaledVector(this.torqueAxis,-i)),this.rigidBody.setLinvel(this.newLinVel,!0),this.rigidBody.setAngvel(this.newAngVel,!0),this.syncMeshWithBody()}syncMeshWithBody(){this.mesh.position.copy(this.rigidBody.translation()),this.mesh.quaternion.copy(this.rigidBody.rotation())}updateCameraPosition(e){this.desiredCameraPosition.copy(_.CAMERA_OFFSET).applyQuaternion(this.yawQuaternion).add(this.mesh.position);const t=_.CAMERA_LERP_FACTOR*e;this.smoothedCameraPosition.lerp(this.desiredCameraPosition,t),this.desiredTargetPosition.copy(this.mesh.position),this.desiredTargetPosition.y+=1,this.smoothedCameraTarget.lerp(this.desiredTargetPosition,t),A.camera.position.copy(this.smoothedCameraPosition),A.camera.lookAt(this.smoothedCameraTarget)}get position(){return this.mesh.position}get yaw(){return this.yawInRadians}}class Ms extends z{_uniforms;constructor(e){super(),this._uniforms={...e},this.createMaterial()}createMaterial(){this.flatShading=!0,this.castShadowNode=f(.6);const e=Q.computeMapUvByPosition(R.xz),t=C(e),o=Le.getTerrainShadowFactor(t),s=y(l.noiseTexture,I(R.xz),3).r,r=oe(this._uniforms.uTime.mul(2.5).add(s.mul(5))).mul(.05),n=p(-.15).add(r),a=p(1).sub(B(n,R.y)),i=p(1).sub(a),c=f(1),h=p(1).sub(K(-1.5,1,R.y).mul(a)),m=P(f(1),f(.6,.8,1).mul(.75),h),w=c.mul(m).mul(a),T=c.mul(i).add(w);this.colorNode=T.mul(o)}}class vs{player;constructor(){this.player=new Ss,new xs}getSizes(){const e=window.innerWidth,t=window.innerHeight;return{width:e,height:t,dpr:Math.min(window.devicePixelRatio,1.5),aspect:e/t}}onResize(){const e=this.getSizes();A.camera.aspect=e.aspect,A.camera.updateProjectionMatrix(),V.renderer.setSize(e.width,e.height),V.renderer.setPixelRatio(e.dpr)}async startLoop(){await V.init();const t={clock:new ot(!0),player:this.player},o=async()=>{L.update(),q.emit("update",t),V.renderAsync()};new ResizeObserver(()=>{this.onResize()}).observe(document.body),V.renderer.setAnimationLoop(o)}}const Ps=new Ht;Ps.initAsync().then(()=>{new vs().startLoop()})});