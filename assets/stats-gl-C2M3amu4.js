class c{constructor(t,e,i){this.id=0,this.name=t,this.fg=e,this.bg=i,this.gradient=null,this.PR=Math.round(window.devicePixelRatio||1),this.WIDTH=90*this.PR,this.HEIGHT=48*this.PR,this.TEXT_X=3*this.PR,this.TEXT_Y=2*this.PR,this.GRAPH_X=3*this.PR,this.GRAPH_Y=15*this.PR,this.GRAPH_WIDTH=84*this.PR,this.GRAPH_HEIGHT=30*this.PR,this.canvas=document.createElement("canvas"),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width="90px",this.canvas.style.height="48px",this.canvas.style.position="absolute",this.canvas.style.cssText="width:90px;height:48px;background-color: transparent !important;",this.context=this.canvas.getContext("2d"),this.initializeCanvas()}createGradient(){if(!this.context)throw new Error("No context");const t=this.context.createLinearGradient(0,this.GRAPH_Y,0,this.GRAPH_Y+this.GRAPH_HEIGHT);let e;const i=this.fg;switch(this.fg.toLowerCase()){case"#0ff":e="#006666";break;case"#0f0":e="#006600";break;case"#ff0":e="#666600";break;case"#e1e1e1":e="#666666";break;default:e=this.bg;break}return t.addColorStop(0,e),t.addColorStop(1,i),t}initializeCanvas(){this.context&&(this.context.imageSmoothingEnabled=!1,this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.gradient=this.createGradient(),this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.HEIGHT),this.context.fillStyle=this.fg,this.context.fillText(this.name,this.TEXT_X,this.TEXT_Y),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT))}update(t,e,i=0){if(!this.context||!this.gradient)return;const s=Math.min(1/0,t),h=Math.max(e,t);this.context.globalAlpha=1,this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.GRAPH_Y),this.context.fillStyle=this.fg,this.context.fillText(`${t.toFixed(i)} ${this.name} (${s.toFixed(i)}-${parseFloat(h.toFixed(i))})`,this.TEXT_X,this.TEXT_Y)}updateGraph(t,e){if(!this.context||!this.gradient)return;t===0&&e===0&&(e=1),e=Math.max(e,t,.1),t=Math.max(t,0);const i=Math.round(this.GRAPH_X),s=Math.round(this.GRAPH_Y),h=Math.round(this.GRAPH_WIDTH),a=Math.round(this.GRAPH_HEIGHT),n=Math.round(this.PR);this.context.drawImage(this.canvas,i+n,s,h-n,a,i,s,h-n,a),this.context.fillStyle=this.bg,this.context.fillRect(i+h-n,s,n,a);const r=Math.min(a,Math.round(t/e*a));r>0&&(this.context.globalAlpha=.9,this.context.fillStyle=this.gradient,this.context.fillRect(i+h-n,s+(a-r),n,r)),this.context.globalAlpha=1}}class P extends c{constructor(t,e,i){super(t,e,i),this.vsyncValue=0,this.SMALL_HEIGHT=9*this.PR,this.HEIGHT=this.SMALL_HEIGHT,this.WIDTH=35*this.PR,this.TEXT_Y=0*this.PR,this.canvas.height=this.HEIGHT,this.canvas.width=this.WIDTH,this.canvas.style.height="9px",this.canvas.style.width="35px",this.canvas.style.cssText=`
            width: 35px;
            height: 9px;
            position: absolute;
            top: 0;
            left: 0;
            background-color: transparent !important;
            pointer-events: none;
        `,this.initializeCanvas()}initializeCanvas(){this.context&&(this.context.imageSmoothingEnabled=!1,this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.context.globalAlpha=1)}update(t,e,i=0){this.context&&(this.vsyncValue=t,this.context.clearRect(0,0,this.WIDTH,this.HEIGHT),this.context.globalAlpha=1,this.context.fillStyle=this.bg,this.context.fillText(`${t.toFixed(0)}Hz`,this.TEXT_X,this.TEXT_Y))}updateGraph(t,e){}setOffset(t,e){this.canvas.style.transform=`translate(${t}px, ${e}px)`}}const u=class l{constructor({trackGPU:t=!1,trackCPT:e=!1,trackHz:i=!1,logsPerSecond:s=4,graphsPerSecond:h=30,samplesLog:a=40,samplesGraph:n=10,precision:r=2,minimal:o=!1,horizontal:m=!0,mode:d=0}={}){this.gl=null,this.ext=null,this.activeQuery=null,this.gpuQueries=[],this.threeRendererPatched=!1,this.frameTimes=[],this.renderCount=0,this.totalCpuDuration=0,this.totalGpuDuration=0,this.totalGpuDurationCompute=0,this.gpuPanel=null,this.gpuPanelCompute=null,this.vsyncPanel=null,this.averageFps={logs:[],graph:[]},this.averageCpu={logs:[],graph:[]},this.averageGpu={logs:[],graph:[]},this.averageGpuCompute={logs:[],graph:[]},this.updateCounter=0,this.lastMin={},this.lastMax={},this.lastValue={},this.VSYNC_RATES=[{refreshRate:60,frameTime:16.67},{refreshRate:75,frameTime:13.33},{refreshRate:90,frameTime:11.11},{refreshRate:120,frameTime:8.33},{refreshRate:144,frameTime:6.94},{refreshRate:165,frameTime:6.06},{refreshRate:240,frameTime:4.17}],this.detectedVSync=null,this.frameTimeHistory=[],this.HISTORY_SIZE=120,this.VSYNC_THRESHOLD=.05,this.lastFrameTime=0,this.handleClick=g=>{g.preventDefault(),this.showPanel(++this.mode%this.dom.children.length)},this.handleResize=()=>{this.resizePanel(this.fpsPanel),this.resizePanel(this.msPanel),this.gpuPanel&&this.resizePanel(this.gpuPanel),this.gpuPanelCompute&&this.resizePanel(this.gpuPanelCompute)},this.mode=d,this.horizontal=m,this.minimal=o,this.trackGPU=t,this.trackCPT=e,this.trackHz=i,this.samplesLog=a,this.samplesGraph=n,this.precision=r,this.logsPerSecond=s,this.graphsPerSecond=h;const p=performance.now();this.prevGraphTime=p,this.dom=document.createElement("div"),this.initializeDOM(),this.beginTime=performance.now(),this.prevTextTime=this.beginTime,this.prevCpuTime=this.beginTime,this._panelId=0,this.fpsPanel=this.addPanel(new l.Panel("FPS","#0ff","#002")),this.msPanel=this.addPanel(new l.Panel("CPU","#0f0","#020")),this.trackHz===!0&&(this.vsyncPanel=new P("","#f0f","#202"),this.dom.appendChild(this.vsyncPanel.canvas),this.vsyncPanel.setOffset(56,35)),this.setupEventListeners()}initializeDOM(){this.dom.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      opacity: 0.9;
      z-index: 10000;
      ${this.minimal?"cursor: pointer;":""}
    `}setupEventListeners(){this.minimal?(this.dom.addEventListener("click",this.handleClick),this.showPanel(this.mode)):window.addEventListener("resize",this.handleResize)}async init(t){if(!t){console.error('Stats: The "canvas" parameter is undefined.');return}if(!this.handleThreeRenderer(t)&&!await this.handleWebGPURenderer(t))if(this.initializeWebGL(t)){this.trackGPU&&this.initializeGPUTracking();return}else console.error("Stats-gl: Failed to initialize WebGL context")}handleThreeRenderer(t){return t.isWebGLRenderer&&!this.threeRendererPatched?(this.patchThreeRenderer(t),this.gl=t.getContext(),this.trackGPU&&this.initializeGPUTracking(),!0):!1}async handleWebGPURenderer(t){return t.isWebGPURenderer?((this.trackGPU||this.trackCPT)&&(t.backend.trackTimestamp=!0,await t.hasFeatureAsync("timestamp-query")&&this.initializeWebGPUPanels()),this.info=t.info,this.patchThreeWebGPU(t),!0):!1}initializeWebGPUPanels(){this.trackGPU&&(this.gpuPanel=this.addPanel(new l.Panel("GPU","#ff0","#220"))),this.trackCPT&&(this.gpuPanelCompute=this.addPanel(new l.Panel("CPT","#e1e1e1","#212121")))}initializeWebGL(t){if(t instanceof WebGL2RenderingContext)this.gl=t;else if(t instanceof HTMLCanvasElement||t instanceof OffscreenCanvas){if(this.gl=t.getContext("webgl2"),!this.gl)return console.error("Stats: Unable to obtain WebGL2 context."),!1}else return console.error("Stats: Invalid input type. Expected WebGL2RenderingContext, HTMLCanvasElement, or OffscreenCanvas."),!1;return!0}initializeGPUTracking(){this.gl&&(this.ext=this.gl.getExtension("EXT_disjoint_timer_query_webgl2"),this.ext&&(this.gpuPanel=this.addPanel(new l.Panel("GPU","#ff0","#220"))))}begin(){this.beginProfiling("cpu-started"),!(!this.gl||!this.ext)&&(this.activeQuery&&this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.activeQuery=this.gl.createQuery(),this.activeQuery&&this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery))}end(){this.renderCount++,this.gl&&this.ext&&this.activeQuery&&(this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.gpuQueries.push({query:this.activeQuery}),this.activeQuery=null),this.endProfiling("cpu-started","cpu-finished","cpu-duration")}update(){this.endProfiling("cpu-started","cpu-finished","cpu-duration"),this.info?this.processWebGPUTimestamps():this.processGpuQueries(),this.updateAverages(),this.resetCounters()}processWebGPUTimestamps(){this.totalGpuDuration=this.info.render.timestamp,this.totalGpuDurationCompute=this.info.compute.timestamp}resetCounters(){this.renderCount=0,this.totalCpuDuration=0,this.beginTime=this.endInternal()}resizePanel(t){t.canvas.style.position="absolute",this.minimal?t.canvas.style.display="none":(t.canvas.style.display="block",this.horizontal?(t.canvas.style.top="0px",t.canvas.style.left=t.id*t.WIDTH/t.PR+"px"):(t.canvas.style.left="0px",t.canvas.style.top=t.id*t.HEIGHT/t.PR+"px"))}addPanel(t){return t.canvas&&(this.dom.appendChild(t.canvas),t.id=this._panelId,this.resizePanel(t),this._panelId++),t}showPanel(t){for(let e=0;e<this.dom.children.length;e++){const i=this.dom.children[e];i.style.display=e===t?"block":"none"}this.mode=t}processGpuQueries(){!this.gl||!this.ext||(this.totalGpuDuration=0,this.gpuQueries.forEach((t,e)=>{if(this.gl){const i=this.gl.getQueryParameter(t.query,this.gl.QUERY_RESULT_AVAILABLE),s=this.gl.getParameter(this.ext.GPU_DISJOINT_EXT);if(i&&!s){const a=this.gl.getQueryParameter(t.query,this.gl.QUERY_RESULT)*1e-6;this.totalGpuDuration+=a,this.gl.deleteQuery(t.query),this.gpuQueries.splice(e,1)}}}))}detectVSync(t){if(this.lastFrameTime===0){this.lastFrameTime=t;return}const e=t-this.lastFrameTime;if(this.lastFrameTime=t,this.frameTimeHistory.push(e),this.frameTimeHistory.length>this.HISTORY_SIZE&&this.frameTimeHistory.shift(),this.frameTimeHistory.length<60)return;const i=this.frameTimeHistory.reduce((r,o)=>r+o)/this.frameTimeHistory.length,s=this.frameTimeHistory.reduce((r,o)=>r+Math.pow(o-i,2),0)/this.frameTimeHistory.length;if(Math.sqrt(s)>2){this.detectedVSync=null;return}let a=null,n=1/0;for(const r of this.VSYNC_RATES){const o=Math.abs(i-r.frameTime);o<n&&(n=o,a=r)}a&&n/a.frameTime<=this.VSYNC_THRESHOLD?this.detectedVSync=a:this.detectedVSync=null}endInternal(){var t;const e=performance.now();for(this.frameTimes.push(e);this.frameTimes.length>0&&this.frameTimes[0]<=e-1e3;)this.frameTimes.shift();const i=Math.round(this.frameTimes.length);this.addToAverage(i,this.averageFps);const s=e>=this.prevTextTime+1e3/this.logsPerSecond,h=e>=this.prevGraphTime+1e3/this.graphsPerSecond;if(this.updatePanelComponents(this.fpsPanel,this.averageFps,0,s,h),this.updatePanelComponents(this.msPanel,this.averageCpu,this.precision,s,h),this.gpuPanel&&this.updatePanelComponents(this.gpuPanel,this.averageGpu,this.precision,s,h),this.trackCPT&&this.gpuPanelCompute&&this.updatePanelComponents(this.gpuPanelCompute,this.averageGpuCompute,this.precision,s,h),s&&(this.prevTextTime=e),h&&(this.prevGraphTime=e),this.vsyncPanel!==null){this.detectVSync(e);const a=((t=this.detectedVSync)==null?void 0:t.refreshRate)||0;s&&a>0&&this.vsyncPanel.update(a,a)}return e}updatePanelComponents(t,e,i,s,h){if(!t||e.logs.length===0)return;t.name in this.lastMin||(this.lastMin[t.name]=1/0,this.lastMax[t.name]=0,this.lastValue[t.name]=0);const a=e.logs[e.logs.length-1];this.lastMax[t.name]=Math.max(...e.logs),this.lastMin[t.name]=Math.min(this.lastMin[t.name],a),this.lastValue[t.name]=this.lastValue[t.name]*.7+a*.3;const n=Math.max(Math.max(...e.logs),...e.graph.slice(-this.samplesGraph));this.updateCounter++,s&&t.update(this.lastValue[t.name],this.lastMax[t.name],i),h&&t.updateGraph(a,n)}beginProfiling(t){if(window.performance)try{window.performance.clearMarks(t),window.performance.mark(t)}catch(e){console.debug("Stats: Performance marking failed:",e)}}endProfiling(t,e,i){if(!(!window.performance||!e||!t))try{window.performance.getEntriesByName(t,"mark").length===0&&this.beginProfiling(t),window.performance.clearMarks(e),window.performance.mark(e),window.performance.clearMeasures(i);const h=performance.measure(i,t,e);this.totalCpuDuration+=h.duration,window.performance.clearMarks(t),window.performance.clearMarks(e),window.performance.clearMeasures(i)}catch(s){console.debug("Stats: Performance measurement failed:",s)}}updatePanel(t,e,i=2){if(!t||e.logs.length===0)return;const s=performance.now();t.name in this.lastMin||(this.lastMin[t.name]=1/0,this.lastMax[t.name]=0,this.lastValue[t.name]=0);const h=e.logs[e.logs.length-1],a=Math.max(...e.logs.slice(-30));this.lastMin[t.name]=Math.min(this.lastMin[t.name],h),this.lastMax[t.name]=Math.max(this.lastMax[t.name],h),this.lastValue[t.name]=this.lastValue[t.name]*.7+h*.3;const n=Math.max(a,...e.graph.slice(-this.samplesGraph));this.updateCounter++,this.updateCounter%(this.logsPerSecond*2)===0&&(this.lastMax[t.name]=a,this.lastMin[t.name]=h),t.update&&(s>=this.prevCpuTime+1e3/this.logsPerSecond&&t.update(this.lastValue[t.name],h,this.lastMax[t.name],n,i),s>=this.prevGraphTime+1e3/this.graphsPerSecond&&(t.updateGraph(h,n),this.prevGraphTime=s))}updateAverages(){this.addToAverage(this.totalCpuDuration,this.averageCpu),this.addToAverage(this.totalGpuDuration,this.averageGpu),this.info&&this.totalGpuDurationCompute!==void 0&&this.addToAverage(this.totalGpuDurationCompute,this.averageGpuCompute)}addToAverage(t,e){e.logs.push(t),e.logs.length>this.samplesLog&&(e.logs=e.logs.slice(-this.samplesLog)),e.graph.push(t),e.graph.length>this.samplesGraph&&(e.graph=e.graph.slice(-this.samplesGraph))}get domElement(){return this.dom}patchThreeWebGPU(t){const e=t.info.reset,i=this;t.info.reset=function(){i.beginProfiling("cpu-started"),e.call(this)}}patchThreeRenderer(t){const e=t.render,i=this;t.render=function(s,h){i.begin(),e.call(this,s,h),i.end()},this.threeRendererPatched=!0}};u.Panel=c;let T=u;export{T as S};
