import{T as ge,D as we,G as ye,C as Te,L as _e,P as be,p as Ae,m as Pe,o as Le,e as Ce,b as Ee,W as Ie,A as Se,S as ve,a as Me,V as w,c as xe,d as De,O as Fe,F as y,v as f,Q as Be,u as a,I as Ne,M as le,f as Re,t as P,g as x,h as U,s as se,i as h,j as v,k as Oe,l as ce,n as b,q as ue,r as Ge,B as H,w as j,x as ne,y as E,z as X,E as k,H as N,J as Ue,K,N as Y,R as We,U as oe,X as Q,Y as ze,Z as G,_ as V,$ as ee,a0 as R,a1 as de,a2 as D,a3 as Ve,a4 as He,a5 as te,a6 as ke,a7 as M,a8 as Ze,a9 as Z,aa as Ke,ab as je,ac as qe,ad as Je,ae as Xe,af as $,ag as ie,ah as Ye}from"./three-D22t4V9-.js";import{World as $e,Ray as Qe,RigidBodyDesc as q,ColliderDesc as J,HeightFieldFlags as et,__tla as __tla_0}from"./@dimforge-Tx9Ov1ko.js";import{P as tt}from"./tweakpane-BXg6ZhiP.js";import{S as re}from"./stats-gl-C2M3amu4.js";import{l as st}from"./tseep-Cm86LyiT.js";Promise.all([(()=>{try{return __tla_0}catch{}})()]).then(async()=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=t(o);fetch(o.href,n)}})();const ot="/revo-realms/textures/noise/noise.webp",nt="/revo-realms/models/realm.glb",it="/revo-realms/textures/realm/water_grass_map.webp",rt="/revo-realms/textures/realm/sand_nor.webp",at="/revo-realms/textures/realm/leaf.webp",lt="/revo-realms/textures/realm/water_lilies.webp",ct="/revo-realms/textures/realm/water_lilies_alpha.webp",ut="/revo-realms/textures/environment/px.webp",dt="/revo-realms/textures/environment/nx.webp",ht="/revo-realms/textures/environment/py.webp",mt="/revo-realms/textures/environment/ny.webp",pt="/revo-realms/textures/environment/pz.webp",ft="/revo-realms/textures/environment/nz.webp";class gt{textureLoader;gltfLoader;cubeTextureLoader;noiseTexture;envMapTexture;floorGrassWaterMap;sandNormalTexture;leafTexture;waterLiliesTexture;waterLiliesAlphaTexture;npcsModel;realmModel;constructor(){const e=this.createLoadingManager();this.textureLoader=new ge(e);const t=new we(e);t.setDecoderPath("/revo-realms/draco/"),this.gltfLoader=new ye(e),this.gltfLoader.setDRACOLoader(t),this.cubeTextureLoader=new Te(e)}createLoadingManager(){const e=new _e;e.onStart=function(t,s,o){console.log("Started loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onLoad=function(){console.log("Loading complete!")},e.onProgress=function(t,s,o){console.log("Loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onError=function(t){console.log("There was an error loading "+t)}}async initAsync(){const e=await Promise.all([m.cubeTextureLoader.loadAsync([ut,dt,ht,mt,pt,ft]),this.textureLoader.loadAsync(ot),this.gltfLoader.loadAsync(nt),this.textureLoader.loadAsync(it),this.textureLoader.loadAsync(rt),this.textureLoader.loadAsync(at),this.textureLoader.loadAsync(lt),this.textureLoader.loadAsync(ct)]);this.envMapTexture=e[0],this.noiseTexture=e[1],this.realmModel=e[2],this.floorGrassWaterMap=e[3],this.floorGrassWaterMap.flipY=!1,this.sandNormalTexture=e[4],this.leafTexture=e[5],this.waterLiliesTexture=e[6],this.waterLiliesAlphaTexture=e[7]}}const m=new gt,wt="modulepreload",yt=function(u){return"/revo-realms/"+u},ae={},Tt=function(e,t,s){let o=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),r=i?.nonce||i?.getAttribute("nonce");o=Promise.allSettled(t.map(l=>{if(l=yt(l),l in ae)return;ae[l]=!0;const c=l.endsWith(".css"),p=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${p}`))return;const d=document.createElement("link");if(d.rel=c?"stylesheet":wt,c||(d.as="script"),d.crossOrigin="",d.href=l,r&&d.setAttribute("nonce",r),document.head.appendChild(d),c)return new Promise((_,A)=>{d.addEventListener("load",_),d.addEventListener("error",()=>A(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(i){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=i,window.dispatchEvent(r),!r.defaultPrevented)throw i}return o.then(i=>{for(const r of i||[])r.status==="rejected"&&n(r.reason);return e().catch(n)})};class _t{world;constructor(){}async init(){return Tt(()=>import("./@dimforge-Tx9Ov1ko.js").then(async m=>{await m.__tla;return m}),[]).then(()=>{this.world=new $e({x:0,y:-9.81,z:0})})}update(){this.world.step()}}const I=new _t;class bt{async initAsync(){await Promise.all([I.init(),m.initAsync()])}}class At{keysPressed;keyDownListeners;keyUpListeners;constructor(){this.keysPressed=new Set,this.keyDownListeners=new Map,this.keyUpListeners=new Map,window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this))}handleKeyDown(e){const t=e.key.toLowerCase();this.keysPressed.has(t)||(this.keysPressed.add(t),this.keyDownListeners.get(t)?.())}handleKeyUp(e){const t=e.key.toLowerCase();this.keysPressed.delete(t),this.keyUpListeners.get(t)?.()}isKeyPressed(e){return e==="*"?this.keysPressed.size>0:this.keysPressed.has(e.toLowerCase())}onKeyDown(e,t){this.keyDownListeners.set(e.toLowerCase(),t)}onKeyUp(e,t){this.keyUpListeners.set(e.toLowerCase(),t)}dispose(){window.removeEventListener("keydown",this.handleKeyDown.bind(this)),window.removeEventListener("keyup",this.handleKeyUp.bind(this))}}const B=new At;class Pt{panel;constructor(){this.panel=new tt({title:"Revo Realms"}),this.panel.hidden=!0,this.panel.element.parentElement.style.zIndex="1",this.panel.element.parentElement.style.width="340px"}setVisibility(e){this.panel.hidden=!e}}const W=new Pt;class Lt{stats;lastSecond=performance.now();drawCallsPanel;geometriesPanel;constructor(e){const t=new re({trackGPU:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,horizontal:!1,precision:2});e&&document.body.appendChild(t.dom),this.stats=t,this.drawCallsPanel=this.createNumberPanel("# DRAW CALLS","#fff","#333"),this.geometriesPanel=this.createNumberPanel("# GEOMETRIES","#ffdab9","#163843")}createNumberPanel(e,t,s){const o=this.stats.addPanel(new re.Panel(e,t,s));return o.update=n=>{const i=o.canvas.getContext("2d");if(!i)return;const{width:r,height:l}=o.canvas;i.clearRect(0,0,r,l),i.fillStyle=s,i.fillRect(0,0,r,l),i.fillStyle=t;const c=i.font;i.textAlign="left",i.textBaseline="top",i.fillText(o.name,4,4),i.font="bold 20px Arial",i.textAlign="center",i.textBaseline="middle",i.fillText(`${Math.round(n)}`,r/2,l/1.65),i.font=c},o}updateCustomPanels(){const e=performance.now();if(e-this.lastSecond<1e3)return;const{render:t,memory:s}=O.renderer.info;this.drawCallsPanel.update(t.drawCalls,0),this.geometriesPanel.update(s.geometries,0),this.lastSecond=e}}class Ct{composer;constructor(){this.composer=new be(O.renderer);const e=Ae(T.scene,T.renderCamera);e.setMRT(Pe({output:Le,emissive:Ce}));const t=e.getTextureNode("output"),s=e.getTextureNode("emissive"),o=Ee(s,.25,.1,.5),n=t.add(o);this.composer.outputNode=n,this.composer.needsUpdate=!0}}class Et{renderer;canvas;monitoringManager;postprocessingManager;POSTPROCESSING_ENABLED=!1;MONITORING_ENABLED=!1;DEBUGGING_ENABLED=!1;constructor(){const e=document.createElement("canvas");e.classList.add("revo-realms"),document.body.appendChild(e),this.canvas=e;const t=new Ie({canvas:e,antialias:!0,trackTimestamp:!1});t.shadowMap.enabled=!0,t.toneMapping=Se,t.toneMappingExposure=1.5,this.renderer=t,this.monitoringManager=new Lt(this.MONITORING_ENABLED),W.setVisibility(this.DEBUGGING_ENABLED)}async init(){this.postprocessingManager=new Ct,this.MONITORING_ENABLED&&await this.monitoringManager.stats.init(this.renderer)}async renderAsync(){this.MONITORING_ENABLED&&await this.renderer.resolveTimestampsAsync("compute"),this.POSTPROCESSING_ENABLED?await this.postprocessingManager.composer.renderAsync():await this.renderer.renderAsync(T.scene,T.renderCamera),this.MONITORING_ENABLED&&(this.monitoringManager.updateCustomPanels(),await this.renderer.resolveTimestampsAsync("render"),this.monitoringManager.stats.update())}}const O=new Et;class It{scene;camera;renderCamera;cameraHelper;controls;orbitControlsCamera;constructor(){const e=new ve;this.scene=e;const t=window.innerWidth,s=window.innerHeight,o=t/s,n=new Me(45,o,.01,100);n.position.set(0,5,10),this.camera=n,e.add(n),this.renderCamera=n}debugScene(){if(!this.controls)return;W.panel.addFolder({title:"\uD83C\uDFA5 View"}).addBinding(this.controls,"enabled",{label:"Enable orbit controls"}).on("change",({value:t})=>{!this.cameraHelper||!this.orbitControlsCamera||(this.renderCamera=t?this.orbitControlsCamera:this.camera,this.cameraHelper.visible=t)})}update(){this.controls?.enabled&&this.controls.update()}}const T=new It,z=new st.EventEmitter;class St{directionalLight;ambientLight;LIGHT_POSITION_OFFSET=new w(20,30,20);constructor(){this.directionalLight=this.setupDirectionalLighting(),T.scene.add(this.directionalLight),this.ambientLight=this.setupAmbientLighting(),T.scene.add(this.ambientLight),z.on("update",this.update.bind(this)),this.debugLight()}setupAmbientLighting(){const e=new xe("white",.4);return e.intensity=.5,e.color.setRGB(1,.95,.6),e}setupDirectionalLighting(){const e=new De;e.intensity=1,e.color.setRGB(1,.85,.73),e.position.copy(this.LIGHT_POSITION_OFFSET),e.target=new Fe,e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048;const t=50;return e.shadow.radius=2,e.shadow.camera.left=-t,e.shadow.camera.right=t,e.shadow.camera.top=t,e.shadow.camera.bottom=-t,e.shadow.camera.far=75,e.shadow.bias=-.003,e}debugLight(){const e=W.panel.addFolder({title:"\uD83D\uDCA1 Light"});e.expanded=!1,e.addBinding(this.directionalLight,"color",{label:"Directional Color",view:"color",color:{type:"float"}}),e.addBinding(this.directionalLight,"intensity",{min:0,max:1,label:"Directional intensity"}),e.addBinding(this.ambientLight,"color",{label:"Ambient Color",view:"color",color:{type:"float"}}),e.addBinding(this.ambientLight,"intensity",{min:0,max:1,label:"Ambient intensity"})}material_computeIllumination=y(()=>f(0));setTarget(e){this.directionalLight.target=e}update(e){const{player:t}=e;this.directionalLight.position.copy(t.position).add(this.LIGHT_POSITION_OFFSET)}}const vt=new St;class Mt{mesh;rigidBody;smoothedCameraPosition=new w;desiredCameraPosition=new w;smoothedCameraTarget=new w;desiredTargetPosition=new w;yawInRadians=0;prevYawInRadians=-1;yawQuaternion=new Be;JUMP_IMPULSE=5;JUMP_BUFFER_DURATION_IN_SECONDS=.2;MAX_CONSECUTIVE_JUMPS=2;JUMP_CUT_MULTIPLIER=.25;FALL_MULTIPLIER=2.75;MAX_UPWARD_VELOCITY=6;LINEAR_DAMPING=.25;ANGULAR_DAMPING=1;jumpImpulse=new w(0,this.JUMP_IMPULSE,0);LIN_VEL_STRENGTH=25;ANG_VEL_STRENGTH=25;newLinVel=new w;newAngVel=new w;torqueAxis=new w;forwardVec=new w;isOnGround=!1;jumpCount=0;wasJumpHeld=!1;jumpBufferTimer=0;RADIUS=.5;PLAYER_INITIAL_POSITION=new w(0,5,0);CAMERA_OFFSET=new w(0,12,16);CAMERA_LERP_FACTOR=7.5;UP=new w(0,1,0);DOWN=new w(0,-1,0);FORWARD=new w(0,0,-1);rayOrigin=new w;ray=new Qe(this.rayOrigin,this.DOWN);uTime=a(0);constructor(){this.mesh=this.createCharacterMesh(),T.scene.add(this.mesh),vt.setTarget(this.mesh),this.rigidBody=I.world.createRigidBody(this.createRigidBodyDesc()),I.world.createCollider(this.createColliderDesc(),this.rigidBody),z.on("update",this.update.bind(this))}createCharacterMesh(){const e=new Ne(this.RADIUS,3),t=new xt({uTime:this.uTime}),s=new le(e,t);return s.castShadow=!0,s.position.copy(this.PLAYER_INITIAL_POSITION),s}createRigidBodyDesc(){const{x:e,y:t,z:s}=this.PLAYER_INITIAL_POSITION;return q.dynamic().setTranslation(e,t,s).setLinearDamping(this.LINEAR_DAMPING).setAngularDamping(this.ANGULAR_DAMPING)}createColliderDesc(){return J.ball(this.RADIUS).setRestitution(.2).setFriction(1)}update(e){const{clock:t}=e,s=t.getDelta();this.uTime.value=t.getElapsedTime(),this.prevYawInRadians!==this.yawInRadians&&(this.yawQuaternion.setFromAxisAngle(this.UP,this.yawInRadians),this.prevYawInRadians=this.yawInRadians),this.updateVerticalMovement(s),this.updateHorizontalMovement(s),this.updateCameraPosition(s)}updateVerticalMovement(e){const t=B.isKeyPressed(" ");this.isOnGround=this.checkIfGrounded(),this.isOnGround&&(this.jumpCount=0),t&&!this.wasJumpHeld?this.jumpBufferTimer=this.JUMP_BUFFER_DURATION_IN_SECONDS:this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),this.jumpBufferTimer>0&&this.canJump()&&(this.performJump(),this.jumpBufferTimer=0);const o=this.rigidBody.linvel();this.handleJumpCut(t,o),this.handleFastFall(e,o,I.world.gravity.y),this.clampUpwardVelocity(o),this.rigidBody.setLinvel(o,!0),this.wasJumpHeld=t}checkIfGrounded(){this.rayOrigin.copy(this.rigidBody.translation()),this.rayOrigin.y-=this.RADIUS+.01;const e=.2,t=I.world.castRay(this.ray,e,!0);return t?t.timeOfImpact*e<.01:!1}canJump(){return this.isOnGround?!0:this.jumpCount<this.MAX_CONSECUTIVE_JUMPS}performJump(){this.rigidBody.applyImpulse(this.jumpImpulse,!0),this.jumpCount+=1}handleJumpCut(e,t){!(!e&&this.wasJumpHeld)||t.y<=0||(t.y*=this.JUMP_CUT_MULTIPLIER)}handleFastFall(e,t,s){if(t.y>=0)return;const o=this.FALL_MULTIPLIER*Math.abs(s)*e;t.y-=o}clampUpwardVelocity(e){e.y<=this.MAX_UPWARD_VELOCITY||(e.y=this.MAX_UPWARD_VELOCITY)}updateHorizontalMovement(e){const t=B.isKeyPressed("w")||B.isKeyPressed("arrowup"),s=B.isKeyPressed("s")||B.isKeyPressed("arrowdown"),o=B.isKeyPressed("a")||B.isKeyPressed("arrowleft"),n=B.isKeyPressed("d")||B.isKeyPressed("arrowright"),i=2;o&&(this.yawInRadians+=i*e),n&&(this.yawInRadians-=i*e),this.forwardVec.copy(this.FORWARD).applyQuaternion(this.yawQuaternion),this.torqueAxis.crossVectors(this.UP,this.forwardVec).normalize(),this.newLinVel.copy(this.rigidBody.linvel()),this.newAngVel.copy(this.rigidBody.angvel());const r=this.LIN_VEL_STRENGTH*e,l=this.ANG_VEL_STRENGTH*e;t&&(this.newLinVel.addScaledVector(this.forwardVec,r),this.newAngVel.addScaledVector(this.torqueAxis,l)),s&&(this.newLinVel.addScaledVector(this.forwardVec,-r),this.newAngVel.addScaledVector(this.torqueAxis,-l)),this.rigidBody.setLinvel(this.newLinVel,!0),this.rigidBody.setAngvel(this.newAngVel,!0),this.syncMeshWithBody()}syncMeshWithBody(){this.mesh.position.copy(this.rigidBody.translation()),this.mesh.quaternion.copy(this.rigidBody.rotation())}updateCameraPosition(e){this.desiredCameraPosition.copy(this.CAMERA_OFFSET).applyQuaternion(this.yawQuaternion).add(this.mesh.position);const t=this.CAMERA_LERP_FACTOR*e;this.smoothedCameraPosition.lerp(this.desiredCameraPosition,t),this.desiredTargetPosition.copy(this.mesh.position),this.desiredTargetPosition.y+=1,this.smoothedCameraTarget.lerp(this.desiredTargetPosition,t),T.camera.position.copy(this.smoothedCameraPosition),T.camera.lookAt(this.smoothedCameraTarget)}get position(){return this.mesh.position}get yaw(){return this.yawInRadians}}class xt extends Re{_uniforms;constructor(e){super(),this._uniforms={...e},this.createMaterial()}createMaterial(){this.flatShading=!0,this.roughness=.5;const e=P(m.noiseTexture,x(U.xz),3).r,t=se(this._uniforms.uTime.mul(2.5).add(e.mul(5))).mul(.05),s=h(-.15).add(t),o=h(1).sub(v(s,U.y)),n=h(1).sub(o),i=Oe("silver"),r=i.mul(n),l=i.mul(1.5).mul(o),c=r.add(l);this.colorNode=c;const p=h(.9).mul(n),d=h(.65).mul(o);this.metalnessNode=p.add(d)}}const Dt=()=>({BLADE_WIDTH:.15,BLADE_HEIGHT:1.25,BLADE_BOUNDING_SPHERE_RADIUS:1.25,TILE_SIZE:130,TILE_HALF_SIZE:130/2,BLADES_PER_SIDE:500,COUNT:500*500,SPACING:130/500}),g=Dt(),he={uTime:a(0),uPlayerPosition:a(new w(0,0,0)),uCameraMatrix:a(new ce),uBladeMinScale:a(.5),uBladeMaxScale:a(1.25),uTrailGrowthRate:a(.004),uTrailMinScale:a(.1),uTrailRaius:a(.65),uTrailRaiusSquared:a(.65*.65),uGlowRadius:a(2),uGlowRadiusSquared:a(4),uGlowFadeIn:a(.05),uGlowFadeOut:a(.01),uGlowColor:a(new b().setRGB(1,.6,.1)),uBladeMaxBendAngle:a(Math.PI*.15),uWindStrength:a(.35),uBaseColor:a(new b().setRGB(.1,.2,0)),uTipColor:a(new b().setRGB(.8,.9,.2)),uDelta:a(new ue(0,0))};class Ft extends j{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...he,...e},this._buffer1=ne(g.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=ne(g.COUNT,"vec4"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createGrassMaterial()}computeInit=y(()=>{const e=this._buffer1.element(E),t=X(h(E).div(g.BLADES_PER_SIDE)),s=h(E).mod(g.BLADES_PER_SIDE),o=k(E.add(4321)),n=k(E.add(1234)),i=s.mul(g.SPACING).sub(g.TILE_HALF_SIZE).add(o.mul(g.SPACING*.5)),r=t.mul(g.SPACING).sub(g.TILE_HALF_SIZE).add(n.mul(g.SPACING*.5)),l=f(i,0,r);e.x=i,e.y=r;const c=l.xz.add(g.TILE_HALF_SIZE).div(g.TILE_SIZE),p=h(2),d=x(c.mul(p)),A=P(m.noiseTexture,d,1).b.sub(.5).mul(h(Math.PI*2));e.z=A;const L=this._buffer2.element(E),F=this._uniforms.uBladeMaxScale.sub(this._uniforms.uBladeMinScale),S=k(E.add(100)).mul(F).add(this._uniforms.uBladeMinScale);L.x=S,L.y=S})().compute(g.COUNT);computeVisibility=y(([e=f(0)])=>{const t=this._uniforms.uCameraMatrix.mul(N(e,1)),s=t.xyz.div(t.w),o=g.BLADE_BOUNDING_SPHERE_RADIUS,n=h(1);return v(n.negate().sub(o),s.x).mul(v(s.x,n.add(o))).mul(v(n.negate().sub(o),s.y)).mul(v(s.y,n.add(o))).mul(v(0,s.z)).mul(v(s.z,n))});computeBending=y(([e=N(0,0,0,0),t=f(0,0,0)])=>{const s=t.xz.add(this._uniforms.uTime.mul(.25)).mul(.5),o=x(s),i=P(m.noiseTexture,o,5).r.mul(this._uniforms.uWindStrength);return e.w.add(i.sub(e.w).mul(.1))});computeAlpha=y(([e=f(0)])=>{const t=e.xz.add(C.HALF_MAP_SIZE).div(C.MAP_SIZE);return P(m.floorGrassWaterMap,t).g});computeTrailScale=y(([e=N(0),t=h(0)])=>{const s=e.x.add(this._uniforms.uTrailGrowthRate),o=h(1).sub(t),n=this._uniforms.uTrailMinScale.mul(t).add(s.mul(o));return Ue(n,e.y)});computeTrailGlow=y(([e=N(0),t=h(0),s=h(0),o=h(0)])=>{const n=K(this._uniforms.uGlowRadiusSquared,h(0),t),i=100,r=X(Y(this._uniforms.uDelta.x).mul(i)),l=X(Y(this._uniforms.uDelta.y).mul(i)),c=v(1,r.add(l)),p=n.mul(h(1).sub(s)).mul(o),d=We(c,e.w).mul(p),_=d.mul(this._uniforms.uGlowFadeIn),A=h(1).sub(d).mul(this._uniforms.uGlowFadeOut),L=h(1).sub(c).mul(this._uniforms.uGlowFadeOut).mul(e.w);return oe(e.w.add(_).sub(A).sub(L),0,1)});computeUpdate=y(()=>{const e=this._buffer1.element(E),t=this._buffer2.element(E),s=Q(e.x.sub(this._uniforms.uDelta.x).add(g.TILE_HALF_SIZE),g.TILE_SIZE).sub(g.TILE_HALF_SIZE),o=Q(e.y.sub(this._uniforms.uDelta.y).add(g.TILE_HALF_SIZE),g.TILE_SIZE).sub(g.TILE_HALF_SIZE),n=f(s,0,o);e.x=s,e.y=o;const i=n.add(this._uniforms.uPlayerPosition),r=this.computeVisibility(i);t.z=r,ze(r,()=>{const l=G(this._uniforms.uDelta.x,this._uniforms.uDelta.y),c=n.xz.sub(l),p=c.dot(c),d=v(.1,h(1).sub(this._uniforms.uPlayerPosition.y)),_=v(p,this._uniforms.uTrailRaiusSquared).mul(d);t.x=this.computeTrailScale(t,_),t.z=this.computeAlpha(i),e.w=this.computeBending(e,i),t.w=this.computeTrailGlow(t,p,_,d)})})().compute(g.COUNT);computePosition=y(([e=N(0),t=N(0)])=>{const s=f(e.x,0,e.y),o=e.z,n=e.w,i=t.x,r=n.mul(V().y),c=ee(R,f(r,0,0)).mul(f(1,i,1));return ee(c,f(0,o,0)).add(s)});computeDiffuseColor=y(([e=N(0)])=>{const t=de(V().y,1.5),s=D(this._uniforms.uBaseColor,this._uniforms.uTipColor,t),o=k(E).mul(.05).sub(.025),n=e.w;return D(s.add(o),this._uniforms.uGlowColor,n)});computeAO=y(([e=N(0)])=>{const t=Y(se(e.z)).mul(.5);return K(-.75,1.25,V().y).mul(h(1).sub(t))});createGrassMaterial(){this.precision="lowp",this.side=Ve;const e=this._buffer1.element(E),t=this._buffer2.element(E);He(t.z.equal(0)),this.positionNode=this.computePosition(e,t),this.opacityNode=t.z,this.alphaTest=.25,this.aoNode=this.computeAO(e),this.colorNode=this.computeDiffuseColor(t)}async updateAsync(){await O.renderer.computeAsync(this.computeUpdate)}}class Bt{material;grassField;uniforms={...he,uDelta:a(new ue(0,0)),uPlayerPosition:a(new w(0,0,0)),uCameraMatrix:a(new ce),uTime:a(0)};constructor(){const e=this.createBladeGeometry();e.instanceCount=g.COUNT,this.material=new Ft(this.uniforms),this.grassField=new le(e,this.material),T.scene.add(this.grassField),z.on("update",this.updateAsync.bind(this))}debugGrass(){const e=W.panel.addFolder({title:"\uD83C\uDF31 Grass"});e.expanded=!1,e.addBinding(this.uniforms.uTipColor,"value",{label:"Tip Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGlowColor,"value",{label:"Glow Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWindStrength,"value",{label:"Wind strength",min:0,max:Math.PI/2,step:.1})}createBladeGeometry(){const e=g.BLADE_WIDTH/2,t=e/2,s=g.BLADE_HEIGHT/2,o=new Float32Array([-e,0,0,e,0,0,-t,s*1,0,t,s*1,0,0,s*2,0]),n=new Float32Array([0,0,1,0,.25,s*1,.75,s*1,.5,s*2]),i=new Uint16Array([0,1,3,0,3,2,2,3,4]),l=25*Math.PI/180,c=Math.cos(l),p=Math.sin(l),_=15*Math.PI/180,A=Math.cos(_),L=Math.sin(_),F=new Float32Array([-c,p,0,c,p,0,-A,L,0,A,L,0,0,1,0]),S=new Ge;return S.setAttribute("position",new H(o,3)),S.setAttribute("uv",new H(n,2)),S.setIndex(new H(i,1)),S.setAttribute("normal",new H(F,3)),S}async updateAsync(e){const{player:t,clock:s}=e,o=t.position.x-this.grassField.position.x,n=t.position.z-this.grassField.position.z;this.uniforms.uDelta.value.set(o,n),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(T.camera.projectionMatrix).multiply(T.camera.matrixWorldInverse),this.uniforms.uTime.value=s.getElapsedTime(),this.grassField.position.copy(t.position).setY(0),await this.material.updateAsync()}}const me={uBaseColor:a(new b("#8c8c8c"))};class Nt extends j{_uniforms;constructor(e){super(),this._uniforms={...me,...e},this.createMaterial()}createMaterial(){this.flatShading=!1;const e=P(m.noiseTexture,x(V().mul(1.5))).mul(.1),t=P(m.noiseTexture,V().mul(.5)).mul(.05),s=e.add(t),o=this._uniforms.uBaseColor.add(s.b),n=oe(te(ke,f(0,1,0)),.3,1),i=o.mul(n);this.colorNode=i}}class Rt{uniforms=me;constructor(){const e=new Nt(this.uniforms),t=m.realmModel.scene.children.filter(({name:o})=>o.endsWith("_monument"));t.forEach(o=>{o.material=e}),T.scene.add(...t),m.realmModel.scene.children.filter(({name:o})=>o.startsWith("monument_collider")).forEach(o=>{const n=q.fixed().setTranslation(...o.position.toArray()).setRotation(o.quaternion),i=I.world.createRigidBody(n),r=.5*o.scale.x,l=.5*o.scale.y,c=.5*o.scale.z,p=J.cuboid(r,l,c).setRestitution(.2);I.world.createCollider(p,i)}),this.debugMonument()}debugMonument(){const e=W.panel.addFolder({title:"\uD83D\uDDFD Monuments"});e.expanded=!1,e.addBinding(this.uniforms.uBaseColor,"value",{label:"Color",view:"color",color:{type:"float"}})}}const Ot={uTime:a(0),uWaterSandColor:a(new b("#D8C098")),uPathColor1:a(new b("#D8C098")),uPathColor2:a(new b("#B89A77")),uGrassColor1:a(new b("#A3A16D")),uGrassColor2:a(new b("#8C865A"))};class Gt extends j{_uniforms;constructor(e){super(),this._uniforms={...Ot,...e},this.createMaterial()}computeCausticsDiffuse=y(([e=G(0,0),t=f(0,0,0)])=>{const s=this._uniforms.uTime.mul(.1),o=h(15),n=e.mul(o),i=x(n.add(G(s,0))),r=x(n.add(G(0,s.negate()))),l=P(m.noiseTexture,i,1).g,c=P(m.noiseTexture,r,2).g,p=l.add(c),d=de(p,3),_=f(1.2,1.2,.8).mul(.15);return D(t,_,d)});computeWaterDiffuse=y(([e=h(0),t=G(0,0)])=>{const s=h(5),o=h(.001),n=K(0,s.add(o),e),i=this._uniforms.uWaterSandColor,r=i.mul(.5),l=i.add(r.sub(i).mul(n)),c=this.computeCausticsDiffuse(t);return l.add(c)});createMaterial(){const e=U.xz.add(C.HALF_MAP_SIZE).div(C.MAP_SIZE),t=M(e),s=P(m.floorGrassWaterMap,t,2.5),o=s.g,n=s.b,r=h(1).sub(o).sub(n),l=P(m.noiseTexture,x(e),2).b,c=D(this._uniforms.uGrassColor1,this._uniforms.uGrassColor2,l).mul(o),p=D(this._uniforms.uPathColor1,this._uniforms.uPathColor2,l).mul(2.25).mul(r),d=M(U.y.negate()),A=this.computeWaterDiffuse(d,t).mul(n);this.colorNode=c.add(p).add(A);const L=x(e.mul(30)),F=x(e.mul(-30)),S=P(m.sandNormalTexture,L),pe=P(m.sandNormalTexture,F),fe=ee(pe.rgb,f(1,0,0));this.normalNode=S.mul(fe)}}class Ut{constructor(e){const t=this.createFloor();t.material=e,T.scene.add(t)}createFloor(){const e=m.realmModel.scene.getObjectByName("floor");return delete e.geometry.attributes.normal,e.receiveShadow=!0,this.createFloorPhysics(),e}getFloorDisplacementData(){const e=m.realmModel.scene.getObjectByName("heightfield"),t=e.geometry.attributes._displacement.array[0],s=e.geometry.attributes.position;e.geometry.boundingBox||e.geometry.computeBoundingBox();const o=e.geometry.boundingBox,n=s.count,i=Math.sqrt(n),r=o.max.x,l=new Float32Array(n);for(let c=0;c<n;c++){const p=s.array[c*3+0],d=s.array[c*3+1],_=s.array[c*3+2],A=Math.round((p/(r*2)+.5)*(i-1)),F=Math.round((_/(r*2)+.5)*(i-1))+A*i;l[F]=d}return{rowsCount:i,heights:l,displacement:t}}createFloorPhysics(){const e=this.getFloorDisplacementData(),{rowsCount:t,heights:s,displacement:o}=e,n=q.fixed().setTranslation(0,-o,0),i=I.world.createRigidBody(n),r=J.heightfield(t-1,t-1,s,{x:C.MAP_SIZE,y:1,z:C.MAP_SIZE},et.FIX_INTERNAL_EDGES).setFriction(1).setRestitution(.2);I.world.createCollider(r,i)}}class Wt{outerFloor;kintoun;kintounPosition=new w;constructor(e){this.outerFloor=this.createOuterFloorVisual(),this.outerFloor.material=e,this.kintoun=this.createKintoun(),T.scene.add(this.outerFloor)}createOuterFloorVisual(){return m.realmModel.scene.getObjectByName("outer_world")}createKintoun(){const e=q.kinematicPositionBased().setTranslation(0,-20,0),t=I.world.createRigidBody(e),s=2,o=J.cuboid(s,C.HALF_FLOOR_THICKNESS,s).setFriction(1).setRestitution(.2);return I.world.createCollider(o,t),t}useKintoun(e){this.kintounPosition.copy(e).setY(-C.HALF_FLOOR_THICKNESS),this.kintoun.setTranslation(this.kintounPosition,!0)}update(e){const{player:t}=e,s=C.HALF_MAP_SIZE-Math.abs(t.position.x)<C.KINTOUN_ACTIVATION_THRESHOLD,o=C.HALF_MAP_SIZE-Math.abs(t.position.z)<C.KINTOUN_ACTIVATION_THRESHOLD;(s||o)&&this.useKintoun(t.position);const n=C.MAP_SIZE,i=Math.abs(t.position.x),r=Math.sign(t.position.x),l=Math.abs(t.position.z),c=Math.sign(t.position.z),p=i>n?i-n:0,d=l>n?l-n:0;this.outerFloor.position.set(p*r,0,d*c)}}class zt{outerTerrain;uniforms={uTime:a(0),uWaterSandColor:a(new b("#D8C098")),uPathColor1:a(new b("#D8C098")),uPathColor2:a(new b("#B89A77")),uGrassColor1:a(new b("#A3A16D")),uGrassColor2:a(new b("#8C865A"))};constructor(){const e=new Gt(this.uniforms);new Ut(e),this.outerTerrain=new Wt(e),z.on("update",this.update.bind(this))}debugTerrain(){const e=W.panel.addFolder({title:"⛰️ Terrain"});e.expanded=!1,e.addBinding(this.uniforms.uGrassColor1,"value",{label:"Grass terrain Color 1",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGrassColor2,"value",{label:"Grass terrain Color 2",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uPathColor1,"value",{label:"Path terrain Color 1",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uPathColor2,"value",{label:"Path terrain Color 2",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWaterSandColor,"value",{label:"Water sand Color",view:"color",color:{type:"float"}})}update(e){const{clock:t}=e;this.uniforms.uTime.value=t.getElapsedTime(),this.outerTerrain.update(e)}}class Vt{constructor(){new Ht}}class Ht{uTime=a(0);constructor(){const e=m.realmModel.scene.getObjectByName("water_lilies");e.material=this.createMaterial(),e.castShadow=!0,T.scene.add(e),z.on("update",this.update.bind(this))}createMaterial(){const e=new j;e.transparent=!0,e.map=m.waterLiliesTexture,e.alphaTest=.5,e.alphaMap=m.waterLiliesAlphaTexture;const t=this.uTime.mul(.001),s=U.x.mul(.1),o=P(m.noiseTexture,x(U.xz.add(t).mul(s))).b.mul(.5),n=se(o);return e.positionNode=R.add(n),e}update(e){const{clock:t}=e;this.uTime.value=t.getElapsedTime()}}const kt={uTime:a(0),uWavesSpeed:a(.02),uWavesAmplitude:a(.02),uWavesFrequency:a(.64),uTroughColor:a(new b("#186691")),uSurfaceColor:a(new b("#9bd8c0")),uPeakColor:a(new b("#bbd8e0")),uPeakThreshold:a(.5),uPeakTransition:a(0),uTroughThreshold:a(-.23),uTroughTransition:a(.15),uFresnelScale:a(.8)};class Zt extends Ze{_uniforms;debugFolder;constructor(e){super(),this._uniforms={...kt,...e},this.createWaterMaterial(),this.debugFolder=W.panel.addFolder({title:"\uD83C\uDF0A Water"}),this.debugFolder.expanded=!1;const t=!1;this.debugFolder.hidden=!t}computeElevation=y(([e=G(0,0)])=>{const t=this._uniforms.uTime.mul(this._uniforms.uWavesSpeed).mul(.1),s=Q(e.mul(this._uniforms.uWavesFrequency).add(t),1),o=P(m.noiseTexture,s,.5).b,n=P(m.noiseTexture,s,1.5).b;return D(o,n,.5).mul(this._uniforms.uWavesAmplitude).mul(.001)});computePosition=y(([e=h(0)])=>{const t=e.mul(10);return f(R.x,R.y.add(t),R.z)});computeNormal=y(([e=h(0)])=>{const t=h(.001),s=this.computeElevation(G(R.x.sub(t),R.z)),o=this.computeElevation(G(R.x,R.z.sub(t))),n=Z(f(t,s.sub(e),0)),i=Z(f(0,o.sub(e),t)),r=f(1e-4);return Z(Ke(n,i)).add(r)});computeFresnel=y(([e=M(f(0,0,0)),t=f(0,0,0)])=>{const s=je(qe(h(1).sub(oe(te(t,e),0,1))));return this._uniforms.uFresnelScale.mul(s)});computeReflectionColor=y(([e=M(f(0,0,0)),t=f(0,0,0)])=>{let s=Je(t,e);return s.x=s.x.negate(),Xe(m.envMapTexture,s)});computeColor=y(([e=M(f(0,0,0)),t=M(f(0,0,0)),s=M(f(0,0,0))])=>{const o=Z(t.sub($)),n=this.computeReflectionColor(e,o),i=this.computeFresnel(e,o),r=ie(t.y.sub(this._uniforms.uTroughThreshold).div(this._uniforms.uTroughTransition.mul(2))),l=D(this._uniforms.uTroughColor,this._uniforms.uSurfaceColor,r),c=ie(t.y.sub(this._uniforms.uPeakThreshold).div(this._uniforms.uPeakTransition.mul(2))),p=D(l,this._uniforms.uPeakColor,c),d=D(p,n.rgb,i),_=te(s.xz.sub($.xz),s.xz.sub($.xz)),A=10,L=55,F=D(0,1,K(A*A,L*L,_));return N(d,F)});createWaterMaterial(){this.precision="lowp";const e=this.computeElevation(V()).mul(1e3),t=this.computePosition(e),s=this.computeNormal(e),o=M(t,"vPosition"),n=M(s,"vNormal"),i=M(U,"vWorldPosition"),r=this.computeColor(n,o,i);this.transparent=!0,this.colorNode=r,this.positionNode=t}debugWaves(){const e=this.debugFolder.addFolder({title:"Waves"});e.addBinding(this._uniforms.uWavesAmplitude,"value",{min:0,max:.1,label:"Amplitude"}),e.addBinding(this._uniforms.uWavesFrequency,"value",{min:.1,max:10,label:"Frequency"}),e.addBinding(this._uniforms.uWavesSpeed,"value",{min:0,max:1,label:"Speed"})}debugColor(){const e=this.debugFolder.addFolder({title:"Color"});e.addBinding(this._uniforms.uTroughColor,"value",{label:"Trough Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uSurfaceColor,"value",{label:"Surface Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakColor,"value",{label:"Peak Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakThreshold,"value",{min:0,max:.5,label:"Peak Threshold"}),e.addBinding(this._uniforms.uPeakTransition,"value",{min:0,max:.5,label:"Peak Transition"}),e.addBinding(this._uniforms.uTroughThreshold,"value",{min:-.5,max:0,label:"Trough Threshold"}),e.addBinding(this._uniforms.uTroughTransition,"value",{min:0,max:.5,label:"Trough Transition"})}debugFresnel(){this.debugFolder.addFolder({title:"Fresnel"}).addBinding(this._uniforms.uFresnelScale,"value",{min:0,max:1,label:"Scale"})}}class Kt{uTime=a(0);constructor(){const e=this.createWater();T.scene.add(e),z.on("update",this.update.bind(this))}createWater(){const e=m.realmModel.scene.getObjectByName("water");delete e.geometry.attributes.normal;const t=new Zt({uTime:this.uTime});return e.material=t,e}update(e){const{clock:t}=e;this.uTime.value=t.getElapsedTime()}}const jt=()=>Object.freeze({MAP_SIZE:256,HALF_MAP_SIZE:256/2,KINTOUN_ACTIVATION_THRESHOLD:2,HALF_FLOOR_THICKNESS:.3,OUTER_MAP_SIZE:256*3,OUTER_HALF_MAP_SIZE:256*1.5}),C=jt();class qt{constructor(){new zt,new Bt,new Rt,new Kt,new Vt}}class Jt{player;constructor(){this.player=new Mt,new qt}getSizes(){const e=window.innerWidth,t=window.innerHeight;return{width:e,height:t,dpr:Math.min(window.devicePixelRatio,1.5),aspect:e/t}}onResize(){const e=this.getSizes();T.camera.aspect=e.aspect,T.camera.updateProjectionMatrix(),O.renderer.setSize(e.width,e.height),O.renderer.setPixelRatio(e.dpr)}async startLoop(){await O.init();const t={clock:new Ye(!0),player:this.player},s=async()=>{I.update(),z.emit("update",t),await O.renderAsync()};new ResizeObserver(()=>{this.onResize()}).observe(document.body),O.renderer.setAnimationLoop(s)}}const Xt=new bt;Xt.initAsync().then(()=>{new Jt().startLoop()})});