import{L as Ve,T as ze,D as Ze,G as je,C as qe,S as ve,P as Ke,F as w,p as Ye,m as Je,o as Xe,e as $e,b as Qe,W as et,a as tt,A as st,c as ot,d as it,f as at,g as nt,h as rt,i as lt,V as I,M as Ae,H as ct,j as ut,O as dt,t as A,v as S,k as p,l as G,n as U,I as ee,u as D,q as c,r as Le,s as R,w as q,x as b,y as M,z as te,B as be,E as Se,J as N,N as he,K as g,Q as se,R as C,U as ne,X as re,Y as ce,Z as j,_ as mt,$ as ht,a0 as pt,a1 as ft,a2 as De,a3 as yt,a4 as gt,a5 as we,a6 as H,a7 as B,a8 as Ne,a9 as de,aa as Ce,ab as _e,ac as pe,ad as Be,ae as wt,af as le,ag as ue,ah as At,ai as _t,aj as me,ak as Re,al as Ie,am as bt,an as St,ao as xt,ap as Tt,aq as Lt,ar as It,as as Et}from"./three-BSGWjFC-.js";import{P as Pt}from"./tweakpane-BXg6ZhiP.js";import{S as Ee}from"./stats-gl-C2M3amu4.js";import{World as Mt,EventQueue as vt,RigidBodyDesc as K,ColliderDesc as Y,HeightFieldFlags as Dt,Ray as Nt,ActiveEvents as Ct,__tla as __tla_0}from"./@dimforge-Tx9Ov1ko.js";import{e as Bt}from"./tseep-DsfRTLTM.js";Promise.all([(()=>{try{return __tla_0}catch{}})()]).then(async()=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();const Rt="/revo-realms/models/realm.glb",Ot="/revo-realms/textures/environment/px.webp",Ft="/revo-realms/textures/environment/nx.webp",Ut="/revo-realms/textures/environment/py.webp",Gt="/revo-realms/textures/environment/ny.webp",kt="/revo-realms/textures/environment/pz.webp",Ht="/revo-realms/textures/environment/nz.webp",Wt="/revo-realms/textures/noise/noise.webp",Vt="/revo-realms/textures/realm/terrainType.webp",zt="/revo-realms/textures/realm/sandNormal.webp",Zt="/revo-realms/textures/realm/grassNormal.webp",jt="/revo-realms/textures/realm/grassDiffuse.webp",qt="/revo-realms/textures/realm/waterNormal.webp",Kt="/revo-realms/textures/realm/terrainShadowAo.webp",Yt="/revo-realms/textures/realm/waterLiliesDiffuse.webp",Jt="/revo-realms/textures/realm/waterLiliesAlpha.webp",Xt="/revo-realms/textures/realm/flowerAtlas.webp",$t="/revo-realms/textures/realm/stoneAtlas.webp",Qt="/revo-realms/textures/realm/barkDiffuse.webp",es="/revo-realms/textures/realm/barkNormal.webp",ts="/revo-realms/textures/realm/canopyDiffuse.webp",ss="/revo-realms/textures/realm/canopyNormal.webp",os="/revo-realms/textures/realm/axeDiffuse.webp",is="/revo-realms/textures/realm/axeEmissive.webp",as="/revo-realms/textures/realm/trunkDiffuse.webp",ns="/revo-realms/textures/realm/trunkNormal.webp",rs="/revo-realms/textures/realm/onePieceAtlas.webp",ls="/revo-realms/textures/realm/kunaiDiffuse.webp",cs={2:{scale:[.4375,.4375],offset:[.03125,.03125]},chatGPTImageApr92025010111AM:{scale:[.4375,.4375],offset:[.03125,.53125]},chatGPTImageApr92025125808AM:{scale:[.4375,.4375],offset:[.53125,.03125]},dandelionDiffusecopy:{scale:[.4375,.4375],offset:[.53125,.53125]}},us={luffyDifuse:{scale:[.484375,.484375],offset:[.0078125,.0078125]},robinDiffuse:{scale:[.484375,.484375],offset:[.0078125,.5078125]},sanjiDiffuse:{scale:[.484375,.484375],offset:[.5078125,.0078125]},zoroDiffuse:{scale:[.484375,.484375],offset:[.5078125,.5078125]}},ds={stoneDiffuse:{scale:[.4921875,.4921875],offset:[.00390625,.00390625]},stoneMossyDiffuse:{scale:[.4921875,.4921875],offset:[.00390625,.50390625]},stoneMossyNormalAo:{scale:[.4921875,.4921875],offset:[.50390625,.00390625]},stoneNormalAo:{scale:[.4921875,.4921875],offset:[.50390625,.50390625]}},ms={flowers:cs,onePiece:us,stones:ds};class hs{manager;constructor(){this.manager=this.createLoadingManager()}onErrorLog(e){console.log("There was an error loading "+e)}createLoadingManager(){const e=new Ve;return e.onError=this.onErrorLog,e}}const Oe=new hs;class ps{atlasesCoords=ms;textureLoader;gltfLoader;cubeTextureLoader;realmModel;noiseTexture;envMapTexture;terrainTypeMap;terrainShadowAo;grassDiffuse;sandNormal;grassNormal;waterNormal;waterLiliesTexture;waterLiliesAlphaTexture;flowerAtlas;stoneAtlas;canopyDiffuse;canopyNormal;barkDiffuse;barkNormal;axeDiffuse;axeEmissive;trunkDiffuse;trunkNormal;onePieceAtlas;kunaiDiffuse;constructor(e){this.textureLoader=new ze(e);const t=new Ze;t.setDecoderPath("/revo-realms/draco/"),this.gltfLoader=new je(e),this.gltfLoader.setDRACOLoader(t),this.cubeTextureLoader=new qe(e)}async initAsync(){const e=await Promise.all([this.gltfLoader.loadAsync(Rt),u.cubeTextureLoader.loadAsync([Ot,Ft,Ut,Gt,kt,Ht]),this.textureLoader.loadAsync(Wt),this.textureLoader.loadAsync(Vt),this.textureLoader.loadAsync(jt),this.textureLoader.loadAsync(Zt),this.textureLoader.loadAsync(zt),this.textureLoader.loadAsync(qt),this.textureLoader.loadAsync(Kt),this.textureLoader.loadAsync(Yt),this.textureLoader.loadAsync(Jt),this.textureLoader.loadAsync(Xt),this.textureLoader.loadAsync($t),this.textureLoader.loadAsync(ts),this.textureLoader.loadAsync(ss),this.textureLoader.loadAsync(Qt),this.textureLoader.loadAsync(es),this.textureLoader.loadAsync(os),this.textureLoader.loadAsync(is),this.textureLoader.loadAsync(as),this.textureLoader.loadAsync(ns),this.textureLoader.loadAsync(rs),this.textureLoader.loadAsync(ls)]);this.realmModel=e[0],this.envMapTexture=e[1],this.envMapTexture.generateMipmaps=!1,this.noiseTexture=e[2],this.terrainTypeMap=e[3],this.terrainTypeMap.flipY=!1,this.grassDiffuse=e[4],this.grassNormal=e[5],this.sandNormal=e[6],this.waterNormal=e[7],this.terrainShadowAo=e[8],this.terrainShadowAo.flipY=!1,this.waterLiliesTexture=e[9],this.waterLiliesTexture.flipY=!1,this.waterLiliesAlphaTexture=e[10],this.waterLiliesAlphaTexture.flipY=!1,this.flowerAtlas=e[11],this.flowerAtlas.flipY=!1,this.stoneAtlas=e[12],this.stoneAtlas.flipY=!1,this.canopyDiffuse=e[13],this.canopyDiffuse.flipY=!1,this.canopyNormal=e[14],this.canopyNormal.flipY=!1,this.barkDiffuse=e[15],this.barkDiffuse.flipY=!1,this.barkNormal=e[16],this.barkNormal.flipY=!1,this.axeDiffuse=e[17],this.axeDiffuse.flipY=!1,this.axeEmissive=e[18],this.axeEmissive.flipY=!1,this.trunkDiffuse=e[19],this.trunkDiffuse.flipY=!1,this.trunkNormal=e[20],this.trunkNormal.flipY=!1,this.onePieceAtlas=e[21],this.onePieceAtlas.flipY=!1,this.kunaiDiffuse=e[22],this.kunaiDiffuse.flipY=!1,this.kunaiDiffuse.colorSpace=ve}}const u=new ps(Oe.manager);class fs{panel;constructor(){this.panel=new Pt({title:"Revo Realms"}),this.panel.hidden=!0,this.panel.element.parentElement?.classList.add("debug-panel")}setVisibility(e){this.panel.hidden=!e}}const $=new fs;class ys{stats;lastSecond=performance.now();drawCallsPanel;trianglesPanel;constructor(e){const t=new Ee({trackGPU:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,horizontal:!1,precision:2});t.dom.classList.add("monitoring-panel"),e&&document.body.appendChild(t.dom),this.stats=t,this.drawCallsPanel=this.createNumberPanel("# DRAW CALLS","#fff","#333"),this.trianglesPanel=this.createNumberPanel("# TRIANGLES","#ffdab9","#163843")}createNumberPanel(e,t,s){const o=this.stats.addPanel(new Ee.Panel(e,t,s));return o.update=i=>{const a=o.canvas.getContext("2d");if(!a)return;const{width:n,height:r}=o.canvas;a.clearRect(0,0,n,r),a.fillStyle=s,a.fillRect(0,0,n,r),a.fillStyle=t;const d=a.font;a.textAlign="left",a.textBaseline="top",a.fillText(o.name,4,4),a.font="bold 20px Arial",a.textAlign="center",a.textBaseline="middle";const m=gs.format(i);a.fillText(`${m}`,n/2,r/1.65),a.font=d},o}updateCustomPanels(){const e=performance.now();if(e-this.lastSecond<1e3)return;const{render:t}=z.renderer.info;this.drawCallsPanel.update(t.drawCalls,0),this.trianglesPanel.update(t.triangles,0),this.lastSecond=e}}const gs=new Intl.NumberFormat("en-US",{notation:"compact"});class ws extends Ke{constructor(e){super(e),this.outputNode=this.getPasses()}getPasses=w(()=>{const e=Ye(_.scene,_.renderCamera);e.setMRT(Je({output:Xe,emissive:$e}));const t=e.getTextureNode(),s=e.getTextureNode("emissive"),o=Qe(s);return t.add(o)})}class As{renderer;canvas;monitoringManager;postprocessingManager;IS_POSTPROCESSING_ENABLED=!1;IS_MONITORING_ENABLED=!1;IS_DEBUGGING_ENABLED=!1;constructor(){const e=document.createElement("canvas");e.classList.add("revo-realms"),document.body.appendChild(e),this.canvas=e;const t=new et({canvas:e,antialias:!0,trackTimestamp:!1,powerPreference:"high-performance",stencil:!1,depth:!0});t.shadowMap.enabled=!0,t.shadowMap.type=tt,t.toneMapping=st,t.outputColorSpace=ve,t.setClearColor(0,1),t.toneMappingExposure=1.5,this.renderer=t,this.monitoringManager=new ys(this.IS_MONITORING_ENABLED),$.setVisibility(this.IS_DEBUGGING_ENABLED)}async init(){this.postprocessingManager=new ws(this.renderer),this.IS_MONITORING_ENABLED&&await this.monitoringManager.stats.init(this.renderer)}async renderSceneAsync(){return this.IS_POSTPROCESSING_ENABLED?this.postprocessingManager.renderAsync():this.renderer.renderAsync(_.scene,_.renderCamera)}async renderWithMonitoring(){await this.renderer.resolveTimestampsAsync("compute"),await this.renderSceneAsync(),this.monitoringManager.updateCustomPanels(),await this.renderer.resolveTimestampsAsync("render"),this.monitoringManager.stats.update()}async renderAsync(){this.IS_MONITORING_ENABLED?this.renderWithMonitoring():this.renderSceneAsync()}}const z=new As;class _s{scene;camera;renderCamera;cameraHelper;controls;orbitControlsCamera;constructor(){const e=new ot;this.scene=e;const t=window.innerWidth,s=window.innerHeight,o=t/s,i=new it(45,o,.01,150);i.position.set(0,5,10),this.camera=i,e.add(i),this.renderCamera=i}debugScene(){if(!this.controls)return;$.panel.addFolder({title:"\uD83C\uDFA5 View"}).addBinding(this.controls,"enabled",{label:"Enable orbit controls"}).on("change",({value:t})=>{!this.cameraHelper||!this.orbitControlsCamera||(this.renderCamera=t?this.orbitControlsCamera:this.camera,this.cameraHelper.visible=t)})}update(){this.controls?.enabled&&this.controls.update()}}const _=new _s,bs="/revo-realms/audio/ambient/ambient.mp3",Ss="/revo-realms/audio/ambient/lake.mp3",xs="/revo-realms/audio/collisions/hitWood.mp3",Ts="/revo-realms/audio/collisions/hitStone.mp3";class Ls{audioLoader;audioListener;isMute=!0;files=[];ambient;lake;hitWood;hitStone;constructor(e){this.audioLoader=new at(e),this.audioListener=new nt,_.camera.add(this.audioListener)}async toggleMute(){const e=this.audioListener.context;e.state==="suspended"&&await e.resume(),this.isMute=!this.isMute,this.files.forEach(t=>{const s=this.isMute?0:t.userData.originalVolume;t.setVolume(s),t.loop&&!t.isPlaying&&t.play()})}newAudio(e,t=1,s=!1){const o=new rt(this.audioListener);return o.setBuffer(e),o.setVolume(0),o.setLoop(s),o.userData.originalVolume=t,this.files.push(o),o}newPositionalAudio(e,t=1,s=!1,o=1){const i=new lt(this.audioListener);return i.setBuffer(e),i.setVolume(0),i.setLoop(s),i.userData.originalVolume=t,i.setMaxDistance(o),this.files.push(i),i}async initAsync(){const e=await Promise.all([this.audioLoader.loadAsync(bs),this.audioLoader.loadAsync(Ss),this.audioLoader.loadAsync(xs),this.audioLoader.loadAsync(Ts)]);this.ambient=this.newAudio(e[0],.01,!0),this.lake=this.newPositionalAudio(e[1],1,!0,10),this.hitWood=this.newAudio(e[2],0,!1),this.hitStone=this.newAudio(e[3],0,!1)}}const Z=new Ls(Oe.manager),Is="modulepreload",Es=function(l){return"/revo-realms/"+l},Pe={},Ps=function(e,t,s){let o=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),n=a?.nonce||a?.getAttribute("nonce");o=Promise.allSettled(t.map(r=>{if(r=Es(r),r in Pe)return;Pe[r]=!0;const d=r.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${r}"]${m}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":Is,d||(h.as="script"),h.crossOrigin="",h.href=r,n&&h.setAttribute("nonce",n),document.head.appendChild(h),d)return new Promise((f,y)=>{h.addEventListener("load",f),h.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${r}`)))})}))}function i(a){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=a,window.dispatchEvent(n),!n.defaultPrevented)throw a}return o.then(a=>{for(const n of a||[])n.status==="rejected"&&i(n.reason);return e().catch(i)})};var O=(l=>(l.Player="Player",l.Terrain="Terrain",l.Wood="Wood",l.Stone="Stone",l))(O||{});const Ms=()=>({minImpactSq:5,maxImpactSq:400,minImpactVolume:.01,maxImpactVolume:.08}),X=Ms();class vs{world;eventQueue;dummyVectorLinVel=new I;constructor(){}async initAsync(){return Ps(()=>import("./@dimforge-Tx9Ov1ko.js").then(async m=>{await m.__tla;return m}),[]).then(()=>{this.world=new Mt({x:0,y:-9.81,z:0}),this.eventQueue=new vt(!0)})}getColliderName(e){return e?.parent?.()?.userData?.type}impactToVolume(e){const t=Ae.mapLinear(e,X.minImpactSq,X.maxImpactSq,X.minImpactVolume,X.maxImpactVolume);return Ae.clamp(t,X.minImpactVolume,X.maxImpactVolume)}onCollisionWithWood(e){const t=e.parent()?.linvel();if(!t)return;this.dummyVectorLinVel.copy(t);const s=this.dummyVectorLinVel.lengthSq();if(s<X.minImpactSq)return;const o=this.impactToVolume(s);Z.hitWood.setVolume(o),Z.hitWood.play()}onCollisionWithStone(e){const t=e.parent()?.linvel();if(!t)return;this.dummyVectorLinVel.copy(t);const s=this.dummyVectorLinVel.lengthSq();if(s<X.minImpactSq)return;const o=this.impactToVolume(s);Z.hitStone.setVolume(o),Z.hitStone.play()}update(){this.world.step(this.eventQueue),this.eventQueue.drainCollisionEvents((e,t,s)=>{if(Z.isMute)return;const o=this.world.getCollider(e),i=this.world.getCollider(t);if(!(this.getColliderName(o)===O.Player)||!s)return;switch(this.getColliderName(i)){case O.Wood:this.onCollisionWithWood(o);break;case O.Stone:this.onCollisionWithStone(o);break}})}}const E=new vs;class Ds{async initAsync(){await Promise.all([E.initAsync(),u.initAsync(),Z.initAsync()])}}class Ns{keysPressed;keyDownListeners;keyUpListeners;constructor(){this.keysPressed=new Set,this.keyDownListeners=new Map,this.keyUpListeners=new Map,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp)}handleKeyDown(e){const t=e.code;this.keysPressed.has(t)||(this.keysPressed.add(t),this.keyDownListeners.get(t)?.())}handleKeyUp(e){const t=e.code;this.keysPressed.delete(t),this.keyUpListeners.get(t)?.()}isKeyPressed(e){return e==="*"?this.keysPressed.size>0:this.keysPressed.has(e)}onKeyDown(e,t){this.keyDownListeners.set(e,t)}onKeyUp(e,t){this.keyUpListeners.set(e,t)}dispose(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp)}isForward(){return this.isKeyPressed("KeyW")||this.isKeyPressed("ArrowUp")}isBackward(){return this.isKeyPressed("KeyS")||this.isKeyPressed("ArrowDown")}isLeftward(){return this.isKeyPressed("KeyA")||this.isKeyPressed("ArrowLeft")}isRightward(){return this.isKeyPressed("KeyD")||this.isKeyPressed("ArrowRight")}isJumpPressed(){return this.isKeyPressed("Space")}}const ae=new Ns,Cs=[2,4,8,60],F=new Bt.EventEmitter,Bs=l=>{let e=0;F.on("update",t=>{e++,!(e<l)&&(e=0,F.emit(`update-throttle-${l}x`,t))})};Cs.forEach(l=>Bs(l));const Q={LIGHT_POSITION_OFFSET:new I(10,10,10)};class Rs{directionalLight;hemisphereLight;constructor(){this.directionalLight=this.setupDirectionalLighting(),_.scene.add(this.directionalLight),this.hemisphereLight=this.setupHemisphereLight(),_.scene.add(this.hemisphereLight),F.on("update",this.update.bind(this)),this.debugLight()}setupHemisphereLight(){const e=new ct;return e.color.setRGB(.6,.4,.5),e.groundColor.setRGB(.3,.2,.2),e.intensity=.3,e.position.copy(Q.LIGHT_POSITION_OFFSET),e}setupDirectionalLighting(){const e=new ut;e.intensity=.8,e.color.setRGB(.85,.75,.7),e.position.copy(Q.LIGHT_POSITION_OFFSET),e.target=new dt,e.castShadow=!0,e.shadow.mapSize.set(64,64);const t=1;return e.shadow.intensity=.85,e.shadow.camera.left=-t,e.shadow.camera.right=t,e.shadow.camera.top=t,e.shadow.camera.bottom=-t,e.shadow.camera.near=.01,e.shadow.camera.far=30,e.shadow.normalBias=.1,e.shadow.bias=-.001,e}getTerrainShadowFactor=w(([e=S(0)])=>A(u.terrainShadowAo,e).r);debugLight(){const e=$.panel.addFolder({title:"\uD83D\uDCA1 Light"});e.expanded=!1,e.addBinding(Q.LIGHT_POSITION_OFFSET,"x",{label:"Sun position X"}),e.addBinding(Q.LIGHT_POSITION_OFFSET,"z",{label:"Sun position Z"}),e.addBinding(Q.LIGHT_POSITION_OFFSET,"y",{label:"Sun height"}),e.addBinding(this.directionalLight,"color",{label:"Directional Color",view:"color",color:{type:"float"}}),e.addBinding(this.directionalLight,"intensity",{min:0,max:5,label:"Directional intensity"}),e.addBinding(this.hemisphereLight,"color",{label:"Hemisphere sky color",view:"color",color:{type:"float"}}),e.addBinding(this.hemisphereLight,"groundColor",{label:"Hemisphere ground color",view:"color",color:{type:"float"}}),e.addBinding(this.hemisphereLight,"intensity",{min:0,max:1,label:"Hemisphere intensity"})}material_computeIllumination=w(()=>p(0));setTarget(e){this.directionalLight.target=e}update(e){const{player:t}=e;this.directionalLight.position.copy(t.position).add(Q.LIGHT_POSITION_OFFSET)}}const Fe=new Rs;class Os extends G{constructor(){super(),this.precision="lowp",this.flatShading=!1,this.map=u.trunkDiffuse,this.normalMap=u.trunkNormal}}class Fs extends G{constructor(){super(),this.precision="lowp",this.flatShading=!1,this.map=u.axeDiffuse,this.emissiveMap=u.axeEmissive,this.emissiveIntensity=2,this.emissive=new U("lightblue")}}class Us{constructor(){const e=u.realmModel.scene.getObjectByName("kratos_axe");e.material=new Fs;const t=u.realmModel.scene.getObjectByName("tree_trunk");t.material=new Os,_.scene.add(e,t);const s=u.realmModel.scene.getObjectByName("axe_collider"),o=K.fixed().setTranslation(...s.position.toArray()).setRotation(s.quaternion).setUserData({type:O.Wood}),i=E.world.createRigidBody(o),a=s.geometry.boundingBox.max,n=Y.cuboid(a.x,a.y,a.z).setRestitution(.75);E.world.createCollider(n,i);const r=u.realmModel.scene.getObjectByName("trunk_collider"),{x:d,y:m}=r.geometry.boundingBox.max,h=K.fixed().setTranslation(...r.position.toArray()).setRotation(r.quaternion).setUserData({type:O.Wood}),f=E.world.createRigidBody(h),y=d,T=m/2,v=Y.capsule(T,y).setRestitution(.75);E.world.createCollider(v,f)}}class Gs{constructor(){const e=u.realmModel.scene.getObjectByName("jojo_mask");e.material=new ks;const t=u.realmModel.scene.children.filter(i=>i.name.startsWith("jojo_symbol")),s=new Hs,o=new ee(t[0].geometry,s,t.length);for(let i=0;i<t.length;i++){const a=t[i];o.setMatrixAt(i,a.matrix)}_.scene.add(e,o)}}class ks extends G{constructor(){super(),this.precision="lowp",this.flatShading=!0;const{stoneDiffuse:e}=u.atlasesCoords.stones,t=V.computeAtlasUv(S(...e.scale),S(...e.offset),D()),s=A(u.stoneAtlas,t);this.colorNode=s}}class Hs extends G{uTime=c(0);constructor(){super(),F.on("update",({clock:e})=>{this.uTime.value=e.getElapsedTime()}),this.createMaterial()}createMaterial(){this.precision="lowp",this.flatShading=!0;const e=Le("#eb5694"),t=Le("#9642D3");this.colorNode=R(t,e,D().y.mul(.5)).mul(.45);const s=this.uTime.mul(20),o=q(s.add(b)),i=M(0,o).mul(.25);this.positionNode=te.add(i)}}class Ws extends be{uScale=c(1);constructor(){super();const e=A(u.kunaiDiffuse,D());this.colorNode=e.mul(.5)}}class Vs{constructor(){const e=u.realmModel.scene.children.filter(({name:i})=>i.startsWith("kunai_collider")),t=u.realmModel.scene.getObjectByName("base_kunai"),s=new Ws,o=new ee(t.geometry,s,e.length);e.forEach((i,a)=>{o.setMatrixAt(a,i.matrix);const n=K.fixed().setTranslation(...i.position.toArray()).setRotation(i.quaternion).setUserData({type:O.Wood}),r=E.world.createRigidBody(n);i.geometry.computeBoundingBox();const{x:d,y:m,z:h}=i.geometry.boundingBox.max,f=Y.cuboid(d,m,h).setRestitution(.75);E.world.createCollider(f,r)}),_.scene.add(o)}}class zs extends G{constructor(){super(),this.map=u.onePieceAtlas,this.side=Se}}class Zs{constructor(){const e=u.realmModel.scene.getObjectByName("one_piece_posters");e.material=new zs,_.scene.add(e)}}class js{constructor(){new Us,new Zs,new Gs,new Vs}}const Ue={uBaseColor:c(new U),uRandom:c(0)};class qs extends G{_uniforms;constructor(e){super(),this._uniforms={...Ue,...e},this.createMaterial()}setRandomSeed(e){this._uniforms.uRandom.value=e}createMaterial(){this.precision="lowp",this.flatShading=!1;const e=N(D().mul(2).add(this._uniforms.uRandom)),{stoneDiffuse:t,stoneNormalAo:s}=u.atlasesCoords.stones,o=V.computeAtlasUv(S(...t.scale),S(...t.offset),e),i=A(u.stoneAtlas,o);this.colorNode=i.mul(1.5);const a=V.computeAtlasUv(S(...s.scale),S(...s.offset),e),n=A(u.stoneAtlas,a);this.normalNode=new he(n.rgb,g(.5)),this.aoNode=n.a}}class Ks{uniforms=Ue;constructor(){const e=new qs(this.uniforms),t=u.realmModel.scene.children.filter(({name:o})=>o.endsWith("_monument"));t.forEach((o,i)=>{const a=Ae.seededRandom(i);o.material=e,o.receiveShadow=!0,o.onBeforeRender=(n,r,d,m,h)=>{h.setRandomSeed(a)}}),_.scene.add(...t),u.realmModel.scene.children.filter(({name:o})=>o.startsWith("monument_collider")).forEach(o=>{const i=K.fixed().setTranslation(...o.position.toArray()).setRotation(o.quaternion).setUserData({type:O.Stone}),a=E.world.createRigidBody(i),n=.5*o.scale.x,r=.5*o.scale.y,d=.5*o.scale.z,m=Y.cuboid(n,r,d).setRestitution(.75);E.world.createCollider(m,a)}),this.debugMonuments()}debugMonuments(){const e=$.panel.addFolder({title:"\uD83D\uDDFD Monuments"});e.expanded=!1,e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base color",view:"color",color:{type:"float"}})}}class Ys{constructor(){const e=u.realmModel.scene.getObjectByName("water");e.material=new Js,e.add(Z.lake),_.scene.add(e)}}class Js extends be{playerDir=new se(0,0);uTime=c(0);uSpeed=c(.0025);uScale1=c(.25);uScale2=c(5);uWaveFrequency=c(2);uWaveAmplitude=c(.1);uFresnelScale=c(.4);uMinDist=c(15);uMaxDist=c(55);uBaseColor=c(new U().setRGB(.06,.11,.1));uPlayerPosition=c(new I(0,0,0));uPlayerDirection=c(new se(0,0));uRippleStrength=c(.2);uMaxYDiff=c(1);uMaxDistSq=c(9);uRings=c(3);uAmplitude=c(.5);uRipplesScale=c(.3);constructor(){super(),this.createMaterial(),F.on("update",this.update.bind(this)),this.debugWater()}debugWater(){const e=$.panel.addFolder({title:"\uD83C\uDF0A Water",expanded:!1});e.addBinding(this.uSpeed,"value",{label:"Speed"}),e.addBinding(this.uScale1,"value",{label:"UV Scale 1"}),e.addBinding(this.uScale2,"value",{label:"UV Scale 2"}),e.addBinding(this.uWaveFrequency,"value",{label:"Wave frequency"}),e.addBinding(this.uWaveAmplitude,"value",{label:"Wave amplitude"}),e.addBinding(this.uFresnelScale,"value",{label:"Fresnel strength"}),e.addBinding(this.uMinDist,"value",{label:"Opacity min dist"}),e.addBinding(this.uMaxDist,"value",{label:"Opacity max dist"}),e.addBinding(this.uBaseColor,"value",{label:"Base color",view:"color",color:{type:"float"}}),e.addBinding(this.uRippleStrength,"value",{min:0,max:10,label:"Ripple strength"}),e.addBinding(this.uMaxYDiff,"value",{min:-10,max:10,label:"Y Max diff"}),e.addBinding(this.uMaxDistSq,"value",{min:0,max:50,label:"Max dist"}),e.addBinding(this.uRings,"value",{min:0,max:10,label:"# Rings"}),e.addBinding(this.uAmplitude,"value",{min:0,max:10,label:"Amplitude ripples"}),e.addBinding(this.uRipplesScale,"value",{min:0,max:3,label:"Ripples scale"})}update(e){const{clock:t,player:s}=e;this.uTime.value=t.getElapsedTime();const o=s.position.x-this.uPlayerPosition.value.x,i=s.position.z-this.uPlayerPosition.value.z;this.playerDir.set(o,i),this.uPlayerDirection.value.lerp(this.playerDir,.5).normalize(),this.uPlayerPosition.value.copy(s.position)}computeRipples=w(()=>{const e=C.xz,t=this.uPlayerPosition.xz,s=ne(this.uPlayerDirection),o=this.uPlayerPosition.y,i=e.sub(t),a=re(i,i),n=M(a,this.uMaxDistSq),r=ce(o.sub(C.y)),d=j(this.uMaxYDiff.add(.5),this.uMaxYDiff.negate().add(.5),r),m=this.uRings,h=this.uTime.sub(a.mul(.5)),f=q(h.mul(m)).mul(mt(a.negate().mul(this.uAmplitude))),y=re(ne(i),s).mul(.5).add(.5),T=j(.05,.95,y),v=f.mul(T).mul(this.uRippleStrength).mul(n).mul(d);return p(v)});tangentToObject=w(([e=p(0)])=>{const t=p(1,0,0),s=p(0,0,-1),o=p(0,1,0);return e.x.mul(t).add(e.y.mul(s)).add(e.z.mul(o))});objectToWorld=w(([e=p(0)])=>ne(ht.mul(e)));sampleTangentNormal=w(([e=S(0)])=>{const t=A(u.waterNormal,e);return p(t.r.mul(2).sub(1),t.g.mul(2).sub(1),t.b.mul(2).sub(1))});computeNormal=w(()=>{const t=this.computeRipples().xz.mul(this.uRipplesScale),s=this.uTime.mul(this.uSpeed).add(t),o=N(D().mul(this.uScale1).add(s)),i=this.sampleTangentNormal(o),a=N(D().mul(this.uScale2).sub(s)),n=this.sampleTangentNormal(a),r=N(D().mul(this.uScale2.mul(this.uScale1)).add(s)),d=this.sampleTangentNormal(r),m=R(i,n,.5),h=R(m,d,.5),f=this.tangentToObject(h);return this.objectToWorld(f)});computeFresnelFactor=w(([e=p(0),t=p(0)])=>{const s=pt(ft(g(1).sub(De(re(t,e),0,1))));return this.uFresnelScale.mul(s)});computeReflectionColor=w(([e=p(0),t=p(0)])=>{const s=yt(t,e);return gt(u.envMapTexture,s)});computeColorOpacity=w(()=>{const e=re(C.xz.sub(we.xz),C.xz.sub(we.xz)),t=this.uMinDist,s=this.uMaxDist;return R(.05,.5,j(t.mul(t),s.mul(s),e))});computeColor=w(()=>{const e=this.computeNormal(),t=ne(we.sub(C)),s=this.computeReflectionColor(e,t),o=this.computeFresnelFactor(e,t),i=R(this.uBaseColor.rgb,s.rgb,o),a=this.computeColorOpacity();return H(i.rgb,a)});computePosition=w(()=>{const e=B(te.xz).add(Ne).mul(.015),t=q(this.uTime.mul(e).mul(this.uWaveFrequency)).mul(this.uWaveAmplitude);return te.add(p(0,t,0))});createMaterial(){this.precision="lowp",this.transparent=!0,this.positionNode=this.computePosition(),this.colorNode=this.computeColor()}}const Me=20;class Xs extends G{_noiseBuffer;constructor(){super(),this._noiseBuffer=de(Me,"float"),this._noiseBuffer.setPBO(!0),z.renderer.computeAsync(this.computeInit),this.precision="lowp",this.flatShading=!1;const e=B(b),t=this._noiseBuffer.element(b),s=M(.5,t),o=g(1).sub(s),i=N(D().mul(3.6).add(e)),a=N(D().mul(1.5).add(e)),n=i.mul(s).add(a.mul(o)),{stoneDiffuse:r,stoneNormalAo:d,stoneMossyDiffuse:m,stoneMossyNormalAo:h}=u.atlasesCoords.stones,f=S(...r.scale).mul(s),y=S(...m.scale).mul(o),T=f.add(y),v=S(...r.offset).mul(s),J=S(...m.offset).mul(o),k=v.add(J),oe=V.computeAtlasUv(T,k,n);this.colorNode=A(u.stoneAtlas,oe);const ie=S(...d.scale).mul(s),fe=S(...h.scale).mul(o),xe=ie.add(fe),ye=S(...d.offset).mul(s),ge=S(...h.offset).mul(o),He=ye.add(ge),We=V.computeAtlasUv(xe,He,n),Te=A(u.stoneAtlas,We);this.normalNode=new he(Te.rgb,g(3)),this.aoNode=Te.a}computeInit=w(()=>{const e=this._noiseBuffer.element(b),t=S(B(b),B(b).mul(21.63)).fract(),s=A(u.noiseTexture,t);e.assign(s.r)})().compute(Me)}class $s{constructor(){const e=u.realmModel.scene.getObjectByName("stone"),t=u.realmModel.scene.children.filter(({name:i})=>i.startsWith("stone_collider")),s=new Xs,o=new ee(e.geometry,s,t.length);o.receiveShadow=!0,t.forEach((i,a)=>{o.setMatrixAt(a,i.matrix);const n=K.fixed().setTranslation(...i.position.toArray()).setRotation(i.quaternion).setUserData({type:O.Stone}),r=E.world.createRigidBody(n);i.geometry.computeBoundingBox();const d=i.geometry.boundingBox.max.x*i.scale.x,m=Y.ball(d).setRestitution(.75);E.world.createCollider(m,r)}),_.scene.add(o)}}const Qs={uTime:c(0),uGrassTerrainColor:c(new U),uWaterSandColor:c(new U),uPathSandColor:c(new U)};class eo extends G{_uniforms;constructor(e){super(),this._uniforms={...Qs,...e},this.createMaterial()}computeCausticsDiffuse=w(([e=S(0,0),t=g(0),s=p(0,0,0)])=>{const o=this._uniforms.uTime.mul(.1),i=g(20),a=e.mul(i),n=N(a.add(S(o,0))),r=N(a.add(S(0,o.negate()))),d=A(u.noiseTexture,n,1).g,m=A(u.noiseTexture,r,2).g,h=d.add(m),f=j(-1,10,t),y=Ce(h,3).mul(g(1).sub(f)),T=p(.6,.8,1).mul(.3);return R(s,T,y)});computeWaterDiffuse=w(([e=g(0),t=S(0,0)])=>{const s=g(8),o=g(.001),i=j(0,s.add(o),e),a=this._uniforms.uWaterSandColor,n=p(.35,.45,.55).mul(.65),r=this.computeCausticsDiffuse(t,e),d=j(0,1.5,e),m=p(1,.9,.7).mul(.1).mul(d);return R(a,n,i).add(m).add(r)});createMaterial(){this.precision="lowp",this.flatShading=!1;const e=V.computeMapUvByPosition(C.xz),t=_e(e),s=A(u.terrainShadowAo,D().clamp());this.aoNode=s.g;const o=A(u.terrainTypeMap,t,2.5),i=o.g,a=o.b,r=g(1).sub(i).sub(a),d=A(u.sandNormal,N(t.mul(30))),m=N(t.mul(30)),f=A(u.grassNormal,m).dot(d).mul(.65),y=N(t.mul(15)),T=A(u.grassDiffuse,m),v=A(u.grassDiffuse,y),J=R(T,v,.5),k=g(1).sub(J.a),oe=this._uniforms.uGrassTerrainColor.mul(k).add(J.mul(p(1,.79,.79))).mul(i).mul(.85),ie=this._uniforms.uPathSandColor.mul(1.2).mul(r),fe=_e(C.y.negate()),ye=this.computeWaterDiffuse(fe,t).mul(a),ge=oe.add(ie.mul(f)).add(ye.mul(f).mul(.5));this.colorNode=ge.mul(s.r)}}class to{constructor(e){const t=this.createFloor();t.material=e,_.scene.add(t)}createFloor(){const e=u.realmModel.scene.getObjectByName("floor");return e.receiveShadow=!0,this.createFloorPhysics(),e}getFloorDisplacementData(){const e=u.realmModel.scene.getObjectByName("heightfield"),t=e.geometry.attributes._displacement.array[0],s=e.geometry.attributes.position;e.geometry.boundingBox||e.geometry.computeBoundingBox();const o=e.geometry.boundingBox,i=s.count,a=Math.sqrt(i),n=o.max.x,r=new Float32Array(i);for(let d=0;d<i;d++){const m=s.array[d*3+0],h=s.array[d*3+1],f=s.array[d*3+2],y=Math.round((m/(n*2)+.5)*(a-1)),v=Math.round((f/(n*2)+.5)*(a-1))+y*a;r[v]=h}return{rowsCount:a,heights:r,displacement:t}}createFloorPhysics(){const e=this.getFloorDisplacementData(),{rowsCount:t,heights:s,displacement:o}=e,i=K.fixed().setTranslation(0,-o,0).setUserData({type:O.Terrain}),a=E.world.createRigidBody(i),n=Y.heightfield(t-1,t-1,s,{x:W.MAP_SIZE,y:1,z:W.MAP_SIZE},Dt.FIX_INTERNAL_EDGES).setFriction(1).setRestitution(.2);E.world.createCollider(n,a)}}class so{outerFloor;kintoun;kintounPosition=new I;constructor(e){this.outerFloor=this.createOuterFloorVisual(),this.outerFloor.material=e,this.kintoun=this.createKintoun(),_.scene.add(this.outerFloor)}createOuterFloorVisual(){const e=u.realmModel.scene.getObjectByName("outer_world");return e.receiveShadow=!0,e}createKintoun(){const e=K.kinematicPositionBased().setTranslation(0,-20,0).setUserData({type:O.Terrain}),t=E.world.createRigidBody(e),s=2,o=Y.cuboid(s,W.HALF_FLOOR_THICKNESS,s).setFriction(1).setRestitution(.2);return E.world.createCollider(o,t),t}useKintoun(e){this.kintounPosition.copy(e).setY(-W.HALF_FLOOR_THICKNESS),this.kintoun.setTranslation(this.kintounPosition,!0)}update(e){const{player:t}=e,s=W.HALF_MAP_SIZE-Math.abs(t.position.x)<W.KINTOUN_ACTIVATION_THRESHOLD,o=W.HALF_MAP_SIZE-Math.abs(t.position.z)<W.KINTOUN_ACTIVATION_THRESHOLD;(s||o)&&this.useKintoun(t.position);const i=W.MAP_SIZE,a=Math.abs(t.position.x),n=Math.sign(t.position.x),r=Math.abs(t.position.z),d=Math.sign(t.position.z),m=a>i?a-i:0,h=r>i?r-i:0;this.outerFloor.position.set(m*n,0,h*d)}}class oo{outerTerrain;uniforms={uTime:c(0),uGrassTerrainColor:c(new U().setRGB(.21,.26,.05)),uWaterSandColor:c(new U().setRGB(.54,.39,.2)),uPathSandColor:c(new U().setRGB(.65,.49,.27))};constructor(){const e=new eo(this.uniforms);new to(e),this.outerTerrain=new so(e),F.on("update",this.update.bind(this)),this.debugTerrain()}debugTerrain(){const e=$.panel.addFolder({title:"⛰️ Terrain"});e.expanded=!1,e.addBinding(this.uniforms.uPathSandColor,"value",{label:"Path color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWaterSandColor,"value",{label:"Water bed color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGrassTerrainColor,"value",{label:"Grass terrain color",view:"color",color:{type:"float"}})}update(e){const{clock:t}=e;this.uniforms.uTime.value=t.getElapsedTime(),this.outerTerrain.update(e)}}const io=()=>({BLADE_WIDTH:.1,BLADE_HEIGHT:1.5,BLADE_BOUNDING_SPHERE_RADIUS:1.5,TILE_SIZE:150,TILE_HALF_SIZE:150/2,BLADES_PER_SIDE:500,COUNT:500*500,SPACING:150/500}),L=io(),Ge={uTime:c(0),uPlayerPosition:c(new I(0,0,0)),uCameraMatrix:c(new pe),uBladeMinScale:c(.5),uBladeMaxScale:c(1.25),uTrailGrowthRate:c(.004),uTrailMinScale:c(.25),uTrailRaius:c(.65),uTrailRaiusSquared:c(.65*.65),uGlowRadius:c(2),uGlowRadiusSquared:c(4),uGlowFadeIn:c(.05),uGlowFadeOut:c(.01),uGlowColor:c(new U().setRGB(.45,.19,.07)),uBladeMaxBendAngle:c(Math.PI*.15),uWindStrength:c(.6),uBaseColor:c(new U().setRGB(.06,.06,.01)),uTipColor:c(new U().setRGB(.28,.13,.06)),uDelta:c(new se(0,0))};class ao extends be{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...Ge,...e},this._buffer1=de(L.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=de(L.COUNT,"vec4"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createGrassMaterial()}computeInit=w(()=>{const e=this._buffer1.element(b),t=ue(g(b).div(L.BLADES_PER_SIDE)),s=g(b).mod(L.BLADES_PER_SIDE),o=B(b.add(4321)),i=B(b.add(1234)),a=s.mul(L.SPACING).sub(L.TILE_HALF_SIZE).add(o.mul(L.SPACING*.5)),n=t.mul(L.SPACING).sub(L.TILE_HALF_SIZE).add(i.mul(L.SPACING*.5)),r=p(a,0,n).xz.add(L.TILE_HALF_SIZE).div(L.TILE_SIZE).abs(),d=A(u.noiseTexture,r),m=d.b.sub(.5).mul(30),h=d.g.sub(.5).mul(10);e.x=a.add(m),e.y=n.add(h);const f=d.b.sub(.5).mul(g(Math.PI*2));e.z=f;const y=this._buffer2.element(b),T=this._uniforms.uBladeMaxScale.sub(this._uniforms.uBladeMinScale),v=B(b.add(100)).mul(T).add(this._uniforms.uBladeMinScale);y.x=v,y.y=v})().compute(L.COUNT);computeVisibility=w(([e=p(0)])=>{const t=this._uniforms.uCameraMatrix.mul(H(e,1)),s=t.xyz.div(t.w),o=L.BLADE_BOUNDING_SPHERE_RADIUS,i=g(1);return M(i.negate().sub(o),s.x).mul(M(s.x,i.add(o))).mul(M(i.negate().sub(o),s.y)).mul(M(s.y,i.add(o))).mul(M(0,s.z)).mul(M(s.z,i))});computeBending=w(([e=H(0,0,0,0),t=p(0,0,0)])=>{const s=t.xz.add(this._uniforms.uTime.mul(.25)).mul(.5),o=N(s),a=A(u.noiseTexture,o,5).r.mul(this._uniforms.uWindStrength);return e.w.add(a.sub(e.w).mul(.1))});computeAlpha=w(([e=p(0)])=>{const t=V.computeMapUvByPosition(e.xz);return A(u.terrainTypeMap,t).g});computeTrailScale=w(([e=H(0),t=g(0)])=>{const s=e.x.add(this._uniforms.uTrailGrowthRate),o=g(1).sub(t),i=this._uniforms.uTrailMinScale.mul(t).add(s.mul(o));return At(i,e.y)});computeTrailGlow=w(([e=H(0),t=g(0),s=g(0),o=g(0)])=>{const i=j(this._uniforms.uGlowRadiusSquared,g(0),t),a=100,n=ue(ce(this._uniforms.uDelta.x).mul(a)),r=ue(ce(this._uniforms.uDelta.y).mul(a)),d=M(1,n.add(r)),m=i.mul(g(1).sub(s)).mul(o),h=_t(d,e.w).mul(m),f=h.mul(this._uniforms.uGlowFadeIn),y=g(1).sub(h).mul(this._uniforms.uGlowFadeOut),T=g(1).sub(d).mul(this._uniforms.uGlowFadeOut).mul(e.w);return De(e.w.add(f).sub(y).sub(T),0,1)});computeUpdate=w(()=>{const e=this._buffer1.element(b),t=this._buffer2.element(b),s=me(e.x.sub(this._uniforms.uDelta.x).add(L.TILE_HALF_SIZE),L.TILE_SIZE).sub(L.TILE_HALF_SIZE),o=me(e.y.sub(this._uniforms.uDelta.y).add(L.TILE_HALF_SIZE),L.TILE_SIZE).sub(L.TILE_HALF_SIZE),i=p(s,0,o);e.x=s,e.y=o;const a=i.add(this._uniforms.uPlayerPosition),n=this.computeVisibility(a);t.z=n,Re(n,()=>{const r=S(this._uniforms.uDelta.x,this._uniforms.uDelta.y),d=i.xz.sub(r),m=d.dot(d),h=M(.1,g(1).sub(this._uniforms.uPlayerPosition.y)),f=M(m,this._uniforms.uTrailRaiusSquared).mul(h);t.x=this.computeTrailScale(t,f),t.z=this.computeAlpha(a),e.w=this.computeBending(e,a),t.w=this.computeTrailGlow(t,m,f,h)})})().compute(L.COUNT);computePosition=w(([e=H(0),t=H(0)])=>{const s=p(e.x,0,e.y),o=e.z,i=e.w,a=t.x,n=i.mul(D().y),d=Ie(te,p(n,0,0)).mul(p(1,a,1)),m=Ie(d,p(0,o,0)),h=B(b).mul(6.28),f=q(this._uniforms.uTime.mul(5).add(e.w).add(h)).mul(.1),y=D().y.mul(t.w),T=f.mul(y);return m.add(s).add(p(T))});computeDiffuseColor=w(([e=H(0)])=>{const t=Ce(D().y,1.5),s=R(this._uniforms.uBaseColor,this._uniforms.uTipColor,t),o=B(b).mul(.05).sub(.025),i=e.w;return R(s.add(o),this._uniforms.uGlowColor.mul(.5),i)});computeAO=w(([e=H(0)])=>{const t=ce(q(e.z)).mul(.5);return j(-2.5,1.25,D().y).mul(g(1).sub(t))});createGrassMaterial(){this.precision="lowp",this.side=Se;const e=this._buffer1.element(b),t=this._buffer2.element(b);bt(t.z.equal(0)),this.positionNode=this.computePosition(e,t),this.opacityNode=t.z,this.alphaTest=.25,this.aoNode=this.computeAO(e),this.colorNode=this.computeDiffuseColor(t)}async updateAsync(){await z.renderer.computeAsync(this.computeUpdate)}}class no{material;grassField;uniforms={...Ge,uDelta:c(new se(0,0)),uPlayerPosition:c(new I(0,0,0)),uCameraMatrix:c(new pe),uTime:c(0)};constructor(){const e=this.createBladeGeometry();e.instanceCount=L.COUNT,this.material=new ao(this.uniforms),this.grassField=new Be(e,this.material),_.scene.add(this.grassField),F.on("update",this.updateAsync.bind(this)),this.debugGrass()}debugGrass(){const e=$.panel.addFolder({title:"\uD83C\uDF31 Grass"});e.expanded=!1,e.addBinding(this.uniforms.uTipColor,"value",{label:"Tip Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGlowColor,"value",{label:"Glow Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWindStrength,"value",{label:"Wind strength",min:0,max:Math.PI/2,step:.1})}createBladeGeometry(){const e=L.BLADE_WIDTH/2,t=e/2,s=L.BLADE_HEIGHT/4,o=new Float32Array([-e,0,0,e,0,0,-t,s*1,0,t,s*1,0,-t*.5,s*2,0,t*.5,s*2,0,0,s*3,0]),i=new Float32Array([0,0,1,0,.25,s*1,.75,s*1,.375,s*2,.625,s*2,.5,s*3]),a=new Uint16Array([0,1,3,0,3,2,2,3,5,2,5,4,4,5,6]),n=25*Math.PI/180,r=15*Math.PI/180,d=8*Math.PI/180,m=Math.cos(n),h=Math.sin(n),f=Math.cos(r),y=Math.sin(r),T=Math.cos(d),v=Math.sin(d),J=new Float32Array([-m,h,0,m,h,0,-f,y,0,f,y,0,-T,v,0,T,v,0,0,1,0]),k=new wt;return k.setAttribute("position",new le(o,3)),k.setAttribute("uv",new le(i,2)),k.setIndex(new le(a,1)),k.setAttribute("normal",new le(J,3)),k}async updateAsync(e){const{player:t,clock:s}=e,o=t.position.x-this.grassField.position.x,i=t.position.z-this.grassField.position.z;this.uniforms.uDelta.value.set(o,i),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(_.camera.projectionMatrix).multiply(_.camera.matrixWorldInverse),this.uniforms.uTime.value=s.getElapsedTime(),this.grassField.position.copy(t.position).setY(0),await this.material.updateAsync()}}const ro=()=>({FLOWER_WIDTH:.5,FLOWER_HEIGHT:1,BLADE_BOUNDING_SPHERE_RADIUS:1,TILE_SIZE:150,TILE_HALF_SIZE:150/2,FLOWERS_PER_SIDE:25,COUNT:25*25,SPACING:150/25}),P=ro();class lo{flowerField;material;uniforms={...ke,uDelta:c(new se(0,0)),uPlayerPosition:c(new I(0,0,0)),uCameraMatrix:c(new pe),uTime:c(0)};constructor(){this.material=new co(this.uniforms),this.flowerField=new ee(new St(1,1),this.material,P.COUNT),_.scene.add(this.flowerField),F.on("update",this.updateAsync.bind(this))}async updateAsync(e){const{player:t,clock:s}=e,o=t.position.x-this.flowerField.position.x,i=t.position.z-this.flowerField.position.z;this.uniforms.uDelta.value.set(o,i),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(_.camera.projectionMatrix).multiply(_.camera.matrixWorldInverse),this.uniforms.uTime.value=s.getElapsedTime(),this.flowerField.position.copy(t.position).setY(0),await this.material.updateAsync()}}const ke={uTime:c(0),uPlayerPosition:c(new I(0,0,0)),uCameraMatrix:c(new pe),uDelta:c(new se(0,0))};class co extends xt{_uniforms;_buffer1;constructor(e){super(),this._uniforms={...ke,...e},this._buffer1=de(P.COUNT,"vec4"),this._buffer1.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createMaterial()}computeInit=w(()=>{const e=this._buffer1.element(b),t=ue(g(b).div(P.FLOWERS_PER_SIDE)),s=g(b).mod(P.FLOWERS_PER_SIDE),o=B(b.add(4321)),i=B(b.add(1234)),a=s.mul(P.SPACING).sub(P.TILE_HALF_SIZE).add(o.mul(P.SPACING*.5)),n=t.mul(P.SPACING).sub(P.TILE_HALF_SIZE).add(i.mul(P.SPACING*.5)),r=p(a,0,n).xz.add(P.TILE_HALF_SIZE).div(P.TILE_SIZE).abs(),m=A(u.noiseTexture,r).r,h=m.sub(.5).mul(100),f=m.clamp(.5,.75),y=m.sub(.5).mul(50);e.x=a.add(h),e.y=f,e.z=n.add(y)})().compute(P.COUNT);computeVisibility=w(([e=p(0)])=>{const t=this._uniforms.uCameraMatrix.mul(H(e,1)),s=t.xyz.div(t.w),o=P.BLADE_BOUNDING_SPHERE_RADIUS,i=g(1);return M(i.negate().sub(o),s.x).mul(M(s.x,i.add(o))).mul(M(i.negate().sub(o),s.y)).mul(M(s.y,i.add(o))).mul(M(0,s.z)).mul(M(s.z,i))});computeAlpha=w(([e=p(0)])=>{const t=V.computeMapUvByPosition(e.xz);return A(u.terrainTypeMap,t).g});computeUpdate=w(()=>{const e=this._buffer1.element(b),t=me(e.x.sub(this._uniforms.uDelta.x).add(P.TILE_HALF_SIZE),P.TILE_SIZE).sub(P.TILE_HALF_SIZE),s=me(e.z.sub(this._uniforms.uDelta.y).add(P.TILE_HALF_SIZE),P.TILE_SIZE).sub(P.TILE_HALF_SIZE);e.x=t,e.z=s;const i=p(e.x,0,e.z).add(this._uniforms.uPlayerPosition),a=this.computeVisibility(i);e.w=a,Re(a,()=>{e.w=this.computeAlpha(i)})})().compute(P.COUNT);createMaterial(){this.precision="lowp";const e=this._buffer1.element(b),t=B(b.add(9234)),s=B(b.add(33.87)),o=this._uniforms.uTime.mul(2),i=q(o.add(t.mul(100))).mul(.05);this.positionNode=e.xyz.add(p(i,0,i)),this.opacityNode=e.w,this.alphaTest=.15,this.scaleNode=t.mul(.2).add(.3);const a=M(.5,t).mul(.5),n=M(.5,s).mul(.5),d=D().mul(.5).add(S(a,n)),m=A(u.flowerAtlas,d);this.colorNode=H(m.rgb.mul(.35),m.a)}async updateAsync(){z.renderer.computeAsync(this.computeUpdate)}}class uo{uTime=c(0);constructor(){const e=u.realmModel.scene.getObjectByName("water_lilies");e.material=this.createMaterial(),_.scene.add(e),F.on("update",this.update.bind(this))}createMaterial(){const e=new G;e.precision="lowp",e.transparent=!0,e.map=u.waterLiliesTexture,e.alphaTest=.5,e.alphaMap=u.waterLiliesAlphaTexture;const t=this.uTime.mul(5e-4),s=C.x.mul(.1),o=A(u.noiseTexture,N(C.xz.add(t).mul(s))).b.mul(.5),i=q(o);return e.positionNode=te.add(i),e}update(e){const{clock:t}=e;this.uTime.value=t.getElapsedTime()}}class mo extends G{constructor(){super(),this.precision="lowp",this.flatShading=!1;const e=N(D().mul(7)),t=A(u.barkDiffuse,e);this.colorNode=t;const s=A(u.barkNormal,e);this.normalNode=new he(s)}}class ho extends G{uTime=c(0);constructor(){super(),this.precision="lowp",this.flatShading=!1,this.transparent=!0,this.side=Se;const e=V.computeMapUvByPosition(C.xz),t=A(u.noiseTexture,e),s=A(u.canopyDiffuse,D()),o=R(p(.889,.095,0),p(1,.162,.009),.5);this.colorNode=R(s.mul(1.25),o,t.b.mul(.4));const i=A(u.canopyNormal,D());this.normalNode=new he(i,g(1.25)),this.alphaTest=.9;const a=this.uTime.mul(t.r).add(Ne).mul(7.5),n=q(a).mul(.015),r=Tt(a.mul(.75)).mul(.01);this.positionNode=te.add(p(0,r,n)),F.on("update",this.update.bind(this))}update(e){const{clock:t}=e;this.uTime.value=t.elapsedTime}}class po{constructor(){const e=u.realmModel.scene.getObjectByName("tree"),t=u.realmModel.scene.children.filter(({name:y})=>y.startsWith("tree_collider")),s=new mo,o=new ho,[i,a]=e.children,n=new ee(i.geometry,s,t.length);n.receiveShadow=!0;const r=new ee(a.geometry,o,t.length),m=u.realmModel.scene.getObjectByName("base_tree_collider").geometry.boundingBox,h=m.max.x,f=m.max.y/2;t.forEach((y,T)=>{n.setMatrixAt(T,y.matrix),r.setMatrixAt(T,y.matrix);const v=K.fixed().setTranslation(...y.position.toArray()).setRotation(y.quaternion).setUserData({type:O.Wood}),J=E.world.createRigidBody(v),k=h*y.scale.x,oe=f*y.scale.y,ie=Y.capsule(oe,k).setRestitution(.75);E.world.createCollider(ie,J)}),_.scene.add(n,r)}}class fo{constructor(){new no,new uo,new lo,new po}}const yo=()=>Object.freeze({MAP_SIZE:256,HALF_MAP_SIZE:256/2,KINTOUN_ACTIVATION_THRESHOLD:2,HALF_FLOOR_THICKNESS:.3,OUTER_MAP_SIZE:256*3,OUTER_HALF_MAP_SIZE:256*1.5}),W=yo();class go{constructor(){new oo,new Ks,new Ys,new fo,new $s,new js}}class wo{computeMapUvByPosition=w(([e=S(0)])=>e.add(W.HALF_MAP_SIZE).div(W.MAP_SIZE));computeAtlasUv=w(([e=S(0),t=S(0),s=S(0)])=>s.mul(e).add(t))}const V=new wo,Ao=()=>({JUMP_BUFFER_DURATION_IN_SECONDS:.2,MAX_CONSECUTIVE_JUMPS:2,JUMP_CUT_MULTIPLIER:.25,FALL_MULTIPLIER:2.75,MAX_UPWARD_VELOCITY:6,LINEAR_DAMPING:.35,ANGULAR_DAMPING:.6,JUMP_IMPULSE:new I(0,75,0),LIN_VEL_STRENGTH:35,ANG_VEL_STRENGTH:25,RADIUS:.5,PLAYER_INITIAL_POSITION:new I(0,5,0),CAMERA_OFFSET:new I(0,11,17),CAMERA_LERP_FACTOR:7.5,UP:new I(0,1,0),DOWN:new I(0,-1,0),FORWARD:new I(0,0,-1)}),x=Ao();class _o{mesh;rigidBody;smoothedCameraPosition=new I;desiredCameraPosition=new I;smoothedCameraTarget=new I;desiredTargetPosition=new I;yawInRadians=0;prevYawInRadians=-1;yawQuaternion=new Lt;newLinVel=new I;newAngVel=new I;torqueAxis=new I;forwardVec=new I;isOnGround=!1;jumpCount=0;wasJumpHeld=!1;jumpBufferTimer=0;rayOrigin=new I;ray=new Nt(this.rayOrigin,x.DOWN);uTime=c(0);uOffsetShadow=c(0);constructor(){this.mesh=this.createCharacterMesh(),_.scene.add(this.mesh),Fe.setTarget(this.mesh),this.rigidBody=E.world.createRigidBody(this.createRigidBodyDesc()),E.world.createCollider(this.createColliderDesc(),this.rigidBody),F.on("update",this.update.bind(this)),F.on("update-throttle-60x",this.resetPlayerPosition.bind(this)),this.debugPlayer()}resetPlayerPosition(e){const{player:t}=e;t.position.y>-10||(this.rigidBody.setLinvel({x:0,y:0,z:0},!1),this.rigidBody.setAngvel({x:0,y:0,z:0},!1),this.rigidBody.setTranslation(x.PLAYER_INITIAL_POSITION,!0),this.mesh.position.copy(x.PLAYER_INITIAL_POSITION))}debugPlayer(){const e=$.panel.addFolder({title:"\uD83E\uDEA9 Player",expanded:!1});e.addBinding(x.CAMERA_OFFSET,"y",{label:"Main camera height"}),e.addBinding(x.CAMERA_OFFSET,"z",{label:"Main camera distance"})}createCharacterMesh(){const e=new It(x.RADIUS,2),t=new bo({uTime:this.uTime,uOffsetShadow:this.uOffsetShadow}),s=new Be(e,t);return s.castShadow=!0,s.position.copy(x.PLAYER_INITIAL_POSITION),s}createRigidBodyDesc(){const{x:e,y:t,z:s}=x.PLAYER_INITIAL_POSITION;return K.dynamic().setTranslation(e,t,s).setLinearDamping(x.LINEAR_DAMPING).setAngularDamping(x.ANGULAR_DAMPING).setUserData({type:O.Player})}createColliderDesc(){return Y.ball(x.RADIUS).setRestitution(.25).setFriction(1).setMass(3).setActiveEvents(Ct.COLLISION_EVENTS)}update(e){const{clock:t}=e,s=t.getDelta();this.uTime.value=t.getElapsedTime(),this.prevYawInRadians!==this.yawInRadians&&(this.yawQuaternion.setFromAxisAngle(x.UP,this.yawInRadians),this.prevYawInRadians=this.yawInRadians),this.updateVerticalMovement(s),this.updateHorizontalMovement(s),this.updateCameraPosition(s)}updateVerticalMovement(e){const t=ae.isJumpPressed();this.isOnGround=this.checkIfGrounded(),this.isOnGround&&(this.jumpCount=0),t&&!this.wasJumpHeld?this.jumpBufferTimer=x.JUMP_BUFFER_DURATION_IN_SECONDS:this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),this.jumpBufferTimer>0&&this.canJump()&&(this.performJump(),this.jumpBufferTimer=0);const o=this.rigidBody.linvel();this.handleJumpCut(t,o),this.handleFastFall(e,o,E.world.gravity.y),this.clampUpwardVelocity(o),this.rigidBody.setLinvel(o,!0),this.wasJumpHeld=t}checkIfGrounded(){this.rayOrigin.copy(this.rigidBody.translation()),this.rayOrigin.y-=x.RADIUS+.01;const e=.2,t=E.world.castRay(this.ray,e,!0);return t?t.timeOfImpact*e<.01:!1}canJump(){return this.isOnGround?!0:this.jumpCount<x.MAX_CONSECUTIVE_JUMPS}performJump(){this.rigidBody.applyImpulse(x.JUMP_IMPULSE,!0),this.jumpCount+=1}handleJumpCut(e,t){!(!e&&this.wasJumpHeld)||t.y<=0||(t.y*=x.JUMP_CUT_MULTIPLIER)}handleFastFall(e,t,s){if(t.y>=0)return;const o=x.FALL_MULTIPLIER*Math.abs(s)*e;t.y-=o}clampUpwardVelocity(e){e.y<=x.MAX_UPWARD_VELOCITY||(e.y=x.MAX_UPWARD_VELOCITY)}updateHorizontalMovement(e){const t=ae.isForward(),s=ae.isBackward(),o=ae.isLeftward(),i=ae.isRightward(),a=2;o&&(this.yawInRadians+=a*e),i&&(this.yawInRadians-=a*e),this.forwardVec.copy(x.FORWARD).applyQuaternion(this.yawQuaternion),this.torqueAxis.crossVectors(x.UP,this.forwardVec).normalize(),this.newLinVel.copy(this.rigidBody.linvel()),this.newAngVel.copy(this.rigidBody.angvel());const n=x.LIN_VEL_STRENGTH*e,r=x.ANG_VEL_STRENGTH*e;t&&(this.newLinVel.addScaledVector(this.forwardVec,n),this.newAngVel.addScaledVector(this.torqueAxis,r)),s&&(this.newLinVel.addScaledVector(this.forwardVec,-n),this.newAngVel.addScaledVector(this.torqueAxis,-r)),this.rigidBody.setLinvel(this.newLinVel,!0),this.rigidBody.setAngvel(this.newAngVel,!0),this.syncMeshWithBody()}syncMeshWithBody(){this.mesh.position.copy(this.rigidBody.translation()),this.mesh.quaternion.copy(this.rigidBody.rotation())}updateCameraPosition(e){this.desiredCameraPosition.copy(x.CAMERA_OFFSET).applyQuaternion(this.yawQuaternion).add(this.mesh.position);const t=x.CAMERA_LERP_FACTOR*e;this.smoothedCameraPosition.lerp(this.desiredCameraPosition,t),this.desiredTargetPosition.copy(this.mesh.position),this.desiredTargetPosition.y+=1,this.smoothedCameraTarget.lerp(this.desiredTargetPosition,t),_.camera.position.copy(this.smoothedCameraPosition),_.camera.lookAt(this.smoothedCameraTarget)}get position(){return this.mesh.position}get yaw(){return this.yawInRadians}}class bo extends G{_uniforms;constructor(e){super(),this._uniforms={...e},this.createMaterial()}createMaterial(){this.flatShading=!0,this.castShadowNode=p(.6);const e=V.computeMapUvByPosition(C.xz),t=_e(e),s=Fe.getTerrainShadowFactor(t),o=A(u.noiseTexture,N(C.xz),3).r,i=q(this._uniforms.uTime.mul(2.5).add(o.mul(5))).mul(.05),a=g(-.15).add(i),n=g(1).sub(M(a,C.y)),r=g(1).sub(n),d=p(1),m=g(1).sub(j(-1.5,1,C.y).mul(n)),h=R(p(1),p(.6,.8,1).mul(.75),m),f=d.mul(h).mul(n),T=d.mul(r).add(f);this.colorNode=T.mul(s)}}class So{player;constructor(){this.player=new _o,new go}getSizes(){const e=window.innerWidth,t=window.innerHeight;return{width:e,height:t,dpr:Math.min(window.devicePixelRatio,1.5),aspect:e/t}}onResize(){const e=this.getSizes();_.camera.aspect=e.aspect,_.camera.updateProjectionMatrix(),z.renderer.setSize(e.width,e.height),z.renderer.setPixelRatio(e.dpr)}async startLoop(){await z.init();const t={clock:new Et(!0),player:this.player},s=async()=>{E.update(),F.emit("update",t),z.renderAsync()};new ResizeObserver(()=>{this.onResize()}).observe(document.body),z.renderer.setAnimationLoop(s)}}class xo{constructor(){}init(){this.initAudioButton(),this.initCreditsButton()}initAudioButton(){const e=document.getElementById("audio"),t=e?.querySelector("path");if(!e||!t)return;const s="M1129.432 113v1694.148H903.545l-451.772-451.773V564.773L903.545 113h225.887Zm542.545 248.057C1832.017 521.097 1920 733.882 1920 960.107c0 226.226-87.983 438.898-248.023 598.938l-79.851-79.85c138.694-138.582 214.93-323.018 214.93-519.087 0-196.183-76.236-380.506-214.93-519.2ZM338.83 564.773v790.602H169.415C75.672 1355.375 0 1279.703 0 1185.96V734.187c0-93.742 75.672-169.414 169.415-169.414H338.83Zm1093.922 36.085c95.776 97.018 148.407 224.644 148.407 359.16 0 134.628-52.631 262.253-148.407 359.272l-80.303-79.174c74.656-75.897 115.767-175.4 115.767-280.099 0-104.585-41.111-204.088-115.767-279.986Z",o="M1129.433 113v1694.15H903.547l-451.774-451.773V564.773L903.547 113h225.886ZM338.83 564.773v790.604H169.415c-92.806 0-167.9-74.166-169.392-166.609L0 1185.962V734.188c0-92.805 74.166-167.9 166.608-169.392l2.807-.023H338.83ZM1789.951 635 1920 764.926 1724.988 959.94 1920 1154.95 1789.951 1285l-194.89-195.012L1400.05 1285 1270 1154.951l195.012-195.012L1270 764.926 1400.049 635l195.012 195.012L1789.951 635Z";e.addEventListener("click",async i=>{i.stopPropagation(),await Z.toggleMute();const a=Z.isMute?o:s;t.setAttribute("d",a)})}initCreditsButton(){const e=document.getElementById("credits"),t=document.getElementById("credits-dialog");if(!e||!t)return;t.addEventListener("click",r=>{switch(r.stopPropagation(),r.target?.id){case"credits-dialog":case"close-dialog-btn":t.close();break}}),e.addEventListener("click",r=>{r.stopPropagation(),t.showModal()});const i="aleksandar.d.gjoreski@gmail.com",a=document.createElement("a");a.setAttribute("href",`mailto:${i}`),a.innerText=i,document.getElementById("email-placeholder")?.appendChild(a)}}const To=new xo,Lo=new Ds;Lo.initAsync().then(()=>{To.init(),new So().startLoop()})});