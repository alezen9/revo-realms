import{L as et,T as tt,D as st,G as ot,C as at,S as pe,P as it,F as A,p as nt,m as rt,o as lt,e as ct,b as dt,W as ut,a as mt,A as ht,c as pt,d as ft,f as yt,g as wt,h as gt,i as At,V as T,M as Me,H as bt,j as xt,O as _t,t as b,v as _,k as Ae,I as oe,l as Ge,n as ke,q as le,r as g,s as N,u as U,w as k,x as p,y as De,z as q,B as He,E as D,J as W,K as H,N as Ne,Q as G,R as v,U as ie,X as h,Y as Ee,Z as C,_ as be,$ as ne,a0 as B,a1 as ce,a2 as de,a3 as fe,a4 as $,a5 as St,a6 as f,a7 as Lt,a8 as It,a9 as Mt,aa as We,ab as Tt,ac as Et,ad as Ie,ae as Ve,af as ze,ag as Te,ah as xe,ai as Ze,aj as Pt,ak as ue,al as ye,am as vt,an as Dt,ao as ge,ap as je,aq as Ce,ar as Nt,as as Ct,at as Bt,au as Rt}from"./three-Dtoyj4kI.js";import{P as Ot}from"./tweakpane-BXg6ZhiP.js";import{S as Be}from"./stats-gl-C2M3amu4.js";import{e as Ft}from"./tseep-DsfRTLTM.js";import{World as Ut,EventQueue as Gt,RigidBodyDesc as K,ColliderDesc as Y,HeightFieldFlags as kt,Ray as Ht,ActiveEvents as Wt,__tla as __tla_0}from"./@dimforge-Tx9Ov1ko.js";import{n as Vt}from"./nipplejs-BxsX8Mt3.js";Promise.all([(()=>{try{return __tla_0}catch{}})()]).then(async()=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();const zt="/revo-realms/models/realm.glb",Zt="/revo-realms/textures/environment/px.webp",jt="/revo-realms/textures/environment/nx.webp",qt="/revo-realms/textures/environment/py.webp",Kt="/revo-realms/textures/environment/ny.webp",Yt="/revo-realms/textures/environment/pz.webp",Xt="/revo-realms/textures/environment/nz.webp",Jt="/revo-realms/textures/noise/noise.webp",$t="/revo-realms/textures/realm/terrainType.webp",Qt="/revo-realms/textures/realm/sandNormal.webp",es="/revo-realms/textures/realm/grassNormal.webp",ts="/revo-realms/textures/realm/grassDiffuse.webp",ss="/revo-realms/textures/realm/waterNormal.webp",os="/revo-realms/textures/realm/terrainShadowAo.webp",as="/revo-realms/textures/realm/waterLiliesDiffuse.webp",is="/revo-realms/textures/realm/waterLiliesAlpha.webp",ns="/revo-realms/textures/realm/flowerAtlas.webp",rs="/revo-realms/textures/realm/stoneAtlas.webp",ls="/revo-realms/textures/realm/barkDiffuse.webp",cs="/revo-realms/textures/realm/barkNormal.webp",ds="/revo-realms/textures/realm/canopyDiffuse.webp",us="/revo-realms/textures/realm/canopyNormal.webp",ms="/revo-realms/textures/realm/axeDiffuse.webp",hs="/revo-realms/textures/realm/axeEmissive.webp",ps="/revo-realms/textures/realm/trunkDiffuse.webp",fs="/revo-realms/textures/realm/trunkNormal.webp",ys="/revo-realms/textures/realm/onePieceAtlas.webp",ws="/revo-realms/textures/realm/kunaiDiffuse.webp",gs="/revo-realms/textures/realm/campfireDiffuse.webp",As="/revo-realms/textures/realm/fireDiffuse.webp",bs={stoneDiffuse:{scale:[.4921875,.4921875],offset:[.00390625,.00390625]},stoneMossyDiffuse:{scale:[.4921875,.4921875],offset:[.00390625,.50390625]},stoneMossyNormalAo:{scale:[.4921875,.4921875],offset:[.50390625,.00390625]},stoneNormalAo:{scale:[.4921875,.4921875],offset:[.50390625,.50390625]}},xs={stones:bs};class _s{manager;constructor(){this.manager=this.createLoadingManager()}onErrorLog(e){console.log("There was an error loading "+e)}createLoadingManager(){const e=new et;return e.onError=this.onErrorLog,e}}const qe=new _s;class Ss{atlasesCoords=xs;textureLoader;gltfLoader;cubeTextureLoader;realmModel;noiseTexture;envMapTexture;terrainTypeMap;terrainShadowAo;grassDiffuse;sandNormal;grassNormal;waterNormal;waterLiliesTexture;waterLiliesAlphaTexture;flowerAtlas;stoneAtlas;canopyDiffuse;canopyNormal;barkDiffuse;barkNormal;axeDiffuse;axeEmissive;trunkDiffuse;trunkNormal;onePieceAtlas;kunaiDiffuse;campfireDiffuse;fireDiffuse;constructor(e){this.textureLoader=new tt(e);const t=new st;t.setDecoderPath("/revo-realms/draco/"),this.gltfLoader=new ot(e),this.gltfLoader.setDRACOLoader(t),this.cubeTextureLoader=new at(e)}async initAsync(){const e=await Promise.all([this.gltfLoader.loadAsync(zt),c.cubeTextureLoader.loadAsync([Zt,jt,qt,Kt,Yt,Xt]),this.textureLoader.loadAsync(Jt),this.textureLoader.loadAsync($t),this.textureLoader.loadAsync(ts),this.textureLoader.loadAsync(es),this.textureLoader.loadAsync(Qt),this.textureLoader.loadAsync(ss),this.textureLoader.loadAsync(os),this.textureLoader.loadAsync(as),this.textureLoader.loadAsync(is),this.textureLoader.loadAsync(ns),this.textureLoader.loadAsync(rs),this.textureLoader.loadAsync(ds),this.textureLoader.loadAsync(us),this.textureLoader.loadAsync(ls),this.textureLoader.loadAsync(cs),this.textureLoader.loadAsync(ms),this.textureLoader.loadAsync(hs),this.textureLoader.loadAsync(ps),this.textureLoader.loadAsync(fs),this.textureLoader.loadAsync(ys),this.textureLoader.loadAsync(ws),this.textureLoader.loadAsync(gs),this.textureLoader.loadAsync(As)]);this.realmModel=e[0],this.envMapTexture=e[1],this.envMapTexture.generateMipmaps=!1,this.noiseTexture=e[2],this.terrainTypeMap=e[3],this.terrainTypeMap.flipY=!1,this.grassDiffuse=e[4],this.grassNormal=e[5],this.sandNormal=e[6],this.waterNormal=e[7],this.terrainShadowAo=e[8],this.terrainShadowAo.flipY=!1,this.waterLiliesTexture=e[9],this.waterLiliesTexture.flipY=!1,this.waterLiliesAlphaTexture=e[10],this.waterLiliesAlphaTexture.flipY=!1,this.flowerAtlas=e[11],this.flowerAtlas.flipY=!1,this.stoneAtlas=e[12],this.stoneAtlas.flipY=!1,this.canopyDiffuse=e[13],this.canopyDiffuse.flipY=!1,this.canopyNormal=e[14],this.canopyNormal.flipY=!1,this.barkDiffuse=e[15],this.barkDiffuse.flipY=!1,this.barkNormal=e[16],this.barkNormal.flipY=!1,this.axeDiffuse=e[17],this.axeDiffuse.flipY=!1,this.axeEmissive=e[18],this.axeEmissive.flipY=!1,this.trunkDiffuse=e[19],this.trunkDiffuse.flipY=!1,this.trunkNormal=e[20],this.trunkNormal.flipY=!1,this.onePieceAtlas=e[21],this.onePieceAtlas.flipY=!1,this.kunaiDiffuse=e[22],this.kunaiDiffuse.flipY=!1,this.kunaiDiffuse.colorSpace=pe,this.campfireDiffuse=e[23],this.campfireDiffuse.flipY=!1,this.campfireDiffuse.colorSpace=pe,this.fireDiffuse=e[24],this.fireDiffuse.colorSpace=pe}}const c=new Ss(qe.manager);class Ls{panel;constructor(){this.panel=new Ot({title:"Revo Realms"}),this.panel.hidden=!0,this.panel.element.parentElement?.classList.add("debug-panel")}setVisibility(e){this.panel.hidden=!e}}const ee=new Ls;class Is{stats;lastSecond=performance.now();drawCallsPanel;trianglesPanel;constructor(e){const t=new Be({trackGPU:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,horizontal:!1,precision:2});t.dom.classList.add("monitoring-panel"),e&&document.body.appendChild(t.dom),this.stats=t,this.drawCallsPanel=this.createNumberPanel("# DRAW CALLS","#fff","#333"),this.trianglesPanel=this.createNumberPanel("# TRIANGLES","#ffdab9","#163843")}createNumberPanel(e,t,s){const o=this.stats.addPanel(new Be.Panel(e,t,s));return o.update=a=>{const i=o.canvas.getContext("2d");if(!i)return;const{width:n,height:l}=o.canvas;i.clearRect(0,0,n,l),i.fillStyle=s,i.fillRect(0,0,n,l),i.fillStyle=t;const d=i.font;i.textAlign="left",i.textBaseline="top",i.fillText(o.name,4,4),i.font="bold 20px Arial",i.textAlign="center",i.textBaseline="middle";const u=Ms.format(a);i.fillText(`${u}`,n/2,l/1.65),i.font=d},o}updateCustomPanels(){const e=performance.now();if(e-this.lastSecond<1e3)return;const{render:t}=j.renderer.info;this.drawCallsPanel.update(t.drawCalls,0),this.trianglesPanel.update(t.triangles,0),this.lastSecond=e}}const Ms=new Intl.NumberFormat("en-US",{notation:"compact"});class Ts extends it{constructor(e){super(e),this.outputNode=this.getPasses()}getPasses=A(()=>{const e=nt(x.scene,x.renderCamera);e.setMRT(rt({output:lt,emissive:ct}));const t=e.getTextureNode(),s=e.getTextureNode("emissive"),o=dt(s);return t.add(o)})}class Es{renderer;canvas;monitoringManager;postprocessingManager;IS_POSTPROCESSING_ENABLED=!1;IS_MONITORING_ENABLED=!1;IS_DEBUGGING_ENABLED=!1;constructor(){const e=document.createElement("canvas");e.classList.add("revo-realms"),document.body.appendChild(e),this.canvas=e;const t=new ut({canvas:e,antialias:!0,trackTimestamp:!1,powerPreference:"high-performance",stencil:!1,depth:!0});t.shadowMap.enabled=!0,t.shadowMap.type=mt,t.toneMapping=ht,t.outputColorSpace=pe,t.setClearColor(0,1),t.toneMappingExposure=1.5,this.renderer=t,this.monitoringManager=new Is(this.IS_MONITORING_ENABLED),ee.setVisibility(this.IS_DEBUGGING_ENABLED)}async init(){this.postprocessingManager=new Ts(this.renderer),this.IS_MONITORING_ENABLED&&await this.monitoringManager.stats.init(this.renderer)}async renderSceneAsync(){return this.IS_POSTPROCESSING_ENABLED?this.postprocessingManager.renderAsync():this.renderer.renderAsync(x.scene,x.renderCamera)}async renderWithMonitoring(){await this.renderer.resolveTimestampsAsync("compute"),await this.renderSceneAsync(),this.monitoringManager.updateCustomPanels(),await this.renderer.resolveTimestampsAsync("render"),this.monitoringManager.stats.update()}async renderAsync(){this.IS_MONITORING_ENABLED?this.renderWithMonitoring():this.renderSceneAsync()}}const j=new Es;class Ps{scene;camera;renderCamera;cameraHelper;controls;orbitControlsCamera;constructor(){const e=new pt;this.scene=e;const t=window.innerWidth,s=window.innerHeight,o=t/s,a=new ft(45,o,.01,150);a.position.set(0,5,10),this.camera=a,e.add(a),this.renderCamera=a}debugScene(){if(!this.controls)return;ee.panel.addFolder({title:"\uD83C\uDFA5 View"}).addBinding(this.controls,"enabled",{label:"Enable orbit controls"}).on("change",({value:t})=>{!this.cameraHelper||!this.orbitControlsCamera||(this.renderCamera=t?this.orbitControlsCamera:this.camera,this.cameraHelper.visible=t)})}update(){this.controls?.enabled&&this.controls.update()}}const x=new Ps,vs="/revo-realms/audio/ambient/ambient.mp3",Ds="/revo-realms/audio/ambient/lake.mp3",Ns="/revo-realms/audio/collisions/hitWood.mp3",Cs="/revo-realms/audio/collisions/hitStone.mp3",Bs=[2,4,8,60],O=new Ft.EventEmitter,Rs=r=>{let e=0;O.on("update",t=>{e++,!(e<r)&&(e=0,O.emit(`update-throttle-${r}x`,t))})};Bs.forEach(r=>Rs(r));class Os{audioLoader;audioListener;isReady=!1;isMute=!0;files=[];ambient;lake;hitWood;hitStone;constructor(e){this.audioLoader=new yt(e),this.audioListener=new wt,x.camera.add(this.audioListener)}async toggleMute(){if(!this.isReady)return;const e=this.audioListener.context;e.state==="suspended"&&await e.resume(),this.isMute=!this.isMute,this.files.forEach(t=>{const s=this.isMute?0:t.userData.originalVolume;t.setVolume(s),t.loop&&!t.isPlaying&&t.play()})}newAudio(e,t=1,s=!1){const o=new gt(this.audioListener);return o.setBuffer(e),o.setVolume(0),o.setLoop(s),o.userData.originalVolume=t,this.files.push(o),o}newPositionalAudio(e,t=1,s=!1,o=1){const a=new At(this.audioListener);return a.setBuffer(e),a.setVolume(0),a.setLoop(s),a.userData.originalVolume=t,a.setMaxDistance(o),this.files.push(a),a}async initAsync(){const e=await Promise.all([this.audioLoader.loadAsync(vs),this.audioLoader.loadAsync(Ds),this.audioLoader.loadAsync(Ns),this.audioLoader.loadAsync(Cs)]);this.ambient=this.newAudio(e[0],.01,!0),this.lake=this.newPositionalAudio(e[1],1,!0,10),this.hitWood=this.newAudio(e[2],0,!1),this.hitStone=this.newAudio(e[3],0,!1),this.isReady=!0,O.emit("audio-ready")}}const Z=new Os(qe.manager),Fs="modulepreload",Us=function(r){return"/revo-realms/"+r},Re={},Gs=function(e,t,s){let o=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),n=i?.nonce||i?.getAttribute("nonce");o=Promise.allSettled(t.map(l=>{if(l=Us(l),l in Re)return;Re[l]=!0;const d=l.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const m=document.createElement("link");if(m.rel=d?"stylesheet":Fs,d||(m.as="script"),m.crossOrigin="",m.href=l,n&&m.setAttribute("nonce",n),document.head.appendChild(m),d)return new Promise((y,w)=>{m.addEventListener("load",y),m.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(i){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=i,window.dispatchEvent(n),!n.defaultPrevented)throw i}return o.then(i=>{for(const n of i||[])n.status==="rejected"&&a(n.reason);return e().catch(a)})};var R=(r=>(r.Player="Player",r.Terrain="Terrain",r.Wood="Wood",r.Stone="Stone",r))(R||{});const ks=()=>({minImpactSq:5,maxImpactSq:400,minImpactVolume:.01,maxImpactVolume:.08}),Q=ks();class Hs{world;eventQueue;dummyVectorLinVel=new T;constructor(){}async initAsync(){return Gs(()=>import("./@dimforge-Tx9Ov1ko.js").then(async m=>{await m.__tla;return m}),[]).then(()=>{this.world=new Ut({x:0,y:-9.81,z:0}),this.eventQueue=new Gt(!0)})}getColliderName(e){return e?.parent?.()?.userData?.type}impactToVolume(e){const t=Me.mapLinear(e,Q.minImpactSq,Q.maxImpactSq,Q.minImpactVolume,Q.maxImpactVolume);return Me.clamp(t,Q.minImpactVolume,Q.maxImpactVolume)}onCollisionWithWood(e){const t=e.parent()?.linvel();if(!t)return;this.dummyVectorLinVel.copy(t);const s=this.dummyVectorLinVel.lengthSq();if(s<Q.minImpactSq)return;const o=this.impactToVolume(s);Z.hitWood.setVolume(o),Z.hitWood.play()}onCollisionWithStone(e){const t=e.parent()?.linvel();if(!t)return;this.dummyVectorLinVel.copy(t);const s=this.dummyVectorLinVel.lengthSq();if(s<Q.minImpactSq)return;const o=this.impactToVolume(s);Z.hitStone.setVolume(o),Z.hitStone.play()}handleCollisionSounds(){this.eventQueue.drainCollisionEvents((e,t,s)=>{if(Z.isMute)return;const o=this.world.getCollider(e),a=this.world.getCollider(t);if(!(this.getColliderName(o)===R.Player)||!s)return;switch(this.getColliderName(a)){case R.Wood:this.onCollisionWithWood(o);break;case R.Stone:this.onCollisionWithStone(o);break}})}update(){this.world.step(this.eventQueue),Z.isReady&&this.handleCollisionSounds()}}const M=new Hs;class Ws{constructor(){("ontouchstart"in window||navigator.maxTouchPoints>0)&&document.body.classList.add("is-touch-device")}async initAsync(){Z.initAsync(),await Promise.all([M.initAsync(),c.initAsync()])}}class Vs{keysPressed;keyDownListeners;keyUpListeners;constructor(){this.keysPressed=new Set,this.keyDownListeners=new Map,this.keyUpListeners=new Map,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp)}handleKeyDown(e){const t=e.code;this.keysPressed.has(t)||(this.keysPressed.add(t),this.keyDownListeners.get(t)?.())}handleKeyUp(e){const t=e.code;this.keysPressed.delete(t),this.keyUpListeners.get(t)?.()}isKeyPressed(e){return e==="*"?this.keysPressed.size>0:this.keysPressed.has(e)}onKeyDown(e,t){this.keyDownListeners.set(e,t)}onKeyUp(e,t){this.keyUpListeners.set(e,t)}dispose(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp)}}const J=new Vs;class zs{isActive=!1;direction={x:0,y:0};constructor(){const e=document.createElement("div");e.classList.add("joystick-zone"),document.body.appendChild(e);const t=Vt.create({zone:e,mode:"static",position:{left:"50%",top:"50%"},restOpacity:.1,size:100,threshold:.2});t.on("start",()=>{this.isActive=!0}),t.on("move",(s,o)=>{o?.vector&&(this.direction={x:o.vector.x,y:o.vector.y})}),t.on("end",()=>{this.isActive=!1,this.direction={x:0,y:0}})}threshold=.2;isForward(){return this.isActive&&this.direction.y>-this.threshold}isBackward(){return this.isActive&&this.direction.y<this.threshold}isLeftward(){return this.isActive&&this.direction.x<-this.threshold}isRightward(){return this.isActive&&this.direction.x>this.threshold}}const me=new zs;class Zs{isForward(){return J.isKeyPressed("KeyW")||J.isKeyPressed("ArrowUp")||me.isForward()}isBackward(){return J.isKeyPressed("KeyS")||J.isKeyPressed("ArrowDown")||me.isBackward()}isLeftward(){return J.isKeyPressed("KeyA")||J.isKeyPressed("ArrowLeft")||me.isLeftward()}isRightward(){return J.isKeyPressed("KeyD")||J.isKeyPressed("ArrowRight")||me.isRightward()}isJumpPressed(){return J.isKeyPressed("Space")}}const re=new Zs,ae={LIGHT_POSITION_OFFSET:new T(10,10,10)};class js{directionalLight;hemisphereLight;constructor(){this.directionalLight=this.setupDirectionalLighting(),x.scene.add(this.directionalLight),this.hemisphereLight=this.setupHemisphereLight(),x.scene.add(this.hemisphereLight),O.on("update",({player:e})=>{this.directionalLight.position.copy(e.position).add(ae.LIGHT_POSITION_OFFSET)}),this.debugLight()}setupHemisphereLight(){const e=new bt;return e.color.setRGB(.6,.4,.5),e.groundColor.setRGB(.3,.2,.2),e.intensity=.3,e.position.copy(ae.LIGHT_POSITION_OFFSET),e}setupDirectionalLighting(){const e=new xt;e.intensity=.8,e.color.setRGB(.85,.75,.7),e.position.copy(ae.LIGHT_POSITION_OFFSET),e.target=new _t,e.castShadow=!0,e.shadow.mapSize.set(64,64);const t=1;return e.shadow.intensity=.85,e.shadow.camera.left=-t,e.shadow.camera.right=t,e.shadow.camera.top=t,e.shadow.camera.bottom=-t,e.shadow.camera.near=.01,e.shadow.camera.far=30,e.shadow.normalBias=.1,e.shadow.bias=-.001,e}getTerrainShadowFactor=A(([e=_(0)])=>b(c.terrainShadowAo,e).r);debugLight(){const e=ee.panel.addFolder({title:"\uD83D\uDCA1 Light"});e.expanded=!1,e.addBinding(ae.LIGHT_POSITION_OFFSET,"x",{label:"Sun position X"}),e.addBinding(ae.LIGHT_POSITION_OFFSET,"z",{label:"Sun position Z"}),e.addBinding(ae.LIGHT_POSITION_OFFSET,"y",{label:"Sun height"}),e.addBinding(this.directionalLight,"color",{label:"Directional Color",view:"color",color:{type:"float"}}),e.addBinding(this.directionalLight,"intensity",{min:0,max:5,label:"Directional intensity"}),e.addBinding(this.hemisphereLight,"color",{label:"Hemisphere sky color",view:"color",color:{type:"float"}}),e.addBinding(this.hemisphereLight,"groundColor",{label:"Hemisphere ground color",view:"color",color:{type:"float"}}),e.addBinding(this.hemisphereLight,"intensity",{min:0,max:1,label:"Hemisphere intensity"})}setTarget(e){this.directionalLight.target=e}}const Ke=new js;class qs{constructor(){const e=c.realmModel.scene.getObjectByName("campfire");e.material=new Ks,x.scene.add(e),new Ys(e.position);const t=K.fixed().setTranslation(...e.position.toArray()).setRotation(e.quaternion).setUserData({type:R.Wood}),s=M.world.createRigidBody(t);e.geometry.computeBoundingSphere();const{radius:o}=e.geometry.boundingSphere,a=Y.ball(o).setRestitution(.75);M.world.createCollider(a,s)}}class Ks extends Ae{constructor(){super(),this.map=c.campfireDiffuse}}const we=256,he=1.25,Oe=2,Fe=2;class Ys{constructor(e){const t=new Xs,s=new oe(new Ge,t,we);s.position.copy(e),x.scene.add(s)}}class Xs extends ke{_buffer1;constructor(){super(),this._buffer1=le(we,"vec4"),this._buffer1.setPBO(!0),this.createMaterial(),this.computeUpdate.onInit(({renderer:e})=>{e.computeAsync(this.computeInit)}),O.on("update",()=>{j.renderer.computeAsync(this.computeUpdate)})}computeInit=A(()=>{const e=this._buffer1.element(g),t=N(g.add(12345)).mul(.2).sub(.1);e.assign(U(t,0,t,1))})().compute(we);computeUpdate=A(()=>{const e=this._buffer1.element(g),t=N(g),s=k.mul(.5).mod(he),o=t.mul(he),i=s.add(o).mod(he).div(he),l=p(1).sub(p(1).sub(i).pow(2)).mul(Oe),d=N(g.add(101)),u=N(g.add(202)),m=p(2),y=d.mul(m).add(m),w=u.mul(m).add(m),S=i.mul(y).add(d.mul(De)),E=i.mul(w).add(u.mul(De)),z=q(S).mul(d.mul(.15).add(.15)).mul(Fe),F=He(E).mul(u.mul(.15).add(.15)).mul(Fe),te=l.div(Oe),se=p(.3).sub(te.pow(3)).clamp();e.assign(U(z,l,F,se))})().compute(we);createMaterial(){this.precision="lowp",this.depthWrite=!1;const e=this._buffer1.element(g),t=N(g.add(9234));this.positionNode=e.xyz,this.scaleNode=t.mul(e.w).mul(7.5),this.opacityNode=e.w;const s=b(c.fireDiffuse,D());this.colorNode=s.mul(.75)}}class Js extends W{constructor(){super(),this.precision="lowp",this.flatShading=!1,this.map=c.trunkDiffuse,this.normalMap=c.trunkNormal}}class $s extends W{constructor(){super(),this.precision="lowp",this.flatShading=!1,this.map=c.axeDiffuse,this.emissiveMap=c.axeEmissive,this.emissiveIntensity=2,this.emissive=new H("lightblue")}}class Qs{constructor(){const e=c.realmModel.scene.getObjectByName("kratos_axe");e.material=new $s;const t=c.realmModel.scene.getObjectByName("tree_trunk");t.material=new Js,x.scene.add(e,t);const s=c.realmModel.scene.getObjectByName("axe_collider"),o=K.fixed().setTranslation(...s.position.toArray()).setRotation(s.quaternion).setUserData({type:R.Wood}),a=M.world.createRigidBody(o),i=s.geometry.boundingBox.max,n=Y.cuboid(i.x,i.y,i.z).setRestitution(.75);M.world.createCollider(n,a);const l=c.realmModel.scene.getObjectByName("trunk_collider"),{x:d,y:u}=l.geometry.boundingBox.max,m=K.fixed().setTranslation(...l.position.toArray()).setRotation(l.quaternion).setUserData({type:R.Wood}),y=M.world.createRigidBody(m),w=d,S=u/2,E=Y.capsule(S,w).setRestitution(.75);M.world.createCollider(E,y)}}class eo{constructor(){const e=c.realmModel.scene.getObjectByName("jojo_mask");e.material=new to;const t=c.realmModel.scene.children.filter(a=>a.name.startsWith("jojo_symbol")),s=new so,o=new oe(t[0].geometry,s,t.length);for(let a=0;a<t.length;a++){const i=t[a];o.setMatrixAt(a,i.matrix)}x.scene.add(e,o)}}class to extends W{constructor(){super(),this.precision="lowp",this.flatShading=!0;const{stoneDiffuse:e}=c.atlasesCoords.stones,t=X.computeAtlasUv(_(...e.scale),_(...e.offset),D()),s=b(c.stoneAtlas,t);this.colorNode=s}}class so extends W{constructor(){super(),this.precision="lowp",this.flatShading=!0;const e=Ne("#eb5694"),t=Ne("#9642D3");this.colorNode=G(t,e,D().y.mul(.5)).mul(.45);const s=k.mul(20),o=q(s.add(g)),a=v(0,o).mul(.25);this.positionNode=ie.add(a)}}class oo extends Ae{uScale=h(1);constructor(){super();const e=b(c.kunaiDiffuse,D());this.colorNode=e.mul(.5)}}class ao{constructor(){const e=c.realmModel.scene.children.filter(({name:a})=>a.startsWith("kunai_collider")),t=c.realmModel.scene.getObjectByName("base_kunai"),s=new oo,o=new oe(t.geometry,s,e.length);e.forEach((a,i)=>{o.setMatrixAt(i,a.matrix);const n=K.fixed().setTranslation(...a.position.toArray()).setRotation(a.quaternion).setUserData({type:R.Wood}),l=M.world.createRigidBody(n);a.geometry.computeBoundingBox();const{x:d,y:u,z:m}=a.geometry.boundingBox.max,y=Y.cuboid(d,u,m).setRestitution(.75);M.world.createCollider(y,l)}),x.scene.add(o)}}class io extends W{constructor(){super(),this.map=c.onePieceAtlas,this.side=Ee}}class no{constructor(){const e=c.realmModel.scene.getObjectByName("one_piece_posters");e.material=new io,x.scene.add(e)}}class ro{constructor(){new Qs,new no,new eo,new ao,new qs}}const Ye={uBaseColor:h(new H),uRandom:h(0)};class lo extends W{_uniforms;constructor(e){super(),this._uniforms={...Ye,...e},this.createMaterial()}setRandomSeed(e){this._uniforms.uRandom.value=e}createMaterial(){this.precision="lowp",this.flatShading=!1;const e=C(D().mul(2).add(this._uniforms.uRandom)),{stoneDiffuse:t,stoneNormalAo:s}=c.atlasesCoords.stones,o=X.computeAtlasUv(_(...t.scale),_(...t.offset),e),a=b(c.stoneAtlas,o);this.colorNode=a.mul(1.5);const i=X.computeAtlasUv(_(...s.scale),_(...s.offset),e),n=b(c.stoneAtlas,i);this.normalNode=new be(n.rgb,p(.5)),this.aoNode=n.a}}class co{uniforms=Ye;constructor(){const e=new lo(this.uniforms),t=c.realmModel.scene.children.filter(({name:o})=>o.endsWith("_monument"));t.forEach((o,a)=>{const i=Me.seededRandom(a);o.material=e,o.receiveShadow=!0,o.onBeforeRender=(n,l,d,u,m)=>{m.setRandomSeed(i)}}),x.scene.add(...t),c.realmModel.scene.children.filter(({name:o})=>o.startsWith("monument_collider")).forEach(o=>{const a=K.fixed().setTranslation(...o.position.toArray()).setRotation(o.quaternion).setUserData({type:R.Stone}),i=M.world.createRigidBody(a),n=.5*o.scale.x,l=.5*o.scale.y,d=.5*o.scale.z,u=Y.cuboid(n,l,d).setRestitution(.75);M.world.createCollider(u,i)}),this.debugMonuments()}debugMonuments(){const e=ee.panel.addFolder({title:"\uD83D\uDDFD Monuments"});e.expanded=!1,e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base color",view:"color",color:{type:"float"}})}}class uo{constructor(){const e=c.realmModel.scene.getObjectByName("water");e.material=new mo,x.scene.add(e),O.on("audio-ready",()=>{e.add(Z.lake)})}}class mo extends Ae{playerDir=new ne(0,0);uSpeed=h(.0025);uScale1=h(.25);uScale2=h(5);uWaveFrequency=h(2);uWaveAmplitude=h(.1);uFresnelScale=h(.4);uMinDist=h(15);uMaxDist=h(55);uBaseColor=h(new H().setRGB(.06,.11,.1));uPlayerPosition=h(new T(0,0,0));uPlayerDirection=h(new ne(0,0));uRippleStrength=h(.2);uMaxYDiff=h(1);uMaxDistSq=h(9);uRings=h(3);uAmplitude=h(.5);uRipplesScale=h(.3);constructor(){super(),this.createMaterial(),O.on("update",this.update.bind(this)),this.debugWater()}debugWater(){const e=ee.panel.addFolder({title:"\uD83C\uDF0A Water",expanded:!1});e.addBinding(this.uSpeed,"value",{label:"Speed"}),e.addBinding(this.uScale1,"value",{label:"UV Scale 1"}),e.addBinding(this.uScale2,"value",{label:"UV Scale 2"}),e.addBinding(this.uWaveFrequency,"value",{label:"Wave frequency"}),e.addBinding(this.uWaveAmplitude,"value",{label:"Wave amplitude"}),e.addBinding(this.uFresnelScale,"value",{label:"Fresnel strength"}),e.addBinding(this.uMinDist,"value",{label:"Opacity min dist"}),e.addBinding(this.uMaxDist,"value",{label:"Opacity max dist"}),e.addBinding(this.uBaseColor,"value",{label:"Base color",view:"color",color:{type:"float"}}),e.addBinding(this.uRippleStrength,"value",{min:0,max:10,label:"Ripple strength"}),e.addBinding(this.uMaxYDiff,"value",{min:-10,max:10,label:"Y Max diff"}),e.addBinding(this.uMaxDistSq,"value",{min:0,max:50,label:"Max dist"}),e.addBinding(this.uRings,"value",{min:0,max:10,label:"# Rings"}),e.addBinding(this.uAmplitude,"value",{min:0,max:10,label:"Amplitude ripples"}),e.addBinding(this.uRipplesScale,"value",{min:0,max:3,label:"Ripples scale"})}update(e){const{player:t}=e,s=t.position.x-this.uPlayerPosition.value.x,o=t.position.z-this.uPlayerPosition.value.z;this.playerDir.set(s,o),this.uPlayerDirection.value.lerp(this.playerDir,.5).normalize(),this.uPlayerPosition.value.copy(t.position)}computeRipples=A(()=>{const e=B.xz,t=this.uPlayerPosition.xz,s=ce(this.uPlayerDirection),o=this.uPlayerPosition.y,a=e.sub(t),i=de(a,a),n=v(i,this.uMaxDistSq),l=fe(o.sub(B.y)),d=$(this.uMaxYDiff.add(.5),this.uMaxYDiff.negate().add(.5),l),u=this.uRings,m=k.sub(i.mul(.5)),y=q(m.mul(u)).mul(St(i.negate().mul(this.uAmplitude))),w=de(ce(a),s).mul(.5).add(.5),S=$(.05,.95,w),E=y.mul(S).mul(this.uRippleStrength).mul(n).mul(d);return f(E)});tangentToObject=A(([e=f(0)])=>{const t=f(1,0,0),s=f(0,0,-1),o=f(0,1,0);return e.x.mul(t).add(e.y.mul(s)).add(e.z.mul(o))});objectToWorld=A(([e=f(0)])=>ce(Lt.mul(e)));sampleTangentNormal=A(([e=_(0)])=>{const t=b(c.waterNormal,e);return f(t.r.mul(2).sub(1),t.g.mul(2).sub(1),t.b.mul(2).sub(1))});computeNormal=A(()=>{const t=this.computeRipples().xz.mul(this.uRipplesScale),s=k.mul(this.uSpeed).add(t),o=C(D().mul(this.uScale1).add(s)),a=this.sampleTangentNormal(o),i=C(D().mul(this.uScale2).sub(s)),n=this.sampleTangentNormal(i),l=C(D().mul(this.uScale2.mul(this.uScale1)).add(s)),d=this.sampleTangentNormal(l),u=G(a,n,.5),m=G(u,d,.5),y=this.tangentToObject(m);return this.objectToWorld(y)});computeFresnelFactor=A(([e=f(0),t=f(0)])=>{const s=It(Mt(p(1).sub(We(de(t,e),0,1))));return this.uFresnelScale.mul(s)});computeReflectionColor=A(([e=f(0),t=f(0)])=>{const s=Tt(t,e);return Et(c.envMapTexture,s)});computeColorOpacity=A(()=>{const e=de(B.xz.sub(Ie.xz),B.xz.sub(Ie.xz)),t=this.uMinDist,s=this.uMaxDist;return G(.05,.5,$(t.mul(t),s.mul(s),e))});computeColor=A(()=>{const e=this.computeNormal(),t=ce(Ie.sub(B)),s=this.computeReflectionColor(e,t),o=this.computeFresnelFactor(e,t),a=G(this.uBaseColor.rgb,s.rgb,o),i=this.computeColorOpacity();return U(a.rgb,i)});computePosition=A(()=>{const e=N(ie.xz).add(Ve).mul(.015),t=q(k.mul(e).mul(this.uWaveFrequency)).mul(this.uWaveAmplitude);return ie.add(f(0,t,0))});createMaterial(){this.precision="lowp",this.transparent=!0,this.positionNode=this.computePosition(),this.colorNode=this.computeColor()}}const Ue=20;class ho extends W{_noiseBuffer;constructor(){super(),this._noiseBuffer=le(Ue,"float"),this._noiseBuffer.setPBO(!0),j.renderer.computeAsync(this.computeInit),this.precision="lowp",this.flatShading=!1;const e=N(g),t=this._noiseBuffer.element(g),s=v(.5,t),o=p(1).sub(s),a=C(D().mul(3.6).add(e)),i=C(D().mul(1.5).add(e)),n=a.mul(s).add(i.mul(o)),{stoneDiffuse:l,stoneNormalAo:d,stoneMossyDiffuse:u,stoneMossyNormalAo:m}=c.atlasesCoords.stones,y=_(...l.scale).mul(s),w=_(...u.scale).mul(o),S=y.add(w),E=_(...l.offset).mul(s),z=_(...u.offset).mul(o),F=E.add(z),te=X.computeAtlasUv(S,F,n);this.colorNode=b(c.stoneAtlas,te);const se=_(...d.scale).mul(s),_e=_(...m.scale).mul(o),Pe=se.add(_e),Se=_(...d.offset).mul(s),Le=_(...m.offset).mul(o),$e=Se.add(Le),Qe=X.computeAtlasUv(Pe,$e,n),ve=b(c.stoneAtlas,Qe);this.normalNode=new be(ve.rgb,p(3)),this.aoNode=ve.a}computeInit=A(()=>{const e=this._noiseBuffer.element(g),t=_(N(g),N(g).mul(21.63)).fract(),s=b(c.noiseTexture,t);e.assign(s.r)})().compute(Ue)}class po{constructor(){const e=c.realmModel.scene.getObjectByName("stone"),t=c.realmModel.scene.children.filter(({name:a})=>a.startsWith("stone_collider")),s=new ho,o=new oe(e.geometry,s,t.length);o.receiveShadow=!0,t.forEach((a,i)=>{o.setMatrixAt(i,a.matrix);const n=K.fixed().setTranslation(...a.position.toArray()).setRotation(a.quaternion).setUserData({type:R.Stone}),l=M.world.createRigidBody(n);a.geometry.computeBoundingBox();const d=a.geometry.boundingBox.max.x*a.scale.x,u=Y.ball(d).setRestitution(.75);M.world.createCollider(u,l)}),x.scene.add(o)}}const fo={uGrassTerrainColor:h(new H),uWaterSandColor:h(new H),uPathSandColor:h(new H)};class yo extends W{_uniforms;constructor(e){super(),this._uniforms={...fo,...e},this.createMaterial()}computeCausticsDiffuse=A(([e=_(0,0),t=p(0),s=f(0,0,0)])=>{const o=k.mul(.1),a=p(20),i=e.mul(a),n=C(i.add(_(o,0))),l=C(i.add(_(0,o.negate()))),d=b(c.noiseTexture,n,1).g,u=b(c.noiseTexture,l,2).g,m=d.add(u),y=$(-1,10,t),w=ze(m,3).mul(p(1).sub(y)),S=f(.6,.8,1).mul(.3);return G(s,S,w)});computeWaterDiffuse=A(([e=p(0),t=_(0,0)])=>{const s=p(8),o=p(.001),a=$(0,s.add(o),e),i=this._uniforms.uWaterSandColor,n=f(.35,.45,.55).mul(.65),l=this.computeCausticsDiffuse(t,e),d=$(0,1.5,e),u=f(1,.9,.7).mul(.1).mul(d);return G(i,n,a).add(u).add(l)});createMaterial(){this.precision="lowp",this.flatShading=!1;const e=X.computeMapUvByPosition(B.xz),t=Te(e),s=b(c.terrainShadowAo,D().clamp());this.aoNode=s.g;const o=b(c.terrainTypeMap,t,2.5),a=o.g,i=o.b,l=p(1).sub(a).sub(i),d=b(c.sandNormal,C(t.mul(30))),u=C(t.mul(30)),y=b(c.grassNormal,u).dot(d).mul(.65),w=C(t.mul(15)),S=b(c.grassDiffuse,u),E=b(c.grassDiffuse,w),z=G(S,E,.5),F=p(1).sub(z.a),te=this._uniforms.uGrassTerrainColor.mul(F).add(z.mul(f(1,.79,.79))).mul(a).mul(.85),se=this._uniforms.uPathSandColor.mul(1.2).mul(l),_e=Te(B.y.negate()),Se=this.computeWaterDiffuse(_e,t).mul(i),Le=te.add(se.mul(y)).add(Se.mul(y).mul(.5));this.colorNode=Le.mul(s.r)}}class wo{constructor(e){const t=this.createFloor();t.material=e,x.scene.add(t)}createFloor(){const e=c.realmModel.scene.getObjectByName("floor");return e.receiveShadow=!0,this.createFloorPhysics(),e}getFloorDisplacementData(){const e=c.realmModel.scene.getObjectByName("heightfield"),t=e.geometry.attributes._displacement.array[0],s=e.geometry.attributes.position;e.geometry.boundingBox||e.geometry.computeBoundingBox();const o=e.geometry.boundingBox,a=s.count,i=Math.sqrt(a),n=o.max.x,l=new Float32Array(a);for(let d=0;d<a;d++){const u=s.array[d*3+0],m=s.array[d*3+1],y=s.array[d*3+2],w=Math.round((u/(n*2)+.5)*(i-1)),E=Math.round((y/(n*2)+.5)*(i-1))+w*i;l[E]=m}return{rowsCount:i,heights:l,displacement:t}}createFloorPhysics(){const e=this.getFloorDisplacementData(),{rowsCount:t,heights:s,displacement:o}=e,a=K.fixed().setTranslation(0,-o,0).setUserData({type:R.Terrain}),i=M.world.createRigidBody(a),n=Y.heightfield(t-1,t-1,s,{x:V.MAP_SIZE,y:1,z:V.MAP_SIZE},kt.FIX_INTERNAL_EDGES).setFriction(1).setRestitution(.2);M.world.createCollider(n,i)}}class go{outerFloor;kintoun;kintounPosition=new T;constructor(e){this.outerFloor=this.createOuterFloorVisual(),this.outerFloor.material=e,this.kintoun=this.createKintoun(),x.scene.add(this.outerFloor),O.on("update",this.update.bind(this))}createOuterFloorVisual(){const e=c.realmModel.scene.getObjectByName("outer_world");return e.receiveShadow=!0,e}createKintoun(){const e=K.kinematicPositionBased().setTranslation(0,-20,0).setUserData({type:R.Terrain}),t=M.world.createRigidBody(e),s=2,o=Y.cuboid(s,V.HALF_FLOOR_THICKNESS,s).setFriction(1).setRestitution(.2);return M.world.createCollider(o,t),t}useKintoun(e){this.kintounPosition.copy(e).setY(-V.HALF_FLOOR_THICKNESS),this.kintoun.setTranslation(this.kintounPosition,!0)}update(e){const{player:t}=e,s=V.HALF_MAP_SIZE-Math.abs(t.position.x)<V.KINTOUN_ACTIVATION_THRESHOLD,o=V.HALF_MAP_SIZE-Math.abs(t.position.z)<V.KINTOUN_ACTIVATION_THRESHOLD;(s||o)&&this.useKintoun(t.position);const a=V.MAP_SIZE,i=Math.abs(t.position.x),n=Math.sign(t.position.x),l=Math.abs(t.position.z),d=Math.sign(t.position.z),u=i>a?i-a:0,m=l>a?l-a:0;this.outerFloor.position.set(u*n,0,m*d)}}class Ao{uniforms={uGrassTerrainColor:h(new H().setRGB(.21,.26,.05)),uWaterSandColor:h(new H().setRGB(.54,.39,.2)),uPathSandColor:h(new H().setRGB(.65,.49,.27))};constructor(){const e=new yo(this.uniforms);new wo(e),new go(e),this.debugTerrain()}debugTerrain(){const e=ee.panel.addFolder({title:"⛰️ Terrain"});e.expanded=!1,e.addBinding(this.uniforms.uPathSandColor,"value",{label:"Path color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWaterSandColor,"value",{label:"Water bed color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGrassTerrainColor,"value",{label:"Grass terrain color",view:"color",color:{type:"float"}})}}const bo=()=>({BLADE_WIDTH:.1,BLADE_HEIGHT:1.5,BLADE_BOUNDING_SPHERE_RADIUS:1.5,TILE_SIZE:150,TILE_HALF_SIZE:150/2,BLADES_PER_SIDE:500,COUNT:500*500,SPACING:150/500}),I=bo(),Xe={uPlayerPosition:h(new T(0,0,0)),uCameraMatrix:h(new xe),uBladeMinScale:h(.5),uBladeMaxScale:h(1.25),uTrailGrowthRate:h(.004),uTrailMinScale:h(.25),uTrailRaius:h(.65),uTrailRaiusSquared:h(.65*.65),uGlowRadius:h(2),uGlowRadiusSquared:h(4),uGlowFadeIn:h(.05),uGlowFadeOut:h(.01),uGlowColor:h(new H().setRGB(.45,.19,.07)),uBladeMaxBendAngle:h(Math.PI*.15),uWindStrength:h(.6),uBaseColor:h(new H().setRGB(.06,.06,.01)),uTipColor:h(new H().setRGB(.28,.13,.06)),uDelta:h(new ne(0,0))};class xo extends Ae{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...Xe,...e},this._buffer1=le(I.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=le(I.COUNT,"vec4"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createGrassMaterial()}computeInit=A(()=>{const e=this._buffer1.element(g),t=ye(p(g).div(I.BLADES_PER_SIDE)),s=p(g).mod(I.BLADES_PER_SIDE),o=N(g.add(4321)),a=N(g.add(1234)),i=s.mul(I.SPACING).sub(I.TILE_HALF_SIZE).add(o.mul(I.SPACING*.5)),n=t.mul(I.SPACING).sub(I.TILE_HALF_SIZE).add(a.mul(I.SPACING*.5)),l=f(i,0,n).xz.add(I.TILE_HALF_SIZE).div(I.TILE_SIZE).abs(),d=b(c.noiseTexture,l),u=d.b.sub(.5).mul(30),m=d.g.sub(.5).mul(10);e.x=i.add(u),e.y=n.add(m);const y=d.b.sub(.5).mul(p(Math.PI*2));e.z=y;const w=this._buffer2.element(g),S=this._uniforms.uBladeMaxScale.sub(this._uniforms.uBladeMinScale),E=N(g.add(100)).mul(S).add(this._uniforms.uBladeMinScale);w.x=E,w.y=E})().compute(I.COUNT);computeVisibility=A(([e=f(0)])=>{const t=this._uniforms.uCameraMatrix.mul(U(e,1)),s=t.xyz.div(t.w),o=I.BLADE_BOUNDING_SPHERE_RADIUS,a=p(1);return v(a.negate().sub(o),s.x).mul(v(s.x,a.add(o))).mul(v(a.negate().sub(o),s.y)).mul(v(s.y,a.add(o))).mul(v(0,s.z)).mul(v(s.z,a))});computeBending=A(([e=U(0,0,0,0),t=f(0,0,0)])=>{const s=t.xz.add(k.mul(.25)).mul(.5),o=C(s),i=b(c.noiseTexture,o,5).r.mul(this._uniforms.uWindStrength);return e.w.add(i.sub(e.w).mul(.1))});computeAlpha=A(([e=f(0)])=>{const t=X.computeMapUvByPosition(e.xz);return b(c.terrainTypeMap,t).g});computeTrailScale=A(([e=U(0),t=p(0)])=>{const s=e.x.add(this._uniforms.uTrailGrowthRate),o=p(1).sub(t),a=this._uniforms.uTrailMinScale.mul(t).add(s.mul(o));return vt(a,e.y)});computeTrailGlow=A(([e=U(0),t=p(0),s=p(0),o=p(0)])=>{const a=$(this._uniforms.uGlowRadiusSquared,p(0),t),i=100,n=ye(fe(this._uniforms.uDelta.x).mul(i)),l=ye(fe(this._uniforms.uDelta.y).mul(i)),d=v(1,n.add(l)),u=a.mul(p(1).sub(s)).mul(o),m=Dt(d,e.w).mul(u),y=m.mul(this._uniforms.uGlowFadeIn),w=p(1).sub(m).mul(this._uniforms.uGlowFadeOut),S=p(1).sub(d).mul(this._uniforms.uGlowFadeOut).mul(e.w);return We(e.w.add(y).sub(w).sub(S),0,1)});computeUpdate=A(()=>{const e=this._buffer1.element(g),t=this._buffer2.element(g),s=ge(e.x.sub(this._uniforms.uDelta.x).add(I.TILE_HALF_SIZE),I.TILE_SIZE).sub(I.TILE_HALF_SIZE),o=ge(e.y.sub(this._uniforms.uDelta.y).add(I.TILE_HALF_SIZE),I.TILE_SIZE).sub(I.TILE_HALF_SIZE),a=f(s,0,o);e.x=s,e.y=o;const i=a.add(this._uniforms.uPlayerPosition),n=this.computeVisibility(i);t.z=n,je(n,()=>{const l=_(this._uniforms.uDelta.x,this._uniforms.uDelta.y),d=a.xz.sub(l),u=d.dot(d),m=v(.1,p(1).sub(this._uniforms.uPlayerPosition.y)),y=v(u,this._uniforms.uTrailRaiusSquared).mul(m);t.x=this.computeTrailScale(t,y),t.z=this.computeAlpha(i),e.w=this.computeBending(e,i),t.w=this.computeTrailGlow(t,u,y,m)})})().compute(I.COUNT);computePosition=A(([e=U(0),t=U(0)])=>{const s=f(e.x,0,e.y),o=e.z,a=e.w,i=t.x,n=a.mul(D().y),d=Ce(ie,f(n,0,0)).mul(f(1,i,1)),u=Ce(d,f(0,o,0)),m=N(g).mul(6.28),y=q(k.mul(5).add(e.w).add(m)).mul(.1),w=D().y.mul(t.w),S=y.mul(w);return u.add(s).add(f(S))});computeDiffuseColor=A(([e=U(0)])=>{const t=ze(D().y,1.5),s=G(this._uniforms.uBaseColor,this._uniforms.uTipColor,t),o=N(g).mul(.05).sub(.025),a=e.w;return G(s.add(o),this._uniforms.uGlowColor.mul(.5),a)});computeAO=A(([e=U(0)])=>{const t=fe(q(e.z)).mul(.5);return $(-2.5,1.25,D().y).mul(p(1).sub(t))});createGrassMaterial(){this.precision="lowp",this.side=Ee;const e=this._buffer1.element(g),t=this._buffer2.element(g);Nt(t.z.equal(0)),this.positionNode=this.computePosition(e,t),this.opacityNode=t.z,this.alphaTest=.25,this.aoNode=this.computeAO(e),this.colorNode=this.computeDiffuseColor(t)}async updateAsync(){await j.renderer.computeAsync(this.computeUpdate)}}class _o{material;grassField;uniforms={...Xe,uDelta:h(new ne(0,0)),uPlayerPosition:h(new T(0,0,0)),uCameraMatrix:h(new xe)};constructor(){const e=this.createBladeGeometry();e.instanceCount=I.COUNT,this.material=new xo(this.uniforms),this.grassField=new Ze(e,this.material),x.scene.add(this.grassField),O.on("update",this.updateAsync.bind(this)),this.debugGrass()}debugGrass(){const e=ee.panel.addFolder({title:"\uD83C\uDF31 Grass"});e.expanded=!1,e.addBinding(this.uniforms.uTipColor,"value",{label:"Tip Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGlowColor,"value",{label:"Glow Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWindStrength,"value",{label:"Wind strength",min:0,max:Math.PI/2,step:.1})}createBladeGeometry(){const e=I.BLADE_WIDTH/2,t=e/2,s=I.BLADE_HEIGHT/4,o=new Float32Array([-e,0,0,e,0,0,-t,s*1,0,t,s*1,0,-t*.5,s*2,0,t*.5,s*2,0,0,s*3,0]),a=new Float32Array([0,0,1,0,.25,s*1,.75,s*1,.375,s*2,.625,s*2,.5,s*3]),i=new Uint16Array([0,1,3,0,3,2,2,3,5,2,5,4,4,5,6]),n=25*Math.PI/180,l=15*Math.PI/180,d=8*Math.PI/180,u=Math.cos(n),m=Math.sin(n),y=Math.cos(l),w=Math.sin(l),S=Math.cos(d),E=Math.sin(d),z=new Float32Array([-u,m,0,u,m,0,-y,w,0,y,w,0,-S,E,0,S,E,0,0,1,0]),F=new Pt;return F.setAttribute("position",new ue(o,3)),F.setAttribute("uv",new ue(a,2)),F.setIndex(new ue(i,1)),F.setAttribute("normal",new ue(z,3)),F}async updateAsync(e){const{player:t}=e,s=t.position.x-this.grassField.position.x,o=t.position.z-this.grassField.position.z;this.uniforms.uDelta.value.set(s,o),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(x.camera.projectionMatrix).multiply(x.camera.matrixWorldInverse),this.grassField.position.copy(t.position).setY(0),await this.material.updateAsync()}}const So=()=>({FLOWER_WIDTH:.5,FLOWER_HEIGHT:1,BLADE_BOUNDING_SPHERE_RADIUS:1,TILE_SIZE:150,TILE_HALF_SIZE:150/2,FLOWERS_PER_SIDE:25,COUNT:25*25,SPACING:150/25}),P=So();class Lo{flowerField;material;uniforms={...Je,uDelta:h(new ne(0,0)),uPlayerPosition:h(new T(0,0,0)),uCameraMatrix:h(new xe)};constructor(){this.material=new Io(this.uniforms),this.flowerField=new oe(new Ge(1,1),this.material,P.COUNT),x.scene.add(this.flowerField),O.on("update",this.updateAsync.bind(this))}async updateAsync(e){const{player:t}=e,s=t.position.x-this.flowerField.position.x,o=t.position.z-this.flowerField.position.z;this.uniforms.uDelta.value.set(s,o),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(x.camera.projectionMatrix).multiply(x.camera.matrixWorldInverse),this.flowerField.position.copy(t.position).setY(0),await this.material.updateAsync()}}const Je={uPlayerPosition:h(new T(0,0,0)),uCameraMatrix:h(new xe),uDelta:h(new ne(0,0))};class Io extends ke{_uniforms;_buffer1;constructor(e){super(),this._uniforms={...Je,...e},this._buffer1=le(P.COUNT,"vec4"),this._buffer1.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createMaterial()}computeInit=A(()=>{const e=this._buffer1.element(g),t=ye(p(g).div(P.FLOWERS_PER_SIDE)),s=p(g).mod(P.FLOWERS_PER_SIDE),o=N(g.add(4321)),a=N(g.add(1234)),i=s.mul(P.SPACING).sub(P.TILE_HALF_SIZE).add(o.mul(P.SPACING*.5)),n=t.mul(P.SPACING).sub(P.TILE_HALF_SIZE).add(a.mul(P.SPACING*.5)),l=f(i,0,n).xz.add(P.TILE_HALF_SIZE).div(P.TILE_SIZE).abs(),u=b(c.noiseTexture,l).r,m=u.sub(.5).mul(100),y=u.clamp(.5,.75),w=u.sub(.5).mul(50);e.x=i.add(m),e.y=y,e.z=n.add(w)})().compute(P.COUNT);computeVisibility=A(([e=f(0)])=>{const t=this._uniforms.uCameraMatrix.mul(U(e,1)),s=t.xyz.div(t.w),o=P.BLADE_BOUNDING_SPHERE_RADIUS,a=p(1);return v(a.negate().sub(o),s.x).mul(v(s.x,a.add(o))).mul(v(a.negate().sub(o),s.y)).mul(v(s.y,a.add(o))).mul(v(0,s.z)).mul(v(s.z,a))});computeAlpha=A(([e=f(0)])=>{const t=X.computeMapUvByPosition(e.xz);return b(c.terrainTypeMap,t).g});computeUpdate=A(()=>{const e=this._buffer1.element(g),t=ge(e.x.sub(this._uniforms.uDelta.x).add(P.TILE_HALF_SIZE),P.TILE_SIZE).sub(P.TILE_HALF_SIZE),s=ge(e.z.sub(this._uniforms.uDelta.y).add(P.TILE_HALF_SIZE),P.TILE_SIZE).sub(P.TILE_HALF_SIZE);e.x=t,e.z=s;const a=f(e.x,0,e.z).add(this._uniforms.uPlayerPosition),i=this.computeVisibility(a);e.w=i,je(i,()=>{e.w=this.computeAlpha(a)})})().compute(P.COUNT);createMaterial(){this.precision="lowp";const e=this._buffer1.element(g),t=N(g.add(9234)),s=N(g.add(33.87)),o=k.mul(2),a=q(o.add(t.mul(100))).mul(.05);this.positionNode=e.xyz.add(f(a,0,a)),this.opacityNode=e.w,this.alphaTest=.15,this.scaleNode=t.mul(.2).add(.3);const i=v(.5,t).mul(.5),n=v(.5,s).mul(.5),d=D().mul(.5).add(_(i,n)),u=b(c.flowerAtlas,d);this.colorNode=U(u.rgb.mul(.35),u.a)}async updateAsync(){j.renderer.computeAsync(this.computeUpdate)}}class Mo{constructor(){const e=c.realmModel.scene.getObjectByName("water_lilies");e.material=this.createMaterial(),x.scene.add(e)}createMaterial(){const e=new W;e.precision="lowp",e.transparent=!0,e.map=c.waterLiliesTexture,e.alphaTest=.5,e.alphaMap=c.waterLiliesAlphaTexture;const t=k.mul(5e-4),s=B.x.mul(.1),o=b(c.noiseTexture,C(B.xz.add(t).mul(s))).b.mul(.5),a=q(o);return e.positionNode=ie.add(a),e}}class To extends W{constructor(){super(),this.precision="lowp",this.flatShading=!1;const e=C(D().mul(7)),t=b(c.barkDiffuse,e);this.colorNode=t;const s=b(c.barkNormal,e);this.normalNode=new be(s)}}class Eo extends W{constructor(){super(),this.precision="lowp",this.flatShading=!1,this.transparent=!0,this.side=Ee;const e=X.computeMapUvByPosition(B.xz),t=b(c.noiseTexture,e),s=b(c.canopyDiffuse,D()),o=G(f(.889,.095,0),f(1,.162,.009),.5);this.colorNode=G(s.mul(1.25),o,t.b.mul(.4));const a=b(c.canopyNormal,D());this.normalNode=new be(a,p(1.25)),this.alphaTest=.9;const i=k.mul(t.r).add(Ve).mul(7.5),n=q(i).mul(.015),l=He(i.mul(.75)).mul(.01);this.positionNode=ie.add(f(0,l,n))}}class Po{constructor(){const e=c.realmModel.scene.getObjectByName("tree"),t=c.realmModel.scene.children.filter(({name:w})=>w.startsWith("tree_collider")),s=new To,o=new Eo,[a,i]=e.children,n=new oe(a.geometry,s,t.length);n.receiveShadow=!0;const l=new oe(i.geometry,o,t.length),u=c.realmModel.scene.getObjectByName("base_tree_collider").geometry.boundingBox,m=u.max.x,y=u.max.y/2;t.forEach((w,S)=>{n.setMatrixAt(S,w.matrix),l.setMatrixAt(S,w.matrix);const E=K.fixed().setTranslation(...w.position.toArray()).setRotation(w.quaternion).setUserData({type:R.Wood}),z=M.world.createRigidBody(E),F=m*w.scale.x,te=y*w.scale.y,se=Y.capsule(te,F).setRestitution(.75);M.world.createCollider(se,z)}),x.scene.add(n,l)}}class vo{constructor(){new _o,new Mo,new Lo,new Po}}const Do=()=>Object.freeze({MAP_SIZE:256,HALF_MAP_SIZE:256/2,KINTOUN_ACTIVATION_THRESHOLD:2,HALF_FLOOR_THICKNESS:.3,OUTER_MAP_SIZE:256*3,OUTER_HALF_MAP_SIZE:256*1.5}),V=Do();class No{constructor(){new Ao,new co,new uo,new vo,new po,new ro}}class Co{computeMapUvByPosition=A(([e=_(0)])=>e.add(V.HALF_MAP_SIZE).div(V.MAP_SIZE));computeAtlasUv=A(([e=_(0),t=_(0),s=_(0)])=>s.mul(e).add(t))}const X=new Co,Bo=()=>({JUMP_BUFFER_DURATION_IN_SECONDS:.2,MAX_CONSECUTIVE_JUMPS:2,JUMP_CUT_MULTIPLIER:.25,FALL_MULTIPLIER:2.75,MAX_UPWARD_VELOCITY:6,LINEAR_DAMPING:.35,ANGULAR_DAMPING:.6,JUMP_IMPULSE:new T(0,75,0),LIN_VEL_STRENGTH:35,ANG_VEL_STRENGTH:25,RADIUS:.5,PLAYER_INITIAL_POSITION:new T(0,5,0),CAMERA_OFFSET:new T(0,11,17),CAMERA_LERP_FACTOR:7.5,UP:new T(0,1,0),DOWN:new T(0,-1,0),FORWARD:new T(0,0,-1)}),L=Bo();class Ro{mesh;rigidBody;smoothedCameraPosition=new T;desiredCameraPosition=new T;smoothedCameraTarget=new T;desiredTargetPosition=new T;yawInRadians=0;prevYawInRadians=-1;yawQuaternion=new Ct;newLinVel=new T;newAngVel=new T;torqueAxis=new T;forwardVec=new T;isOnGround=!1;jumpCount=0;wasJumpHeld=!1;jumpBufferTimer=0;rayOrigin=new T;ray=new Ht(this.rayOrigin,L.DOWN);constructor(){this.mesh=this.createCharacterMesh(),x.scene.add(this.mesh),Ke.setTarget(this.mesh),this.rigidBody=M.world.createRigidBody(this.createRigidBodyDesc()),M.world.createCollider(this.createColliderDesc(),this.rigidBody),O.on("update",this.update.bind(this)),O.on("update-throttle-60x",this.resetPlayerPosition.bind(this)),this.debugPlayer()}resetPlayerPosition(e){const{player:t}=e;t.position.y>-10||(this.rigidBody.setLinvel({x:0,y:0,z:0},!1),this.rigidBody.setAngvel({x:0,y:0,z:0},!1),this.rigidBody.setTranslation(L.PLAYER_INITIAL_POSITION,!0),this.mesh.position.copy(L.PLAYER_INITIAL_POSITION))}debugPlayer(){const e=ee.panel.addFolder({title:"\uD83E\uDEA9 Player",expanded:!1});e.addBinding(L.CAMERA_OFFSET,"y",{label:"Main camera height"}),e.addBinding(L.CAMERA_OFFSET,"z",{label:"Main camera distance"})}createCharacterMesh(){const e=new Bt(L.RADIUS,2),t=new Oo,s=new Ze(e,t);return s.castShadow=!0,s.position.copy(L.PLAYER_INITIAL_POSITION),s}createRigidBodyDesc(){const{x:e,y:t,z:s}=L.PLAYER_INITIAL_POSITION;return K.dynamic().setTranslation(e,t,s).setLinearDamping(L.LINEAR_DAMPING).setAngularDamping(L.ANGULAR_DAMPING).setUserData({type:R.Player})}createColliderDesc(){return Y.ball(L.RADIUS).setRestitution(.25).setFriction(1).setMass(3).setActiveEvents(Wt.COLLISION_EVENTS)}update(e){const{clock:t}=e,s=t.getDelta();this.prevYawInRadians!==this.yawInRadians&&(this.yawQuaternion.setFromAxisAngle(L.UP,this.yawInRadians),this.prevYawInRadians=this.yawInRadians),this.updateVerticalMovement(s),this.updateHorizontalMovement(s),this.updateCameraPosition(s)}updateVerticalMovement(e){const t=re.isJumpPressed();this.isOnGround=this.checkIfGrounded(),this.isOnGround&&(this.jumpCount=0),t&&!this.wasJumpHeld?this.jumpBufferTimer=L.JUMP_BUFFER_DURATION_IN_SECONDS:this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),this.jumpBufferTimer>0&&this.canJump()&&(this.performJump(),this.jumpBufferTimer=0);const o=this.rigidBody.linvel();this.handleJumpCut(t,o),this.handleFastFall(e,o,M.world.gravity.y),this.clampUpwardVelocity(o),this.rigidBody.setLinvel(o,!0),this.wasJumpHeld=t}checkIfGrounded(){this.rayOrigin.copy(this.rigidBody.translation()),this.rayOrigin.y-=L.RADIUS+.01;const e=.2,t=M.world.castRay(this.ray,e,!0);return t?t.timeOfImpact*e<.01:!1}canJump(){return this.isOnGround?!0:this.jumpCount<L.MAX_CONSECUTIVE_JUMPS}performJump(){this.rigidBody.applyImpulse(L.JUMP_IMPULSE,!0),this.jumpCount+=1}handleJumpCut(e,t){!(!e&&this.wasJumpHeld)||t.y<=0||(t.y*=L.JUMP_CUT_MULTIPLIER)}handleFastFall(e,t,s){if(t.y>=0)return;const o=L.FALL_MULTIPLIER*Math.abs(s)*e;t.y-=o}clampUpwardVelocity(e){e.y<=L.MAX_UPWARD_VELOCITY||(e.y=L.MAX_UPWARD_VELOCITY)}updateHorizontalMovement(e){const t=re.isForward(),s=re.isBackward(),o=re.isLeftward(),a=re.isRightward(),i=2;o&&(this.yawInRadians+=i*e),a&&(this.yawInRadians-=i*e),this.forwardVec.copy(L.FORWARD).applyQuaternion(this.yawQuaternion),this.torqueAxis.crossVectors(L.UP,this.forwardVec).normalize(),this.newLinVel.copy(this.rigidBody.linvel()),this.newAngVel.copy(this.rigidBody.angvel());const n=L.LIN_VEL_STRENGTH*e,l=L.ANG_VEL_STRENGTH*e;t&&(this.newLinVel.addScaledVector(this.forwardVec,n),this.newAngVel.addScaledVector(this.torqueAxis,l)),s&&(this.newLinVel.addScaledVector(this.forwardVec,-n),this.newAngVel.addScaledVector(this.torqueAxis,-l)),this.rigidBody.setLinvel(this.newLinVel,!0),this.rigidBody.setAngvel(this.newAngVel,!0),this.syncMeshWithBody()}syncMeshWithBody(){this.mesh.position.copy(this.rigidBody.translation()),this.mesh.quaternion.copy(this.rigidBody.rotation())}updateCameraPosition(e){this.desiredCameraPosition.copy(L.CAMERA_OFFSET).applyQuaternion(this.yawQuaternion).add(this.mesh.position);const t=L.CAMERA_LERP_FACTOR*e;this.smoothedCameraPosition.lerp(this.desiredCameraPosition,t),this.desiredTargetPosition.copy(this.mesh.position),this.desiredTargetPosition.y+=1,this.smoothedCameraTarget.lerp(this.desiredTargetPosition,t),x.camera.position.copy(this.smoothedCameraPosition),x.camera.lookAt(this.smoothedCameraTarget)}get position(){return this.mesh.position}get yaw(){return this.yawInRadians}}class Oo extends W{constructor(){super(),this.createMaterial()}createMaterial(){this.flatShading=!0,this.castShadowNode=f(.6);const e=X.computeMapUvByPosition(B.xz),t=Te(e),s=Ke.getTerrainShadowFactor(t),o=b(c.noiseTexture,C(B.xz),3).r,a=q(k.mul(2.5).add(o.mul(5))).mul(.05),i=p(-.45).add(a),n=p(1).sub(v(i,B.y)),l=p(1).sub(n),d=f(1),u=p(1).sub($(-1.5,1,B.y).mul(n)),m=G(f(1),f(.6,.8,1).mul(.75),u),y=d.mul(m).mul(n),S=d.mul(l).add(y);this.colorNode=S.mul(s)}}class Fo{player;constructor(){this.player=new Ro,new No}getSizes(){const e=window.innerWidth,t=window.innerHeight;return{width:e,height:t,dpr:Math.min(window.devicePixelRatio,1.5),aspect:e/t}}onResize(){const e=this.getSizes();x.camera.aspect=e.aspect,x.camera.updateProjectionMatrix(),j.renderer.setSize(e.width,e.height),j.renderer.setPixelRatio(e.dpr)}async startLoop(){await j.init();const t={clock:new Rt(!0),player:this.player},s=async()=>{M.update(),O.emit("update",t),j.renderAsync()};new ResizeObserver(()=>{this.onResize()}).observe(document.body),j.renderer.setAnimationLoop(s)}}class Uo{constructor(){}init(){this.initAudioButton(),this.initCreditsButton()}initAudioButton(){const e=document.getElementById("audio");e.disabled=!0;const t=e?.querySelector("path");if(!e||!t)return;const s="M1129.432 113v1694.148H903.545l-451.772-451.773V564.773L903.545 113h225.887Zm542.545 248.057C1832.017 521.097 1920 733.882 1920 960.107c0 226.226-87.983 438.898-248.023 598.938l-79.851-79.85c138.694-138.582 214.93-323.018 214.93-519.087 0-196.183-76.236-380.506-214.93-519.2ZM338.83 564.773v790.602H169.415C75.672 1355.375 0 1279.703 0 1185.96V734.187c0-93.742 75.672-169.414 169.415-169.414H338.83Zm1093.922 36.085c95.776 97.018 148.407 224.644 148.407 359.16 0 134.628-52.631 262.253-148.407 359.272l-80.303-79.174c74.656-75.897 115.767-175.4 115.767-280.099 0-104.585-41.111-204.088-115.767-279.986Z",o="M1129.433 113v1694.15H903.547l-451.774-451.773V564.773L903.547 113h225.886ZM338.83 564.773v790.604H169.415c-92.806 0-167.9-74.166-169.392-166.609L0 1185.962V734.188c0-92.805 74.166-167.9 166.608-169.392l2.807-.023H338.83ZM1789.951 635 1920 764.926 1724.988 959.94 1920 1154.95 1789.951 1285l-194.89-195.012L1400.05 1285 1270 1154.951l195.012-195.012L1270 764.926 1400.049 635l195.012 195.012L1789.951 635Z";e.addEventListener("click",async a=>{a.stopPropagation(),await Z.toggleMute();const i=Z.isMute?o:s;t.setAttribute("d",i)}),O.on("audio-ready",()=>{e.disabled=!1})}initCreditsButton(){const e=document.getElementById("credits"),t=document.getElementById("credits-dialog");if(!e||!t)return;t.addEventListener("click",l=>{switch(l.stopPropagation(),l.target?.id){case"credits-dialog":case"close-dialog-btn":t.close();break}}),e.addEventListener("click",l=>{l.stopPropagation(),t.showModal()});const a="aleksandar.d.gjoreski@gmail.com",i=document.createElement("a");i.setAttribute("href",`mailto:${a}`),i.innerText=a,document.getElementById("email-placeholder")?.appendChild(i)}}const Go=new Uo,ko=new Ws;ko.initAsync().then(()=>{Go.init(),new Fo().startLoop()})});