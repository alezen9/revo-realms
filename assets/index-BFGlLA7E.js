import{T as ue,D as he,G as me,C as pe,L as ge,_ as fe,V as y,Q as we,u as c,I as ye,M as te,a as _e,t as M,f as v,p as R,s as se,b as d,c as E,d as F,e as O,g as oe,F as f,m as Z,h as b,v as D,i as u,j as C,n as B,k as Te,l as Me,o as Ae,q as ie,r as K,w as S,x as Pe,y as Ie,z,A as X,B as V,E as N,H,J as ne,K as ae,N as re,O as be,P as Le,R as Ee,S as Se,U as ve,W as xe,X as Ce,Y as Ne,Z as Fe,$ as De,a0 as Re,a1 as Be,a2 as Oe,a3 as Ue,a4 as Ge,a5 as He,a6 as Ve,a7 as le,a8 as ce,a9 as ze,aa as U,ab as Y,ac as I,ad as k,ae as G,af as ke,ag as W,ah as We,ai as Q,aj as Ze,ak as Ke}from"./three-CIm_2J5_.js";import{Ray as je,RigidBodyDesc as j,ColliderDesc as J,HeightFieldFlags as Je,World as qe}from"./@dimforge-CmnDU9Yz.js";import{P as Xe}from"./tweakpane-BXg6ZhiP.js";import{S as $}from"./stats-gl-C2M3amu4.js";(async()=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();const Ye="/revo-realms/textures/noise/perlin_noise.webp",Qe="/revo-realms/textures/noise/random_noise.webp",$e="/revo-realms/textures/noise/voronoi_noise.webp",et="/revo-realms/models/realm.glb",tt="/revo-realms/models/npcs.glb",st="/revo-realms/textures/realm/water_grass_map.webp",ot="/revo-realms/textures/realm/coast_sand_nor.webp",it="/revo-realms/textures/environment/px.webp",nt="/revo-realms/textures/environment/nx.webp",at="/revo-realms/textures/environment/py.webp",rt="/revo-realms/textures/environment/ny.webp",lt="/revo-realms/textures/environment/pz.webp",ct="/revo-realms/textures/environment/nz.webp";class dt{textureLoader;gltfLoader;cubeTextureLoader;perlinNoiseTexture;randomNoiseTexture;voronoiNoiseTexture;envMapTexture;floorGrassWaterMap;sandNormalTexture;npcsModel;realmModel;constructor(){const e=this.createLoadingManager();this.textureLoader=new ue(e);const t=new he(e);t.setDecoderPath("/revo-realms/draco/"),this.gltfLoader=new me(e),this.gltfLoader.setDRACOLoader(t),this.cubeTextureLoader=new pe(e)}createLoadingManager(){const e=new ge;e.onStart=function(t,s,o){console.log("Started loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onLoad=function(){console.log("Loading complete!")},e.onProgress=function(t,s,o){console.log("Loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onError=function(t){console.log("There was an error loading "+t)}}async initAsync(){const e=await Promise.all([w.cubeTextureLoader.loadAsync([it,nt,at,rt,lt,ct]),this.textureLoader.loadAsync(Ye),this.textureLoader.loadAsync(Qe),this.textureLoader.loadAsync($e),this.gltfLoader.loadAsync(tt),this.gltfLoader.loadAsync(et),this.textureLoader.loadAsync(st),this.textureLoader.loadAsync(ot)]);this.envMapTexture=e[0],this.perlinNoiseTexture=e[1],this.randomNoiseTexture=e[2],this.voronoiNoiseTexture=e[3],this.npcsModel=e[4],this.realmModel=e[5],this.floorGrassWaterMap=e[6],this.floorGrassWaterMap.flipY=!1,this.sandNormalTexture=e[7]}}const w=new dt;class ut{async initAsync(){const e=await fe(()=>import("./@dimforge-CmnDU9Yz.js"),[]);await Promise.all([e.init(),w.initAsync()])}}class ht{mesh;rigidBody;inputManager;smoothedCameraPosition=new y;desiredCameraPosition=new y;smoothedCameraTarget=new y;desiredTargetPosition=new y;yawInRadians=0;prevYawInRadians=-1;yawQuaternion=new we;JUMP_IMPULSE=5;JUMP_BUFFER_DURATION_IN_SECONDS=.2;MAX_CONSECUTIVE_JUMPS=2;JUMP_CUT_MULTIPLIER=.25;FALL_MULTIPLIER=1.75;MAX_UPWARD_VELOCITY=6;LINEAR_DAMPING=.25;ANGULAR_DAMPING=1;jumpImpulse=new y(0,this.JUMP_IMPULSE,0);LIN_VEL_STRENGTH=25;ANG_VEL_STRENGTH=25;newLinVel=new y;newAngVel=new y;torqueAxis=new y;forwardVec=new y;isOnGround=!1;jumpCount=0;wasJumpHeld=!1;jumpBufferTimer=0;RADIUS=.5;PLAYER_INITIAL_POSITION=new y(-95,5,45);CAMERA_OFFSET=new y(0,11,17);CAMERA_LERP_FACTOR=7.5;UP=new y(0,1,0);DOWN=new y(0,-1,0);FORWARD=new y(0,0,-1);rayOrigin=new y;ray=new je(this.rayOrigin,this.DOWN);lighting;uTime=c(0);constructor(e){const{scene:t,world:s,inputManager:o,lighting:i}=e;this.inputManager=o,this.lighting=i,this.mesh=this.createCharacterMesh(),t.add(this.mesh),this.rigidBody=s.createRigidBody(this.createRigidBodyDesc()),s.createCollider(this.createColliderDesc(),this.rigidBody)}createCharacterMesh(){const e=new ye(this.RADIUS,3),t=new mt({uTime:this.uTime}),s=new te(e,t);return s.castShadow=!0,s.position.copy(this.PLAYER_INITIAL_POSITION),s}createRigidBodyDesc(){const{x:e,y:t,z:s}=this.PLAYER_INITIAL_POSITION;return j.dynamic().setTranslation(e,t,s).setLinearDamping(this.LINEAR_DAMPING).setAngularDamping(this.ANGULAR_DAMPING)}createColliderDesc(){return J.ball(this.RADIUS).setRestitution(.2).setFriction(1)}update(e){const{clock:t,camera:s,world:o}=e,i=t.getDelta();this.uTime.value=t.getElapsedTime(),this.prevYawInRadians!==this.yawInRadians&&(this.yawQuaternion.setFromAxisAngle(this.UP,this.yawInRadians),this.prevYawInRadians=this.yawInRadians),this.updateVerticalMovement(i,o),this.updateHorizontalMovement(i),this.updateCameraPosition(s,i)}updateVerticalMovement(e,t){const s=this.inputManager.isKeyPressed(" ");this.isOnGround=this.checkIfGrounded(t),this.isOnGround&&(this.jumpCount=0),s&&!this.wasJumpHeld?this.jumpBufferTimer=this.JUMP_BUFFER_DURATION_IN_SECONDS:this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),this.jumpBufferTimer>0&&this.canJump()&&(this.performJump(),this.jumpBufferTimer=0);const i=this.rigidBody.linvel();this.handleJumpCut(s,i),this.handleFastFall(e,i,t.gravity.y),this.clampUpwardVelocity(i),this.rigidBody.setLinvel(i,!0),this.wasJumpHeld=s}checkIfGrounded(e){this.rayOrigin.copy(this.rigidBody.translation()),this.rayOrigin.y-=this.RADIUS+.01;const t=.2,s=e.castRay(this.ray,t,!0);return s?s.timeOfImpact*t<.01:!1}canJump(){return this.isOnGround?!0:this.jumpCount<this.MAX_CONSECUTIVE_JUMPS}performJump(){this.rigidBody.applyImpulse(this.jumpImpulse,!0),this.jumpCount+=1}handleJumpCut(e,t){!(!e&&this.wasJumpHeld)||t.y<=0||(t.y*=this.JUMP_CUT_MULTIPLIER)}handleFastFall(e,t,s){if(t.y>=0)return;const o=this.FALL_MULTIPLIER*Math.abs(s)*e;t.y-=o}clampUpwardVelocity(e){e.y<=this.MAX_UPWARD_VELOCITY||(e.y=this.MAX_UPWARD_VELOCITY)}updateHorizontalMovement(e){const t=this.inputManager.isKeyPressed("w")||this.inputManager.isKeyPressed("arrowup"),s=this.inputManager.isKeyPressed("s")||this.inputManager.isKeyPressed("arrowdown"),o=this.inputManager.isKeyPressed("a")||this.inputManager.isKeyPressed("arrowleft"),i=this.inputManager.isKeyPressed("d")||this.inputManager.isKeyPressed("arrowright"),n=2;o&&(this.yawInRadians+=n*e),i&&(this.yawInRadians-=n*e),this.forwardVec.copy(this.FORWARD).applyQuaternion(this.yawQuaternion),this.torqueAxis.crossVectors(this.UP,this.forwardVec).normalize(),this.newLinVel.copy(this.rigidBody.linvel()),this.newAngVel.copy(this.rigidBody.angvel());const a=this.LIN_VEL_STRENGTH*e,r=this.ANG_VEL_STRENGTH*e;t&&(this.newLinVel.addScaledVector(this.forwardVec,a),this.newAngVel.addScaledVector(this.torqueAxis,r)),s&&(this.newLinVel.addScaledVector(this.forwardVec,-a),this.newAngVel.addScaledVector(this.torqueAxis,-r)),this.rigidBody.setLinvel(this.newLinVel,!0),this.rigidBody.setAngvel(this.newAngVel,!0),this.syncMeshWithBody()}syncMeshWithBody(){this.mesh.position.copy(this.rigidBody.translation()),this.mesh.quaternion.copy(this.rigidBody.rotation())}updateCameraPosition(e,t){this.desiredCameraPosition.copy(this.CAMERA_OFFSET).applyQuaternion(this.yawQuaternion).add(this.mesh.position);const s=this.CAMERA_LERP_FACTOR*t;this.smoothedCameraPosition.lerp(this.desiredCameraPosition,s),this.desiredTargetPosition.copy(this.mesh.position),this.desiredTargetPosition.y+=1,this.smoothedCameraTarget.lerp(this.desiredTargetPosition,s),e.position.copy(this.smoothedCameraPosition),e.lookAt(this.smoothedCameraTarget)}get position(){return this.mesh.position}get yaw(){return this.yawInRadians}}class mt extends _e{_uniforms;constructor(e){super(),this._uniforms={...e},this.createMaterial()}createMaterial(){this.flatShading=!0,this.roughness=.5;const e=M(w.perlinNoiseTexture,v(R.xz),3).r,t=se(this._uniforms.uTime.mul(2.5).add(e.mul(5))).mul(.05),s=d(-.15).add(t),o=d(1).sub(E(s,R.y)),i=d(1).sub(o),n=F("silver"),a=n.mul(i),r=n.mul(1.5).mul(o),l=a.add(r);this.colorNode=l;const p=d(.9).mul(i),g=d(.65).mul(o);this.metalnessNode=p.add(g)}}class pt{panel;constructor(){this.panel=new Xe({title:"Revo Realms"}),this.panel.element.parentElement.style.zIndex="1",this.panel.element.parentElement.style.width="340px"}setVisibility(e){this.panel.hidden=!e}}const q=new pt,gt={uTime:c(0),uWavesSpeed:c(.02),uWavesAmplitude:c(.02),uWavesFrequency:c(.64),uTroughColor:c(new O("#186691")),uSurfaceColor:c(new O("#9bd8c0")),uPeakColor:c(new O("#bbd8e0")),uPeakThreshold:c(.5),uPeakTransition:c(0),uTroughThreshold:c(-.23),uTroughTransition:c(.15),uFresnelScale:c(.8)};class ft extends oe{_uniforms;debugFolder;constructor(e,t=!1){super(),this._uniforms={...gt,...e},this.createWaterMaterial(),this.debugFolder=q.panel.addFolder({title:"\uD83C\uDF0A Water"}),this.debugFolder.hidden=!t,t&&(this.debugWaves(),this.debugColor(),this.debugFresnel())}computeElevation=f(([e=D(0,0)])=>{const t=w.randomNoiseTexture,s=this._uniforms.uTime.mul(this._uniforms.uWavesSpeed).mul(.1),o=Z(e.mul(this._uniforms.uWavesFrequency).add(s),1),i=M(t,o,.5).r,n=M(t,o,1.5).r;return b(i,n,.5).mul(this._uniforms.uWavesAmplitude).mul(.001)});computePosition=f(([e=d(0)])=>{const t=e.mul(10);return u(C.x,C.y.add(t),C.z)});computeNormal=f(([e=d(0)])=>{const t=d(.001),s=this.computeElevation(D(C.x.sub(t),C.z)),o=this.computeElevation(D(C.x,C.z.sub(t))),i=B(u(t,s.sub(e),0)),n=B(u(0,o.sub(e),t)),a=u(1e-4);return B(Te(i,n)).add(a)});computeFresnel=f(([e=S(u(0,0,0)),t=u(0,0,0)])=>{const s=Me(Ae(d(1).sub(ie(K(t,e),0,1))));return this._uniforms.uFresnelScale.mul(s)});computeReflectionColor=f(([e=S(u(0,0,0)),t=u(0,0,0)])=>{let s=Pe(t,e);return s.x=s.x.negate(),Ie(w.envMapTexture,s)});computeColor=f(([e=S(u(0,0,0)),t=S(u(0,0,0)),s=S(u(0,0,0))])=>{const o=B(t.sub(z)),i=this.computeReflectionColor(e,o),n=this.computeFresnel(e,o),a=X(t.y.sub(this._uniforms.uTroughThreshold).div(this._uniforms.uTroughTransition.mul(2))),r=b(this._uniforms.uTroughColor,this._uniforms.uSurfaceColor,a),l=X(t.y.sub(this._uniforms.uPeakThreshold).div(this._uniforms.uPeakTransition.mul(2))),p=b(r,this._uniforms.uPeakColor,l),g=b(p,i.rgb,n),_=K(s.xz.sub(z.xz),s.xz.sub(z.xz)),A=10,P=55,x=b(0,1,V(A*A,P*P,_));return N(g,x)});createWaterMaterial(){this.precision="lowp";const e=this.computeElevation(H()).mul(1e3),t=this.computePosition(e),s=this.computeNormal(e),o=S(t,"vPosition"),i=S(s,"vNormal"),n=S(R,"vWorldPosition"),a=this.computeColor(i,o,n);this.transparent=!0,this.colorNode=a,this.positionNode=t}debugWaves(){const e=this.debugFolder.addFolder({title:"Waves"});e.addBinding(this._uniforms.uWavesAmplitude,"value",{min:0,max:.1,label:"Amplitude"}),e.addBinding(this._uniforms.uWavesFrequency,"value",{min:.1,max:10,label:"Frequency"}),e.addBinding(this._uniforms.uWavesSpeed,"value",{min:0,max:1,label:"Speed"})}debugColor(){const e=this.debugFolder.addFolder({title:"Color"});e.addBinding(this._uniforms.uTroughColor,"value",{label:"Trough Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uSurfaceColor,"value",{label:"Surface Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakColor,"value",{label:"Peak Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakThreshold,"value",{min:0,max:.5,label:"Peak Threshold"}),e.addBinding(this._uniforms.uPeakTransition,"value",{min:0,max:.5,label:"Peak Transition"}),e.addBinding(this._uniforms.uTroughThreshold,"value",{min:-.5,max:0,label:"Trough Threshold"}),e.addBinding(this._uniforms.uTroughTransition,"value",{min:0,max:.5,label:"Trough Transition"})}debugFresnel(){this.debugFolder.addFolder({title:"Fresnel"}).addBinding(this._uniforms.uFresnelScale,"value",{min:0,max:1,label:"Scale"})}}const wt=()=>Object.freeze({MAP_SIZE:256,HALF_MAP_SIZE:256/2,KINTOUN_ACTIVATION_THRESHOLD:2,HALF_FLOOR_THICKNESS:.3,OUTER_MAP_SIZE:256*3,OUTER_HALF_MAP_SIZE:256*1.5}),T=wt();class yt{world;scene;kintounRigidBody;kintounPosition=new y;outerFloorMesh;uTime=c(0);constructor(e){const{world:t,scene:s}=e;this.world=t,this.scene=s,this.createFloor(),this.createWater(),this.outerFloorMesh=this.createOuterFloorVisual(),this.scene.add(this.outerFloorMesh),this.kintounRigidBody=this.createKintoun()}createOuterFloorVisual(){const e=w.realmModel.scene.getObjectByName("outer_world");return e.geometry.computeVertexNormals(),e.material=new Mt,e}createFloor(){const e=w.realmModel.scene.getObjectByName("floor");e.material=new Tt({uTime:this.uTime}),e.receiveShadow=!0,this.scene.add(e),this.createFloorPhysics()}createWater(){const e=w.realmModel.scene.getObjectByName("lake"),t=new ft({uTime:this.uTime});e.material=t,this.scene.add(e)}getFloorDisplacementData(){const e=w.realmModel.scene.getObjectByName("heightfield"),t=e.geometry.attributes._displacement.array[0],s=e.geometry.attributes.position;e.geometry.boundingBox||e.geometry.computeBoundingBox();const o=e.geometry.boundingBox,i=s.count,n=Math.sqrt(i),a=o.max.x,r=new Float32Array(i);for(let l=0;l<i;l++){const p=s.array[l*3+0],g=s.array[l*3+1],_=s.array[l*3+2],A=Math.round((p/(a*2)+.5)*(n-1)),x=Math.round((_/(a*2)+.5)*(n-1))+A*n;r[x]=g}return{rowsCount:n,heights:r,displacement:t}}createFloorPhysics(){const e=this.getFloorDisplacementData(),{rowsCount:t,heights:s,displacement:o}=e,i=j.fixed().setTranslation(0,-o,0),n=this.world.createRigidBody(i),a=J.heightfield(t-1,t-1,s,{x:T.MAP_SIZE,y:1,z:T.MAP_SIZE},Je.FIX_INTERNAL_EDGES).setFriction(1).setRestitution(.2);this.world.createCollider(a,n)}createKintoun(){const e=j.kinematicPositionBased().setTranslation(0,-20,0),t=this.world.createRigidBody(e),s=2,o=J.cuboid(s,T.HALF_FLOOR_THICKNESS,s).setFriction(1).setRestitution(.2);return this.world.createCollider(o,t),t}useKintoun(e){this.kintounPosition.copy(e).setY(-T.HALF_FLOOR_THICKNESS),this.kintounRigidBody.setTranslation(this.kintounPosition,!0)}update(e){const{player:t,clock:s}=e;this.uTime.value=s.getElapsedTime();const o=T.HALF_MAP_SIZE-Math.abs(t.position.x)<T.KINTOUN_ACTIVATION_THRESHOLD,i=T.HALF_MAP_SIZE-Math.abs(t.position.z)<T.KINTOUN_ACTIVATION_THRESHOLD;(o||i)&&this.useKintoun(t.position);const n=T.MAP_SIZE,a=Math.abs(t.position.x),r=Math.sign(t.position.x),l=Math.abs(t.position.z),p=Math.sign(t.position.z),g=a>n?a-n:0,_=l>n?l-n:0;this.outerFloorMesh.position.set(g*r,0,_*p)}}const _t={uTime:c(0)};class Tt extends ne{_uniforms;constructor(e){super(),this._uniforms={..._t,...e},this.createMaterial()}computeCausticsDiffuse=f(([e=D(0,0),t=u(0,0,0)])=>{const s=this._uniforms.uTime.mul(.1),o=d(15),i=e.mul(o),n=v(i.add(D(s,0))),a=v(i.add(D(0,s.negate()))),r=M(w.voronoiNoiseTexture,n,1).r,l=M(w.voronoiNoiseTexture,a,2).r,p=r.add(l),g=ae(p,3),_=u(1.2,1.2,.8).mul(.15);return b(t,_,g)});computeWaterDiffuse=f(([e=d(0),t=D(0,0)])=>{const s=d(5),o=d(.001),i=V(0,s.add(o),e),n=F("#D8C098"),a=n.mul(.5),r=n.add(a.sub(n).mul(i)),l=this.computeCausticsDiffuse(t);return r.add(l)});createMaterial(){const e=R.xz.add(T.HALF_MAP_SIZE).div(T.MAP_SIZE),t=S(e),s=M(w.floorGrassWaterMap,t,2.5),o=s.g,i=s.b,a=d(1).sub(o).sub(i),r=M(w.randomNoiseTexture,e,2).r,l=b(F("#A3A16D"),F("#8C865A"),r).mul(o),p=b(F("#D8C098"),F("#B89A77"),r).mul(2.25).mul(a),g=S(R.y.negate()),A=this.computeWaterDiffuse(g,t).mul(i);this.colorNode=l.add(p).add(A);const P=v(e.mul(30)),x=v(e.mul(15)),L=M(w.sandNormalTexture,P),de=M(w.sandNormalTexture,x);this.normalNode=B(L.mul(de))}}class Mt extends ne{constructor(){super(),this.createMaterial()}createMaterial(){const e=R.xz.add(T.HALF_MAP_SIZE).div(T.MAP_SIZE),t=v(e),s=M(w.randomNoiseTexture,t,2).r,o=b(F("#A3A16D"),F("#8C865A"),s),i=v(e.mul(30)),n=v(e.mul(15)),a=M(w.sandNormalTexture,i),r=M(w.sandNormalTexture,n);this.normalNode=B(a.mul(r)),this.colorNode=o}}class ee{emitters=[];registerEmitter(e){this.emitters.push({position:c(e.position),hue:c(e.hue),intensity:c(e.intensity)})}material_computeSingleEmissiveLight=f(({position:e=u(0,0,0),hue:t=u(1,0,0),intensity:s=10})=>{const o=e.sub(R),i=o.length(),n=d(1).div(d(1).add(i.mul(.3).add(i.pow(2).mul(.5)))),a=.5,r=o.normalize(),l=re(0,K(be,r).mul(1-a).add(a));return t.mul(s).mul(l).mul(n)});material_computeEmissiveLight=f(()=>{let e=u(0);for(const t of this.emitters){const s=this.material_computeSingleEmissiveLight(t);e=e.add(s)}return e})}class At{directionalLight;ambientLight;emissive=new ee;LIGHT_POSITION_OFFSET=new y(10,20,10);target=new Le;constructor(e){this.emissive=new ee,e.add(this.target),this.directionalLight=this.setupDirectionalLighting(),e.add(this.directionalLight),this.ambientLight=this.setupAmbientLighting(),e.add(this.ambientLight)}setupAmbientLighting(){return new Ee("white",.4)}setupDirectionalLighting(){const e=new Se("white",1);return e.position.copy(this.LIGHT_POSITION_OFFSET),e.target=this.target,e.castShadow=!0,e.shadow.intensity=.75,e.shadow.mapSize.width=64,e.shadow.mapSize.height=64,e.shadow.radius=2,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.bias=-.003,e}material_computeIllumination=f(()=>u(0));update(e){const{player:t}=e;this.directionalLight.position.copy(t.position).add(this.LIGHT_POSITION_OFFSET),this.target.position.copy(t.position)}}class Pt{keysPressed;keyDownListeners;keyUpListeners;constructor(){this.keysPressed=new Set,this.keyDownListeners=new Map,this.keyUpListeners=new Map,window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this))}handleKeyDown(e){const t=e.key.toLowerCase();this.keysPressed.has(t)||(this.keysPressed.add(t),this.keyDownListeners.get(t)?.())}handleKeyUp(e){const t=e.key.toLowerCase();this.keysPressed.delete(t),this.keyUpListeners.get(t)?.()}isKeyPressed(e){return e==="*"?this.keysPressed.size>0:this.keysPressed.has(e.toLowerCase())}onKeyDown(e,t){this.keyDownListeners.set(e.toLowerCase(),t)}onKeyUp(e,t){this.keyUpListeners.set(e.toLowerCase(),t)}dispose(){window.removeEventListener("keydown",this.handleKeyDown.bind(this)),window.removeEventListener("keyup",this.handleKeyUp.bind(this))}}class It{stats;lastSecond=performance.now();drawCallsPanel;geometriesPanel;constructor(e){const t=new $({trackGPU:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,horizontal:!1,precision:2});e&&document.body.appendChild(t.dom),this.stats=t,this.drawCallsPanel=this.createNumberPanel("# DRAW CALLS","#fff","#333"),this.geometriesPanel=this.createNumberPanel("# GEOMETRIES","#ffdab9","#163843")}createNumberPanel(e,t,s){const o=this.stats.addPanel(new $.Panel(e,t,s));return o.update=i=>{const n=o.canvas.getContext("2d");if(!n)return;const{width:a,height:r}=o.canvas;n.clearRect(0,0,a,r),n.fillStyle=s,n.fillRect(0,0,a,r),n.fillStyle=t;const l=n.font;n.textAlign="left",n.textBaseline="top",n.fillText(o.name,4,4),n.font="bold 20px Arial",n.textAlign="center",n.textBaseline="middle",n.fillText(`${Math.round(i)}`,a/2,r/1.65),n.font=l},o}updateCustomPanels(e){const t=performance.now();if(t-this.lastSecond<1e3)return;const{render:s,memory:o}=e.info;this.drawCallsPanel.update(s.drawCalls,0),this.geometriesPanel.update(o.geometries,0),this.lastSecond=t}}class bt{composer;constructor(e,t){this.composer=new ve(e.renderer);const s=xe(t.scene,t.renderCamera);s.setMRT(Ce({output:Ne,emissive:Fe}));const o=s.getTextureNode("output"),i=s.getTextureNode("emissive"),n=De(i,.25,.1,.5),a=o.add(n);this.composer.outputNode=a,this.composer.needsUpdate=!0}}class Lt{renderer;canvas;monitoringManager;postprocessingManager;POSTPROCESSING_ENABLED=!1;MONITORING_ENABLED=!1;DEBUGGING_ENABLED=!1;constructor(){const e=document.createElement("canvas");e.classList.add("revo-realms"),document.body.appendChild(e),this.canvas=e;const t=new Re({canvas:e,antialias:!0,trackTimestamp:!1});t.shadowMap.enabled=!0,t.shadowMap.type=Be,t.toneMapping=Oe,t.toneMappingExposure=1.5,this.renderer=t,this.monitoringManager=new It(this.MONITORING_ENABLED),q.setVisibility(this.DEBUGGING_ENABLED)}async init(e){this.postprocessingManager=new bt(this,e),this.MONITORING_ENABLED&&await this.monitoringManager.stats.init(this.renderer)}async renderAsync(...e){this.MONITORING_ENABLED&&await this.renderer.resolveTimestampsAsync("compute"),this.POSTPROCESSING_ENABLED?await this.postprocessingManager.composer.renderAsync():await this.renderer.renderAsync(...e),this.MONITORING_ENABLED&&(this.monitoringManager.updateCustomPanels(this.renderer),await this.renderer.resolveTimestampsAsync("render"),this.monitoringManager.stats.update())}}class Et{scene;camera;cameraHelper;renderCamera;controls;orbitControlsCamera;constructor(e){const t=new Ue;this.scene=t;const s=window.innerWidth,o=window.innerHeight,i=s/o,n=new Ge(45,i,.01,100);n.position.set(0,5,10),this.camera=n,t.add(n);const a=new He(n);a.visible=!1,t.add(a),this.cameraHelper=a;const r=n.clone(),l=new Ve(r,e.canvas);r.near=.01,r.far=5e3,this.orbitControlsCamera=r,l.enableDamping=!0,l.maxPolarAngle=Math.PI/2.05,l.enabled=!1,this.controls=l,this.renderCamera=n,this.debug()}debug(){q.panel.addFolder({title:"\uD83C\uDFA5 View"}).addBinding(this.controls,"enabled",{label:"Enable orbit controls"}).on("change",({value:t})=>{this.renderCamera=t?this.orbitControlsCamera:this.camera,this.cameraHelper.visible=t})}update(){this.controls.enabled&&this.controls.update()}}const St=()=>({BLADE_WIDTH:.15,BLADE_HEIGHT:1.25,BLADE_BOUNDING_SPHERE_RADIUS:1.25,TILE_SIZE:150,TILE_HALF_SIZE:150/2,BLADES_PER_SIDE:700,COUNT:700*700,SPACING:150/700}),h=St(),vt={uTime:c(0),uPlayerPosition:c(new y(0,0,0)),uCameraMatrix:c(new le),uBladeMinScale:c(.5),uBladeMaxScale:c(1.25),uTrailGrowthRate:c(.004),uTrailMinScale:c(.1),uTrailRaius:c(.65),uTrailRaiusSquared:c(.65*.65),uGlowRadius:c(2),uGlowRadiusSquared:c(4),uGlowFadeIn:c(.05),uGlowFadeOut:c(.01),uGlowColor:c(new O(1,.6,.1)),uBladeMaxBendAngle:c(Math.PI*.15),uBaseColor:c(new O().setRGB(.05,.2,.01)),uTipColor:c(new O().setRGB(.5,.5,.1)),uDelta:c(new ce(0,0))};class xt extends oe{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...vt,...e},this._buffer1=Y(h.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=Y(h.COUNT,"vec4"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createGrassMaterial()}computeInit=f(()=>{const e=this._buffer1.element(I),t=k(d(I).div(h.BLADES_PER_SIDE)),s=d(I).mod(h.BLADES_PER_SIDE),o=G(I.add(4321)),i=G(I.add(1234)),n=s.mul(h.SPACING).sub(h.TILE_HALF_SIZE).add(o.mul(h.SPACING*.5)),a=t.mul(h.SPACING).sub(h.TILE_HALF_SIZE).add(i.mul(h.SPACING*.5)),r=u(n,0,a);e.x=n,e.y=a;const l=r.xz.add(h.TILE_HALF_SIZE).div(h.TILE_SIZE),p=d(2),g=v(l.mul(p)),A=M(w.randomNoiseTexture,g,1).r.sub(.5).mul(d(Math.PI*2));e.z=A;const P=this._buffer2.element(I),x=this._uniforms.uBladeMaxScale.sub(this._uniforms.uBladeMinScale),L=G(I.add(100)).mul(x).add(this._uniforms.uBladeMinScale);P.x=L,P.y=L})().compute(h.COUNT);computeVisibility=f(([e=u(0)])=>{const t=this._uniforms.uCameraMatrix.mul(N(e,1)),s=t.xyz.div(t.w),o=h.BLADE_BOUNDING_SPHERE_RADIUS,i=d(1);return E(i.negate().sub(o),s.x).mul(E(s.x,i.add(o))).mul(E(i.negate().sub(o),s.y)).mul(E(s.y,i.add(o))).mul(E(0,s.z)).mul(E(s.z,i))});computeBending=f(([e=N(0,0,0,0),t=u(0,0,0)])=>{const s=t.xz.add(this._uniforms.uTime.mul(.25)).mul(.5),o=v(s),n=M(w.perlinNoiseTexture,o,5).r.mul(.35);return e.w.add(n.sub(e.w).mul(.1))});computeAlpha=f(([e=u(0)])=>{const t=e.xz.add(T.HALF_MAP_SIZE).div(T.MAP_SIZE);return M(w.floorGrassWaterMap,t).g});computeTrailScale=f(([e=N(0),t=d(0)])=>{const s=e.x.add(this._uniforms.uTrailGrowthRate),o=d(1).sub(t),i=this._uniforms.uTrailMinScale.mul(t).add(s.mul(o));return ke(i,e.y)});computeTrailGlow=f(([e=N(0),t=d(0),s=d(0),o=d(0)])=>{const i=V(this._uniforms.uGlowRadiusSquared,d(0),t),n=100,a=k(W(this._uniforms.uDelta.x).mul(n)),r=k(W(this._uniforms.uDelta.y).mul(n)),l=E(1,a.add(r)),p=i.mul(d(1).sub(s)).mul(o),g=re(l,e.w).mul(p),_=g.mul(this._uniforms.uGlowFadeIn),A=d(1).sub(g).mul(this._uniforms.uGlowFadeOut),P=d(1).sub(l).mul(this._uniforms.uGlowFadeOut).mul(e.w);return ie(e.w.add(_).sub(A).sub(P),0,1)});computeUpdate=f(()=>{const e=this._buffer1.element(I),t=this._buffer2.element(I),s=Z(e.x.sub(this._uniforms.uDelta.x).add(h.TILE_HALF_SIZE),h.TILE_SIZE).sub(h.TILE_HALF_SIZE),o=Z(e.y.sub(this._uniforms.uDelta.y).add(h.TILE_HALF_SIZE),h.TILE_SIZE).sub(h.TILE_HALF_SIZE),i=u(s,0,o);e.x=s,e.y=o;const n=i.add(this._uniforms.uPlayerPosition),a=this.computeVisibility(n);t.z=a,We(a,()=>{const r=D(this._uniforms.uDelta.x,this._uniforms.uDelta.y),l=i.xz.sub(r),p=l.dot(l),g=E(.1,d(1).sub(this._uniforms.uPlayerPosition.y)),_=E(p,this._uniforms.uTrailRaiusSquared).mul(g);t.x=this.computeTrailScale(t,_),t.z=this.computeAlpha(n),e.w=this.computeBending(e,n),t.w=this.computeTrailGlow(t,p,_,g)})})().compute(h.COUNT);computePosition=f(([e=N(0),t=N(0)])=>{const s=u(e.x,0,e.y),o=e.z,i=e.w,n=t.x,a=i.mul(H().y),l=Q(C,u(a,0,0)).mul(u(1,n,1));return Q(l,u(0,o,0)).add(s)});computeDiffuseColor=f(([e=N(0)])=>{const t=ae(H().y,1.5),s=b(this._uniforms.uBaseColor,this._uniforms.uTipColor,t),o=G(I).mul(.05).sub(.025),i=e.w;return b(s.add(o),this._uniforms.uGlowColor,i)});computeAO=f(()=>{const e=W(se(this._buffer1.element(I).z)).mul(.5);return V(-.75,1.25,H().y).mul(d(1).sub(e))});createGrassMaterial(){this.precision="lowp",this.side=Ze;const e=this._buffer1.element(I),t=this._buffer2.element(I);this.positionNode=this.computePosition(e,t),this.opacityNode=t.z,this.alphaTest=.25,this.aoNode=this.computeAO(),this.colorNode=this.computeDiffuseColor(t)}async updateAsync(e){const{renderer:t}=e;await t.computeAsync(this.computeUpdate)}}class Ct{material;grassField;uniforms={uDelta:c(new ce(0,0)),uPlayerPosition:c(new y(0,0,0)),uCameraMatrix:c(new le),uTime:c(0)};constructor(e){const t=this.createBladeGeometry();t.instanceCount=h.COUNT,this.material=new xt(this.uniforms),this.grassField=new te(t,this.material),e.add(this.grassField)}createBladeGeometry(){const e=h.BLADE_WIDTH/2,t=e/2,s=h.BLADE_HEIGHT/2,o=new Float32Array([-e,0,0,e,0,0,-t,s*1,0,t,s*1,0,0,s*2,0]),i=new Float32Array([0,0,1,0,.25,s*1,.75,s*1,.5,s*2]),n=new Uint16Array([0,1,3,0,3,2,2,3,4]),r=25*Math.PI/180,l=Math.cos(r),p=Math.sin(r),_=15*Math.PI/180,A=Math.cos(_),P=Math.sin(_),x=new Float32Array([-l,p,0,l,p,0,-A,P,0,A,P,0,0,1,0]),L=new ze;return L.setAttribute("position",new U(o,3)),L.setAttribute("uv",new U(i,2)),L.setIndex(new U(n,1)),L.setAttribute("normal",new U(x,3)),L}async updateAsync(e){const{player:t,camera:s,clock:o}=e,i=t.position.x-this.grassField.position.x,n=t.position.z-this.grassField.position.z;this.uniforms.uDelta.value.set(i,n),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(s.projectionMatrix).multiply(s.matrixWorldInverse),this.uniforms.uTime.value=o.getElapsedTime(),this.grassField.position.copy(t.position).setY(0),await this.material.updateAsync(e)}}class Nt{rendererManager;sceneManager;inputManager;clock;world;player;realm;lighting;grass;constructor(){this.rendererManager=new Lt,this.sceneManager=new Et(this.rendererManager),this.inputManager=new Pt,this.clock=new Ke(!1),this.lighting=new At(this.sceneManager.scene),this.world=new qe({x:0,y:-9.81,z:0}),this.player=new ht({scene:this.sceneManager.scene,inputManager:this.inputManager,lighting:this.lighting,world:this.world}),this.realm=new yt({scene:this.sceneManager.scene,world:this.world}),this.grass=new Ct(this.sceneManager.scene)}getSizes(){const e=window.innerWidth,t=window.innerHeight;return{width:e,height:t,dpr:Math.min(window.devicePixelRatio,1.5),aspect:e/t}}onResize(){const e=this.getSizes();this.sceneManager.camera.aspect=e.aspect,this.sceneManager.camera.updateProjectionMatrix(),this.rendererManager.renderer.setSize(e.width,e.height),this.rendererManager.renderer.setPixelRatio(e.dpr)}async startLoop(){await this.rendererManager.init(this.sceneManager),this.clock.start();const e={clock:this.clock,scene:this.sceneManager.scene,camera:this.sceneManager.camera,inputManager:this.inputManager,lighting:this.lighting,world:this.world,player:this.player,renderer:this.rendererManager.renderer},t=async()=>{this.sceneManager.update(),this.world.step(),this.player.update(e),this.realm.update(e),this.lighting.update(e),this.grass.updateAsync(e),await this.rendererManager.renderAsync(this.sceneManager.scene,this.sceneManager.renderCamera)};new ResizeObserver(()=>{this.onResize()}).observe(document.body),this.rendererManager.renderer.setAnimationLoop(t)}}const Ft=new ut;Ft.initAsync().then(()=>{new Nt().startLoop()})})();