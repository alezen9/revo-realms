import{T as Pe,D as Ae,G as Ce,C as Me,L as ve,P as Fe,F as w,p as Re,b as De,W as Be,a as Ne,A as Oe,S as Ue,c as Ge,d as He,V as x,e as We,f as ze,O as ke,t as I,v as U,g as f,u as a,M as j,h as D,i as W,j as Ze,k as A,I as ye,l as O,m as y,n as R,o as de,q as ce,r as Ve,s as m,w as _e,x as te,y as z,z as M,B as oe,E as ie,H as Te,J as je,K as Q,N as be,Q as se,R as q,U as v,X as S,Y as Ke,Z as ae,_ as qe,$ as V,a0 as Ee,a1 as ue,a2 as N,a3 as X,a4 as Xe,a5 as Je,a6 as ee,a7 as Ye,a8 as $e,a9 as Qe,aa as et,ab as tt,ac as le,ad as fe,ae as st,af as ot,ag as it,ah as nt}from"./three-BR4N-OmE.js";import{World as rt,RigidBodyDesc as J,ColliderDesc as Y,HeightFieldFlags as at,Ray as lt,__tla as __tla_0}from"./@dimforge-Tx9Ov1ko.js";import{P as ct}from"./tweakpane-BXg6ZhiP.js";import{S as we}from"./stats-gl-C2M3amu4.js";import{e as ut}from"./tseep-DsfRTLTM.js";Promise.all([(()=>{try{return __tla_0}catch{}})()]).then(async()=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();const dt="/revo-realms/textures/noise/noise.webp",mt="/revo-realms/models/realm.glb",ht="/revo-realms/textures/realm/water_grass_map.webp",pt="/revo-realms/textures/realm/sand_nor.webp",ft="/revo-realms/textures/realm/leaf.webp",wt="/revo-realms/textures/realm/water_lilies.webp",gt="/revo-realms/textures/realm/water_lilies_alpha.webp",yt="/revo-realms/textures/realm/grass_diff.webp",_t="/revo-realms/textures/realm/grass_nor.webp",Tt="/revo-realms/textures/realm/flower_composition_1.webp",bt="/revo-realms/textures/realm/flower_composition_2.webp",Et="/revo-realms/textures/realm/lightmap.webp",xt="/revo-realms/textures/realm/rock_diff.webp",It="/revo-realms/textures/realm/stone_diff.webp",Lt="/revo-realms/textures/environment/px.webp",St="/revo-realms/textures/environment/nx.webp",Pt="/revo-realms/textures/environment/py.webp",At="/revo-realms/textures/environment/ny.webp",Ct="/revo-realms/textures/environment/pz.webp",Mt="/revo-realms/textures/environment/nz.webp";class vt{textureLoader;gltfLoader;cubeTextureLoader;noiseTexture;envMapTexture;floorGrassWaterMap;sandNormalTexture;leafTexture;waterLiliesTexture;waterLiliesAlphaTexture;grassDiffTexture;grassNorTexture;flowerCompositionTexture_1;flowerCompositionTexture_2;lightmapTexture;rockDiffTexture;stoneDifflTexture;realmModel;constructor(){const e=this.createLoadingManager();this.textureLoader=new Pe(e);const t=new Ae(e);t.setDecoderPath("/revo-realms/draco/"),this.gltfLoader=new Ce(e),this.gltfLoader.setDRACOLoader(t),this.cubeTextureLoader=new Me(e)}createLoadingManager(){const e=new ve;e.onStart=function(t,s,o){console.log("Started loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onLoad=function(){console.log("Loading complete!")},e.onProgress=function(t,s,o){console.log("Loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onError=function(t){console.log("There was an error loading "+t)}}async initAsync(){const e=await Promise.all([h.cubeTextureLoader.loadAsync([Lt,St,Pt,At,Ct,Mt]),this.textureLoader.loadAsync(dt),this.gltfLoader.loadAsync(mt),this.textureLoader.loadAsync(ht),this.textureLoader.loadAsync(pt),this.textureLoader.loadAsync(ft),this.textureLoader.loadAsync(wt),this.textureLoader.loadAsync(gt),this.textureLoader.loadAsync(yt),this.textureLoader.loadAsync(_t),this.textureLoader.loadAsync(Tt),this.textureLoader.loadAsync(bt),this.textureLoader.loadAsync(Et),this.textureLoader.loadAsync(xt),this.textureLoader.loadAsync(It)]);this.envMapTexture=e[0],this.noiseTexture=e[1],this.realmModel=e[2],this.floorGrassWaterMap=e[3],this.floorGrassWaterMap.flipY=!1,this.sandNormalTexture=e[4],this.leafTexture=e[5],this.waterLiliesTexture=e[6],this.waterLiliesTexture.flipY=!1,this.waterLiliesTexture.generateMipmaps=!1,this.waterLiliesAlphaTexture=e[7],this.waterLiliesAlphaTexture.flipY=!1,this.waterLiliesAlphaTexture.generateMipmaps=!1,this.grassDiffTexture=e[8],this.grassDiffTexture.generateMipmaps=!1,this.grassNorTexture=e[9],this.grassNorTexture.generateMipmaps=!1,this.flowerCompositionTexture_1=e[10],this.flowerCompositionTexture_2=e[11],this.lightmapTexture=e[12],this.lightmapTexture.flipY=!1,this.lightmapTexture.generateMipmaps=!1,this.rockDiffTexture=e[13],this.stoneDifflTexture=e[14]}}const h=new vt,Ft="modulepreload",Rt=function(u){return"/revo-realms/"+u},ge={},Dt=function(e,t,s){let o=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),r=n?.nonce||n?.getAttribute("nonce");o=Promise.allSettled(t.map(c=>{if(c=Rt(c),c in ge)return;ge[c]=!0;const l=c.endsWith(".css"),p=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${p}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":Ft,l||(d.as="script"),d.crossOrigin="",d.href=c,r&&d.setAttribute("nonce",r),document.head.appendChild(d),l)return new Promise((_,b)=>{d.addEventListener("load",_),d.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(n){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=n,window.dispatchEvent(r),!r.defaultPrevented)throw n}return o.then(n=>{for(const r of n||[])r.status==="rejected"&&i(r.reason);return e().catch(i)})};class Bt{world;constructor(){}async init(){return Dt(()=>import("./@dimforge-Tx9Ov1ko.js").then(async m=>{await m.__tla;return m}),[]).then(()=>{this.world=new rt({x:0,y:-9.81,z:0})})}update(){this.world.step()}}const P=new Bt;class Nt{async initAsync(){await Promise.all([P.init(),h.initAsync()])}}class Ot{keysPressed;keyDownListeners;keyUpListeners;constructor(){this.keysPressed=new Set,this.keyDownListeners=new Map,this.keyUpListeners=new Map,window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this))}handleKeyDown(e){const t=e.key.toLowerCase();this.keysPressed.has(t)||(this.keysPressed.add(t),this.keyDownListeners.get(t)?.())}handleKeyUp(e){const t=e.key.toLowerCase();this.keysPressed.delete(t),this.keyUpListeners.get(t)?.()}isKeyPressed(e){return e==="*"?this.keysPressed.size>0:this.keysPressed.has(e.toLowerCase())}onKeyDown(e,t){this.keyDownListeners.set(e.toLowerCase(),t)}onKeyUp(e,t){this.keyUpListeners.set(e.toLowerCase(),t)}dispose(){window.removeEventListener("keydown",this.handleKeyDown.bind(this)),window.removeEventListener("keyup",this.handleKeyUp.bind(this))}}const G=new Ot;class Ut{panel;constructor(){this.panel=new ct({title:"Revo Realms"}),this.panel.hidden=!0,this.panel.element.parentElement.style.zIndex="1",this.panel.element.parentElement.style.width="340px"}setVisibility(e){this.panel.hidden=!e}}const Z=new Ut;class Gt{stats;lastSecond=performance.now();drawCallsPanel;trianglesPanel;constructor(e){const t=new we({trackGPU:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,horizontal:!1,precision:2});e&&document.body.appendChild(t.dom),this.stats=t,this.drawCallsPanel=this.createNumberPanel("# DRAW CALLS","#fff","#333"),this.trianglesPanel=this.createNumberPanel("# TRIANGLES","#ffdab9","#163843")}createNumberPanel(e,t,s){const o=this.stats.addPanel(new we.Panel(e,t,s));return o.update=i=>{const n=o.canvas.getContext("2d");if(!n)return;const{width:r,height:c}=o.canvas;n.clearRect(0,0,r,c),n.fillStyle=s,n.fillRect(0,0,r,c),n.fillStyle=t;const l=n.font;n.textAlign="left",n.textBaseline="top",n.fillText(o.name,4,4),n.font="bold 20px Arial",n.textAlign="center",n.textBaseline="middle";const p=Ht.format(i);n.fillText(`${p}`,r/2,c/1.65),n.font=l},o}updateCustomPanels(){const e=performance.now();if(e-this.lastSecond<1e3)return;const{render:t}=H.renderer.info;this.drawCallsPanel.update(t.drawCalls,0),this.trianglesPanel.update(t.triangles,0),this.lastSecond=e}}const Ht=new Intl.NumberFormat("en-US",{notation:"compact"});class Wt{composer;constructor(){this.composer=new Fe(H.renderer),this.composer.outputNode=this.getPasses()}getPasses=w(()=>{const e=Re(T.scene,T.renderCamera),t=e.getTextureNode();return De(t,.25,.1,.5).add(e)})}class zt{renderer;canvas;monitoringManager;postprocessingManager;POSTPROCESSING_ENABLED=!1;MONITORING_ENABLED=!1;DEBUGGING_ENABLED=!1;constructor(){const e=document.createElement("canvas");e.classList.add("revo-realms"),document.body.appendChild(e),this.canvas=e;const t=new Be({canvas:e,antialias:!0,trackTimestamp:!1,powerPreference:"high-performance",stencil:!1,depth:!0});t.shadowMap.enabled=!0,t.shadowMap.type=Ne,t.toneMapping=Oe,t.outputColorSpace=Ue,t.setClearColor(0,1),t.toneMappingExposure=1.5,this.renderer=t,this.monitoringManager=new Gt(this.MONITORING_ENABLED),Z.setVisibility(this.DEBUGGING_ENABLED)}async init(){this.postprocessingManager=new Wt,this.MONITORING_ENABLED&&await this.monitoringManager.stats.init(this.renderer)}async renderAsync(){this.MONITORING_ENABLED&&await this.renderer.resolveTimestampsAsync("compute"),this.POSTPROCESSING_ENABLED?await this.postprocessingManager.composer.renderAsync():await this.renderer.renderAsync(T.scene,T.renderCamera),this.MONITORING_ENABLED&&(this.monitoringManager.updateCustomPanels(),await this.renderer.resolveTimestampsAsync("render"),this.monitoringManager.stats.update())}}const H=new zt;class kt{scene;camera;renderCamera;cameraHelper;controls;orbitControlsCamera;constructor(){const e=new Ge;this.scene=e;const t=window.innerWidth,s=window.innerHeight,o=t/s,i=new He(45,o,.01,150);i.position.set(0,5,10),this.camera=i,e.add(i),this.renderCamera=i}debugScene(){if(!this.controls)return;Z.panel.addFolder({title:"\uD83C\uDFA5 View"}).addBinding(this.controls,"enabled",{label:"Enable orbit controls"}).on("change",({value:t})=>{!this.cameraHelper||!this.orbitControlsCamera||(this.renderCamera=t?this.orbitControlsCamera:this.camera,this.cameraHelper.visible=t)})}update(){this.controls?.enabled&&this.controls.update()}}const T=new kt,k=new ut.EventEmitter,K={LIGHT_POSITION_OFFSET:new x(1,1,1)};class Zt{directionalLight;ambientLight;constructor(){this.directionalLight=this.setupDirectionalLighting(),T.scene.add(this.directionalLight),this.ambientLight=this.setupAmbientLighting(),T.scene.add(this.ambientLight),k.on("update",this.update.bind(this)),this.debugLight()}setupAmbientLighting(){const e=new We;return e.intensity=.4,e.color.setRGB(1,.95,.6),e}setupDirectionalLighting(){const e=new ze;e.intensity=.7,e.color.setRGB(1,.66,.47),e.position.copy(K.LIGHT_POSITION_OFFSET),e.target=new ke,e.castShadow=!0,e.shadow.mapSize.set(64,64);const t=1;return e.shadow.intensity=.85,e.shadow.radius=3,e.shadow.camera.left=-t,e.shadow.camera.right=t,e.shadow.camera.top=t,e.shadow.camera.bottom=-t,e.shadow.camera.near=.01,e.shadow.camera.far=15,e.shadow.normalBias=.1,e.shadow.bias=-.001,e}getBakedMapShadowColor=w(([e=U(0)])=>I(h.lightmapTexture,e).add(this.directionalLight.intensity));get shadowIntensity(){return this.directionalLight.shadow.intensity}debugLight(){const e=Z.panel.addFolder({title:"\uD83D\uDCA1 Light"});e.expanded=!1,e.addBinding(K.LIGHT_POSITION_OFFSET,"x",{label:"Sun position X"}),e.addBinding(K.LIGHT_POSITION_OFFSET,"z",{label:"Sun position Z"}),e.addBinding(K.LIGHT_POSITION_OFFSET,"y",{label:"Sun height"}),e.addBinding(this.directionalLight,"color",{label:"Directional Color",view:"color",color:{type:"float"}}),e.addBinding(this.directionalLight,"intensity",{min:0,max:1,label:"Directional intensity"}),e.addBinding(this.ambientLight,"color",{label:"Ambient Color",view:"color",color:{type:"float"}}),e.addBinding(this.ambientLight,"intensity",{min:0,max:1,label:"Ambient intensity"})}material_computeIllumination=w(()=>f(0));setTarget(e){this.directionalLight.target=e}update(e){const{player:t}=e;this.directionalLight.position.copy(t.position).add(K.LIGHT_POSITION_OFFSET)}}const me=new Zt,xe={uRandom:a(0)};class Vt extends j{_uniforms;constructor(e){super(),this._uniforms={...xe,...e},this.createMaterial()}setRandomSeed(e){this._uniforms.uRandom.value=e}createMaterial(){this.precision="lowp",this.flatShading=!1;const e=D(W().add(this._uniforms.uRandom).mul(5)),t=I(h.stoneDifflTexture,e);this.colorNode=t.mul(.85)}}class jt{uniforms=xe;constructor(){const e=new Vt(this.uniforms),t=h.realmModel.scene.children.filter(({name:o})=>o.endsWith("_monument"));t.forEach((o,i)=>{const n=Ze.seededRandom(i);o.material=e,o.receiveShadow=!0,o.onBeforeRender=(r,c,l,p,d)=>{d.setRandomSeed(n)}}),T.scene.add(...t),h.realmModel.scene.children.filter(({name:o})=>o.startsWith("monument_collider")).forEach(o=>{const i=J.fixed().setTranslation(...o.position.toArray()).setRotation(o.quaternion),n=P.world.createRigidBody(i),r=.5*o.scale.x,c=.5*o.scale.y,l=.5*o.scale.z,p=Y.cuboid(r,c,l).setRestitution(.25);P.world.createCollider(p,n)})}}const Ie={uBaseColor:a(new A().setRGB(.57,.57,.57))};class Kt extends j{_uniforms;constructor(e){super(),this._uniforms={...Ie,...e},this.createMaterial()}createMaterial(){this.precision="lowp",this.flatShading=!1;const e=O(y),t=I(h.noiseTexture,D(W().add(e).mul(5))),s=R(t.b,t.r,.15),o=this._uniforms.uBaseColor.add(s),i=de(ce(Ve,f(0,1,0)),.4,.5),n=o.mul(i);this.colorNode=n}}class qt{uniforms=Ie;constructor(){const e=h.realmModel.scene.getObjectByName("rock"),t=h.realmModel.scene.children.filter(({name:i})=>i.startsWith("rock_collider")),s=new Kt(this.uniforms),o=new ye(e.geometry,s,t.length);o.receiveShadow=!0,t.forEach((i,n)=>{const r=Math.random()*Math.PI*2;i.rotateY(r),i.updateMatrix(),o.setMatrixAt(n,i.matrix);const c=J.fixed().setTranslation(...i.position.toArray()).setRotation(i.quaternion),l=P.world.createRigidBody(c),p=.5*i.scale.y,d=Y.ball(p).setRestitution(.15);P.world.createCollider(d,l)}),T.scene.add(o),this.debugMonument()}debugMonument(){const e=Z.panel.addFolder({title:"\uD83E\uDEA8 Rocks"});e.expanded=!1,e.addBinding(this.uniforms.uBaseColor,"value",{label:"Color",view:"color",color:{type:"float"}})}}const Xt={uTime:a(0),uGrassTerrainColor:a(new A),uWaterSandColor:a(new A),uPathSandColor:a(new A)};class Jt extends j{_uniforms;constructor(e){super(),this._uniforms={...Xt,...e},this.createMaterial()}computeCausticsDiffuse=w(([e=U(0,0),t=f(0,0,0)])=>{const s=this._uniforms.uTime.mul(.1),o=m(15),i=e.mul(o),n=D(i.add(U(s,0))),r=D(i.add(U(0,s.negate()))),c=I(h.noiseTexture,n,1).g,l=I(h.noiseTexture,r,2).g,p=c.add(l),d=_e(p,3),_=f(1.2,1.2,.8).mul(.15);return R(t,_,d)});computeWaterDiffuse=w(([e=m(0),t=U(0,0)])=>{const s=m(5),o=m(.001),i=te(0,s.add(o),e),n=this._uniforms.uWaterSandColor,r=n.mul(.5),c=n.add(r.sub(n).mul(i)),l=this.computeCausticsDiffuse(t);return c.add(l)});createMaterial(){this.flatShading=!1;const e=ne.computeMapUvByPosition(z.xz),t=M(e);this.aoMap=h.lightmapTexture,this.aoMapIntensity=me.shadowIntensity;const s=I(h.floorGrassWaterMap,t,2.5),o=s.g,i=s.b,r=m(1).sub(o).sub(i),c=I(h.sandNormalTexture,D(t.mul(30))),l=D(t.mul(20)),d=I(h.grassNorTexture,l).dot(c).mul(.65),_=I(h.grassDiffTexture,l),b=m(1).sub(_.a),L=this._uniforms.uGrassTerrainColor.mul(b).add(_).mul(o).mul(.85),C=this._uniforms.uPathSandColor.mul(1.2).mul(r),B=M(z.y.negate()),$=this.computeWaterDiffuse(B,t).mul(i),re=L.add(C.mul(d)).add($.mul(d).mul(.5));this.colorNode=re}}class Yt{constructor(e){const t=this.createFloor();t.material=e,T.scene.add(t)}createFloor(){const e=h.realmModel.scene.getObjectByName("floor");return e.receiveShadow=!0,this.createFloorPhysics(),e}getFloorDisplacementData(){const e=h.realmModel.scene.getObjectByName("heightfield"),t=e.geometry.attributes._displacement.array[0],s=e.geometry.attributes.position;e.geometry.boundingBox||e.geometry.computeBoundingBox();const o=e.geometry.boundingBox,i=s.count,n=Math.sqrt(i),r=o.max.x,c=new Float32Array(i);for(let l=0;l<i;l++){const p=s.array[l*3+0],d=s.array[l*3+1],_=s.array[l*3+2],b=Math.round((p/(r*2)+.5)*(n-1)),C=Math.round((_/(r*2)+.5)*(n-1))+b*n;c[C]=d}return{rowsCount:n,heights:c,displacement:t}}createFloorPhysics(){const e=this.getFloorDisplacementData(),{rowsCount:t,heights:s,displacement:o}=e,i=J.fixed().setTranslation(0,-o,0),n=P.world.createRigidBody(i),r=Y.heightfield(t-1,t-1,s,{x:F.MAP_SIZE,y:1,z:F.MAP_SIZE},at.FIX_INTERNAL_EDGES).setFriction(1).setRestitution(.2);P.world.createCollider(r,n)}}class $t{outerFloor;kintoun;kintounPosition=new x;constructor(e){this.outerFloor=this.createOuterFloorVisual(),this.outerFloor.material=e,this.kintoun=this.createKintoun(),T.scene.add(this.outerFloor)}createOuterFloorVisual(){const e=h.realmModel.scene.getObjectByName("outer_world");return e.receiveShadow=!0,e}createKintoun(){const e=J.kinematicPositionBased().setTranslation(0,-20,0),t=P.world.createRigidBody(e),s=2,o=Y.cuboid(s,F.HALF_FLOOR_THICKNESS,s).setFriction(1).setRestitution(.2);return P.world.createCollider(o,t),t}useKintoun(e){this.kintounPosition.copy(e).setY(-F.HALF_FLOOR_THICKNESS),this.kintoun.setTranslation(this.kintounPosition,!0)}update(e){const{player:t}=e,s=F.HALF_MAP_SIZE-Math.abs(t.position.x)<F.KINTOUN_ACTIVATION_THRESHOLD,o=F.HALF_MAP_SIZE-Math.abs(t.position.z)<F.KINTOUN_ACTIVATION_THRESHOLD;(s||o)&&this.useKintoun(t.position);const i=F.MAP_SIZE,n=Math.abs(t.position.x),r=Math.sign(t.position.x),c=Math.abs(t.position.z),l=Math.sign(t.position.z),p=n>i?n-i:0,d=c>i?c-i:0;this.outerFloor.position.set(p*r,0,d*l)}}class Qt{outerTerrain;uniforms={uTime:a(0),uGrassTerrainColor:a(new A().setRGB(.431,.302,.122)),uWaterSandColor:a(new A().setRGB(.54,.39,.2)),uPathSandColor:a(new A().setRGB(.65,.49,.27))};constructor(){const e=new Jt(this.uniforms);new Yt(e),this.outerTerrain=new $t(e),k.on("update",this.update.bind(this)),this.debugTerrain()}debugTerrain(){const e=Z.panel.addFolder({title:"⛰️ Terrain"});e.expanded=!1,e.addBinding(this.uniforms.uPathSandColor,"value",{label:"Path color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWaterSandColor,"value",{label:"Water bed color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGrassTerrainColor,"value",{label:"Grass terrain color",view:"color",color:{type:"float"}})}update(e){const{clock:t}=e;this.uniforms.uTime.value=t.getElapsedTime(),this.outerTerrain.update(e)}}const es=()=>({BLADE_WIDTH:.085,BLADE_HEIGHT:1.25,BLADE_BOUNDING_SPHERE_RADIUS:1.25,TILE_SIZE:150,TILE_HALF_SIZE:150/2,BLADES_PER_SIDE:500,COUNT:500*500,SPACING:150/500}),g=es(),Le={uTime:a(0),uPlayerPosition:a(new x(0,0,0)),uCameraMatrix:a(new oe),uBladeMinScale:a(.5),uBladeMaxScale:a(1.25),uTrailGrowthRate:a(.004),uTrailMinScale:a(.25),uTrailRaius:a(.65),uTrailRaiusSquared:a(.65*.65),uGlowRadius:a(2),uGlowRadiusSquared:a(4),uGlowFadeIn:a(.05),uGlowFadeOut:a(.01),uGlowColor:a(new A().setRGB(1,.6,.1)),uBladeMaxBendAngle:a(Math.PI*.15),uWindStrength:a(.45),uBaseColor:a(new A().setRGB(.15,.2,.05)),uTipColor:a(new A().setRGB(.35,.35,.05)),uDelta:a(new ie(0,0))};class ts extends be{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...Le,...e},this._buffer1=se(g.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=se(g.COUNT,"vec4"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createGrassMaterial()}computeInit=w(()=>{const e=this._buffer1.element(y),t=q(m(y).div(g.BLADES_PER_SIDE)),s=m(y).mod(g.BLADES_PER_SIDE),o=O(y.add(4321)),i=O(y.add(1234)),n=s.mul(g.SPACING).sub(g.TILE_HALF_SIZE).add(o.mul(g.SPACING*.5)),r=t.mul(g.SPACING).sub(g.TILE_HALF_SIZE).add(i.mul(g.SPACING*.5)),c=f(n,0,r).xz.add(g.TILE_HALF_SIZE).div(g.TILE_SIZE).abs(),l=I(h.noiseTexture,c),p=l.b.sub(.5).mul(30),d=l.g.sub(.5).mul(10);e.x=n.add(p),e.y=r.add(d);const b=f(e.x,0,e.y).xz.add(g.TILE_HALF_SIZE).div(g.TILE_SIZE),L=m(20),C=D(b.mul(L)),he=I(h.noiseTexture,C,1).b.sub(.5).mul(m(Math.PI*2));e.z=he;const $=this._buffer2.element(y),re=this._uniforms.uBladeMaxScale.sub(this._uniforms.uBladeMinScale),pe=O(y.add(100)).mul(re).add(this._uniforms.uBladeMinScale);$.x=pe,$.y=pe})().compute(g.COUNT);computeVisibility=w(([e=f(0)])=>{const t=this._uniforms.uCameraMatrix.mul(v(e,1)),s=t.xyz.div(t.w),o=g.BLADE_BOUNDING_SPHERE_RADIUS,i=m(1);return S(i.negate().sub(o),s.x).mul(S(s.x,i.add(o))).mul(S(i.negate().sub(o),s.y)).mul(S(s.y,i.add(o))).mul(S(0,s.z)).mul(S(s.z,i))});computeBending=w(([e=v(0,0,0,0),t=f(0,0,0)])=>{const s=t.xz.add(this._uniforms.uTime.mul(.25)).mul(.5),o=D(s),n=I(h.noiseTexture,o,5).r.mul(this._uniforms.uWindStrength);return e.w.add(n.sub(e.w).mul(.1))});computeAlpha=w(([e=f(0)])=>{const t=ne.computeMapUvByPosition(e.xz);return I(h.floorGrassWaterMap,t).g});computeTrailScale=w(([e=v(0),t=m(0)])=>{const s=e.x.add(this._uniforms.uTrailGrowthRate),o=m(1).sub(t),i=this._uniforms.uTrailMinScale.mul(t).add(s.mul(o));return Ke(i,e.y)});computeTrailGlow=w(([e=v(0),t=m(0),s=m(0),o=m(0)])=>{const i=te(this._uniforms.uGlowRadiusSquared,m(0),t),n=100,r=q(ae(this._uniforms.uDelta.x).mul(n)),c=q(ae(this._uniforms.uDelta.y).mul(n)),l=S(1,r.add(c)),p=i.mul(m(1).sub(s)).mul(o),d=qe(l,e.w).mul(p),_=d.mul(this._uniforms.uGlowFadeIn),b=m(1).sub(d).mul(this._uniforms.uGlowFadeOut),L=m(1).sub(l).mul(this._uniforms.uGlowFadeOut).mul(e.w);return de(e.w.add(_).sub(b).sub(L),0,1)});computeUpdate=w(()=>{const e=this._buffer1.element(y),t=this._buffer2.element(y),s=V(e.x.sub(this._uniforms.uDelta.x).add(g.TILE_HALF_SIZE),g.TILE_SIZE).sub(g.TILE_HALF_SIZE),o=V(e.y.sub(this._uniforms.uDelta.y).add(g.TILE_HALF_SIZE),g.TILE_SIZE).sub(g.TILE_HALF_SIZE),i=f(s,0,o);e.x=s,e.y=o;const n=i.add(this._uniforms.uPlayerPosition),r=this.computeVisibility(n);t.z=r,Ee(r,()=>{const c=U(this._uniforms.uDelta.x,this._uniforms.uDelta.y),l=i.xz.sub(c),p=l.dot(l),d=S(.1,m(1).sub(this._uniforms.uPlayerPosition.y)),_=S(p,this._uniforms.uTrailRaiusSquared).mul(d);t.x=this.computeTrailScale(t,_),t.z=this.computeAlpha(n),e.w=this.computeBending(e,n),t.w=this.computeTrailGlow(t,p,_,d)})})().compute(g.COUNT);computePosition=w(([e=v(0),t=v(0)])=>{const s=f(e.x,0,e.y),o=e.z,i=e.w,n=t.x,r=i.mul(W().y),l=ue(N,f(r,0,0)).mul(f(1,n,1)),p=ue(l,f(0,o,0)),d=O(y).mul(6.28),_=X(this._uniforms.uTime.mul(5).add(e.w).add(d)).mul(.1),b=W().y.mul(t.w),L=_.mul(b);return p.add(s).add(f(L))});computeDiffuseColor=w(([e=v(0)])=>{const t=_e(W().y,1.5),s=R(this._uniforms.uBaseColor,this._uniforms.uTipColor,t),o=O(y).mul(.05).sub(.025),i=e.w;return R(s.add(o),this._uniforms.uGlowColor.mul(.5),i)});computeAO=w(([e=v(0)])=>{const t=ae(X(e.z)).mul(.5);return te(-.75,1.25,W().y).mul(m(1).sub(t))});createGrassMaterial(){this.precision="lowp",this.side=Xe;const e=this._buffer1.element(y),t=this._buffer2.element(y);Je(t.z.equal(0)),this.positionNode=this.computePosition(e,t),this.opacityNode=t.z,this.alphaTest=.25,this.aoNode=this.computeAO(e),this.colorNode=this.computeDiffuseColor(t)}async updateAsync(){await H.renderer.computeAsync(this.computeUpdate)}}class ss{material;grassField;uniforms={...Le,uDelta:a(new ie(0,0)),uPlayerPosition:a(new x(0,0,0)),uCameraMatrix:a(new oe),uTime:a(0)};constructor(){const e=this.createBladeGeometry();e.instanceCount=g.COUNT,this.material=new ts(this.uniforms),this.grassField=new Te(e,this.material),T.scene.add(this.grassField),k.on("update",this.updateAsync.bind(this)),this.debugGrass()}debugGrass(){const e=Z.panel.addFolder({title:"\uD83C\uDF31 Grass"});e.expanded=!1,e.addBinding(this.uniforms.uTipColor,"value",{label:"Tip Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGlowColor,"value",{label:"Glow Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWindStrength,"value",{label:"Wind strength",min:0,max:Math.PI/2,step:.1})}createBladeGeometry(){const e=g.BLADE_WIDTH/2,t=e/2,s=g.BLADE_HEIGHT/2,o=new Float32Array([-e,0,0,e,0,0,-t,s*1,0,t,s*1,0,0,s*2,0]),i=new Float32Array([0,0,1,0,.25,s*1,.75,s*1,.5,s*2]),n=new Uint16Array([0,1,3,0,3,2,2,3,4]),c=25*Math.PI/180,l=Math.cos(c),p=Math.sin(c),_=15*Math.PI/180,b=Math.cos(_),L=Math.sin(_),C=new Float32Array([-l,p,0,l,p,0,-b,L,0,b,L,0,0,1,0]),B=new je;return B.setAttribute("position",new Q(o,3)),B.setAttribute("uv",new Q(i,2)),B.setIndex(new Q(n,1)),B.setAttribute("normal",new Q(C,3)),B}async updateAsync(e){const{player:t,clock:s}=e,o=t.position.x-this.grassField.position.x,i=t.position.z-this.grassField.position.z;this.uniforms.uDelta.value.set(o,i),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(T.camera.projectionMatrix).multiply(T.camera.matrixWorldInverse),this.uniforms.uTime.value=s.getElapsedTime(),this.grassField.position.copy(t.position).setY(0),await this.material.updateAsync()}}const os=()=>({FLOWER_WIDTH:1,FLOWER_HEIGHT:1,BLADE_BOUNDING_SPHERE_RADIUS:1,TILE_SIZE:150,TILE_HALF_SIZE:150/2,FLOWERS_PER_SIDE:30,COUNT:30*30,SPACING:150/30}),E=os();class is{flowerField;material;uniforms={...Se,uDelta:a(new ie(0,0)),uPlayerPosition:a(new x(0,0,0)),uCameraMatrix:a(new oe),uTime:a(0)};constructor(){const e=h.realmModel.scene.getObjectByName("flowers_plane");e.geometry.translate(0,.35,0),this.material=new ns(this.uniforms),this.flowerField=new ye(e.geometry,this.material,E.COUNT),T.scene.add(this.flowerField),k.on("update",this.updateAsync.bind(this))}async updateAsync(e){const{player:t,clock:s}=e,o=t.position.x-this.flowerField.position.x,i=t.position.z-this.flowerField.position.z;this.uniforms.uDelta.value.set(o,i),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(T.camera.projectionMatrix).multiply(T.camera.matrixWorldInverse),this.uniforms.uTime.value=s.getElapsedTime(),this.flowerField.position.copy(t.position).setY(0),await this.material.updateAsync()}}const Se={uTime:a(0),uPlayerPosition:a(new x(0,0,0)),uCameraMatrix:a(new oe),uFlowersMinScale:a(.75),uFlowersMaxScale:a(1),uDelta:a(new ie(0,0))};class ns extends j{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...Se,...e},this._buffer1=se(E.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=se(E.COUNT,"float"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createFlowerMaterial()}computeInit=w(()=>{const e=this._buffer1.element(y),t=q(m(y).div(E.FLOWERS_PER_SIDE)),s=m(y).mod(E.FLOWERS_PER_SIDE),o=O(y.add(4321)),i=O(y.add(1234)),n=s.mul(E.SPACING).sub(E.TILE_HALF_SIZE).add(o.mul(E.SPACING*.5)),r=t.mul(E.SPACING).sub(E.TILE_HALF_SIZE).add(i.mul(E.SPACING*.5)),c=f(n,0,r).xz.add(E.TILE_HALF_SIZE).div(E.TILE_SIZE).abs(),l=I(h.noiseTexture,c),p=R(l.r,l.b,.75),d=p.sub(.5).mul(100),_=p.sub(.5).mul(50);e.x=n.add(d),e.y=r.add(_);const b=l.b.sub(.5).mul(m(Math.PI*2));e.z=b;const L=this._buffer2.element(y),C=this._uniforms.uFlowersMaxScale.sub(this._uniforms.uFlowersMinScale),B=O(y.add(100)).mul(C).add(this._uniforms.uFlowersMinScale);L.assign(B)})().compute(E.COUNT);computeVisibility=w(([e=f(0)])=>{const t=this._uniforms.uCameraMatrix.mul(v(e,1)),s=t.xyz.div(t.w),o=E.BLADE_BOUNDING_SPHERE_RADIUS,i=m(1);return S(i.negate().sub(o),s.x).mul(S(s.x,i.add(o))).mul(S(i.negate().sub(o),s.y)).mul(S(s.y,i.add(o))).mul(S(0,s.z)).mul(S(s.z,i))});computeAlpha=w(([e=f(0)])=>{const t=ne.computeMapUvByPosition(e.xz);return q(I(h.floorGrassWaterMap,t).g)});computeUpdate=w(()=>{const e=this._buffer1.element(y),t=V(e.x.sub(this._uniforms.uDelta.x).add(E.TILE_HALF_SIZE),E.TILE_SIZE).sub(E.TILE_HALF_SIZE),s=V(e.y.sub(this._uniforms.uDelta.y).add(E.TILE_HALF_SIZE),E.TILE_SIZE).sub(E.TILE_HALF_SIZE);e.x=t,e.y=s;const i=f(e.x,0,e.y).add(this._uniforms.uPlayerPosition),n=this.computeVisibility(i);e.w=n,Ee(n,()=>{e.w=this.computeAlpha(i)})})().compute(E.COUNT);computePosition=w(([e=v(0),t=m(0)])=>{const s=O(y),o=f(e.x,0,e.y),i=e.z,n=N.mul(f(t,t.add(.25),t)),r=X(this._uniforms.uTime.mul(5).mul(s)).mul(.015);return ue(n,f(r,i.mul(2),r.mul(2))).add(o)});createFlowerMaterial(){this.precision="lowp";const e=this._buffer1.element(y),t=this._buffer2.element(y);this.positionNode=this.computePosition(e,t),this.opacityNode=e.w,this.alphaTest=.25;const s=V(m(y),2),o=m(1).sub(s),i=I(h.flowerCompositionTexture_1,W()).mul(s).mul(1.25),n=I(h.flowerCompositionTexture_2,W()).mul(o).mul(1.5),r=i.add(n);this.colorNode=r.mul(1.5)}async updateAsync(){await H.renderer.computeAsync(this.computeUpdate)}}class rs{uTime=a(0);constructor(){const e=h.realmModel.scene.getObjectByName("water_lilies");e.material=this.createMaterial(),T.scene.add(e),k.on("update",this.update.bind(this))}createMaterial(){const e=new j;e.precision="lowp",e.transparent=!0,e.map=h.waterLiliesTexture,e.alphaTest=.5,e.alphaMap=h.waterLiliesAlphaTexture;const t=this.uTime.mul(5e-4),s=z.x.mul(.1),o=I(h.noiseTexture,D(z.xz.add(t).mul(s))).b.mul(.5),i=X(o);return e.positionNode=N.add(i),e}update(e){const{clock:t}=e;this.uTime.value=t.getElapsedTime()}}class as{constructor(){new ss,new rs,new is}}const ls={uTime:a(0),uWavesSpeed:a(.01),uWavesAmplitude:a(.05),uWavesFrequency:a(2.68),uTroughColor:a(new A().setRGB(.58,.93,.88)),uSurfaceColor:a(new A().setRGB(.59,.46,.36)),uPeakColor:a(new A().setRGB(.27,.4,.38)),uPeakThreshold:a(0),uPeakTransition:a(.5),uTroughThreshold:a(-.2),uTroughTransition:a(.35),uFresnelScale:a(.65)};class cs extends be{_uniforms;debugFolder;constructor(e){super(),this._uniforms={...ls,...e},this.createWaterMaterial(),this.debugFolder=Z.panel.addFolder({title:"\uD83C\uDF0A Water"}),this.debugFolder.expanded=!1,this.debugWaves(),this.debugColor(),this.debugFresnel()}computeElevation=w(([e=U(0,0)])=>{const t=this._uniforms.uTime.mul(this._uniforms.uWavesSpeed).mul(.1),s=V(e.mul(this._uniforms.uWavesFrequency).add(t),1),o=I(h.noiseTexture,D(s.mul(10)),2),i=R(o.r,o.g,.5);return R(i,o.b,.75).mul(this._uniforms.uWavesAmplitude).mul(.001)});computePosition=w(([e=m(0)])=>{const t=e.mul(10);return f(N.x,N.y.add(t),N.z)});computeNormal=w(([e=m(0)])=>{const t=m(.001),s=this.computeElevation(U(N.x.sub(t),N.z)),o=this.computeElevation(U(N.x,N.z.sub(t))),i=ee(f(t,s.sub(e),0)),n=ee(f(0,o.sub(e),t)),r=f(1e-4);return ee(Ye(i,n)).add(r)});computeFresnel=w(([e=M(f(0,0,0)),t=f(0,0,0)])=>{const s=$e(Qe(m(1).sub(de(ce(t,e),0,1))));return this._uniforms.uFresnelScale.mul(s)});computeReflectionColor=w(([e=M(f(0,0,0)),t=f(0,0,0)])=>{let s=et(t,e);return s.x=s.x.negate(),tt(h.envMapTexture,s)});computeColor=w(([e=M(f(0,0,0)),t=M(f(0,0,0)),s=M(f(0,0,0))])=>{const o=ee(s.sub(le)),i=this.computeReflectionColor(e,o),n=this.computeFresnel(e,o),r=fe(t.y.sub(this._uniforms.uTroughThreshold).div(this._uniforms.uTroughTransition.mul(2))),c=R(this._uniforms.uTroughColor,this._uniforms.uSurfaceColor,r),l=fe(t.y.sub(this._uniforms.uPeakThreshold).div(this._uniforms.uPeakTransition.mul(2))),p=R(c,this._uniforms.uPeakColor,l),d=R(p,i.rgb,n),_=ce(s.xz.sub(le.xz),s.xz.sub(le.xz)),b=10,L=55,C=R(0,.5,te(b*b,L*L,_));return v(d,C)});createWaterMaterial(){this.precision="lowp";const e=this.computeElevation(W()).mul(1e3),t=this.computePosition(e),s=this.computeNormal(e),o=M(t,"vPosition"),i=M(s,"vNormal"),n=M(z,"vWorldPosition"),r=this.computeColor(i,o,n);this.transparent=!0,this.colorNode=r,this.positionNode=t}debugWaves(){const e=this.debugFolder.addFolder({title:"Waves"});e.addBinding(this._uniforms.uWavesAmplitude,"value",{min:0,max:.1,label:"Amplitude"}),e.addBinding(this._uniforms.uWavesFrequency,"value",{min:.1,max:10,label:"Frequency"}),e.addBinding(this._uniforms.uWavesSpeed,"value",{min:0,max:1,label:"Speed"})}debugColor(){const e=this.debugFolder.addFolder({title:"Color"});e.addBinding(this._uniforms.uTroughColor,"value",{label:"Trough Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uSurfaceColor,"value",{label:"Surface Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakColor,"value",{label:"Peak Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakThreshold,"value",{min:0,max:.5,label:"Peak Threshold"}),e.addBinding(this._uniforms.uPeakTransition,"value",{min:0,max:.5,label:"Peak Transition"}),e.addBinding(this._uniforms.uTroughThreshold,"value",{min:-.5,max:0,label:"Trough Threshold"}),e.addBinding(this._uniforms.uTroughTransition,"value",{min:0,max:.5,label:"Trough Transition"})}debugFresnel(){this.debugFolder.addFolder({title:"Fresnel"}).addBinding(this._uniforms.uFresnelScale,"value",{min:0,max:1,label:"Scale"})}}class us{uTime=a(0);constructor(){const e=this.createWater();T.scene.add(e),k.on("update",this.update.bind(this))}createWater(){const e=h.realmModel.scene.getObjectByName("water");delete e.geometry.attributes.normal;const t=new cs({uTime:this.uTime});return e.material=t,e}update(e){const{clock:t}=e;this.uTime.value=t.getElapsedTime()}}const ds=()=>Object.freeze({MAP_SIZE:256,HALF_MAP_SIZE:256/2,KINTOUN_ACTIVATION_THRESHOLD:2,HALF_FLOOR_THICKNESS:.3,OUTER_MAP_SIZE:256*3,OUTER_HALF_MAP_SIZE:256*1.5}),F=ds();class ms{constructor(){new Qt,new jt,new us,new as,new qt}}class hs{computeMapUvByPosition=w(([e=U(0)])=>e.add(F.HALF_MAP_SIZE).div(F.MAP_SIZE))}const ne=new hs;class ps{mesh;rigidBody;smoothedCameraPosition=new x;desiredCameraPosition=new x;smoothedCameraTarget=new x;desiredTargetPosition=new x;yawInRadians=0;prevYawInRadians=-1;yawQuaternion=new st;JUMP_IMPULSE=75;JUMP_BUFFER_DURATION_IN_SECONDS=.2;MAX_CONSECUTIVE_JUMPS=2;JUMP_CUT_MULTIPLIER=.25;FALL_MULTIPLIER=2.75;MAX_UPWARD_VELOCITY=6;LINEAR_DAMPING=.35;ANGULAR_DAMPING=.6;jumpImpulse=new x(0,this.JUMP_IMPULSE,0);LIN_VEL_STRENGTH=35;ANG_VEL_STRENGTH=25;newLinVel=new x;newAngVel=new x;torqueAxis=new x;forwardVec=new x;isOnGround=!1;jumpCount=0;wasJumpHeld=!1;jumpBufferTimer=0;RADIUS=.5;PLAYER_INITIAL_POSITION=new x(0,5,0);CAMERA_OFFSET=new x(0,11,17);CAMERA_LERP_FACTOR=7.5;UP=new x(0,1,0);DOWN=new x(0,-1,0);FORWARD=new x(0,0,-1);rayOrigin=new x;ray=new lt(this.rayOrigin,this.DOWN);uTime=a(0);uOffsetShadow=a(0);constructor(){this.mesh=this.createCharacterMesh(),T.scene.add(this.mesh),me.setTarget(this.mesh),this.rigidBody=P.world.createRigidBody(this.createRigidBodyDesc()),P.world.createCollider(this.createColliderDesc(),this.rigidBody),k.on("update",this.update.bind(this))}createCharacterMesh(){const e=new ot(this.RADIUS,2),t=new fs({uTime:this.uTime,uOffsetShadow:this.uOffsetShadow}),s=new Te(e,t);return s.castShadow=!0,s.position.copy(this.PLAYER_INITIAL_POSITION),s}createRigidBodyDesc(){const{x:e,y:t,z:s}=this.PLAYER_INITIAL_POSITION;return J.dynamic().setTranslation(e,t,s).setLinearDamping(this.LINEAR_DAMPING).setAngularDamping(this.ANGULAR_DAMPING)}createColliderDesc(){return Y.ball(this.RADIUS).setRestitution(.2).setFriction(1).setMass(3)}update(e){const{clock:t}=e,s=t.getDelta();this.uTime.value=t.getElapsedTime(),this.prevYawInRadians!==this.yawInRadians&&(this.yawQuaternion.setFromAxisAngle(this.UP,this.yawInRadians),this.prevYawInRadians=this.yawInRadians),this.updateVerticalMovement(s),this.updateHorizontalMovement(s),this.updateCameraPosition(s)}updateVerticalMovement(e){const t=G.isKeyPressed(" ");this.isOnGround=this.checkIfGrounded(),this.isOnGround&&(this.jumpCount=0),t&&!this.wasJumpHeld?this.jumpBufferTimer=this.JUMP_BUFFER_DURATION_IN_SECONDS:this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),this.jumpBufferTimer>0&&this.canJump()&&(this.performJump(),this.jumpBufferTimer=0);const o=this.rigidBody.linvel();this.handleJumpCut(t,o),this.handleFastFall(e,o,P.world.gravity.y),this.clampUpwardVelocity(o),this.rigidBody.setLinvel(o,!0),this.wasJumpHeld=t}checkIfGrounded(){this.rayOrigin.copy(this.rigidBody.translation()),this.rayOrigin.y-=this.RADIUS+.01;const e=.2,t=P.world.castRay(this.ray,e,!0);return t?t.timeOfImpact*e<.01:!1}canJump(){return this.isOnGround?!0:this.jumpCount<this.MAX_CONSECUTIVE_JUMPS}performJump(){this.rigidBody.applyImpulse(this.jumpImpulse,!0),this.jumpCount+=1}handleJumpCut(e,t){!(!e&&this.wasJumpHeld)||t.y<=0||(t.y*=this.JUMP_CUT_MULTIPLIER)}handleFastFall(e,t,s){if(t.y>=0)return;const o=this.FALL_MULTIPLIER*Math.abs(s)*e;t.y-=o}clampUpwardVelocity(e){e.y<=this.MAX_UPWARD_VELOCITY||(e.y=this.MAX_UPWARD_VELOCITY)}updateHorizontalMovement(e){const t=G.isKeyPressed("w")||G.isKeyPressed("arrowup"),s=G.isKeyPressed("s")||G.isKeyPressed("arrowdown"),o=G.isKeyPressed("a")||G.isKeyPressed("arrowleft"),i=G.isKeyPressed("d")||G.isKeyPressed("arrowright"),n=2;o&&(this.yawInRadians+=n*e),i&&(this.yawInRadians-=n*e),this.forwardVec.copy(this.FORWARD).applyQuaternion(this.yawQuaternion),this.torqueAxis.crossVectors(this.UP,this.forwardVec).normalize(),this.newLinVel.copy(this.rigidBody.linvel()),this.newAngVel.copy(this.rigidBody.angvel());const r=this.LIN_VEL_STRENGTH*e,c=this.ANG_VEL_STRENGTH*e;t&&(this.newLinVel.addScaledVector(this.forwardVec,r),this.newAngVel.addScaledVector(this.torqueAxis,c)),s&&(this.newLinVel.addScaledVector(this.forwardVec,-r),this.newAngVel.addScaledVector(this.torqueAxis,-c)),this.rigidBody.setLinvel(this.newLinVel,!0),this.rigidBody.setAngvel(this.newAngVel,!0),this.syncMeshWithBody()}syncMeshWithBody(){this.mesh.position.copy(this.rigidBody.translation()),this.mesh.quaternion.copy(this.rigidBody.rotation())}updateCameraPosition(e){this.desiredCameraPosition.copy(this.CAMERA_OFFSET).applyQuaternion(this.yawQuaternion).add(this.mesh.position);const t=this.CAMERA_LERP_FACTOR*e;this.smoothedCameraPosition.lerp(this.desiredCameraPosition,t),this.desiredTargetPosition.copy(this.mesh.position),this.desiredTargetPosition.y+=1,this.smoothedCameraTarget.lerp(this.desiredTargetPosition,t),T.camera.position.copy(this.smoothedCameraPosition),T.camera.lookAt(this.smoothedCameraTarget)}get position(){return this.mesh.position}get yaw(){return this.yawInRadians}}class fs extends j{_uniforms;constructor(e){super(),this._uniforms={...e},this.createMaterial()}createMaterial(){this.flatShading=!0;const e=ne.computeMapUvByPosition(z.xz),t=M(e),s=me.getBakedMapShadowColor(t),o=I(h.noiseTexture,D(z.xz),3).r,i=X(this._uniforms.uTime.mul(2.5).add(o.mul(5))).mul(.05),n=m(-.15).add(i),r=m(1).sub(S(n,z.y)),c=m(1).sub(r),l=it("#CE8946"),p=l.mul(c),d=l.mul(1.25).mul(r),_=p.add(d),b=s;this.colorNode=_.mul(b)}}class ws{player;constructor(){this.player=new ps,new ms}getSizes(){const e=window.innerWidth,t=window.innerHeight;return{width:e,height:t,dpr:Math.min(window.devicePixelRatio,1.5),aspect:e/t}}onResize(){const e=this.getSizes();T.camera.aspect=e.aspect,T.camera.updateProjectionMatrix(),H.renderer.setSize(e.width,e.height),H.renderer.setPixelRatio(e.dpr)}async startLoop(){await H.init();const t={clock:new nt(!0),player:this.player},s=async()=>{P.update(),k.emit("update",t),await H.renderAsync()};new ResizeObserver(()=>{this.onResize()}).observe(document.body),H.renderer.setAnimationLoop(s)}}const gs=new Nt;gs.initAsync().then(()=>{new ws().startLoop()})});