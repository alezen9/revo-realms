import{T as Ce,D as Me,G as ve,C as Fe,L as Be,P as Re,F as y,p as De,b as Ne,W as Oe,a as Ue,A as Ge,S as He,c as ke,d as ze,V as L,H as We,e as Ze,O as Ve,t as E,v as G,f,u as a,g as C,M as Z,h as F,i as N,j as je,I as ie,k as U,l as _,m as M,n as p,s as j,o as ye,q as z,r as B,w as ne,x as ae,y as Te,z as Ke,B as se,E as _e,J as re,K as Q,N as R,Q as S,R as qe,U as ce,X as Xe,Y as be,Z as X,_ as xe,$ as de,a0 as O,a1 as ee,a2 as Ee,a3 as Je,a4 as oe,a5 as Ye,a6 as $e,a7 as Qe,a8 as pe,a9 as et,aa as tt,ab as ue,ac as fe,ad as st,ae as ot,af as it}from"./three-EfYEkdtV.js";import{World as rt,RigidBodyDesc as J,ColliderDesc as Y,HeightFieldFlags as nt,Ray as at,__tla as __tla_0}from"./@dimforge-Tx9Ov1ko.js";import{P as lt}from"./tweakpane-BXg6ZhiP.js";import{S as we}from"./stats-gl-C2M3amu4.js";import{e as ct}from"./tseep-DsfRTLTM.js";Promise.all([(()=>{try{return __tla_0}catch{}})()]).then(async()=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const ut="/revo-realms/models/realm.glb",dt="/revo-realms/textures/environment/px.webp",ht="/revo-realms/textures/environment/nx.webp",mt="/revo-realms/textures/environment/py.webp",pt="/revo-realms/textures/environment/ny.webp",ft="/revo-realms/textures/environment/pz.webp",wt="/revo-realms/textures/environment/nz.webp",gt="/revo-realms/textures/noise/noise.webp",yt="/revo-realms/textures/realm/terrain_type.webp",Tt="/revo-realms/textures/realm/sand_nor.webp",_t="/revo-realms/textures/realm/grass_diff.webp",bt="/revo-realms/textures/realm/grass_nor.webp",xt="/revo-realms/textures/realm/lightmap.webp",Et="/revo-realms/textures/realm/water_lilies.webp",It="/revo-realms/textures/realm/water_lilies_alpha.webp",Lt="/revo-realms/textures/realm/flower_composition_1.webp",St="/revo-realms/textures/realm/flower_composition_2.webp",Pt="/revo-realms/textures/realm/stone_diff.webp",At="/revo-realms/textures/realm/bark_diff.webp",Ct="/revo-realms/textures/realm/canopy_diff.webp",Mt="/revo-realms/textures/realm/canopy_nor.webp";class vt{textureLoader;gltfLoader;cubeTextureLoader;realmModel;noiseTexture;envMapTexture;terrainTypeMap;grassDiffTexture;grassNorTexture;sandNormalTexture;lightmapTexture;waterLiliesTexture;waterLiliesAlphaTexture;flowerCompositionTexture_1;flowerCompositionTexture_2;stoneDiffTexture;canopyDiffTexture;canopyNorTexture;barkDiffTexture;constructor(){const e=this.createLoadingManager();this.textureLoader=new Ce(e);const t=new Me(e);t.setDecoderPath("/revo-realms/draco/"),this.gltfLoader=new ve(e),this.gltfLoader.setDRACOLoader(t),this.cubeTextureLoader=new Fe(e)}createLoadingManager(){const e=new Be;e.onStart=function(t,o,s){console.log("Started loading file: "+t+`.
Loaded `+o+" of "+s+" files.")},e.onLoad=function(){console.log("Loading complete!")},e.onProgress=function(t,o,s){console.log("Loading file: "+t+`.
Loaded `+o+" of "+s+" files.")},e.onError=function(t){console.log("There was an error loading "+t)}}async initAsync(){const e=await Promise.all([this.gltfLoader.loadAsync(ut),u.cubeTextureLoader.loadAsync([dt,ht,mt,pt,ft,wt]),this.textureLoader.loadAsync(gt),this.textureLoader.loadAsync(yt),this.textureLoader.loadAsync(_t),this.textureLoader.loadAsync(bt),this.textureLoader.loadAsync(Tt),this.textureLoader.loadAsync(xt),this.textureLoader.loadAsync(Et),this.textureLoader.loadAsync(It),this.textureLoader.loadAsync(Lt),this.textureLoader.loadAsync(St),this.textureLoader.loadAsync(Pt),this.textureLoader.loadAsync(Ct),this.textureLoader.loadAsync(Mt),this.textureLoader.loadAsync(At)]);this.realmModel=e[0],this.envMapTexture=e[1],this.envMapTexture.generateMipmaps=!1,this.noiseTexture=e[2],this.terrainTypeMap=e[3],this.terrainTypeMap.flipY=!1,this.grassDiffTexture=e[4],this.grassDiffTexture.generateMipmaps=!1,this.sandNormalTexture=e[5],this.sandNormalTexture.generateMipmaps=!1,this.grassNorTexture=e[6],this.grassNorTexture.generateMipmaps=!1,this.lightmapTexture=e[7],this.lightmapTexture.flipY=!1,this.lightmapTexture.generateMipmaps=!1,this.waterLiliesTexture=e[8],this.waterLiliesTexture.flipY=!1,this.waterLiliesTexture.generateMipmaps=!1,this.waterLiliesAlphaTexture=e[9],this.waterLiliesAlphaTexture.flipY=!1,this.waterLiliesAlphaTexture.generateMipmaps=!1,this.flowerCompositionTexture_1=e[10],this.flowerCompositionTexture_2=e[11],this.stoneDiffTexture=e[12],this.canopyDiffTexture=e[13],this.canopyDiffTexture.flipY=!1,this.canopyNorTexture=e[14],this.canopyNorTexture.flipY=!1,this.barkDiffTexture=e[15],this.barkDiffTexture.flipY=!1}}const u=new vt,Ft="modulepreload",Bt=function(d){return"/revo-realms/"+d},ge={},Rt=function(e,t,o){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),n=r?.nonce||r?.getAttribute("nonce");s=Promise.allSettled(t.map(l=>{if(l=Bt(l),l in ge)return;ge[l]=!0;const c=l.endsWith(".css"),h=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const m=document.createElement("link");if(m.rel=c?"stylesheet":Ft,c||(m.as="script"),m.crossOrigin="",m.href=l,n&&m.setAttribute("nonce",n),document.head.appendChild(m),c)return new Promise((g,w)=>{m.addEventListener("load",g),m.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(r){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=r,window.dispatchEvent(n),!n.defaultPrevented)throw r}return s.then(r=>{for(const n of r||[])n.status==="rejected"&&i(n.reason);return e().catch(i)})};class Dt{world;constructor(){}async init(){return Rt(()=>import("./@dimforge-Tx9Ov1ko.js").then(async m=>{await m.__tla;return m}),[]).then(()=>{this.world=new rt({x:0,y:-9.81,z:0})})}update(){this.world.step()}}const P=new Dt;class Nt{async initAsync(){await Promise.all([P.init(),u.initAsync()])}}class Ot{keysPressed;keyDownListeners;keyUpListeners;constructor(){this.keysPressed=new Set,this.keyDownListeners=new Map,this.keyUpListeners=new Map,window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this))}handleKeyDown(e){const t=e.key.toLowerCase();this.keysPressed.has(t)||(this.keysPressed.add(t),this.keyDownListeners.get(t)?.())}handleKeyUp(e){const t=e.key.toLowerCase();this.keysPressed.delete(t),this.keyUpListeners.get(t)?.()}isKeyPressed(e){return e==="*"?this.keysPressed.size>0:this.keysPressed.has(e.toLowerCase())}onKeyDown(e,t){this.keyDownListeners.set(e.toLowerCase(),t)}onKeyUp(e,t){this.keyUpListeners.set(e.toLowerCase(),t)}dispose(){window.removeEventListener("keydown",this.handleKeyDown.bind(this)),window.removeEventListener("keyup",this.handleKeyUp.bind(this))}}const H=new Ot;class Ut{panel;constructor(){this.panel=new lt({title:"Revo Realms"}),this.panel.hidden=!0,this.panel.element.parentElement.style.zIndex="1",this.panel.element.parentElement.style.width="340px"}setVisibility(e){this.panel.hidden=!e}}const W=new Ut;class Gt{stats;lastSecond=performance.now();drawCallsPanel;trianglesPanel;constructor(e){const t=new we({trackGPU:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,horizontal:!1,precision:2});e&&document.body.appendChild(t.dom),this.stats=t,this.drawCallsPanel=this.createNumberPanel("# DRAW CALLS","#fff","#333"),this.trianglesPanel=this.createNumberPanel("# TRIANGLES","#ffdab9","#163843")}createNumberPanel(e,t,o){const s=this.stats.addPanel(new we.Panel(e,t,o));return s.update=i=>{const r=s.canvas.getContext("2d");if(!r)return;const{width:n,height:l}=s.canvas;r.clearRect(0,0,n,l),r.fillStyle=o,r.fillRect(0,0,n,l),r.fillStyle=t;const c=r.font;r.textAlign="left",r.textBaseline="top",r.fillText(s.name,4,4),r.font="bold 20px Arial",r.textAlign="center",r.textBaseline="middle";const h=Ht.format(i);r.fillText(`${h}`,n/2,l/1.65),r.font=c},s}updateCustomPanels(){const e=performance.now();if(e-this.lastSecond<1e3)return;const{render:t}=k.renderer.info;this.drawCallsPanel.update(t.drawCalls,0),this.trianglesPanel.update(t.triangles,0),this.lastSecond=e}}const Ht=new Intl.NumberFormat("en-US",{notation:"compact"});class kt{composer;constructor(){this.composer=new Re(k.renderer),this.composer.outputNode=this.getPasses()}getPasses=y(()=>{const e=De(b.scene,b.renderCamera),t=e.getTextureNode();return Ne(t,.25,.1,.5).add(e)})}class zt{renderer;canvas;monitoringManager;postprocessingManager;POSTPROCESSING_ENABLED=!1;MONITORING_ENABLED=!1;DEBUGGING_ENABLED=!1;constructor(){const e=document.createElement("canvas");e.classList.add("revo-realms"),document.body.appendChild(e),this.canvas=e;const t=new Oe({canvas:e,antialias:!0,trackTimestamp:!1,powerPreference:"high-performance",stencil:!1,depth:!0});t.shadowMap.enabled=!0,t.shadowMap.type=Ue,t.toneMapping=Ge,t.outputColorSpace=He,t.setClearColor(0,1),t.toneMappingExposure=1.5,this.renderer=t,this.monitoringManager=new Gt(this.MONITORING_ENABLED),W.setVisibility(this.DEBUGGING_ENABLED)}async init(){this.postprocessingManager=new kt,this.MONITORING_ENABLED&&await this.monitoringManager.stats.init(this.renderer)}async renderAsync(){this.MONITORING_ENABLED&&await this.renderer.resolveTimestampsAsync("compute"),this.POSTPROCESSING_ENABLED?await this.postprocessingManager.composer.renderAsync():await this.renderer.renderAsync(b.scene,b.renderCamera),this.MONITORING_ENABLED&&(this.monitoringManager.updateCustomPanels(),await this.renderer.resolveTimestampsAsync("render"),this.monitoringManager.stats.update())}}const k=new zt;class Wt{scene;camera;renderCamera;cameraHelper;controls;orbitControlsCamera;constructor(){const e=new ke;this.scene=e;const t=window.innerWidth,o=window.innerHeight,s=t/o,i=new ze(45,s,.01,150);i.position.set(0,5,10),this.camera=i,e.add(i),this.renderCamera=i}debugScene(){if(!this.controls)return;W.panel.addFolder({title:"\uD83C\uDFA5 View"}).addBinding(this.controls,"enabled",{label:"Enable orbit controls"}).on("change",({value:t})=>{!this.cameraHelper||!this.orbitControlsCamera||(this.renderCamera=t?this.orbitControlsCamera:this.camera,this.cameraHelper.visible=t)})}update(){this.controls?.enabled&&this.controls.update()}}const b=new Wt,V=new ct.EventEmitter,q={LIGHT_POSITION_OFFSET:new L(10,10,10)};class Zt{directionalLight;hemisphereLight;constructor(){this.directionalLight=this.setupDirectionalLighting(),b.scene.add(this.directionalLight),this.hemisphereLight=this.setupHemisphereLight(),b.scene.add(this.hemisphereLight),V.on("update",this.update.bind(this)),this.debugLight()}setupHemisphereLight(){const e=new We;return e.color.setRGB(.5,.4,.6),e.groundColor.setRGB(.3,.2,.2),e.intensity=.3,e.position.copy(q.LIGHT_POSITION_OFFSET),e}setupDirectionalLighting(){const e=new Ze;e.intensity=.7,e.color.setRGB(1,.85,.77),e.position.copy(q.LIGHT_POSITION_OFFSET),e.target=new Ve,e.castShadow=!0,e.shadow.mapSize.set(64,64);const t=1;return e.shadow.intensity=.85,e.shadow.camera.left=-t,e.shadow.camera.right=t,e.shadow.camera.top=t,e.shadow.camera.bottom=-t,e.shadow.camera.near=.01,e.shadow.camera.far=30,e.shadow.normalBias=.1,e.shadow.bias=-.001,e}getBakedMapShadowColor=y(([e=G(0)])=>E(u.lightmapTexture,e).add(this.directionalLight.shadow.intensity));get shadowIntensity(){return this.directionalLight.shadow.intensity}debugLight(){const e=W.panel.addFolder({title:"\uD83D\uDCA1 Light"});e.expanded=!1,e.addBinding(q.LIGHT_POSITION_OFFSET,"x",{label:"Sun position X"}),e.addBinding(q.LIGHT_POSITION_OFFSET,"z",{label:"Sun position Z"}),e.addBinding(q.LIGHT_POSITION_OFFSET,"y",{label:"Sun height"}),e.addBinding(this.directionalLight,"color",{label:"Directional Color",view:"color",color:{type:"float"}}),e.addBinding(this.directionalLight,"intensity",{min:0,max:1,label:"Directional intensity"}),e.addBinding(this.hemisphereLight,"color",{label:"Hemisphere sky color",view:"color",color:{type:"float"}}),e.addBinding(this.hemisphereLight,"groundColor",{label:"Hemisphere ground color",view:"color",color:{type:"float"}}),e.addBinding(this.hemisphereLight,"intensity",{min:0,max:1,label:"Hemisphere intensity"})}material_computeIllumination=y(()=>f(0));setTarget(e){this.directionalLight.target=e}update(e){const{player:t}=e;this.directionalLight.position.copy(t.position).add(q.LIGHT_POSITION_OFFSET)}}const he=new Zt,Ie={uBaseColor:a(new C),uRandom:a(0)};class Vt extends Z{_uniforms;constructor(e){super(),this._uniforms={...Ie,...e},this.createMaterial()}setRandomSeed(e){this._uniforms.uRandom.value=e}createMaterial(){this.precision="lowp",this.flatShading=!1;const e=F(N().add(this._uniforms.uRandom).mul(5)),t=E(u.stoneDiffTexture,e);this.colorNode=t.mul(this._uniforms.uBaseColor)}}class jt{uniforms=Ie;constructor(){const e=new Vt(this.uniforms),t=u.realmModel.scene.children.filter(({name:s})=>s.endsWith("_monument"));t.forEach((s,i)=>{const r=je.seededRandom(i);s.material=e,s.receiveShadow=!0,s.onBeforeRender=(n,l,c,h,m)=>{m.setRandomSeed(r)}}),b.scene.add(...t),u.realmModel.scene.children.filter(({name:s})=>s.startsWith("monument_collider")).forEach(s=>{const i=J.fixed().setTranslation(...s.position.toArray()).setRotation(s.quaternion),r=P.world.createRigidBody(i),n=.5*s.scale.x,l=.5*s.scale.y,c=.5*s.scale.z,h=Y.cuboid(n,l,c).setRestitution(.25);P.world.createCollider(h,r)}),this.debugMonuments()}debugMonuments(){const e=W.panel.addFolder({title:"\uD83D\uDDFD Monuments"});e.expanded=!1,e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base color",view:"color",color:{type:"float"}})}}const Le={uBaseColor:a(new C().setRGB(.57,.57,.57))};class Kt extends Z{_uniforms;constructor(e){super(),this._uniforms={...Le,...e},this.createMaterial()}createMaterial(){this.precision="lowp",this.flatShading=!1;const e=U(_),t=F(N().add(e).mul(2.5)),o=E(u.noiseTexture,t),s=o.b.mul(o.r),i=E(u.stoneDiffTexture,t);this.colorNode=M(i,this._uniforms.uBaseColor,s)}}class qt{uniforms=Le;constructor(){const e=u.realmModel.scene.getObjectByName("rock"),t=u.realmModel.scene.children.filter(({name:i})=>i.startsWith("rock_collider")),o=new Kt(this.uniforms),s=new ie(e.geometry,o,t.length);s.receiveShadow=!0,t.forEach((i,r)=>{s.setMatrixAt(r,i.matrix);const n=J.fixed().setTranslation(...i.position.toArray()).setRotation(i.quaternion),l=P.world.createRigidBody(n),c=.5*i.scale.y,h=Y.ball(c).setRestitution(.15);P.world.createCollider(h,l)}),b.scene.add(s),this.debugRocks()}debugRocks(){const e=W.panel.addFolder({title:"\uD83E\uDEA8 Rocks"});e.expanded=!1,e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base color",view:"color",color:{type:"float"}})}}const Xt={uTime:a(0),uGrassTerrainColor:a(new C),uWaterSandColor:a(new C),uPathSandColor:a(new C)};class Jt extends Z{_uniforms;constructor(e){super(),this._uniforms={...Xt,...e},this.createMaterial()}computeCausticsDiffuse=y(([e=G(0,0),t=p(0),o=f(0,0,0)])=>{const s=this._uniforms.uTime.mul(.1),i=p(15),r=e.mul(i),n=F(r.add(G(s,0))),l=F(r.add(G(0,s.negate()))),c=E(u.noiseTexture,n,1).g,h=E(u.noiseTexture,l,2).g,m=c.add(h),g=j(-1,10,t),w=ye(m,3).mul(p(1).sub(g)),x=f(.6,.8,1).mul(.3);return M(o,x,w)});computeWaterDiffuse=y(([e=p(0),t=G(0,0)])=>{const o=p(8),s=p(.001),i=j(0,o.add(s),e),r=this._uniforms.uWaterSandColor,n=f(.35,.45,.55).mul(.65),l=this.computeCausticsDiffuse(t,e),c=j(0,1.5,e),h=f(1,.9,.7).mul(.1).mul(c);return M(r,n,i).add(h).add(l)});createMaterial(){this.flatShading=!1;const e=le.computeMapUvByPosition(z.xz),t=B(e);this.aoMap=u.lightmapTexture,this.aoMapIntensity=he.shadowIntensity;const o=E(u.terrainTypeMap,t,2.5),s=o.g,i=o.b,n=p(1).sub(s).sub(i),l=E(u.sandNormalTexture,F(t.mul(30))),c=F(t.mul(20)),m=E(u.grassNorTexture,c).dot(l).mul(.65),g=E(u.grassDiffTexture,c),w=p(1).sub(g.a),x=this._uniforms.uGrassTerrainColor.mul(w).add(g).mul(s).mul(.85),A=this._uniforms.uPathSandColor.mul(1.2).mul(n),v=B(z.y.negate()),K=this.computeWaterDiffuse(v,t).mul(i),$=x.add(A.mul(m)).add(K.mul(m).mul(.5));this.colorNode=$}}class Yt{constructor(e){const t=this.createFloor();t.material=e,b.scene.add(t)}createFloor(){const e=u.realmModel.scene.getObjectByName("floor");return e.receiveShadow=!0,this.createFloorPhysics(),e}getFloorDisplacementData(){const e=u.realmModel.scene.getObjectByName("heightfield"),t=e.geometry.attributes._displacement.array[0],o=e.geometry.attributes.position;e.geometry.boundingBox||e.geometry.computeBoundingBox();const s=e.geometry.boundingBox,i=o.count,r=Math.sqrt(i),n=s.max.x,l=new Float32Array(i);for(let c=0;c<i;c++){const h=o.array[c*3+0],m=o.array[c*3+1],g=o.array[c*3+2],w=Math.round((h/(n*2)+.5)*(r-1)),A=Math.round((g/(n*2)+.5)*(r-1))+w*r;l[A]=m}return{rowsCount:r,heights:l,displacement:t}}createFloorPhysics(){const e=this.getFloorDisplacementData(),{rowsCount:t,heights:o,displacement:s}=e,i=J.fixed().setTranslation(0,-s,0),r=P.world.createRigidBody(i),n=Y.heightfield(t-1,t-1,o,{x:D.MAP_SIZE,y:1,z:D.MAP_SIZE},nt.FIX_INTERNAL_EDGES).setFriction(1).setRestitution(.2);P.world.createCollider(n,r)}}class $t{outerFloor;kintoun;kintounPosition=new L;constructor(e){this.outerFloor=this.createOuterFloorVisual(),this.outerFloor.material=e,this.kintoun=this.createKintoun(),b.scene.add(this.outerFloor)}createOuterFloorVisual(){const e=u.realmModel.scene.getObjectByName("outer_world");return e.receiveShadow=!0,e}createKintoun(){const e=J.kinematicPositionBased().setTranslation(0,-20,0),t=P.world.createRigidBody(e),o=2,s=Y.cuboid(o,D.HALF_FLOOR_THICKNESS,o).setFriction(1).setRestitution(.2);return P.world.createCollider(s,t),t}useKintoun(e){this.kintounPosition.copy(e).setY(-D.HALF_FLOOR_THICKNESS),this.kintoun.setTranslation(this.kintounPosition,!0)}update(e){const{player:t}=e,o=D.HALF_MAP_SIZE-Math.abs(t.position.x)<D.KINTOUN_ACTIVATION_THRESHOLD,s=D.HALF_MAP_SIZE-Math.abs(t.position.z)<D.KINTOUN_ACTIVATION_THRESHOLD;(o||s)&&this.useKintoun(t.position);const i=D.MAP_SIZE,r=Math.abs(t.position.x),n=Math.sign(t.position.x),l=Math.abs(t.position.z),c=Math.sign(t.position.z),h=r>i?r-i:0,m=l>i?l-i:0;this.outerFloor.position.set(h*n,0,m*c)}}class Qt{outerTerrain;uniforms={uTime:a(0),uGrassTerrainColor:a(new C().setRGB(.431,.302,.122)),uWaterSandColor:a(new C().setRGB(.54,.39,.2)),uPathSandColor:a(new C().setRGB(.65,.49,.27))};constructor(){const e=new Jt(this.uniforms);new Yt(e),this.outerTerrain=new $t(e),V.on("update",this.update.bind(this)),this.debugTerrain()}debugTerrain(){const e=W.panel.addFolder({title:"⛰️ Terrain"});e.expanded=!1,e.addBinding(this.uniforms.uPathSandColor,"value",{label:"Path color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWaterSandColor,"value",{label:"Water bed color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGrassTerrainColor,"value",{label:"Grass terrain color",view:"color",color:{type:"float"}})}update(e){const{clock:t}=e;this.uniforms.uTime.value=t.getElapsedTime(),this.outerTerrain.update(e)}}const es=()=>({BLADE_WIDTH:.085,BLADE_HEIGHT:1.25,BLADE_BOUNDING_SPHERE_RADIUS:1.25,TILE_SIZE:150,TILE_HALF_SIZE:150/2,BLADES_PER_SIDE:500,COUNT:500*500,SPACING:150/500}),T=es(),Se={uTime:a(0),uPlayerPosition:a(new L(0,0,0)),uCameraMatrix:a(new ne),uBladeMinScale:a(.5),uBladeMaxScale:a(1.25),uTrailGrowthRate:a(.004),uTrailMinScale:a(.25),uTrailRaius:a(.65),uTrailRaiusSquared:a(.65*.65),uGlowRadius:a(2),uGlowRadiusSquared:a(4),uGlowFadeIn:a(.05),uGlowFadeOut:a(.01),uGlowColor:a(new C().setRGB(.49,.3,.07)),uBladeMaxBendAngle:a(Math.PI*.15),uWindStrength:a(.45),uBaseColor:a(new C().setRGB(.1,.1,.02)),uTipColor:a(new C().setRGB(.17,.16,.05)),uDelta:a(new ae(0,0))};class ts extends _e{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...Se,...e},this._buffer1=re(T.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=re(T.COUNT,"vec4"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createGrassMaterial()}computeInit=y(()=>{const e=this._buffer1.element(_),t=Q(p(_).div(T.BLADES_PER_SIDE)),o=p(_).mod(T.BLADES_PER_SIDE),s=U(_.add(4321)),i=U(_.add(1234)),r=o.mul(T.SPACING).sub(T.TILE_HALF_SIZE).add(s.mul(T.SPACING*.5)),n=t.mul(T.SPACING).sub(T.TILE_HALF_SIZE).add(i.mul(T.SPACING*.5)),l=f(r,0,n).xz.add(T.TILE_HALF_SIZE).div(T.TILE_SIZE).abs(),c=E(u.noiseTexture,l),h=c.b.sub(.5).mul(30),m=c.g.sub(.5).mul(10);e.x=r.add(h),e.y=n.add(m);const w=f(e.x,0,e.y).xz.add(T.TILE_HALF_SIZE).div(T.TILE_SIZE),x=p(20),A=F(w.mul(x)),te=E(u.noiseTexture,A,1).b.sub(.5).mul(p(Math.PI*2));e.z=te;const K=this._buffer2.element(_),$=this._uniforms.uBladeMaxScale.sub(this._uniforms.uBladeMinScale),me=U(_.add(100)).mul($).add(this._uniforms.uBladeMinScale);K.x=me,K.y=me})().compute(T.COUNT);computeVisibility=y(([e=f(0)])=>{const t=this._uniforms.uCameraMatrix.mul(R(e,1)),o=t.xyz.div(t.w),s=T.BLADE_BOUNDING_SPHERE_RADIUS,i=p(1);return S(i.negate().sub(s),o.x).mul(S(o.x,i.add(s))).mul(S(i.negate().sub(s),o.y)).mul(S(o.y,i.add(s))).mul(S(0,o.z)).mul(S(o.z,i))});computeBending=y(([e=R(0,0,0,0),t=f(0,0,0)])=>{const o=t.xz.add(this._uniforms.uTime.mul(.25)).mul(.5),s=F(o),r=E(u.noiseTexture,s,5).r.mul(this._uniforms.uWindStrength);return e.w.add(r.sub(e.w).mul(.1))});computeAlpha=y(([e=f(0)])=>{const t=le.computeMapUvByPosition(e.xz);return E(u.terrainTypeMap,t).g});computeTrailScale=y(([e=R(0),t=p(0)])=>{const o=e.x.add(this._uniforms.uTrailGrowthRate),s=p(1).sub(t),i=this._uniforms.uTrailMinScale.mul(t).add(o.mul(s));return qe(i,e.y)});computeTrailGlow=y(([e=R(0),t=p(0),o=p(0),s=p(0)])=>{const i=j(this._uniforms.uGlowRadiusSquared,p(0),t),r=100,n=Q(ce(this._uniforms.uDelta.x).mul(r)),l=Q(ce(this._uniforms.uDelta.y).mul(r)),c=S(1,n.add(l)),h=i.mul(p(1).sub(o)).mul(s),m=Xe(c,e.w).mul(h),g=m.mul(this._uniforms.uGlowFadeIn),w=p(1).sub(m).mul(this._uniforms.uGlowFadeOut),x=p(1).sub(c).mul(this._uniforms.uGlowFadeOut).mul(e.w);return be(e.w.add(g).sub(w).sub(x),0,1)});computeUpdate=y(()=>{const e=this._buffer1.element(_),t=this._buffer2.element(_),o=X(e.x.sub(this._uniforms.uDelta.x).add(T.TILE_HALF_SIZE),T.TILE_SIZE).sub(T.TILE_HALF_SIZE),s=X(e.y.sub(this._uniforms.uDelta.y).add(T.TILE_HALF_SIZE),T.TILE_SIZE).sub(T.TILE_HALF_SIZE),i=f(o,0,s);e.x=o,e.y=s;const r=i.add(this._uniforms.uPlayerPosition),n=this.computeVisibility(r);t.z=n,xe(n,()=>{const l=G(this._uniforms.uDelta.x,this._uniforms.uDelta.y),c=i.xz.sub(l),h=c.dot(c),m=S(.1,p(1).sub(this._uniforms.uPlayerPosition.y)),g=S(h,this._uniforms.uTrailRaiusSquared).mul(m);t.x=this.computeTrailScale(t,g),t.z=this.computeAlpha(r),e.w=this.computeBending(e,r),t.w=this.computeTrailGlow(t,h,g,m)})})().compute(T.COUNT);computePosition=y(([e=R(0),t=R(0)])=>{const o=f(e.x,0,e.y),s=e.z,i=e.w,r=t.x,n=i.mul(N().y),c=de(O,f(n,0,0)).mul(f(1,r,1)),h=de(c,f(0,s,0)),m=U(_).mul(6.28),g=ee(this._uniforms.uTime.mul(5).add(e.w).add(m)).mul(.1),w=N().y.mul(t.w),x=g.mul(w);return h.add(o).add(f(x))});computeDiffuseColor=y(([e=R(0)])=>{const t=ye(N().y,1.5),o=M(this._uniforms.uBaseColor,this._uniforms.uTipColor,t),s=U(_).mul(.05).sub(.025),i=e.w;return M(o.add(s),this._uniforms.uGlowColor.mul(.5),i)});computeAO=y(([e=R(0)])=>{const t=ce(ee(e.z)).mul(.5);return j(-2.5,1.25,N().y).mul(p(1).sub(t))});createGrassMaterial(){this.precision="lowp",this.side=Ee;const e=this._buffer1.element(_),t=this._buffer2.element(_);Je(t.z.equal(0)),this.positionNode=this.computePosition(e,t),this.opacityNode=t.z,this.alphaTest=.25,this.aoNode=this.computeAO(e),this.colorNode=this.computeDiffuseColor(t)}async updateAsync(){await k.renderer.computeAsync(this.computeUpdate)}}class ss{material;grassField;uniforms={...Se,uDelta:a(new ae(0,0)),uPlayerPosition:a(new L(0,0,0)),uCameraMatrix:a(new ne),uTime:a(0)};constructor(){const e=this.createBladeGeometry();e.instanceCount=T.COUNT,this.material=new ts(this.uniforms),this.grassField=new Te(e,this.material),b.scene.add(this.grassField),V.on("update",this.updateAsync.bind(this)),this.debugGrass()}debugGrass(){const e=W.panel.addFolder({title:"\uD83C\uDF31 Grass"});e.expanded=!1,e.addBinding(this.uniforms.uTipColor,"value",{label:"Tip Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGlowColor,"value",{label:"Glow Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWindStrength,"value",{label:"Wind strength",min:0,max:Math.PI/2,step:.1})}createBladeGeometry(){const e=T.BLADE_WIDTH/2,t=e/2,o=T.BLADE_HEIGHT/2,s=new Float32Array([-e,0,0,e,0,0,-t,o*1,0,t,o*1,0,0,o*2,0]),i=new Float32Array([0,0,1,0,.25,o*1,.75,o*1,.5,o*2]),r=new Uint16Array([0,1,3,0,3,2,2,3,4]),l=25*Math.PI/180,c=Math.cos(l),h=Math.sin(l),g=15*Math.PI/180,w=Math.cos(g),x=Math.sin(g),A=new Float32Array([-c,h,0,c,h,0,-w,x,0,w,x,0,0,1,0]),v=new Ke;return v.setAttribute("position",new se(s,3)),v.setAttribute("uv",new se(i,2)),v.setIndex(new se(r,1)),v.setAttribute("normal",new se(A,3)),v}async updateAsync(e){const{player:t,clock:o}=e,s=t.position.x-this.grassField.position.x,i=t.position.z-this.grassField.position.z;this.uniforms.uDelta.value.set(s,i),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(b.camera.projectionMatrix).multiply(b.camera.matrixWorldInverse),this.uniforms.uTime.value=o.getElapsedTime(),this.grassField.position.copy(t.position).setY(0),await this.material.updateAsync()}}const os=()=>({FLOWER_WIDTH:1,FLOWER_HEIGHT:1,BLADE_BOUNDING_SPHERE_RADIUS:1,TILE_SIZE:150,TILE_HALF_SIZE:150/2,FLOWERS_PER_SIDE:30,COUNT:30*30,SPACING:150/30}),I=os();class is{flowerField;material;uniforms={...Pe,uDelta:a(new ae(0,0)),uPlayerPosition:a(new L(0,0,0)),uCameraMatrix:a(new ne),uTime:a(0)};constructor(){const e=u.realmModel.scene.getObjectByName("flowers_plane");e.geometry.translate(0,.35,0),this.material=new rs(this.uniforms),this.flowerField=new ie(e.geometry,this.material,I.COUNT),b.scene.add(this.flowerField),V.on("update",this.updateAsync.bind(this))}async updateAsync(e){const{player:t,clock:o}=e,s=t.position.x-this.flowerField.position.x,i=t.position.z-this.flowerField.position.z;this.uniforms.uDelta.value.set(s,i),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(b.camera.projectionMatrix).multiply(b.camera.matrixWorldInverse),this.uniforms.uTime.value=o.getElapsedTime(),this.flowerField.position.copy(t.position).setY(0),await this.material.updateAsync()}}const Pe={uTime:a(0),uPlayerPosition:a(new L(0,0,0)),uCameraMatrix:a(new ne),uFlowersMinScale:a(.75),uFlowersMaxScale:a(1),uDelta:a(new ae(0,0))};class rs extends Z{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...Pe,...e},this._buffer1=re(I.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=re(I.COUNT,"float"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createFlowerMaterial()}computeInit=y(()=>{const e=this._buffer1.element(_),t=Q(p(_).div(I.FLOWERS_PER_SIDE)),o=p(_).mod(I.FLOWERS_PER_SIDE),s=U(_.add(4321)),i=U(_.add(1234)),r=o.mul(I.SPACING).sub(I.TILE_HALF_SIZE).add(s.mul(I.SPACING*.5)),n=t.mul(I.SPACING).sub(I.TILE_HALF_SIZE).add(i.mul(I.SPACING*.5)),l=f(r,0,n).xz.add(I.TILE_HALF_SIZE).div(I.TILE_SIZE).abs(),c=E(u.noiseTexture,l),h=M(c.r,c.b,.75),m=h.sub(.5).mul(100),g=h.sub(.5).mul(50);e.x=r.add(m),e.y=n.add(g);const w=c.b.sub(.5).mul(p(Math.PI*2));e.z=w;const x=this._buffer2.element(_),A=this._uniforms.uFlowersMaxScale.sub(this._uniforms.uFlowersMinScale),v=U(_.add(100)).mul(A).add(this._uniforms.uFlowersMinScale);x.assign(v)})().compute(I.COUNT);computeVisibility=y(([e=f(0)])=>{const t=this._uniforms.uCameraMatrix.mul(R(e,1)),o=t.xyz.div(t.w),s=I.BLADE_BOUNDING_SPHERE_RADIUS,i=p(1);return S(i.negate().sub(s),o.x).mul(S(o.x,i.add(s))).mul(S(i.negate().sub(s),o.y)).mul(S(o.y,i.add(s))).mul(S(0,o.z)).mul(S(o.z,i))});computeAlpha=y(([e=f(0)])=>{const t=le.computeMapUvByPosition(e.xz);return Q(E(u.terrainTypeMap,t).g)});computeUpdate=y(()=>{const e=this._buffer1.element(_),t=X(e.x.sub(this._uniforms.uDelta.x).add(I.TILE_HALF_SIZE),I.TILE_SIZE).sub(I.TILE_HALF_SIZE),o=X(e.y.sub(this._uniforms.uDelta.y).add(I.TILE_HALF_SIZE),I.TILE_SIZE).sub(I.TILE_HALF_SIZE);e.x=t,e.y=o;const i=f(e.x,0,e.y).add(this._uniforms.uPlayerPosition),r=this.computeVisibility(i);e.w=r,xe(r,()=>{e.w=this.computeAlpha(i)})})().compute(I.COUNT);computePosition=y(([e=R(0),t=p(0)])=>{const o=U(_),s=f(e.x,0,e.y),i=e.z,r=O.mul(f(t,t.add(.25),t)),n=ee(this._uniforms.uTime.mul(5).mul(o)).mul(.015);return de(r,f(n,i.mul(2),n.mul(2))).add(s)});createFlowerMaterial(){this.precision="lowp";const e=this._buffer1.element(_),t=this._buffer2.element(_);this.positionNode=this.computePosition(e,t),this.opacityNode=e.w,this.alphaTest=.25;const o=X(p(_),2),s=p(1).sub(o),i=E(u.flowerCompositionTexture_1,N()).mul(o).mul(1.25),r=E(u.flowerCompositionTexture_2,N()).mul(s).mul(1.5),n=i.add(r);this.colorNode=n.mul(1.5)}async updateAsync(){await k.renderer.computeAsync(this.computeUpdate)}}class ns{uTime=a(0);constructor(){const e=u.realmModel.scene.getObjectByName("water_lilies");e.material=this.createMaterial(),b.scene.add(e),V.on("update",this.update.bind(this))}createMaterial(){const e=new Z;e.precision="lowp",e.transparent=!0,e.map=u.waterLiliesTexture,e.alphaTest=.5,e.alphaMap=u.waterLiliesAlphaTexture;const t=this.uTime.mul(5e-4),o=z.x.mul(.1),s=E(u.noiseTexture,F(z.xz.add(t).mul(o))).b.mul(.5),i=ee(s);return e.positionNode=O.add(i),e}update(e){const{clock:t}=e;this.uTime.value=t.getElapsedTime()}}const Ae={uBaseColor:a(new C)};class as extends Z{constructor(){super(),this.precision="lowp",this.flatShading=!1;const e=F(N()),t=E(u.barkDiffTexture,e);this.colorNode=t}}class ls extends Z{constructor(){super(),this.precision="lowp",this.flatShading=!1,this.transparent=!0,this.depthTest=!1,this.side=Ee,this.normalMap=u.canopyNorTexture;const e=E(u.canopyDiffTexture,N());this.colorNode=e.mul(Ae.uBaseColor)}}class cs{constructor(){const e=u.realmModel.scene.getObjectByName("tree"),t=u.realmModel.scene.children.filter(({name:w})=>w.startsWith("tree_collider")),o=new as,s=new ls,[i,r]=e.children,n=new ie(i.geometry,o,t.length);n.receiveShadow=!0;const l=new ie(r.geometry,s,t.length),h=u.realmModel.scene.getObjectByName("base_tree_collider").geometry.boundingBox,m=h.max.x,g=h.max.y/2;t.forEach((w,x)=>{n.setMatrixAt(x,w.matrix),l.setMatrixAt(x,w.matrix);const A=J.fixed().setTranslation(...w.position.toArray()).setRotation(w.quaternion),v=P.world.createRigidBody(A),te=m*w.scale.x,K=g*w.scale.y,$=Y.capsule(K,te).setRestitution(.15);P.world.createCollider($,v)}),b.scene.add(n,l),this.debugMonument()}debugMonument(){const e=W.panel.addFolder({title:"\uD83C\uDF33 Trees"});e.expanded=!1,e.addBinding(Ae.uBaseColor,"value",{label:"Canopy color",view:"color",color:{type:"float"}})}}class us{constructor(){new ss,new ns,new is,new cs}}const ds={uTime:a(0),uWavesSpeed:a(.02),uWavesAmplitude:a(.05),uWavesFrequency:a(2.68),uTroughColor:a(new C().setRGB(.16,.16,.16)),uSurfaceColor:a(new C().setRGB(.07,.08,.09)),uPeakColor:a(new C().setRGB(.52,.53,.52)),uPeakThreshold:a(.5),uPeakTransition:a(.5),uTroughThreshold:a(-.1),uTroughTransition:a(.35),uFresnelScale:a(.4)};class hs extends _e{_uniforms;debugFolder;constructor(e){super(),this._uniforms={...ds,...e},this.createWaterMaterial(),this.debugFolder=W.panel.addFolder({title:"\uD83C\uDF0A Water"}),this.debugFolder.expanded=!1,this.debugWaves(),this.debugColor(),this.debugFresnel()}computeElevation=y(([e=G(0,0)])=>{const t=this._uniforms.uTime.mul(this._uniforms.uWavesSpeed).mul(.1),o=X(e.mul(this._uniforms.uWavesFrequency).add(t),1),s=E(u.noiseTexture,F(o.mul(10)),2),i=M(s.r,s.g,.5);return M(i,s.b,.75).mul(this._uniforms.uWavesAmplitude).mul(.001)});computePosition=y(([e=p(0)])=>{const t=e.mul(10);return f(O.x,O.y.add(t),O.z)});computeNormal=y(([e=p(0)])=>{const t=p(.001),o=this.computeElevation(G(O.x.sub(t),O.z)),s=this.computeElevation(G(O.x,O.z.sub(t))),i=oe(f(t,o.sub(e),0)),r=oe(f(0,s.sub(e),t)),n=f(1e-4);return oe(Ye(i,r)).add(n)});computeFresnel=y(([e=B(f(0,0,0)),t=f(0,0,0)])=>{const o=$e(Qe(p(1).sub(be(pe(t,e),0,1))));return this._uniforms.uFresnelScale.mul(o)});computeReflectionColor=y(([e=B(f(0,0,0)),t=f(0,0,0)])=>{const o=et(t,e);return tt(u.envMapTexture,o)});computeColor=y(([e=B(f(0,0,0)),t=B(f(0,0,0)),o=B(f(0,0,0))])=>{const s=oe(o.sub(ue)),i=this.computeReflectionColor(e,s),r=this.computeFresnel(e,s),n=fe(t.y.sub(this._uniforms.uTroughThreshold).div(this._uniforms.uTroughTransition.mul(2))),l=M(this._uniforms.uTroughColor,this._uniforms.uSurfaceColor,n),c=fe(t.y.sub(this._uniforms.uPeakThreshold).div(this._uniforms.uPeakTransition.mul(2))),h=M(l,this._uniforms.uPeakColor,c),m=M(h,i.rgb,r),g=pe(o.xz.sub(ue.xz),o.xz.sub(ue.xz)),w=10,x=55,A=M(0,.5,j(w*w,x*x,g));return R(m,A)});createWaterMaterial(){this.precision="lowp";const e=this.computeElevation(N()).mul(1e3),t=this.computePosition(e),o=this.computeNormal(e),s=B(t,"vPosition"),i=B(o,"vNormal"),r=B(z,"vWorldPosition"),n=this.computeColor(i,s,r);this.transparent=!0,this.colorNode=n,this.positionNode=t}debugWaves(){const e=this.debugFolder.addFolder({title:"Waves"});e.addBinding(this._uniforms.uWavesAmplitude,"value",{min:0,max:.1,label:"Amplitude"}),e.addBinding(this._uniforms.uWavesFrequency,"value",{min:.1,max:10,label:"Frequency"}),e.addBinding(this._uniforms.uWavesSpeed,"value",{min:0,max:1,label:"Speed"})}debugColor(){const e=this.debugFolder.addFolder({title:"Color"});e.addBinding(this._uniforms.uTroughColor,"value",{label:"Trough Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uSurfaceColor,"value",{label:"Surface Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakColor,"value",{label:"Peak Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakThreshold,"value",{min:0,max:.5,label:"Peak Threshold"}),e.addBinding(this._uniforms.uPeakTransition,"value",{min:0,max:.5,label:"Peak Transition"}),e.addBinding(this._uniforms.uTroughThreshold,"value",{min:-.5,max:0,label:"Trough Threshold"}),e.addBinding(this._uniforms.uTroughTransition,"value",{min:0,max:.5,label:"Trough Transition"})}debugFresnel(){this.debugFolder.addFolder({title:"Fresnel"}).addBinding(this._uniforms.uFresnelScale,"value",{min:0,max:1,label:"Scale"})}}class ms{uTime=a(0);constructor(){const e=this.createWater();b.scene.add(e),V.on("update",this.update.bind(this))}createWater(){const e=u.realmModel.scene.getObjectByName("water");delete e.geometry.attributes.normal;const t=new hs({uTime:this.uTime});return e.material=t,e}update(e){const{clock:t}=e;this.uTime.value=t.getElapsedTime()}}const ps=()=>Object.freeze({MAP_SIZE:256,HALF_MAP_SIZE:256/2,KINTOUN_ACTIVATION_THRESHOLD:2,HALF_FLOOR_THICKNESS:.3,OUTER_MAP_SIZE:256*3,OUTER_HALF_MAP_SIZE:256*1.5}),D=ps();class fs{constructor(){new Qt,new jt,new ms,new us,new qt}}class ws{computeMapUvByPosition=y(([e=G(0)])=>e.add(D.HALF_MAP_SIZE).div(D.MAP_SIZE))}const le=new ws;class gs{mesh;rigidBody;smoothedCameraPosition=new L;desiredCameraPosition=new L;smoothedCameraTarget=new L;desiredTargetPosition=new L;yawInRadians=0;prevYawInRadians=-1;yawQuaternion=new st;JUMP_IMPULSE=75;JUMP_BUFFER_DURATION_IN_SECONDS=.2;MAX_CONSECUTIVE_JUMPS=2;JUMP_CUT_MULTIPLIER=.25;FALL_MULTIPLIER=2.75;MAX_UPWARD_VELOCITY=6;LINEAR_DAMPING=.35;ANGULAR_DAMPING=.6;jumpImpulse=new L(0,this.JUMP_IMPULSE,0);LIN_VEL_STRENGTH=35;ANG_VEL_STRENGTH=25;newLinVel=new L;newAngVel=new L;torqueAxis=new L;forwardVec=new L;isOnGround=!1;jumpCount=0;wasJumpHeld=!1;jumpBufferTimer=0;RADIUS=.5;PLAYER_INITIAL_POSITION=new L(0,5,0);CAMERA_OFFSET=new L(0,11,17);CAMERA_LERP_FACTOR=7.5;UP=new L(0,1,0);DOWN=new L(0,-1,0);FORWARD=new L(0,0,-1);rayOrigin=new L;ray=new at(this.rayOrigin,this.DOWN);uTime=a(0);uOffsetShadow=a(0);constructor(){this.mesh=this.createCharacterMesh(),b.scene.add(this.mesh),he.setTarget(this.mesh),this.rigidBody=P.world.createRigidBody(this.createRigidBodyDesc()),P.world.createCollider(this.createColliderDesc(),this.rigidBody),V.on("update",this.update.bind(this))}createCharacterMesh(){const e=new ot(this.RADIUS,2),t=new ys({uTime:this.uTime,uOffsetShadow:this.uOffsetShadow}),o=new Te(e,t);return o.castShadow=!0,o.position.copy(this.PLAYER_INITIAL_POSITION),o}createRigidBodyDesc(){const{x:e,y:t,z:o}=this.PLAYER_INITIAL_POSITION;return J.dynamic().setTranslation(e,t,o).setLinearDamping(this.LINEAR_DAMPING).setAngularDamping(this.ANGULAR_DAMPING)}createColliderDesc(){return Y.ball(this.RADIUS).setRestitution(.2).setFriction(1).setMass(3)}update(e){const{clock:t}=e,o=t.getDelta();this.uTime.value=t.getElapsedTime(),this.prevYawInRadians!==this.yawInRadians&&(this.yawQuaternion.setFromAxisAngle(this.UP,this.yawInRadians),this.prevYawInRadians=this.yawInRadians),this.updateVerticalMovement(o),this.updateHorizontalMovement(o),this.updateCameraPosition(o)}updateVerticalMovement(e){const t=H.isKeyPressed(" ");this.isOnGround=this.checkIfGrounded(),this.isOnGround&&(this.jumpCount=0),t&&!this.wasJumpHeld?this.jumpBufferTimer=this.JUMP_BUFFER_DURATION_IN_SECONDS:this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),this.jumpBufferTimer>0&&this.canJump()&&(this.performJump(),this.jumpBufferTimer=0);const s=this.rigidBody.linvel();this.handleJumpCut(t,s),this.handleFastFall(e,s,P.world.gravity.y),this.clampUpwardVelocity(s),this.rigidBody.setLinvel(s,!0),this.wasJumpHeld=t}checkIfGrounded(){this.rayOrigin.copy(this.rigidBody.translation()),this.rayOrigin.y-=this.RADIUS+.01;const e=.2,t=P.world.castRay(this.ray,e,!0);return t?t.timeOfImpact*e<.01:!1}canJump(){return this.isOnGround?!0:this.jumpCount<this.MAX_CONSECUTIVE_JUMPS}performJump(){this.rigidBody.applyImpulse(this.jumpImpulse,!0),this.jumpCount+=1}handleJumpCut(e,t){!(!e&&this.wasJumpHeld)||t.y<=0||(t.y*=this.JUMP_CUT_MULTIPLIER)}handleFastFall(e,t,o){if(t.y>=0)return;const s=this.FALL_MULTIPLIER*Math.abs(o)*e;t.y-=s}clampUpwardVelocity(e){e.y<=this.MAX_UPWARD_VELOCITY||(e.y=this.MAX_UPWARD_VELOCITY)}updateHorizontalMovement(e){const t=H.isKeyPressed("w")||H.isKeyPressed("arrowup"),o=H.isKeyPressed("s")||H.isKeyPressed("arrowdown"),s=H.isKeyPressed("a")||H.isKeyPressed("arrowleft"),i=H.isKeyPressed("d")||H.isKeyPressed("arrowright"),r=2;s&&(this.yawInRadians+=r*e),i&&(this.yawInRadians-=r*e),this.forwardVec.copy(this.FORWARD).applyQuaternion(this.yawQuaternion),this.torqueAxis.crossVectors(this.UP,this.forwardVec).normalize(),this.newLinVel.copy(this.rigidBody.linvel()),this.newAngVel.copy(this.rigidBody.angvel());const n=this.LIN_VEL_STRENGTH*e,l=this.ANG_VEL_STRENGTH*e;t&&(this.newLinVel.addScaledVector(this.forwardVec,n),this.newAngVel.addScaledVector(this.torqueAxis,l)),o&&(this.newLinVel.addScaledVector(this.forwardVec,-n),this.newAngVel.addScaledVector(this.torqueAxis,-l)),this.rigidBody.setLinvel(this.newLinVel,!0),this.rigidBody.setAngvel(this.newAngVel,!0),this.syncMeshWithBody()}syncMeshWithBody(){this.mesh.position.copy(this.rigidBody.translation()),this.mesh.quaternion.copy(this.rigidBody.rotation())}updateCameraPosition(e){this.desiredCameraPosition.copy(this.CAMERA_OFFSET).applyQuaternion(this.yawQuaternion).add(this.mesh.position);const t=this.CAMERA_LERP_FACTOR*e;this.smoothedCameraPosition.lerp(this.desiredCameraPosition,t),this.desiredTargetPosition.copy(this.mesh.position),this.desiredTargetPosition.y+=1,this.smoothedCameraTarget.lerp(this.desiredTargetPosition,t),b.camera.position.copy(this.smoothedCameraPosition),b.camera.lookAt(this.smoothedCameraTarget)}get position(){return this.mesh.position}get yaw(){return this.yawInRadians}}class ys extends Z{_uniforms;constructor(e){super(),this._uniforms={...e},this.createMaterial()}createMaterial(){this.flatShading=!0,this.castShadowNode=f(.6);const e=le.computeMapUvByPosition(z.xz),t=B(e),o=he.getBakedMapShadowColor(t),s=E(u.noiseTexture,F(z.xz),3).r,i=ee(this._uniforms.uTime.mul(2.5).add(s.mul(5))).mul(.05),r=p(-.15).add(i),n=p(1).sub(S(r,z.y)),l=p(1).sub(n),c=f(1),h=p(1).sub(j(-1.5,1,z.y).mul(n)),m=M(f(1),f(.6,.8,1).mul(.75),h),g=c.mul(m).mul(n),x=c.mul(l).add(g);this.colorNode=x.mul(o)}}class Ts{player;constructor(){this.player=new gs,new fs}getSizes(){const e=window.innerWidth,t=window.innerHeight;return{width:e,height:t,dpr:Math.min(window.devicePixelRatio,1.5),aspect:e/t}}onResize(){const e=this.getSizes();b.camera.aspect=e.aspect,b.camera.updateProjectionMatrix(),k.renderer.setSize(e.width,e.height),k.renderer.setPixelRatio(e.dpr)}async startLoop(){await k.init();const t={clock:new it(!0),player:this.player},o=async()=>{P.update(),V.emit("update",t),await k.renderAsync()};new ResizeObserver(()=>{this.onResize()}).observe(document.body),k.renderer.setAnimationLoop(o)}}const _s=new Nt;_s.initAsync().then(()=>{new Ts().startLoop()})});