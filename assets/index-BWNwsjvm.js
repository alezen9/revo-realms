import{T as _e,D as be,G as Ae,C as Pe,L as Ee,P as Le,p as Ie,m as Me,o as Se,e as ve,b as Ce,W as xe,V as Fe,A as Ne,S as De,a as Be,u as l,F as w,c as V,f as d,d as le,g as j,n as Re,v as m,h as y,i as Oe,j as Ue,O as Ge,Q as ze,I as Ve,M as ce,k as He,t as T,l as I,s as ue,q as C,r as R,w as de,x as G,y as me,z as We,B as k,E as W,H as oe,J as L,K as $,N as Z,R as D,U as ke,X as q,Y as Q,Z as se,_ as te,$ as Ze,a0 as U,a1 as z,a2 as J,a3 as B,a4 as he,a5 as S,a6 as pe,a7 as Ke,a8 as je,a9 as x,aa as qe,ab as K,ac as Je,ad as Xe,ae as Ye,af as $e,ag as Qe,ah as ee,ai as ne,aj as et}from"./three-D_P1wedE.js";import{World as tt,Ray as st,RigidBodyDesc as X,ColliderDesc as Y,HeightFieldFlags as ot,__tla as __tla_0}from"./@dimforge-Tx9Ov1ko.js";import{P as nt}from"./tweakpane-BXg6ZhiP.js";import{S as ie}from"./stats-gl-C2M3amu4.js";Promise.all([(()=>{try{return __tla_0}catch{}})()]).then(async()=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const it="/revo-realms/textures/noise/noise.webp",rt="/revo-realms/models/realm.glb",at="/revo-realms/textures/realm/water_grass_map.webp",lt="/revo-realms/textures/realm/sand_nor.webp",ct="/revo-realms/textures/realm/leaf.webp",ut="/revo-realms/textures/environment/px.webp",dt="/revo-realms/textures/environment/nx.webp",mt="/revo-realms/textures/environment/py.webp",ht="/revo-realms/textures/environment/ny.webp",pt="/revo-realms/textures/environment/pz.webp",gt="/revo-realms/textures/environment/nz.webp";class ft{textureLoader;gltfLoader;cubeTextureLoader;noiseTexture;envMapTexture;floorGrassWaterMap;sandNormalTexture;leafTexture;npcsModel;realmModel;constructor(){const e=this.createLoadingManager();this.textureLoader=new _e(e);const t=new be(e);t.setDecoderPath("/revo-realms/draco/"),this.gltfLoader=new Ae(e),this.gltfLoader.setDRACOLoader(t),this.cubeTextureLoader=new Pe(e)}createLoadingManager(){const e=new Ee;e.onStart=function(t,o,s){console.log("Started loading file: "+t+`.
Loaded `+o+" of "+s+" files.")},e.onLoad=function(){console.log("Loading complete!")},e.onProgress=function(t,o,s){console.log("Loading file: "+t+`.
Loaded `+o+" of "+s+" files.")},e.onError=function(t){console.log("There was an error loading "+t)}}async initAsync(){const e=await Promise.all([p.cubeTextureLoader.loadAsync([ut,dt,mt,ht,pt,gt]),this.textureLoader.loadAsync(it),this.gltfLoader.loadAsync(rt),this.textureLoader.loadAsync(at),this.textureLoader.loadAsync(lt),this.textureLoader.loadAsync(ct)]);this.envMapTexture=e[0],this.noiseTexture=e[1],this.realmModel=e[2],this.floorGrassWaterMap=e[3],this.floorGrassWaterMap.flipY=!1,this.sandNormalTexture=e[4],this.leafTexture=e[5]}}const p=new ft,wt="modulepreload",yt=function(u){return"/revo-realms/"+u},re={},Tt=function(e,t,o){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),r=i?.nonce||i?.getAttribute("nonce");s=Promise.allSettled(t.map(a=>{if(a=yt(a),a in re)return;re[a]=!0;const c=a.endsWith(".css"),g=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${a}"]${g}`))return;const h=document.createElement("link");if(h.rel=c?"stylesheet":wt,c||(h.as="script"),h.crossOrigin="",h.href=a,r&&h.setAttribute("nonce",r),document.head.appendChild(h),c)return new Promise((b,A)=>{h.addEventListener("load",b),h.addEventListener("error",()=>A(new Error(`Unable to preload CSS for ${a}`)))})}))}function n(i){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=i,window.dispatchEvent(r),!r.defaultPrevented)throw i}return s.then(i=>{for(const r of i||[])r.status==="rejected"&&n(r.reason);return e().catch(n)})};class _t{world;constructor(){}async init(){return Tt(()=>import("./@dimforge-Tx9Ov1ko.js").then(async m=>{await m.__tla;return m}),[]).then(()=>{this.world=new tt({x:0,y:-9.81,z:0})})}update(){this.world.step()}}const M=new _t;class bt{async initAsync(){await Promise.all([M.init(),p.initAsync()])}}class At{keysPressed;keyDownListeners;keyUpListeners;constructor(){this.keysPressed=new Set,this.keyDownListeners=new Map,this.keyUpListeners=new Map,window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this))}handleKeyDown(e){const t=e.key.toLowerCase();this.keysPressed.has(t)||(this.keysPressed.add(t),this.keyDownListeners.get(t)?.())}handleKeyUp(e){const t=e.key.toLowerCase();this.keysPressed.delete(t),this.keyUpListeners.get(t)?.()}isKeyPressed(e){return e==="*"?this.keysPressed.size>0:this.keysPressed.has(e.toLowerCase())}onKeyDown(e,t){this.keyDownListeners.set(e.toLowerCase(),t)}onKeyUp(e,t){this.keyUpListeners.set(e.toLowerCase(),t)}dispose(){window.removeEventListener("keydown",this.handleKeyDown.bind(this)),window.removeEventListener("keyup",this.handleKeyUp.bind(this))}}const N=new At;class Pt{panel;constructor(){this.panel=new nt({title:"Revo Realms"}),this.panel.hidden=!0,this.panel.element.parentElement.style.zIndex="1",this.panel.element.parentElement.style.width="340px"}setVisibility(e){this.panel.hidden=!e}}const H=new Pt;class Et{stats;lastSecond=performance.now();drawCallsPanel;geometriesPanel;constructor(e){const t=new ie({trackGPU:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,horizontal:!1,precision:2});e&&document.body.appendChild(t.dom),this.stats=t,this.drawCallsPanel=this.createNumberPanel("# DRAW CALLS","#fff","#333"),this.geometriesPanel=this.createNumberPanel("# GEOMETRIES","#ffdab9","#163843")}createNumberPanel(e,t,o){const s=this.stats.addPanel(new ie.Panel(e,t,o));return s.update=n=>{const i=s.canvas.getContext("2d");if(!i)return;const{width:r,height:a}=s.canvas;i.clearRect(0,0,r,a),i.fillStyle=o,i.fillRect(0,0,r,a),i.fillStyle=t;const c=i.font;i.textAlign="left",i.textBaseline="top",i.fillText(s.name,4,4),i.font="bold 20px Arial",i.textAlign="center",i.textBaseline="middle",i.fillText(`${Math.round(n)}`,r/2,a/1.65),i.font=c},s}updateCustomPanels(){const e=performance.now();if(e-this.lastSecond<1e3)return;const{render:t,memory:o}=O.renderer.info;this.drawCallsPanel.update(t.drawCalls,0),this.geometriesPanel.update(o.geometries,0),this.lastSecond=e}}class Lt{composer;constructor(){this.composer=new Le(O.renderer);const e=Ie(_.scene,_.renderCamera);e.setMRT(Me({output:Se,emissive:ve}));const t=e.getTextureNode("output"),o=e.getTextureNode("emissive"),s=Ce(o,.25,.1,.5),n=t.add(s);this.composer.outputNode=n,this.composer.needsUpdate=!0}}class It{renderer;canvas;monitoringManager;postprocessingManager;POSTPROCESSING_ENABLED=!1;MONITORING_ENABLED=!1;DEBUGGING_ENABLED=!1;constructor(){const e=document.createElement("canvas");e.classList.add("revo-realms"),document.body.appendChild(e),this.canvas=e;const t=new xe({canvas:e,antialias:!0,trackTimestamp:!1});t.shadowMap.enabled=!0,t.shadowMap.type=Fe,t.toneMapping=Ne,t.toneMappingExposure=1.5,this.renderer=t,this.monitoringManager=new Et(this.MONITORING_ENABLED),H.setVisibility(this.DEBUGGING_ENABLED)}async init(){this.postprocessingManager=new Lt,this.MONITORING_ENABLED&&await this.monitoringManager.stats.init(this.renderer)}async renderAsync(){this.MONITORING_ENABLED&&await this.renderer.resolveTimestampsAsync("compute"),this.POSTPROCESSING_ENABLED?await this.postprocessingManager.composer.renderAsync():await this.renderer.renderAsync(_.scene,_.renderCamera),this.MONITORING_ENABLED&&(this.monitoringManager.updateCustomPanels(),await this.renderer.resolveTimestampsAsync("render"),this.monitoringManager.stats.update())}}const O=new It;class Mt{scene;camera;renderCamera;cameraHelper;controls;orbitControlsCamera;constructor(){const e=new De;this.scene=e;const t=window.innerWidth,o=window.innerHeight,s=t/o,n=new Be(45,s,.01,100);n.position.set(0,5,10),this.camera=n,e.add(n),this.renderCamera=n}debugScene(){if(!this.controls)return;H.panel.addFolder({title:"\uD83C\uDFA5 View"}).addBinding(this.controls,"enabled",{label:"Enable orbit controls"}).on("change",({value:t})=>{!this.cameraHelper||!this.orbitControlsCamera||(this.renderCamera=t?this.orbitControlsCamera:this.camera,this.cameraHelper.visible=t)})}update(){this.controls?.enabled&&this.controls.update()}}const _=new Mt;class ae{emitters=[];registerEmitter(e){this.emitters.push({position:l(e.position),hue:l(e.hue),intensity:l(e.intensity)})}material_computeSingleEmissiveLight=w(({position:e=m(0,0,0),hue:t=m(1,0,0),intensity:o=10})=>{const s=e.sub(V),n=s.length(),i=d(1).div(d(1).add(n.mul(.3).add(n.pow(2).mul(.5)))),r=.5,a=s.normalize(),c=le(0,j(Re,a).mul(1-r).add(r));return t.mul(o).mul(c).mul(i)});material_computeEmissiveLight=w(()=>{let e=m(0);for(const t of this.emitters){const o=this.material_computeSingleEmissiveLight(t);e=e.add(o)}return e})}class St{directionalLight;ambientLight;emissive=new ae;LIGHT_POSITION_OFFSET=new y(10,20,10);constructor(){this.emissive=new ae,this.directionalLight=this.setupDirectionalLighting(),_.scene.add(this.directionalLight),this.ambientLight=this.setupAmbientLighting(),_.scene.add(this.ambientLight),this.debugLight()}setupAmbientLighting(){const e=new Oe("white",.4);return e.intensity=.5,e.color.setRGB(1,.95,.6),e}setupDirectionalLighting(){const e=new Ue;return e.intensity=1,e.color.setRGB(1,.85,.73),e.position.copy(this.LIGHT_POSITION_OFFSET),e.target=new Ge,e.castShadow=!0,e.shadow.intensity=.75,e.shadow.mapSize.width=64,e.shadow.mapSize.height=64,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-.5,e.shadow.camera.right=.5,e.shadow.camera.top=.5,e.shadow.camera.bottom=-.5,e.shadow.bias=-.003,e}debugLight(){const e=H.panel.addFolder({title:"\uD83D\uDCA1 Light"});e.addBinding(this.directionalLight,"color",{label:"Directional Color",view:"color",color:{type:"float"}}),e.addBinding(this.directionalLight,"intensity",{min:0,max:1,label:"Directional intensity"}),e.addBinding(this.ambientLight,"color",{label:"Ambient Color",view:"color",color:{type:"float"}}),e.addBinding(this.ambientLight,"intensity",{min:0,max:1,label:"Ambient intensity"})}material_computeIllumination=w(()=>m(0));setTarget(e){this.directionalLight.target=e}update(e){const{player:t}=e;this.directionalLight.position.copy(t.position).add(this.LIGHT_POSITION_OFFSET)}}const ge=new St;class vt{mesh;rigidBody;smoothedCameraPosition=new y;desiredCameraPosition=new y;smoothedCameraTarget=new y;desiredTargetPosition=new y;yawInRadians=0;prevYawInRadians=-1;yawQuaternion=new ze;JUMP_IMPULSE=5;JUMP_BUFFER_DURATION_IN_SECONDS=.2;MAX_CONSECUTIVE_JUMPS=2;JUMP_CUT_MULTIPLIER=.25;FALL_MULTIPLIER=2.75;MAX_UPWARD_VELOCITY=6;LINEAR_DAMPING=.25;ANGULAR_DAMPING=1;jumpImpulse=new y(0,this.JUMP_IMPULSE,0);LIN_VEL_STRENGTH=25;ANG_VEL_STRENGTH=25;newLinVel=new y;newAngVel=new y;torqueAxis=new y;forwardVec=new y;isOnGround=!1;jumpCount=0;wasJumpHeld=!1;jumpBufferTimer=0;RADIUS=.5;PLAYER_INITIAL_POSITION=new y(0,5,0);CAMERA_OFFSET=new y(0,13,16);CAMERA_LERP_FACTOR=7.5;UP=new y(0,1,0);DOWN=new y(0,-1,0);FORWARD=new y(0,0,-1);rayOrigin=new y;ray=new st(this.rayOrigin,this.DOWN);uTime=l(0);constructor(){this.mesh=this.createCharacterMesh(),_.scene.add(this.mesh),ge.setTarget(this.mesh),this.rigidBody=M.world.createRigidBody(this.createRigidBodyDesc()),M.world.createCollider(this.createColliderDesc(),this.rigidBody)}createCharacterMesh(){const e=new Ve(this.RADIUS,3),t=new Ct({uTime:this.uTime}),o=new ce(e,t);return o.castShadow=!0,o.position.copy(this.PLAYER_INITIAL_POSITION),o}createRigidBodyDesc(){const{x:e,y:t,z:o}=this.PLAYER_INITIAL_POSITION;return X.dynamic().setTranslation(e,t,o).setLinearDamping(this.LINEAR_DAMPING).setAngularDamping(this.ANGULAR_DAMPING)}createColliderDesc(){return Y.ball(this.RADIUS).setRestitution(.2).setFriction(1)}update(e){const{clock:t}=e,o=t.getDelta();this.uTime.value=t.getElapsedTime(),this.prevYawInRadians!==this.yawInRadians&&(this.yawQuaternion.setFromAxisAngle(this.UP,this.yawInRadians),this.prevYawInRadians=this.yawInRadians),this.updateVerticalMovement(o),this.updateHorizontalMovement(o),this.updateCameraPosition(o)}updateVerticalMovement(e){const t=N.isKeyPressed(" ");this.isOnGround=this.checkIfGrounded(),this.isOnGround&&(this.jumpCount=0),t&&!this.wasJumpHeld?this.jumpBufferTimer=this.JUMP_BUFFER_DURATION_IN_SECONDS:this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),this.jumpBufferTimer>0&&this.canJump()&&(this.performJump(),this.jumpBufferTimer=0);const s=this.rigidBody.linvel();this.handleJumpCut(t,s),this.handleFastFall(e,s,M.world.gravity.y),this.clampUpwardVelocity(s),this.rigidBody.setLinvel(s,!0),this.wasJumpHeld=t}checkIfGrounded(){this.rayOrigin.copy(this.rigidBody.translation()),this.rayOrigin.y-=this.RADIUS+.01;const e=.2,t=M.world.castRay(this.ray,e,!0);return t?t.timeOfImpact*e<.01:!1}canJump(){return this.isOnGround?!0:this.jumpCount<this.MAX_CONSECUTIVE_JUMPS}performJump(){this.rigidBody.applyImpulse(this.jumpImpulse,!0),this.jumpCount+=1}handleJumpCut(e,t){!(!e&&this.wasJumpHeld)||t.y<=0||(t.y*=this.JUMP_CUT_MULTIPLIER)}handleFastFall(e,t,o){if(t.y>=0)return;const s=this.FALL_MULTIPLIER*Math.abs(o)*e;t.y-=s}clampUpwardVelocity(e){e.y<=this.MAX_UPWARD_VELOCITY||(e.y=this.MAX_UPWARD_VELOCITY)}updateHorizontalMovement(e){const t=N.isKeyPressed("w")||N.isKeyPressed("arrowup"),o=N.isKeyPressed("s")||N.isKeyPressed("arrowdown"),s=N.isKeyPressed("a")||N.isKeyPressed("arrowleft"),n=N.isKeyPressed("d")||N.isKeyPressed("arrowright"),i=2;s&&(this.yawInRadians+=i*e),n&&(this.yawInRadians-=i*e),this.forwardVec.copy(this.FORWARD).applyQuaternion(this.yawQuaternion),this.torqueAxis.crossVectors(this.UP,this.forwardVec).normalize(),this.newLinVel.copy(this.rigidBody.linvel()),this.newAngVel.copy(this.rigidBody.angvel());const r=this.LIN_VEL_STRENGTH*e,a=this.ANG_VEL_STRENGTH*e;t&&(this.newLinVel.addScaledVector(this.forwardVec,r),this.newAngVel.addScaledVector(this.torqueAxis,a)),o&&(this.newLinVel.addScaledVector(this.forwardVec,-r),this.newAngVel.addScaledVector(this.torqueAxis,-a)),this.rigidBody.setLinvel(this.newLinVel,!0),this.rigidBody.setAngvel(this.newAngVel,!0),this.syncMeshWithBody()}syncMeshWithBody(){this.mesh.position.copy(this.rigidBody.translation()),this.mesh.quaternion.copy(this.rigidBody.rotation())}updateCameraPosition(e){this.desiredCameraPosition.copy(this.CAMERA_OFFSET).applyQuaternion(this.yawQuaternion).add(this.mesh.position);const t=this.CAMERA_LERP_FACTOR*e;this.smoothedCameraPosition.lerp(this.desiredCameraPosition,t),this.desiredTargetPosition.copy(this.mesh.position),this.desiredTargetPosition.y+=1,this.smoothedCameraTarget.lerp(this.desiredTargetPosition,t),_.camera.position.copy(this.smoothedCameraPosition),_.camera.lookAt(this.smoothedCameraTarget)}get position(){return this.mesh.position}get yaw(){return this.yawInRadians}}class Ct extends He{_uniforms;constructor(e){super(),this._uniforms={...e},this.createMaterial()}createMaterial(){this.flatShading=!0,this.roughness=.5;const e=T(p.noiseTexture,I(V.xz),3).r,t=ue(this._uniforms.uTime.mul(2.5).add(e.mul(5))).mul(.05),o=d(-.15).add(t),s=d(1).sub(C(o,V.y)),n=d(1).sub(s),i=R("silver"),r=i.mul(n),a=i.mul(1.5).mul(s),c=r.add(a);this.colorNode=c;const g=d(.9).mul(n),h=d(.65).mul(s);this.metalnessNode=g.add(h)}}const xt=()=>({BLADE_WIDTH:.15,BLADE_HEIGHT:1.25,BLADE_BOUNDING_SPHERE_RADIUS:1.25,TILE_SIZE:120,TILE_HALF_SIZE:120/2,BLADES_PER_SIDE:600,COUNT:600*600,SPACING:120/600}),f=xt(),fe={uTime:l(0),uPlayerPosition:l(new y(0,0,0)),uCameraMatrix:l(new de),uBladeMinScale:l(.5),uBladeMaxScale:l(1.25),uTrailGrowthRate:l(.004),uTrailMinScale:l(.1),uTrailRaius:l(.65),uTrailRaiusSquared:l(.65*.65),uGlowRadius:l(2),uGlowRadiusSquared:l(4),uGlowFadeIn:l(.05),uGlowFadeOut:l(.01),uGlowColor:l(new G().setRGB(1,.6,.1)),uBladeMaxBendAngle:l(Math.PI*.15),uBaseColor:l(new G().setRGB(.1,.2,0)),uTipColor:l(new G().setRGB(.8,.9,.2)),uDelta:l(new me(0,0))};class Ft extends W{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...fe,...e},this._buffer1=oe(f.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=oe(f.COUNT,"vec4"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createGrassMaterial()}computeInit=w(()=>{const e=this._buffer1.element(L),t=$(d(L).div(f.BLADES_PER_SIDE)),o=d(L).mod(f.BLADES_PER_SIDE),s=Z(L.add(4321)),n=Z(L.add(1234)),i=o.mul(f.SPACING).sub(f.TILE_HALF_SIZE).add(s.mul(f.SPACING*.5)),r=t.mul(f.SPACING).sub(f.TILE_HALF_SIZE).add(n.mul(f.SPACING*.5)),a=m(i,0,r);e.x=i,e.y=r;const c=a.xz.add(f.TILE_HALF_SIZE).div(f.TILE_SIZE),g=d(2),h=I(c.mul(g)),A=T(p.noiseTexture,h,1).b.sub(.5).mul(d(Math.PI*2));e.z=A;const E=this._buffer2.element(L),F=this._uniforms.uBladeMaxScale.sub(this._uniforms.uBladeMinScale),v=Z(L.add(100)).mul(F).add(this._uniforms.uBladeMinScale);E.x=v,E.y=v})().compute(f.COUNT);computeVisibility=w(([e=m(0)])=>{const t=this._uniforms.uCameraMatrix.mul(D(e,1)),o=t.xyz.div(t.w),s=f.BLADE_BOUNDING_SPHERE_RADIUS,n=d(1);return C(n.negate().sub(s),o.x).mul(C(o.x,n.add(s))).mul(C(n.negate().sub(s),o.y)).mul(C(o.y,n.add(s))).mul(C(0,o.z)).mul(C(o.z,n))});computeBending=w(([e=D(0,0,0,0),t=m(0,0,0)])=>{const o=t.xz.add(this._uniforms.uTime.mul(.25)).mul(.5),s=I(o),i=T(p.noiseTexture,s,5).r.mul(.35);return e.w.add(i.sub(e.w).mul(.1))});computeAlpha=w(([e=m(0)])=>{const t=e.xz.add(P.HALF_MAP_SIZE).div(P.MAP_SIZE);return T(p.floorGrassWaterMap,t).g});computeTrailScale=w(([e=D(0),t=d(0)])=>{const o=e.x.add(this._uniforms.uTrailGrowthRate),s=d(1).sub(t),n=this._uniforms.uTrailMinScale.mul(t).add(o.mul(s));return ke(n,e.y)});computeTrailGlow=w(([e=D(0),t=d(0),o=d(0),s=d(0)])=>{const n=q(this._uniforms.uGlowRadiusSquared,d(0),t),i=100,r=$(Q(this._uniforms.uDelta.x).mul(i)),a=$(Q(this._uniforms.uDelta.y).mul(i)),c=C(1,r.add(a)),g=n.mul(d(1).sub(o)).mul(s),h=le(c,e.w).mul(g),b=h.mul(this._uniforms.uGlowFadeIn),A=d(1).sub(h).mul(this._uniforms.uGlowFadeOut),E=d(1).sub(c).mul(this._uniforms.uGlowFadeOut).mul(e.w);return se(e.w.add(b).sub(A).sub(E),0,1)});computeUpdate=w(()=>{const e=this._buffer1.element(L),t=this._buffer2.element(L),o=te(e.x.sub(this._uniforms.uDelta.x).add(f.TILE_HALF_SIZE),f.TILE_SIZE).sub(f.TILE_HALF_SIZE),s=te(e.y.sub(this._uniforms.uDelta.y).add(f.TILE_HALF_SIZE),f.TILE_SIZE).sub(f.TILE_HALF_SIZE),n=m(o,0,s);e.x=o,e.y=s;const i=n.add(this._uniforms.uPlayerPosition),r=this.computeVisibility(i);t.z=r,Ze(r,()=>{const a=U(this._uniforms.uDelta.x,this._uniforms.uDelta.y),c=n.xz.sub(a),g=c.dot(c),h=C(.1,d(1).sub(this._uniforms.uPlayerPosition.y)),b=C(g,this._uniforms.uTrailRaiusSquared).mul(h);t.x=this.computeTrailScale(t,b),t.z=this.computeAlpha(i),e.w=this.computeBending(e,i),t.w=this.computeTrailGlow(t,g,b,h)})})().compute(f.COUNT);computePosition=w(([e=D(0),t=D(0)])=>{const o=m(e.x,0,e.y),s=e.z,n=e.w,i=t.x,r=n.mul(z().y),c=J(B,m(r,0,0)).mul(m(1,i,1));return J(c,m(0,s,0)).add(o)});computeDiffuseColor=w(([e=D(0)])=>{const t=he(z().y,1.5),o=S(this._uniforms.uBaseColor,this._uniforms.uTipColor,t),s=Z(L).mul(.05).sub(.025),n=e.w;return S(o.add(s),this._uniforms.uGlowColor,n)});computeAO=w(()=>{const e=Q(ue(this._buffer1.element(L).z)).mul(.5);return q(-.75,1.25,z().y).mul(d(1).sub(e))});createGrassMaterial(){this.precision="lowp",this.side=pe;const e=this._buffer1.element(L),t=this._buffer2.element(L);this.positionNode=this.computePosition(e,t),this.opacityNode=t.z,this.alphaTest=.25,this.aoNode=this.computeAO(),this.colorNode=this.computeDiffuseColor(t)}async updateAsync(){await O.renderer.computeAsync(this.computeUpdate)}}class Nt{material;grassField;uniforms={...fe,uDelta:l(new me(0,0)),uPlayerPosition:l(new y(0,0,0)),uCameraMatrix:l(new de),uTime:l(0)};constructor(){const e=this.createBladeGeometry();e.instanceCount=f.COUNT,this.material=new Ft(this.uniforms),this.grassField=new ce(e,this.material),_.scene.add(this.grassField)}debugGrass(){const e=H.panel.addFolder({title:"\uD83C\uDF31 Grass"});e.addBinding(this.uniforms.uTipColor,"value",{label:"Tip Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGlowColor,"value",{label:"Glow Color",view:"color",color:{type:"float"}})}createBladeGeometry(){const e=f.BLADE_WIDTH/2,t=e/2,o=f.BLADE_HEIGHT/2,s=new Float32Array([-e,0,0,e,0,0,-t,o*1,0,t,o*1,0,0,o*2,0]),n=new Float32Array([0,0,1,0,.25,o*1,.75,o*1,.5,o*2]),i=new Uint16Array([0,1,3,0,3,2,2,3,4]),a=25*Math.PI/180,c=Math.cos(a),g=Math.sin(a),b=15*Math.PI/180,A=Math.cos(b),E=Math.sin(b),F=new Float32Array([-c,g,0,c,g,0,-A,E,0,A,E,0,0,1,0]),v=new We;return v.setAttribute("position",new k(s,3)),v.setAttribute("uv",new k(n,2)),v.setIndex(new k(i,1)),v.setAttribute("normal",new k(F,3)),v}async updateAsync(e){const{player:t,clock:o}=e,s=t.position.x-this.grassField.position.x,n=t.position.z-this.grassField.position.z;this.uniforms.uDelta.value.set(s,n),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(_.camera.projectionMatrix).multiply(_.camera.matrixWorldInverse),this.uniforms.uTime.value=o.getElapsedTime(),this.grassField.position.copy(t.position).setY(0),await this.material.updateAsync()}}const we={uBaseColor:l(new G("#8c8c8c"))};class Dt extends W{_uniforms;constructor(e){super(),this._uniforms={...we,...e},this.createMaterial()}createMaterial(){this.flatShading=!1;const e=T(p.noiseTexture,I(z().mul(1.5))).mul(.1),t=T(p.noiseTexture,z().mul(.5)).mul(.05),o=e.add(t),s=this._uniforms.uBaseColor.add(o.b),n=se(j(Ke,m(0,1,0)),.3,1),i=s.mul(n);this.colorNode=i}}class Bt{uniforms=we;constructor(){const e=new Dt(this.uniforms),t=p.realmModel.scene.children.filter(({name:s})=>s.endsWith("_monument"));t.forEach(s=>{s.material=e}),_.scene.add(...t),p.realmModel.scene.children.filter(({name:s})=>s.startsWith("monument_collider")).forEach(s=>{const n=X.fixed().setTranslation(...s.position.toArray()).setRotation(s.quaternion),i=M.world.createRigidBody(n),r=.5*s.scale.x,a=.5*s.scale.y,c=.5*s.scale.z,g=Y.cuboid(r,a,c).setRestitution(.2);M.world.createCollider(g,i)}),this.debugMonument()}debugMonument(){H.panel.addFolder({title:"\uD83D\uDDFD Monuments"}).addBinding(this.uniforms.uBaseColor,"value",{label:"Color",view:"color",color:{type:"float"}})}}class Rt{uniforms={uTime:l(0),uPlantColor:l(new G().setRGB(.4,.7,.35))};constructor(){const e=p.realmModel.scene.getObjectByName("plant");e.geometry.computeVertexNormals(),e.material=new Ot(this.uniforms),e.position.set(0,0,-30);const t=p.realmModel.scene.children.filter(s=>s.name.startsWith("plant_placeholder")),o=new je(e.geometry,e.material,t.length);for(let s=0;s<t.length;s++)o.setMatrixAt(s,t[s].matrix);_.scene.add(o),this.debugPlants()}debugPlants(){H.panel.addFolder({title:"\uD83C\uDF3F Plants"}).addBinding(this.uniforms.uPlantColor,"value",{label:"Color",view:"color",color:{type:"float"}})}update(e){const{clock:t}=e;this.uniforms.uTime.value=t.getElapsedTime()}}class Ot extends W{_uniforms;constructor(e){super(),this._uniforms={...e},this.createMaterial()}computeDisplacement=w(()=>{const e=z().y.mul(.1),t=I(V.xz.add(this._uniforms.uTime.mul(.075))),o=T(p.noiseTexture,t,3).r.mul(1.5).mul(e);return B.add(m(0,o.negate(),0))});createMaterial(){this.transparent=!0,this.side=pe,this.positionNode=this.computeDisplacement();const e=T(p.leafTexture,z());this.colorNode=e.mul(D(this._uniforms.uPlantColor,1)),this.aoNode=m(.5),this.alphaTest=.5}}const Ut={uTime:l(0)};class Gt extends W{_uniforms;constructor(e){super(),this._uniforms={...Ut,...e},this.createMaterial()}computeCausticsDiffuse=w(([e=U(0,0),t=m(0,0,0)])=>{const o=this._uniforms.uTime.mul(.1),s=d(15),n=e.mul(s),i=I(n.add(U(o,0))),r=I(n.add(U(0,o.negate()))),a=T(p.noiseTexture,i,1).g,c=T(p.noiseTexture,r,2).g,g=a.add(c),h=he(g,3),b=m(1.2,1.2,.8).mul(.15);return S(t,b,h)});computeWaterDiffuse=w(([e=d(0),t=U(0,0)])=>{const o=d(5),s=d(.001),n=q(0,o.add(s),e),i=R("#D8C098"),r=i.mul(.5),a=i.add(r.sub(i).mul(n)),c=this.computeCausticsDiffuse(t);return a.add(c)});createMaterial(){const e=V.xz.add(P.HALF_MAP_SIZE).div(P.MAP_SIZE),t=x(e),o=T(p.floorGrassWaterMap,t,2.5),s=o.g,n=o.b,r=d(1).sub(s).sub(n),a=T(p.noiseTexture,e,2).b,c=S(R("#A3A16D"),R("#8C865A"),a).mul(s),g=S(R("#D8C098"),R("#B89A77"),a).mul(2.25).mul(r),h=x(V.y.negate()),A=this.computeWaterDiffuse(h,t).mul(n);this.colorNode=c.add(g).add(A);const E=I(e.mul(30)),F=I(e.mul(-30)),v=T(p.sandNormalTexture,E),ye=T(p.sandNormalTexture,F),Te=J(ye.rgb,m(1,0,0));this.normalNode=v.mul(Te)}}class zt extends W{constructor(){super(),this.createMaterial()}createMaterial(){const e=V.xz.add(P.HALF_MAP_SIZE).div(P.MAP_SIZE),t=I(e),o=T(p.noiseTexture,t,2).b,s=S(R("#A3A16D"),R("#8C865A"),o),n=I(e.mul(30)),i=I(e.mul(15)),r=T(p.sandNormalTexture,n),a=T(p.sandNormalTexture,i),c=J(a.rgb,m(1,0,0));this.normalNode=r.mul(c),this.colorNode=s}}class Vt{uTime=l(0);constructor(){const e=this.createFloor();_.scene.add(e)}createFloor(){const e=p.realmModel.scene.getObjectByName("floor");return delete e.geometry.attributes.normal,e.material=new Gt({uTime:this.uTime}),e.receiveShadow=!0,this.createFloorPhysics(),e}getFloorDisplacementData(){const e=p.realmModel.scene.getObjectByName("heightfield"),t=e.geometry.attributes._displacement.array[0],o=e.geometry.attributes.position;e.geometry.boundingBox||e.geometry.computeBoundingBox();const s=e.geometry.boundingBox,n=o.count,i=Math.sqrt(n),r=s.max.x,a=new Float32Array(n);for(let c=0;c<n;c++){const g=o.array[c*3+0],h=o.array[c*3+1],b=o.array[c*3+2],A=Math.round((g/(r*2)+.5)*(i-1)),F=Math.round((b/(r*2)+.5)*(i-1))+A*i;a[F]=h}return{rowsCount:i,heights:a,displacement:t}}createFloorPhysics(){const e=this.getFloorDisplacementData(),{rowsCount:t,heights:o,displacement:s}=e,n=X.fixed().setTranslation(0,-s,0),i=M.world.createRigidBody(n),r=Y.heightfield(t-1,t-1,o,{x:P.MAP_SIZE,y:1,z:P.MAP_SIZE},ot.FIX_INTERNAL_EDGES).setFriction(1).setRestitution(.2);M.world.createCollider(r,i)}update(e){const{clock:t}=e;this.uTime.value=t.getElapsedTime()}}class Ht{outerFloor;kintoun;kintounPosition=new y;constructor(){this.outerFloor=this.createOuterFloorVisual(),this.kintoun=this.createKintoun(),_.scene.add(this.outerFloor)}createOuterFloorVisual(){const e=p.realmModel.scene.getObjectByName("outer_world");return e.material=new zt,e}createKintoun(){const e=X.kinematicPositionBased().setTranslation(0,-20,0),t=M.world.createRigidBody(e),o=2,s=Y.cuboid(o,P.HALF_FLOOR_THICKNESS,o).setFriction(1).setRestitution(.2);return M.world.createCollider(s,t),t}useKintoun(e){this.kintounPosition.copy(e).setY(-P.HALF_FLOOR_THICKNESS),this.kintoun.setTranslation(this.kintounPosition,!0)}update(e){const{player:t}=e,o=P.HALF_MAP_SIZE-Math.abs(t.position.x)<P.KINTOUN_ACTIVATION_THRESHOLD,s=P.HALF_MAP_SIZE-Math.abs(t.position.z)<P.KINTOUN_ACTIVATION_THRESHOLD;(o||s)&&this.useKintoun(t.position);const n=P.MAP_SIZE,i=Math.abs(t.position.x),r=Math.sign(t.position.x),a=Math.abs(t.position.z),c=Math.sign(t.position.z),g=i>n?i-n:0,h=a>n?a-n:0;this.outerFloor.position.set(g*r,0,h*c)}}class Wt{innerTerrain;outerTerrain;constructor(){this.innerTerrain=new Vt,this.outerTerrain=new Ht}update(e){this.innerTerrain.update(e),this.outerTerrain.update(e)}}const kt={uTime:l(0),uWavesSpeed:l(.02),uWavesAmplitude:l(.02),uWavesFrequency:l(.64),uTroughColor:l(new G("#186691")),uSurfaceColor:l(new G("#9bd8c0")),uPeakColor:l(new G("#bbd8e0")),uPeakThreshold:l(.5),uPeakTransition:l(0),uTroughThreshold:l(-.23),uTroughTransition:l(.15),uFresnelScale:l(.8)};class Zt extends qe{_uniforms;debugFolder;constructor(e){super(),this._uniforms={...kt,...e},this.createWaterMaterial(),this.debugFolder=H.panel.addFolder({title:"\uD83C\uDF0A Water"});const t=!1;this.debugFolder.hidden=!t}computeElevation=w(([e=U(0,0)])=>{const t=this._uniforms.uTime.mul(this._uniforms.uWavesSpeed).mul(.1),o=te(e.mul(this._uniforms.uWavesFrequency).add(t),1),s=T(p.noiseTexture,o,.5).b,n=T(p.noiseTexture,o,1.5).b;return S(s,n,.5).mul(this._uniforms.uWavesAmplitude).mul(.001)});computePosition=w(([e=d(0)])=>{const t=e.mul(10);return m(B.x,B.y.add(t),B.z)});computeNormal=w(([e=d(0)])=>{const t=d(.001),o=this.computeElevation(U(B.x.sub(t),B.z)),s=this.computeElevation(U(B.x,B.z.sub(t))),n=K(m(t,o.sub(e),0)),i=K(m(0,s.sub(e),t)),r=m(1e-4);return K(Je(n,i)).add(r)});computeFresnel=w(([e=x(m(0,0,0)),t=m(0,0,0)])=>{const o=Xe(Ye(d(1).sub(se(j(t,e),0,1))));return this._uniforms.uFresnelScale.mul(o)});computeReflectionColor=w(([e=x(m(0,0,0)),t=m(0,0,0)])=>{let o=$e(t,e);return o.x=o.x.negate(),Qe(p.envMapTexture,o)});computeColor=w(([e=x(m(0,0,0)),t=x(m(0,0,0)),o=x(m(0,0,0))])=>{const s=K(t.sub(ee)),n=this.computeReflectionColor(e,s),i=this.computeFresnel(e,s),r=ne(t.y.sub(this._uniforms.uTroughThreshold).div(this._uniforms.uTroughTransition.mul(2))),a=S(this._uniforms.uTroughColor,this._uniforms.uSurfaceColor,r),c=ne(t.y.sub(this._uniforms.uPeakThreshold).div(this._uniforms.uPeakTransition.mul(2))),g=S(a,this._uniforms.uPeakColor,c),h=S(g,n.rgb,i),b=j(o.xz.sub(ee.xz),o.xz.sub(ee.xz)),A=10,E=55,F=S(0,1,q(A*A,E*E,b));return D(h,F)});createWaterMaterial(){this.precision="lowp";const e=this.computeElevation(z()).mul(1e3),t=this.computePosition(e),o=this.computeNormal(e),s=x(t,"vPosition"),n=x(o,"vNormal"),i=x(V,"vWorldPosition"),r=this.computeColor(n,s,i);this.transparent=!0,this.colorNode=r,this.positionNode=t}debugWaves(){const e=this.debugFolder.addFolder({title:"Waves"});e.addBinding(this._uniforms.uWavesAmplitude,"value",{min:0,max:.1,label:"Amplitude"}),e.addBinding(this._uniforms.uWavesFrequency,"value",{min:.1,max:10,label:"Frequency"}),e.addBinding(this._uniforms.uWavesSpeed,"value",{min:0,max:1,label:"Speed"})}debugColor(){const e=this.debugFolder.addFolder({title:"Color"});e.addBinding(this._uniforms.uTroughColor,"value",{label:"Trough Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uSurfaceColor,"value",{label:"Surface Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakColor,"value",{label:"Peak Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakThreshold,"value",{min:0,max:.5,label:"Peak Threshold"}),e.addBinding(this._uniforms.uPeakTransition,"value",{min:0,max:.5,label:"Peak Transition"}),e.addBinding(this._uniforms.uTroughThreshold,"value",{min:-.5,max:0,label:"Trough Threshold"}),e.addBinding(this._uniforms.uTroughTransition,"value",{min:0,max:.5,label:"Trough Transition"})}debugFresnel(){this.debugFolder.addFolder({title:"Fresnel"}).addBinding(this._uniforms.uFresnelScale,"value",{min:0,max:1,label:"Scale"})}}class Kt{uTime=l(0);constructor(){const e=this.createWater();_.scene.add(e)}createWater(){const e=p.realmModel.scene.getObjectByName("water");delete e.geometry.attributes.normal;const t=new Zt({uTime:this.uTime});return e.material=t,e}}const jt=()=>Object.freeze({MAP_SIZE:256,HALF_MAP_SIZE:256/2,KINTOUN_ACTIVATION_THRESHOLD:2,HALF_FLOOR_THICKNESS:.3,OUTER_MAP_SIZE:256*3,OUTER_HALF_MAP_SIZE:256*1.5}),P=jt();class qt{terrain;plants;grass;constructor(){this.terrain=new Wt,this.plants=new Rt,this.grass=new Nt,new Bt,new Kt}async updateAsync(e){this.terrain.update(e),this.plants.update(e),await this.grass.updateAsync(e)}}class Jt{player;realm;constructor(){this.player=new vt,this.realm=new qt}getSizes(){const e=window.innerWidth,t=window.innerHeight;return{width:e,height:t,dpr:Math.min(window.devicePixelRatio,1.5),aspect:e/t}}onResize(){const e=this.getSizes();_.camera.aspect=e.aspect,_.camera.updateProjectionMatrix(),O.renderer.setSize(e.width,e.height),O.renderer.setPixelRatio(e.dpr)}async startLoop(){await O.init();const t={clock:new et(!0),player:this.player},o=async()=>{M.update(),this.player.update(t),ge.update(t),this.realm.updateAsync(t),await O.renderAsync()};new ResizeObserver(()=>{this.onResize()}).observe(document.body),O.renderer.setAnimationLoop(o)}}const Xt=new bt;Xt.initAsync().then(()=>{new Jt().startLoop()})});