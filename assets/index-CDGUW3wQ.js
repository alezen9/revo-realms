import{T as me,D as pe,G as ge,C as fe,L as ye,_ as we,V as T,u as d,I as Te,M as _e,a as ee,Q as Me,b as R,c as te,F as f,m as Z,t as _,d as N,v as F,e as u,p as v,f as m,n as U,g as Ae,h as xe,l as be,i as se,j as V,k as S,r as Pe,o as Ie,q as z,s as q,w as j,x as C,y as P,z as K,A as Le,B as Ee,E as oe,H as D,J as ne,K as re,N as Se,O as ve,P as Ce,R as Ne,S as De,U as Re,W as Fe,X as Be,Y as Oe,Z as Ue,$ as Ge,a0 as He,a1 as ze,a2 as ke,a3 as We,a4 as Ze,a5 as Ve,a6 as ae,a7 as ie,a8 as je,a9 as G,aa as X,ab as A,ac as k,ad as H,ae as E,af as Ke,ag as W,ah as Je,ai as Y,aj as qe,ak as Xe,al as Ye}from"./three-BwfS4HxS.js";import{RigidBodyDesc as B,ColliderDesc as O,Ray as Qe,HeightFieldFlags as $e,World as et}from"./@dimforge-CmnDU9Yz.js";import{P as tt}from"./tweakpane-BXg6ZhiP.js";import{S as Q}from"./stats-gl-C2M3amu4.js";(async()=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=t(o);fetch(o.href,n)}})();const st="/revo-realms/textures/perlin_noise.webp",ot="/revo-realms/textures/random_noise.webp",nt="/revo-realms/textures/voronoi_noise.webp",rt="/revo-realms/models/realm.glb",at="/revo-realms/models/npcs.glb",it="/revo-realms/textures/realm/floor.webp",lt="/revo-realms/textures/realm/water_map.webp",ct="/revo-realms/textures/realm/grass_map.webp",dt="/revo-realms/textures/realm/fence.webp",ut="/revo-realms/textures/realm/coast_sand_diff.webp",ht="/revo-realms/textures/realm/coast_sand_nor.webp",mt="/revo-realms/textures/realm/coast_sand_arm.webp",pt="/revo-realms/textures/realm/grass_diff.jpg",gt="/revo-realms/textures/realm/grass_nor.png",ft="/revo-realms/textures/realm/leaves_arm.jpg",yt="/revo-realms/textures/realm/stone_diff.jpg",wt="/revo-realms/textures/realm/stone_nor.jpg",Tt="/revo-realms/textures/realm/stone_arm.jpg",_t="/revo-realms/environment/px.webp",Mt="/revo-realms/environment/nx.webp",At="/revo-realms/environment/py.webp",xt="/revo-realms/environment/ny.webp",bt="/revo-realms/environment/pz.webp",Pt="/revo-realms/environment/nz.webp";class It{textureLoader;gltfLoader;cubeTextureLoader;perlinNoiseTexture;randomNoiseTexture;voronoiNoiseTexture;environmentMap;realmModel;realmTexture;realmWaterMap;realmGrassMap;fenceTexture;sandDiffuseTexture;sandNormalTexture;sandARMTexture;mudDiffuseTexture;mudNormalTexture;mudARMTexture;stoneDiffuseTexture;stoneNormalTexture;stoneARMTexture;npcsModel;constructor(){const e=this.createLoadingManager();this.textureLoader=new me(e);const t=new pe(e);t.setDecoderPath("/revo-realms/draco/"),this.gltfLoader=new ge(e),this.gltfLoader.setDRACOLoader(t),this.cubeTextureLoader=new fe(e)}createLoadingManager(){const e=new ye;e.onStart=function(t,s,o){console.log("Started loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onLoad=function(){console.log("Loading complete!")},e.onProgress=function(t,s,o){console.log("Loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onError=function(t){console.log("There was an error loading "+t)}}async initAsync(){const e=await Promise.all([this.textureLoader.loadAsync(st),this.textureLoader.loadAsync(ot),this.textureLoader.loadAsync(nt),c.cubeTextureLoader.loadAsync([_t,Mt,At,xt,bt,Pt]),this.gltfLoader.loadAsync(rt),this.textureLoader.loadAsync(it),this.textureLoader.loadAsync(lt),c.textureLoader.loadAsync(ct),c.textureLoader.loadAsync(dt),c.gltfLoader.loadAsync(at),c.textureLoader.loadAsync(ut),c.textureLoader.loadAsync(ht),c.textureLoader.loadAsync(mt),c.textureLoader.loadAsync(pt),c.textureLoader.loadAsync(gt),c.textureLoader.loadAsync(ft),c.textureLoader.loadAsync(yt),c.textureLoader.loadAsync(wt),c.textureLoader.loadAsync(Tt)]);this.perlinNoiseTexture=e[0],this.randomNoiseTexture=e[1],this.voronoiNoiseTexture=e[2],this.environmentMap=e[3],this.realmModel=e[4],this.realmTexture=e[5],this.realmTexture.flipY=!1,this.realmWaterMap=e[6],this.realmWaterMap.flipY=!1,this.realmGrassMap=e[7],this.realmGrassMap.flipY=!1,this.fenceTexture=e[8],this.fenceTexture.flipY=!1,this.npcsModel=e[9],this.sandDiffuseTexture=e[10],this.sandNormalTexture=e[11],this.sandARMTexture=e[12],this.mudDiffuseTexture=e[13],this.mudNormalTexture=e[14],this.mudARMTexture=e[15],this.stoneDiffuseTexture=e[16],this.stoneNormalTexture=e[17],this.stoneARMTexture=e[18]}}const c=new It;class Lt{async initAsync(){const e=await we(()=>import("./@dimforge-CmnDU9Yz.js"),[]);await Promise.all([e.init(),c.initAsync()])}}class Et{mesh;rigidBody;inputManager;smoothedCameraPosition=new T;smoothedCameraTarget=new T;yawInRadians=0;JUMP_IMPULSE=5;JUMP_BUFFER_DURATION_IN_SECONDS=.2;MAX_CONSECUTIVE_JUMPS=2;JUMP_CUT_MULTIPLIER=.25;FALL_MULTIPLIER=1.75;MAX_UPWARD_VELOCITY=6;LINEAR_DAMPING=.25;ANGULAR_DAMPING=1;FORWARD_IMPULSE=4.5;TORQUE_STRENGTH=5.5;isOnGround=!1;jumpCount=0;wasJumpHeld=!1;jumpBufferTimer=0;RADIUS=.5;PLAYER_INITIAL_POSITION=new T(0,2,0);CAMERA_OFFSET=new T(0,11,17);CAMERA_LERP_FACTOR=7.5;UP=new T(0,1,0);DOWN=new T(0,-1,0);lighting;uTime=d(0);constructor(e){const{scene:t,world:s,inputManager:o,lighting:n}=e;this.inputManager=o,this.lighting=n,this.mesh=this.createCharacterMesh(),t.add(this.mesh),this.rigidBody=s.createRigidBody(this.createRigidBodyDesc()),s.createCollider(this.createColliderDesc(),this.rigidBody)}createCharacterMesh(){const e=new Te(this.RADIUS,3),t=new _e({color:"grey",flatShading:!0,metalness:1,roughness:.5}),s=new ee(e,t);return s.castShadow=!0,s.position.copy(this.PLAYER_INITIAL_POSITION),s}createRigidBodyDesc(){const{x:e,y:t,z:s}=this.PLAYER_INITIAL_POSITION;return B.dynamic().setTranslation(e,t,s).setLinearDamping(this.LINEAR_DAMPING).setAngularDamping(this.ANGULAR_DAMPING)}createColliderDesc(){return O.ball(this.RADIUS).setRestitution(.2).setFriction(1)}update(e){const{clock:t,camera:s,world:o}=e,n=t.getDelta();this.uTime.value=t.getElapsedTime(),this.updateVerticalMovement(n,o),this.updateHorizontalMovement(n),this.updateCameraPosition(s,n)}updateVerticalMovement(e,t){const s=this.inputManager.isKeyPressed(" ");this.isOnGround=this.checkIfGrounded(t),this.isOnGround&&(this.jumpCount=0),s&&!this.wasJumpHeld?this.jumpBufferTimer=this.JUMP_BUFFER_DURATION_IN_SECONDS:this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),this.jumpBufferTimer>0&&this.canJump()&&(this.performJump(),this.jumpBufferTimer=0);const n=this.rigidBody.linvel();this.handleJumpCut(s,n),this.handleFastFall(e,n,t.gravity.y),this.clampUpwardVelocity(n),this.rigidBody.setLinvel(n,!0),this.wasJumpHeld=s}checkIfGrounded(e){const t=this.rigidBody.translation(),s=new T(t.x,t.y-(this.RADIUS+.01),t.z),o=new Qe(s,this.DOWN),n=.2,r=e.castRay(o,n,!0);return r?r.timeOfImpact*n<.01:!1}canJump(){return this.isOnGround?!0:this.jumpCount<this.MAX_CONSECUTIVE_JUMPS}performJump(){const e=new T(0,this.JUMP_IMPULSE,0);this.rigidBody.applyImpulse(e,!0),this.jumpCount+=1}handleJumpCut(e,t){!(!e&&this.wasJumpHeld)||t.y<=0||(t.y*=this.JUMP_CUT_MULTIPLIER)}handleFastFall(e,t,s){if(t.y>=0)return;const o=this.FALL_MULTIPLIER*Math.abs(s)*e;t.y-=o}clampUpwardVelocity(e){e.y<=this.MAX_UPWARD_VELOCITY||(e.y=this.MAX_UPWARD_VELOCITY)}updateHorizontalMovement(e){const t=this.inputManager.isKeyPressed("w")||this.inputManager.isKeyPressed("arrowup"),s=this.inputManager.isKeyPressed("s")||this.inputManager.isKeyPressed("arrowdown"),o=this.inputManager.isKeyPressed("a")||this.inputManager.isKeyPressed("arrowleft"),n=this.inputManager.isKeyPressed("d")||this.inputManager.isKeyPressed("arrowright"),r=2;o&&(this.yawInRadians+=r*e),n&&(this.yawInRadians-=r*e);const a=new T(-Math.sin(this.yawInRadians),0,-Math.cos(this.yawInRadians)),i=new T,l=new T,h=new T().crossVectors(this.UP,a).normalize();t&&(i.addScaledVector(a,this.FORWARD_IMPULSE*e),l.addScaledVector(h,this.TORQUE_STRENGTH*e)),s&&(i.addScaledVector(a,-this.FORWARD_IMPULSE*e),l.addScaledVector(h,-this.TORQUE_STRENGTH*e)),this.rigidBody.applyImpulse(i,!0),this.rigidBody.applyTorqueImpulse(l,!0),this.syncMeshWithBody()}syncMeshWithBody(){const e=this.rigidBody.translation();this.mesh.position.set(e.x,e.y,e.z);const t=this.rigidBody.rotation();this.mesh.quaternion.copy(t)}updateCameraPosition(e,t){const s=new Me;s.setFromAxisAngle(this.UP,this.yawInRadians);const o=this.CAMERA_OFFSET.clone().applyQuaternion(s),r=this.mesh.position.clone().add(o),a=this.CAMERA_LERP_FACTOR*t;this.smoothedCameraPosition.lerp(r,a);const i=this.mesh.position.clone();i.y+=1,this.smoothedCameraTarget.lerp(i,a),e.position.copy(this.smoothedCameraPosition),e.lookAt(this.smoothedCameraTarget)}get position(){return this.mesh.position}get yaw(){return this.yawInRadians}}class St{panel;constructor(){this.panel=new tt({title:"Revo Realms"}),this.panel.element.parentElement.style.zIndex="1",this.panel.element.parentElement.style.width="340px"}setVisibility(e){this.panel.hidden=!e}}const J=new St,vt={uTime:d(0),uWavesSpeed:d(.02),uWavesAmplitude:d(.02),uWavesFrequency:d(.64),uTroughColor:d(new R("#186691")),uSurfaceColor:d(new R("#9bd8c0")),uPeakColor:d(new R("#bbd8e0")),uPeakThreshold:d(.5),uPeakTransition:d(0),uTroughThreshold:d(-.23),uTroughTransition:d(.15),uFresnelScale:d(.8)};class Ct extends te{_uniforms;debugFolder;constructor(e,t=!1){super(),this._uniforms={...vt,...e},this.createWaterMaterial(),this.debugFolder=J.panel.addFolder({title:"\uD83C\uDF0A Water"}),this.debugFolder.hidden=!t,t&&(this.debugWaves(),this.debugColor(),this.debugFresnel())}computeElevation=f(([e=F(0,0)])=>{const t=c.randomNoiseTexture,s=this._uniforms.uTime.mul(this._uniforms.uWavesSpeed).mul(.1),o=Z(e.mul(this._uniforms.uWavesFrequency).add(s),1),n=_(t,o,.5).r,r=_(t,o,1.5).r;return N(n,r,.5).mul(this._uniforms.uWavesAmplitude).mul(.001)});computePosition=f(([e=m(0)])=>{const t=e.mul(10);return u(v.x,v.y.add(t),v.z)});computeNormal=f(([e=m(0)])=>{const t=m(.001),s=this.computeElevation(F(v.x.sub(t),v.z)),o=this.computeElevation(F(v.x,v.z.sub(t))),n=U(u(t,s.sub(e),0)),r=U(u(0,o.sub(e),t)),a=u(1e-4);return U(Ae(n,r)).add(a)});computeFresnel=f(([e=S(u(0,0,0)),t=u(0,0,0)])=>{const s=xe(be(m(1).sub(se(V(t,e),0,1))));return this._uniforms.uFresnelScale.mul(s)});computeReflectionColor=f(([e=S(u(0,0,0)),t=u(0,0,0)])=>{let s=Pe(t,e);return s.x=s.x.negate(),Ie(c.environmentMap,s)});computeColor=f(([e=S(u(0,0,0)),t=S(u(0,0,0)),s=S(u(0,0,0))])=>{const o=U(t.sub(z)),n=this.computeReflectionColor(e,o),r=this.computeFresnel(e,o),a=q(t.y.sub(this._uniforms.uTroughThreshold).div(this._uniforms.uTroughTransition.mul(2))),i=N(this._uniforms.uTroughColor,this._uniforms.uSurfaceColor,a),l=q(t.y.sub(this._uniforms.uPeakThreshold).div(this._uniforms.uPeakTransition.mul(2))),h=N(i,this._uniforms.uPeakColor,l),y=N(h,n.rgb,r),w=V(s.xz.sub(z.xz),s.xz.sub(z.xz)),b=10,M=55,I=N(0,1,j(b*b,M*M,w));return C(y,I)});createWaterMaterial(){this.precision="lowp";const e=this.computeElevation(P()).mul(1e3),t=this.computePosition(e),s=this.computeNormal(e),o=S(t,"vPosition"),n=S(s,"vNormal"),r=S(K,"vWorldPosition"),a=this.computeColor(n,o,r);this.transparent=!0,this.colorNode=a,this.positionNode=t}debugWaves(){const e=this.debugFolder.addFolder({title:"Waves"});e.addBinding(this._uniforms.uWavesAmplitude,"value",{min:0,max:.1,label:"Amplitude"}),e.addBinding(this._uniforms.uWavesFrequency,"value",{min:.1,max:10,label:"Frequency"}),e.addBinding(this._uniforms.uWavesSpeed,"value",{min:0,max:1,label:"Speed"})}debugColor(){const e=this.debugFolder.addFolder({title:"Color"});e.addBinding(this._uniforms.uTroughColor,"value",{label:"Trough Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uSurfaceColor,"value",{label:"Surface Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakColor,"value",{label:"Peak Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakThreshold,"value",{min:0,max:.5,label:"Peak Threshold"}),e.addBinding(this._uniforms.uPeakTransition,"value",{min:0,max:.5,label:"Peak Transition"}),e.addBinding(this._uniforms.uTroughThreshold,"value",{min:-.5,max:0,label:"Trough Threshold"}),e.addBinding(this._uniforms.uTroughTransition,"value",{min:0,max:.5,label:"Trough Transition"})}debugFresnel(){this.debugFolder.addFolder({title:"Fresnel"}).addBinding(this._uniforms.uFresnelScale,"value",{min:0,max:1,label:"Scale"})}}const Nt=()=>Object.freeze({MAP_SIZE:256,HALF_MAP_SIZE:256/2,KINTOUN_ACTIVATION_THRESHOLD:2,HALF_FLOOR_THICKNESS:.3,OUTER_MAP_SIZE:256*3,OUTER_HALF_MAP_SIZE:256*1.5}),x=Nt();class Dt{world;scene;kintounRigidBody;kintounPosition=new T;outerFloorMesh;uTime=d(0);constructor(e){const{world:t,scene:s}=e;this.world=t,this.scene=s,s.background=c.environmentMap,s.environment=c.environmentMap,this.createFloor(),this.createWater(),this.createFences(),this.createNpcs(),this.outerFloorMesh=this.createOuterFloorVisual(),this.scene.add(this.outerFloorMesh),this.kintounRigidBody=this.createKintoun()}createOuterFloorVisual(){const e=c.realmModel.scene.getObjectByName("outer_world");return e.geometry.computeVertexNormals(),e.material=new Bt,e}createNpcs(){const e=c.npcsModel.scene.getObjectByName("luffy_model");this.scene.add(e);const t=c.npcsModel.scene.getObjectByName("luffy_collider_ball");this.createNpcBallPhysics(t)}createNpcBallPhysics(e){e.geometry.computeBoundingSphere();const t=e.geometry.boundingSphere?.radius??0,s=B.fixed().setTranslation(...e.position.toArray()).setRotation(e.quaternion),o=this.world.createRigidBody(s),n=O.ball(t).setRestitution(.2);this.world.createCollider(n,o)}createFloor(){const e=c.realmModel.scene.getObjectByName("floor");e.material=new Ft({uTime:this.uTime}),e.receiveShadow=!0,this.scene.add(e),this.createFloorPhysics()}createWater(){const e=c.realmModel.scene.getObjectByName("lake"),t=new Ct({uTime:this.uTime});e.material=t,this.scene.add(e)}createFences(){const e=c.realmModel.scene.getObjectByName("fence"),t=c.realmModel.scene.children.filter(({name:i})=>i.startsWith("fence-placeholder")),s=new Le({map:c.fenceTexture});e.geometry.computeVertexNormals(),e.geometry.computeBoundingSphere(),e.geometry.computeBoundingBox();const o=t.length,n=new Ee(o,e.geometry.attributes.position.count*o,(e.geometry.index?.count??0)*o,s);n.sortObjects=!1;const r=n.addGeometry(e.geometry),a=new T;t[0].geometry.boundingBox?.getSize(a).divideScalar(2);for(let i=0;i<t.length;i++){const l=t[i],h=n.addInstance(r);n.setMatrixAt(h,l.matrix),this.createFencePhysics(l,a)}this.scene.add(n)}createFencePhysics(e,t){const s=B.fixed().setTranslation(...e.position.toArray()).setRotation(e.quaternion),o=this.world.createRigidBody(s),n=O.cuboid(...t.toArray()).setFriction(1).setRestitution(.2);this.world.createCollider(n,o)}getFloorDisplacementData(){const e=c.realmModel.scene.getObjectByName("heightfield"),t=e.geometry.attributes._displacement.array[0],s=e.geometry.attributes.position;e.geometry.boundingBox||e.geometry.computeBoundingBox();const o=e.geometry.boundingBox,n=s.count,r=Math.sqrt(n),a=o.max.x,i=new Float32Array(n);for(let l=0;l<n;l++){const h=s.array[l*3+0],y=s.array[l*3+1],w=s.array[l*3+2],b=Math.round((h/(a*2)+.5)*(r-1)),I=Math.round((w/(a*2)+.5)*(r-1))+b*r;i[I]=y}return{rowsCount:r,heights:i,displacement:t}}createFloorPhysics(){const e=this.getFloorDisplacementData(),{rowsCount:t,heights:s,displacement:o}=e,n=B.fixed().setTranslation(0,-o,0),r=this.world.createRigidBody(n),a=O.heightfield(t-1,t-1,s,{x:x.MAP_SIZE,y:1,z:x.MAP_SIZE},$e.FIX_INTERNAL_EDGES).setFriction(1).setRestitution(.2);this.world.createCollider(a,r)}createKintoun(){const e=B.kinematicPositionBased().setTranslation(0,-20,0),t=this.world.createRigidBody(e),s=2,o=O.cuboid(s,x.HALF_FLOOR_THICKNESS,s).setFriction(1).setRestitution(.2);return this.world.createCollider(o,t),t}useKintoun(e){this.kintounPosition.copy(e).setY(-x.HALF_FLOOR_THICKNESS),this.kintounRigidBody.setTranslation(this.kintounPosition,!0)}update(e){const{player:t,clock:s}=e;this.uTime.value=s.getElapsedTime();const o=x.HALF_MAP_SIZE-Math.abs(t.position.x)<x.KINTOUN_ACTIVATION_THRESHOLD,n=x.HALF_MAP_SIZE-Math.abs(t.position.z)<x.KINTOUN_ACTIVATION_THRESHOLD;(o||n)&&this.useKintoun(t.position);const r=x.MAP_SIZE,a=Math.abs(t.position.x),i=Math.sign(t.position.x),l=Math.abs(t.position.z),h=Math.sign(t.position.z),y=a>r?a-r:0,w=l>r?l-r:0;this.outerFloorMesh.position.set(y*i,0,w*h)}}const Rt={uTime:d(0)};class Ft extends oe{_uniforms;constructor(e){super(),this._uniforms={...Rt,...e},this.createMaterial()}computeCausticsDiffuse=f(([e=m(0),t=u(0,0,0)])=>{const s=m(10),o=P().mul(s),n=D(o.add(F(e,0))),r=D(o.add(F(0,e.negate()))),a=_(c.voronoiNoiseTexture,n,1).r,i=_(c.voronoiNoiseTexture,r,2).r,l=a.add(i).mul(.5),h=ne(l,3),y=u(3.2,3.2,2.8);return N(t,y,h)});createMaterial(){const e=this._uniforms.uTime.mul(.1),t=_(c.realmWaterMap,P(),3).r,s=_(c.realmGrassMap,P(),3).r,o=m(1).sub(s),n=o.sub(t),r=D(P().mul(25)),a=_(c.sandDiffuseTexture,r).mul(o),i=D(P().mul(10)),l=_(c.sandDiffuseTexture,i).mul(o),h=a.mul(l).mul(1.5),y=_(c.realmTexture,P(),2).mul(n),w=this.computeCausticsDiffuse(e,h).mul(t),M=D(P().mul(.5)),I=_(c.randomNoiseTexture,M,1),le=u(.145,.322,.129).mul(I.r.add(.1)).mul(s);this.colorNode=y.add(h).add(w).add(le);const ce=_(c.sandNormalTexture,r).mul(o),de=u(1,1,1).mul(s);this.normalNode=de.add(ce);const ue=_(c.sandARMTexture,r).mul(t).r.mul(.5),he=u(1,1,0).mul(n.add(s)).r;this.aoNode=he.add(ue)}}class Bt extends oe{constructor(){super(),this.createMaterial()}createMaterial(){const t=K.xz.add(x.HALF_MAP_SIZE).div(x.MAP_SIZE).mul(.5),s=D(t),o=_(c.randomNoiseTexture,s,1),r=u(.145,.322,.129).mul(o.r.add(.1));this.colorNode=r}}class ${emitters=[];registerEmitter(e){this.emitters.push({position:d(e.position),hue:d(e.hue),intensity:d(e.intensity)})}material_computeSingleEmissiveLight=f(({position:e=u(0,0,0),hue:t=u(1,0,0),intensity:s=10})=>{const o=e.sub(K),n=o.length(),r=m(1).div(m(1).add(n.mul(.3).add(n.pow(2).mul(.5)))),a=.5,i=o.normalize(),l=re(0,V(Se,i).mul(1-a).add(a));return t.mul(s).mul(l).mul(r)});material_computeEmissiveLight=f(()=>{let e=u(0);for(const t of this.emitters){const s=this.material_computeSingleEmissiveLight(t);e=e.add(s)}return e})}class Ot{directionalLight;ambientLight;emissive=new $;LIGHT_POSITION_OFFSET=new T(10,20,10);target=new ve;constructor(e){this.emissive=new $,e.add(this.target),this.directionalLight=this.setupDirectionalLighting(),e.add(this.directionalLight),this.ambientLight=this.setupAmbientLighting(),e.add(this.ambientLight)}setupAmbientLighting(){return new Ce("white",.4)}setupDirectionalLighting(){const e=new Ne("white",1);return e.position.copy(this.LIGHT_POSITION_OFFSET),e.target=this.target,e.castShadow=!0,e.shadow.intensity=.75,e.shadow.mapSize.width=64,e.shadow.mapSize.height=64,e.shadow.radius=2,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.bias=-.003,e}material_computeIllumination=f(()=>u(0));update(e){const{player:t}=e;this.directionalLight.position.copy(t.position).add(this.LIGHT_POSITION_OFFSET),this.target.position.copy(t.position)}}class Ut{keysPressed;keyDownListeners;keyUpListeners;constructor(){this.keysPressed=new Set,this.keyDownListeners=new Map,this.keyUpListeners=new Map,window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this))}handleKeyDown(e){const t=e.key.toLowerCase();this.keysPressed.has(t)||(this.keysPressed.add(t),this.keyDownListeners.get(t)?.())}handleKeyUp(e){const t=e.key.toLowerCase();this.keysPressed.delete(t),this.keyUpListeners.get(t)?.()}isKeyPressed(e){return e==="*"?this.keysPressed.size>0:this.keysPressed.has(e.toLowerCase())}onKeyDown(e,t){this.keyDownListeners.set(e.toLowerCase(),t)}onKeyUp(e,t){this.keyUpListeners.set(e.toLowerCase(),t)}dispose(){window.removeEventListener("keydown",this.handleKeyDown.bind(this)),window.removeEventListener("keyup",this.handleKeyUp.bind(this))}}class Gt{stats;lastSecond=performance.now();drawCallsPanel;geometriesPanel;constructor(e){const t=new Q({trackGPU:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,horizontal:!1,precision:2});e&&document.body.appendChild(t.dom),this.stats=t,this.drawCallsPanel=this.createNumberPanel("# DRAW CALLS","#fff","#333"),this.geometriesPanel=this.createNumberPanel("# GEOMETRIES","#ffdab9","#163843")}createNumberPanel(e,t,s){const o=this.stats.addPanel(new Q.Panel(e,t,s));return o.update=n=>{const r=o.canvas.getContext("2d");if(!r)return;const{width:a,height:i}=o.canvas;r.clearRect(0,0,a,i),r.fillStyle=s,r.fillRect(0,0,a,i),r.fillStyle=t;const l=r.font;r.textAlign="left",r.textBaseline="top",r.fillText(o.name,4,4),r.font="bold 20px Arial",r.textAlign="center",r.textBaseline="middle",r.fillText(`${Math.round(n)}`,a/2,i/1.65),r.font=l},o}updateCustomPanels(e){const t=performance.now();if(t-this.lastSecond<1e3)return;const{render:s,memory:o}=e.info;this.drawCallsPanel.update(s.drawCalls,0),this.geometriesPanel.update(o.geometries,0),this.lastSecond=t}}class Ht{composer;constructor(e,t){this.composer=new De(e.renderer);const s=Re(t.scene,t.renderCamera);s.setMRT(Fe({output:Be,emissive:Oe}));const o=s.getTextureNode("output"),n=s.getTextureNode("emissive"),r=Ue(n,.25,.1,.5),a=o.add(r);this.composer.outputNode=a,this.composer.needsUpdate=!0}}class zt{renderer;canvas;monitoringManager;postprocessingManager;POSTPROCESSING_ENABLED=!1;MONITORING_ENABLED=!1;DEBUGGING_ENABLED=!0;constructor(){const e=document.createElement("canvas");e.classList.add("revo-realms"),document.body.appendChild(e),this.canvas=e;const t=new Ge({canvas:e,antialias:!0,trackTimestamp:!1});t.shadowMap.enabled=!0,t.shadowMap.type=He,t.toneMapping=ze,t.toneMappingExposure=1.5,this.renderer=t,this.monitoringManager=new Gt(this.MONITORING_ENABLED),J.setVisibility(this.DEBUGGING_ENABLED)}async init(e){this.postprocessingManager=new Ht(this,e),this.MONITORING_ENABLED&&await this.monitoringManager.stats.init(this.renderer)}async renderAsync(...e){this.MONITORING_ENABLED&&await this.renderer.resolveTimestampsAsync("compute"),this.POSTPROCESSING_ENABLED?await this.postprocessingManager.composer.renderAsync():await this.renderer.renderAsync(...e),this.MONITORING_ENABLED&&(this.monitoringManager.updateCustomPanels(this.renderer),await this.renderer.resolveTimestampsAsync("render"),this.monitoringManager.stats.update())}}class kt{scene;camera;cameraHelper;renderCamera;controls;orbitControlsCamera;constructor(e){const t=new ke;this.scene=t;const s=window.innerWidth,o=window.innerHeight,n=s/o,r=new We(45,n,.01,100);r.position.set(0,5,10),this.camera=r,t.add(r);const a=new Ze(r);a.visible=!1,t.add(a),this.cameraHelper=a;const i=r.clone(),l=new Ve(i,e.canvas);i.near=.01,i.far=5e3,this.orbitControlsCamera=i,l.enableDamping=!0,l.maxPolarAngle=Math.PI/2.05,l.enabled=!1,this.controls=l,this.renderCamera=r,this.debug()}debug(){J.panel.addFolder({title:"\uD83C\uDFA5 View"}).addBinding(this.controls,"enabled",{label:"Enable orbit controls"}).on("change",({value:t})=>{this.renderCamera=t?this.orbitControlsCamera:this.camera,this.cameraHelper.visible=t})}update(){this.controls.enabled&&this.controls.update()}}const Wt=()=>({BLADE_WIDTH:.1,BLADE_HEIGHT:1.25,BLADE_BOUNDING_SPHERE_RADIUS:1.25,TILE_SIZE:150,TILE_HALF_SIZE:150/2,BLADES_PER_SIDE:700,COUNT:700*700,SPACING:150/700}),p=Wt(),Zt={uTime:d(0),uPlayerPosition:d(new T(0,0,0)),uCameraMatrix:d(new ae),uBladeMinScale:d(.5),uBladeMaxScale:d(1.25),uTrailGrowthRate:d(.004),uTrailMinScale:d(.1),uTrailRaius:d(.65),uTrailRaiusSquared:d(.65*.65),uGlowRadius:d(2),uGlowRadiusSquared:d(4),uGlowFadeIn:d(.05),uGlowFadeOut:d(.01),uGlowColor:d(new R(1,.6,.1)),uBladeMaxBendAngle:d(Math.PI*.15),uBaseColor:d(new R("#4f8a4f")),uTipColor:d(new R("#bbde47")),uDelta:d(new ie(0,0))};class Vt extends te{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...Zt,...e},this._buffer1=X(p.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=X(p.COUNT,"vec4"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createGrassMaterial()}computeInit=f(()=>{const e=this._buffer1.element(A),t=k(m(A).div(p.BLADES_PER_SIDE)),s=m(A).mod(p.BLADES_PER_SIDE),o=H(A.add(4321)),n=H(A.add(1234)),r=s.mul(p.SPACING).sub(p.TILE_HALF_SIZE).add(o.mul(p.SPACING*.5)),a=t.mul(p.SPACING).sub(p.TILE_HALF_SIZE).add(n.mul(p.SPACING*.5)),i=u(r,0,a);e.x=r,e.y=a;const l=i.xz.add(p.TILE_HALF_SIZE).div(p.TILE_SIZE),h=m(2),y=D(l.mul(h)),b=_(c.randomNoiseTexture,y,1).r.sub(.5).mul(m(Math.PI*2));e.z=b;const M=this._buffer2.element(A),I=this._uniforms.uBladeMaxScale.sub(this._uniforms.uBladeMinScale),L=H(A.add(100)).mul(I).add(this._uniforms.uBladeMinScale);M.x=L,M.y=L})().compute(p.COUNT);computeVisibility=f(([e=u(0)])=>{const t=this._uniforms.uCameraMatrix.mul(C(e,1)),s=t.xyz.div(t.w),o=p.BLADE_BOUNDING_SPHERE_RADIUS,n=m(1);return E(n.negate().sub(o),s.x).mul(E(s.x,n.add(o))).mul(E(n.negate().sub(o),s.y)).mul(E(s.y,n.add(o))).mul(E(0,s.z)).mul(E(s.z,n))});computeBending=f(([e=C(0,0,0,0),t=u(0,0,0)])=>{const s=t.xz.add(this._uniforms.uTime.mul(.25)).mul(.5),o=D(s),r=_(c.perlinNoiseTexture,o,5).r.mul(.35);return e.w.add(r.sub(e.w).mul(.1))});computeAlpha=f(([e=u(0)])=>{const t=e.xz.add(x.HALF_MAP_SIZE).div(x.MAP_SIZE);return _(c.realmGrassMap,t).r});computeTrailScale=f(([e=C(0),t=m(0)])=>{const s=e.x.add(this._uniforms.uTrailGrowthRate),o=m(1).sub(t),n=this._uniforms.uTrailMinScale.mul(t).add(s.mul(o));return Ke(n,e.y)});computeTrailGlow=f(([e=C(0),t=m(0),s=m(0),o=m(0)])=>{const n=j(this._uniforms.uGlowRadiusSquared,m(0),t),r=100,a=k(W(this._uniforms.uDelta.x).mul(r)),i=k(W(this._uniforms.uDelta.y).mul(r)),l=E(1,a.add(i)),h=n.mul(m(1).sub(s)).mul(o),y=re(l,e.w).mul(h),w=y.mul(this._uniforms.uGlowFadeIn),b=m(1).sub(y).mul(this._uniforms.uGlowFadeOut),M=m(1).sub(l).mul(this._uniforms.uGlowFadeOut).mul(e.w);return se(e.w.add(w).sub(b).sub(M),0,1)});computeUpdate=f(()=>{const e=this._buffer1.element(A),t=this._buffer2.element(A),s=Z(e.x.sub(this._uniforms.uDelta.x).add(p.TILE_HALF_SIZE),p.TILE_SIZE).sub(p.TILE_HALF_SIZE),o=Z(e.y.sub(this._uniforms.uDelta.y).add(p.TILE_HALF_SIZE),p.TILE_SIZE).sub(p.TILE_HALF_SIZE),n=u(s,0,o);e.x=s,e.y=o;const r=n.add(this._uniforms.uPlayerPosition),a=this.computeVisibility(r);t.z=a,Je(a,()=>{const i=F(this._uniforms.uDelta.x,this._uniforms.uDelta.y),l=n.xz.sub(i),h=l.dot(l),y=E(.1,m(1).sub(this._uniforms.uPlayerPosition.y)),w=E(h,this._uniforms.uTrailRaiusSquared).mul(y);t.x=this.computeTrailScale(t,w),t.z=this.computeAlpha(r),e.w=this.computeBending(e,r),t.w=this.computeTrailGlow(t,h,w,y)})})().compute(p.COUNT);computePosition=f(([e=C(0),t=C(0)])=>{const s=u(e.x,0,e.y),o=e.z,n=e.w,r=t.x,a=n.mul(P().y),l=Y(v,u(a,0,0)).mul(u(1,r,1));return Y(l,u(0,o,0)).add(s)});computeDiffuseColor=f(([e=C(0)])=>{const t=ne(P().y,1.5),s=N(this._uniforms.uBaseColor,this._uniforms.uTipColor,t),o=H(A).mul(.05).sub(.025),n=e.w;return N(s.add(o),this._uniforms.uGlowColor,n)});computeAO=f(()=>{const e=W(qe(this._buffer1.element(A).z)).mul(.5);return j(-.75,1.25,P().y).mul(m(1).sub(e))});createGrassMaterial(){this.precision="lowp",this.side=Xe;const e=this._buffer1.element(A),t=this._buffer2.element(A);this.positionNode=this.computePosition(e,t),this.opacityNode=t.z,this.alphaTest=.25,this.aoNode=this.computeAO(),this.colorNode=this.computeDiffuseColor(t)}async updateAsync(e){const{renderer:t}=e;await t.computeAsync(this.computeUpdate)}}class jt{material;grassField;uniforms={uDelta:d(new ie(0,0)),uPlayerPosition:d(new T(0,0,0)),uCameraMatrix:d(new ae),uTime:d(0)};constructor(e){const t=this.createBladeGeometry();t.instanceCount=p.COUNT,this.material=new Vt(this.uniforms),this.grassField=new ee(t,this.material),e.add(this.grassField)}createBladeGeometry(){const e=p.BLADE_WIDTH/2,t=e/2,s=p.BLADE_HEIGHT/2,o=new Float32Array([-e,0,0,e,0,0,-t,s*1,0,t,s*1,0,0,s*2,0]),n=new Float32Array([0,0,1,0,.25,s*1,.75,s*1,.5,s*2]),r=new Uint16Array([0,1,3,0,3,2,2,3,4]),i=25*Math.PI/180,l=Math.cos(i),h=Math.sin(i),w=15*Math.PI/180,b=Math.cos(w),M=Math.sin(w),I=new Float32Array([-l,h,0,l,h,0,-b,M,0,b,M,0,0,1,0]),L=new je;return L.setAttribute("position",new G(o,3)),L.setAttribute("uv",new G(n,2)),L.setIndex(new G(r,1)),L.setAttribute("normal",new G(I,3)),L}async updateAsync(e){const{player:t,camera:s,clock:o}=e,n=t.position.x-this.grassField.position.x,r=t.position.z-this.grassField.position.z;this.uniforms.uDelta.value.set(n,r),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(s.projectionMatrix).multiply(s.matrixWorldInverse),this.uniforms.uTime.value=o.getElapsedTime(),this.grassField.position.copy(t.position).setY(0),await this.material.updateAsync(e)}}class Kt{rendererManager;sceneManager;inputManager;clock;world;player;realm;lighting;grass;constructor(){this.rendererManager=new zt,this.sceneManager=new kt(this.rendererManager),this.inputManager=new Ut,this.clock=new Ye(!1),this.lighting=new Ot(this.sceneManager.scene),this.world=new et({x:0,y:-9.81,z:0}),this.player=new Et({scene:this.sceneManager.scene,inputManager:this.inputManager,lighting:this.lighting,world:this.world}),this.realm=new Dt({scene:this.sceneManager.scene,world:this.world}),this.grass=new jt(this.sceneManager.scene)}getSizes(){const e=window.innerWidth,t=window.innerHeight;return{width:e,height:t,dpr:Math.min(window.devicePixelRatio,1.5),aspect:e/t}}onResize(){const e=this.getSizes();this.sceneManager.camera.aspect=e.aspect,this.sceneManager.camera.updateProjectionMatrix(),this.rendererManager.renderer.setSize(e.width,e.height),this.rendererManager.renderer.setPixelRatio(e.dpr)}async startLoop(e){await this.rendererManager.init(this.sceneManager),this.clock.start();const t={clock:this.clock,scene:this.sceneManager.scene,camera:this.sceneManager.camera,inputManager:this.inputManager,lighting:this.lighting,world:this.world,player:this.player,renderer:this.rendererManager.renderer},s=async()=>{this.sceneManager.update(),e?.(t),this.world.step(),this.player.update(t),this.realm.update(t),this.lighting.update(t),await this.grass.updateAsync(t),await this.rendererManager.renderAsync(this.sceneManager.scene,this.sceneManager.renderCamera)};new ResizeObserver(()=>{this.onResize()}).observe(document.body),this.rendererManager.renderer.setAnimationLoop(s)}}const Jt=new Lt;Jt.initAsync().then(()=>{new Kt().startLoop()})})();