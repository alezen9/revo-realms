import{T as Ne,D as ve,G as De,C as Ce,L as ye,a as Be,P as Re,F as g,p as Oe,b as Fe,W as Ue,c as Ge,A as He,S as ke,d as ze,e as Ve,V as E,H as Ze,f as We,O as je,t as _,v as G,g as p,M as k,h as O,i as we,u as l,j as v,k as D,N as me,l as f,m as Ye,n as xe,o as X,q as N,r as ie,s as ne,w as I,x as le,y as Z,z as W,B as Ke,E as qe,I as C,J as Xe,K as Je,Q as be,R as $e,U as Qe,X as pe,Y as F,Z as R,_ as J,$ as Te,a0 as ue,a1 as oe,a2 as de,a3 as b,a4 as Ae,a5 as he,a6 as Se,a7 as et,a8 as re,a9 as ce,aa as tt,ab as st,ac as se,ad as Le,ae as fe,af as ot,ag as at,ah as it,ai as nt}from"./three-BSzBLS0O.js";import{World as rt,RigidBodyDesc as j,ColliderDesc as Y,HeightFieldFlags as lt,Ray as ct,__tla as __tla_0}from"./@dimforge-Tx9Ov1ko.js";import{P as ut}from"./tweakpane-BXg6ZhiP.js";import{S as ge}from"./stats-gl-C2M3amu4.js";import{e as dt}from"./tseep-DsfRTLTM.js";Promise.all([(()=>{try{return __tla_0}catch{}})()]).then(async()=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();const mt="/revo-realms/models/realm.glb",ht="/revo-realms/textures/environment/px.webp",pt="/revo-realms/textures/environment/nx.webp",ft="/revo-realms/textures/environment/py.webp",wt="/revo-realms/textures/environment/ny.webp",yt="/revo-realms/textures/environment/pz.webp",gt="/revo-realms/textures/environment/nz.webp",_t="/revo-realms/textures/noise/noise.webp",xt="/revo-realms/textures/realm/terrainType.webp",bt="/revo-realms/textures/realm/sandNormal.webp",Tt="/revo-realms/textures/realm/grassNormal.webp",At="/revo-realms/textures/realm/grassDiffuse.webp",St="/revo-realms/textures/realm/waterNormal.webp",Lt="/revo-realms/textures/realm/terrainShadowAo.webp",Et="/revo-realms/textures/realm/waterLiliesDiffuse.webp",Pt="/revo-realms/textures/realm/waterLiliesAlpha.webp",It="/revo-realms/textures/realm/stoneDiffuse.webp",Mt="/revo-realms/textures/realm/stoneMossyDiffuse.webp",Nt="/revo-realms/textures/realm/stoneNormalAo.webp",vt="/revo-realms/textures/realm/stoneMossyNormalAo.webp",Dt="/revo-realms/textures/realm/barkDiffuse.webp",Ct="/revo-realms/textures/realm/barkNormal.webp",Bt="/revo-realms/textures/realm/canopyDiffuse.webp",Rt="/revo-realms/textures/realm/canopyNormal.webp",Ot="/revo-realms/textures/realm/axeDiffuse.webp",Ft="/revo-realms/textures/realm/axeEmissive.webp",Ut="/revo-realms/textures/realm/trunkDiffuse.webp",Gt="/revo-realms/textures/realm/trunkNormal.webp",Ht="/revo-realms/textures/realm/onePieceAtlas.webp",kt="/revo-realms/textures/realm/flowers1.webp",zt="/revo-realms/textures/realm/flowers2.webp",Vt={luffyDifuse:{scale:[.484375,.484375],offset:[.0078125,.0078125]},robinDiffuse:{scale:[.484375,.484375],offset:[.0078125,.5078125]},sanjiDiffuse:{scale:[.484375,.484375],offset:[.5078125,.0078125]},zoroDiffuse:{scale:[.484375,.484375],offset:[.5078125,.5078125]}},Zt={onePiece:Vt};class Wt{atlasesCoords=Zt;textureLoader;gltfLoader;cubeTextureLoader;realmModel;noiseTexture;envMapTexture;terrainTypeMap;terrainShadowAo;grassDiffuse;sandNormal;grassNormal;waterNormal;canopyDiffuse;canopyNormal;barkDiffuse;barkNormal;stoneDiffuse;stoneMossyDiffuse;stoneNormalAo;stoneMossyNormalAo;waterLiliesTexture;waterLiliesAlphaTexture;axeDiffuse;axeEmissive;trunkDiffuse;trunkNormal;onePieceAtlas;flowers1;flowers2;constructor(){const e=this.createLoadingManager();this.textureLoader=new Ne(e);const t=new ve(e);t.setDecoderPath("/revo-realms/draco/"),this.gltfLoader=new De(e),this.gltfLoader.setDRACOLoader(t),this.cubeTextureLoader=new Ce(e)}createLoadingManager(){const e=new Be;e.onStart=function(t,s,o){console.log("Started loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onLoad=function(){console.log("Loading complete!")},e.onProgress=function(t,s,o){console.log("Loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onError=function(t){console.log("There was an error loading "+t)}}async initAsync(){const e=await Promise.all([this.gltfLoader.loadAsync(mt),c.cubeTextureLoader.loadAsync([ht,pt,ft,wt,yt,gt]),this.textureLoader.loadAsync(_t),this.textureLoader.loadAsync(xt),this.textureLoader.loadAsync(At),this.textureLoader.loadAsync(Tt),this.textureLoader.loadAsync(bt),this.textureLoader.loadAsync(St),this.textureLoader.loadAsync(Lt),this.textureLoader.loadAsync(Et),this.textureLoader.loadAsync(Pt),this.textureLoader.loadAsync(It),this.textureLoader.loadAsync(Mt),this.textureLoader.loadAsync(Nt),this.textureLoader.loadAsync(vt),this.textureLoader.loadAsync(Bt),this.textureLoader.loadAsync(Rt),this.textureLoader.loadAsync(Dt),this.textureLoader.loadAsync(Ct),this.textureLoader.loadAsync(Ot),this.textureLoader.loadAsync(Ft),this.textureLoader.loadAsync(Ut),this.textureLoader.loadAsync(Gt),this.textureLoader.loadAsync(Ht),this.textureLoader.loadAsync(kt),this.textureLoader.loadAsync(zt)]);this.realmModel=e[0],this.envMapTexture=e[1],this.envMapTexture.generateMipmaps=!1,this.noiseTexture=e[2],this.terrainTypeMap=e[3],this.terrainTypeMap.flipY=!1,this.grassDiffuse=e[4],this.grassNormal=e[5],this.sandNormal=e[6],this.waterNormal=e[7],this.terrainShadowAo=e[8],this.terrainShadowAo.colorSpace=ye,this.terrainShadowAo.flipY=!1,this.waterLiliesTexture=e[9],this.waterLiliesTexture.flipY=!1,this.waterLiliesAlphaTexture=e[10],this.waterLiliesAlphaTexture.flipY=!1,this.waterLiliesAlphaTexture.colorSpace=ye,this.stoneDiffuse=e[11],this.stoneMossyDiffuse=e[12],this.stoneNormalAo=e[13],this.stoneMossyNormalAo=e[14],this.canopyDiffuse=e[15],this.canopyDiffuse.flipY=!1,this.canopyNormal=e[16],this.canopyNormal.flipY=!1,this.barkDiffuse=e[17],this.barkDiffuse.flipY=!1,this.barkNormal=e[18],this.barkNormal.flipY=!1,this.axeDiffuse=e[10],this.axeDiffuse.flipY=!1,this.axeEmissive=e[20],this.axeEmissive.flipY=!1,this.trunkDiffuse=e[21],this.trunkDiffuse.flipY=!1,this.trunkNormal=e[22],this.trunkNormal.flipY=!1,this.onePieceAtlas=e[23],this.onePieceAtlas.flipY=!1,this.flowers1=e[24],this.flowers1.flipY=!1,this.flowers2=e[25],this.flowers2.flipY=!1}}const c=new Wt,jt="modulepreload",Yt=function(d){return"/revo-realms/"+d},_e={},Kt=function(e,t,s){let o=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),n=i?.nonce||i?.getAttribute("nonce");o=Promise.allSettled(t.map(r=>{if(r=Yt(r),r in _e)return;_e[r]=!0;const u=r.endsWith(".css"),m=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${r}"]${m}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":jt,u||(h.as="script"),h.crossOrigin="",h.href=r,n&&h.setAttribute("nonce",n),document.head.appendChild(h),u)return new Promise((y,w)=>{h.addEventListener("load",y),h.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${r}`)))})}))}function a(i){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=i,window.dispatchEvent(n),!n.defaultPrevented)throw i}return o.then(i=>{for(const n of i||[])n.status==="rejected"&&a(n.reason);return e().catch(a)})};class qt{world;constructor(){}async init(){return Kt(()=>import("./@dimforge-Tx9Ov1ko.js").then(async m=>{await m.__tla;return m}),[]).then(()=>{this.world=new rt({x:0,y:-9.81,z:0})})}update(){this.world.step()}}const P=new qt;class Xt{async initAsync(){await Promise.all([P.init(),c.initAsync()])}}class Jt{keysPressed;keyDownListeners;keyUpListeners;constructor(){this.keysPressed=new Set,this.keyDownListeners=new Map,this.keyUpListeners=new Map,window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this))}handleKeyDown(e){const t=e.key.toLowerCase();this.keysPressed.has(t)||(this.keysPressed.add(t),this.keyDownListeners.get(t)?.())}handleKeyUp(e){const t=e.key.toLowerCase();this.keysPressed.delete(t),this.keyUpListeners.get(t)?.()}isKeyPressed(e){return e==="*"?this.keysPressed.size>0:this.keysPressed.has(e.toLowerCase())}onKeyDown(e,t){this.keyDownListeners.set(e.toLowerCase(),t)}onKeyUp(e,t){this.keyUpListeners.set(e.toLowerCase(),t)}dispose(){window.removeEventListener("keydown",this.handleKeyDown.bind(this)),window.removeEventListener("keyup",this.handleKeyUp.bind(this))}}const z=new Jt;class $t{panel;constructor(){this.panel=new ut({title:"Revo Realms"}),this.panel.hidden=!0,this.panel.element.parentElement.style.zIndex="1",this.panel.element.parentElement.style.width="340px"}setVisibility(e){this.panel.hidden=!e}}const K=new $t;class Qt{stats;lastSecond=performance.now();drawCallsPanel;trianglesPanel;constructor(e){const t=new ge({trackGPU:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,horizontal:!1,precision:2});e&&document.body.appendChild(t.dom),this.stats=t,this.drawCallsPanel=this.createNumberPanel("# DRAW CALLS","#fff","#333"),this.trianglesPanel=this.createNumberPanel("# TRIANGLES","#ffdab9","#163843")}createNumberPanel(e,t,s){const o=this.stats.addPanel(new ge.Panel(e,t,s));return o.update=a=>{const i=o.canvas.getContext("2d");if(!i)return;const{width:n,height:r}=o.canvas;i.clearRect(0,0,n,r),i.fillStyle=s,i.fillRect(0,0,n,r),i.fillStyle=t;const u=i.font;i.textAlign="left",i.textBaseline="top",i.fillText(o.name,4,4),i.font="bold 20px Arial",i.textAlign="center",i.textBaseline="middle";const m=es.format(a);i.fillText(`${m}`,n/2,r/1.65),i.font=u},o}updateCustomPanels(){const e=performance.now();if(e-this.lastSecond<1e3)return;const{render:t}=V.renderer.info;this.drawCallsPanel.update(t.drawCalls,0),this.trianglesPanel.update(t.triangles,0),this.lastSecond=e}}const es=new Intl.NumberFormat("en-US",{notation:"compact"});class ts{composer;constructor(){this.composer=new Re(V.renderer),this.composer.outputNode=this.getPasses()}getPasses=g(()=>{const e=Oe(A.scene,A.renderCamera),t=e.getTextureNode();return Fe(t,.25,.1,.5).add(e)})}class ss{renderer;canvas;monitoringManager;postprocessingManager;POSTPROCESSING_ENABLED=!1;MONITORING_ENABLED=!1;DEBUGGING_ENABLED=!1;constructor(){const e=document.createElement("canvas");e.classList.add("revo-realms"),document.body.appendChild(e),this.canvas=e;const t=new Ue({canvas:e,antialias:!0,trackTimestamp:!1,powerPreference:"high-performance",stencil:!1,depth:!0});t.shadowMap.enabled=!0,t.shadowMap.type=Ge,t.toneMapping=He,t.outputColorSpace=ke,t.setClearColor(0,1),t.toneMappingExposure=1.5,this.renderer=t,this.monitoringManager=new Qt(this.MONITORING_ENABLED),K.setVisibility(this.DEBUGGING_ENABLED)}async init(){this.postprocessingManager=new ts,this.MONITORING_ENABLED&&await this.monitoringManager.stats.init(this.renderer)}async renderAsync(){this.MONITORING_ENABLED&&await this.renderer.resolveTimestampsAsync("compute"),this.POSTPROCESSING_ENABLED?await this.postprocessingManager.composer.renderAsync():await this.renderer.renderAsync(A.scene,A.renderCamera),this.MONITORING_ENABLED&&(this.monitoringManager.updateCustomPanels(),await this.renderer.resolveTimestampsAsync("render"),this.monitoringManager.stats.update())}}const V=new ss;class os{scene;camera;renderCamera;cameraHelper;controls;orbitControlsCamera;constructor(){const e=new ze;this.scene=e;const t=window.innerWidth,s=window.innerHeight,o=t/s,a=new Ve(45,o,.01,150);a.position.set(0,5,10),this.camera=a,e.add(a),this.renderCamera=a}debugScene(){if(!this.controls)return;K.panel.addFolder({title:"\uD83C\uDFA5 View"}).addBinding(this.controls,"enabled",{label:"Enable orbit controls"}).on("change",({value:t})=>{!this.cameraHelper||!this.orbitControlsCamera||(this.renderCamera=t?this.orbitControlsCamera:this.camera,this.cameraHelper.visible=t)})}update(){this.controls?.enabled&&this.controls.update()}}const A=new os,H=new dt.EventEmitter,as=d=>{let e=0;H.on("update",t=>{e++,!(e<d)&&(e=0,H.emit(`update-throttled-${d}`,t))})};as(30);const q={LIGHT_POSITION_OFFSET:new E(10,10,10)};class is{directionalLight;hemisphereLight;constructor(){this.directionalLight=this.setupDirectionalLighting(),A.scene.add(this.directionalLight),this.hemisphereLight=this.setupHemisphereLight(),A.scene.add(this.hemisphereLight),H.on("update",this.update.bind(this)),this.debugLight()}setupHemisphereLight(){const e=new Ze;return e.color.setRGB(.6,.4,.5),e.groundColor.setRGB(.3,.2,.2),e.intensity=.5,e.position.copy(q.LIGHT_POSITION_OFFSET),e}setupDirectionalLighting(){const e=new We;e.intensity=.9,e.color.setRGB(.85,.75,.7),e.position.copy(q.LIGHT_POSITION_OFFSET),e.target=new je,e.castShadow=!0,e.shadow.mapSize.set(64,64);const t=1;return e.shadow.intensity=.85,e.shadow.camera.left=-t,e.shadow.camera.right=t,e.shadow.camera.top=t,e.shadow.camera.bottom=-t,e.shadow.camera.near=.01,e.shadow.camera.far=30,e.shadow.normalBias=.1,e.shadow.bias=-.001,e}getTerrainShadowFactor=g(([e=G(0)])=>_(c.terrainShadowAo,e).r);debugLight(){const e=K.panel.addFolder({title:"\uD83D\uDCA1 Light"});e.expanded=!1,e.addBinding(q.LIGHT_POSITION_OFFSET,"x",{label:"Sun position X"}),e.addBinding(q.LIGHT_POSITION_OFFSET,"z",{label:"Sun position Z"}),e.addBinding(q.LIGHT_POSITION_OFFSET,"y",{label:"Sun height"}),e.addBinding(this.directionalLight,"color",{label:"Directional Color",view:"color",color:{type:"float"}}),e.addBinding(this.directionalLight,"intensity",{min:0,max:5,label:"Directional intensity"}),e.addBinding(this.hemisphereLight,"color",{label:"Hemisphere sky color",view:"color",color:{type:"float"}}),e.addBinding(this.hemisphereLight,"groundColor",{label:"Hemisphere ground color",view:"color",color:{type:"float"}}),e.addBinding(this.hemisphereLight,"intensity",{min:0,max:1,label:"Hemisphere intensity"})}material_computeIllumination=g(()=>p(0));setTarget(e){this.directionalLight.target=e}update(e){const{player:t}=e;this.directionalLight.position.copy(t.position).add(q.LIGHT_POSITION_OFFSET)}}const Ee=new is;class ns extends k{constructor(){super(),this.precision="lowp",this.flatShading=!1,this.map=c.trunkDiffuse,this.normalMap=c.trunkNormal}}class rs extends k{constructor(){super(),this.precision="lowp",this.flatShading=!1,this.map=c.axeDiffuse,this.emissiveMap=c.axeEmissive,this.emissiveIntensity=2,this.emissive=new O("lightblue")}}class ls{constructor(){const e=c.realmModel.scene.getObjectByName("kratos_axe");e.material=new rs;const t=c.realmModel.scene.getObjectByName("tree_trunk");t.material=new ns,A.scene.add(e,t);const s=c.realmModel.scene.getObjectByName("axe_collider"),o=j.fixed().setTranslation(...s.position.toArray()).setRotation(s.quaternion),a=P.world.createRigidBody(o),i=s.geometry.boundingBox.max,n=Y.cuboid(i.x,i.y,i.z).setRestitution(.15);P.world.createCollider(n,a);const r=c.realmModel.scene.getObjectByName("trunk_collider"),{x:u,y:m}=r.geometry.boundingBox.max,h=j.fixed().setTranslation(...r.position.toArray()).setRotation(r.quaternion),y=P.world.createRigidBody(h),w=u,x=m/2,M=Y.capsule(x,w).setRestitution(.15);P.world.createCollider(M,y)}}class cs extends k{constructor(){super(),this.map=c.onePieceAtlas,this.side=we}}class us{constructor(){const e=c.realmModel.scene.getObjectByName("one_piece_posters");e.material=new cs,A.scene.add(e)}}class ds{constructor(){new ls,new us}}const Pe={uBaseColor:l(new O),uRandom:l(0)};class ms extends k{_uniforms;constructor(e){super(),this._uniforms={...Pe,...e},this.createMaterial()}setRandomSeed(e){this._uniforms.uRandom.value=e}createMaterial(){this.precision="lowp",this.flatShading=!1;const e=v(D().mul(2).add(this._uniforms.uRandom)),t=_(c.stoneDiffuse,e);this.colorNode=t.mul(1.5);const s=_(c.stoneNormalAo,e);this.normalNode=new me(s.rgb,f(.5)),this.aoNode=s.a}}class hs{uniforms=Pe;constructor(){const e=new ms(this.uniforms),t=c.realmModel.scene.children.filter(({name:o})=>o.endsWith("_monument"));t.forEach((o,a)=>{const i=Ye.seededRandom(a);o.material=e,o.receiveShadow=!0,o.onBeforeRender=(n,r,u,m,h)=>{h.setRandomSeed(i)}}),A.scene.add(...t),c.realmModel.scene.children.filter(({name:o})=>o.startsWith("monument_collider")).forEach(o=>{const a=j.fixed().setTranslation(...o.position.toArray()).setRotation(o.quaternion),i=P.world.createRigidBody(a),n=.5*o.scale.x,r=.5*o.scale.y,u=.5*o.scale.z,m=Y.cuboid(n,r,u).setRestitution(.25);P.world.createCollider(m,i)}),this.debugMonuments()}debugMonuments(){const e=K.panel.addFolder({title:"\uD83D\uDDFD Monuments"});e.expanded=!1,e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base color",view:"color",color:{type:"float"}})}}class ps{constructor(){const e=c.realmModel.scene.getObjectByName("water");e.material=new fs,A.scene.add(e)}}class fs extends xe{playerDir=new X(0,0);uTime=l(0);uScale1=l(.25);uScale2=l(5);uScaleOffset=l(.05);uFresnelScale=l(.4);uMinDist=l(15);uMaxDist=l(55);uBaseColor=l(new O().setRGB(.06,.11,.1));uPlayerPosition=l(new E(0,0,0));uPlayerDirection=l(new X(0,0));uRippleStrength=l(.2);uMaxYDiff=l(1);uMaxDistSq=l(9);uRings=l(3);uAmplitude=l(.5);uRipplesScale=l(.3);constructor(){super(),this.createMaterial(),H.on("update",this.update.bind(this)),this.debugWater()}debugWater(){const e=K.panel.addFolder({title:"\uD83C\uDF0A Water",expanded:!1});e.addBinding(this.uScale1,"value",{label:"UV Scale 1"}),e.addBinding(this.uScale2,"value",{label:"UV Scale 2"}),e.addBinding(this.uScaleOffset,"value",{label:"Displacement scale"}),e.addBinding(this.uFresnelScale,"value",{label:"Fresnel strength"}),e.addBinding(this.uMinDist,"value",{label:"Opacity min dist"}),e.addBinding(this.uMaxDist,"value",{label:"Opacity max dist"}),e.addBinding(this.uBaseColor,"value",{label:"Base color",view:"color",color:{type:"float"}}),e.addBinding(this.uRippleStrength,"value",{min:0,max:10,label:"Ripple strength"}),e.addBinding(this.uMaxYDiff,"value",{min:-10,max:10,label:"Y Max diff"}),e.addBinding(this.uMaxDistSq,"value",{min:0,max:50,label:"Max dist"}),e.addBinding(this.uRings,"value",{min:0,max:10,label:"# Rings"}),e.addBinding(this.uAmplitude,"value",{min:0,max:10,label:"Amplitude ripples"}),e.addBinding(this.uRipplesScale,"value",{min:0,max:3,label:"Ripples scale"})}update(e){const{clock:t,player:s}=e;this.uTime.value=t.getElapsedTime();const o=s.position.x-this.uPlayerPosition.value.x,a=s.position.z-this.uPlayerPosition.value.z;this.playerDir.set(o,a),this.uPlayerDirection.value.lerp(this.playerDir,.5).normalize(),this.uPlayerPosition.value.copy(s.position)}computeRipples=g(()=>{const e=N.xz,t=this.uPlayerPosition.xz,s=ie(this.uPlayerDirection),o=this.uPlayerPosition.y,a=e.sub(t),i=ne(a,a),n=I(i,this.uMaxDistSq),r=le(o.sub(N.y)),u=Z(this.uMaxYDiff.add(.5),this.uMaxYDiff.negate().add(.5),r),m=this.uRings,h=this.uTime.sub(i.mul(.5)),y=W(h.mul(m)).mul(Ke(i.negate().mul(this.uAmplitude))),w=ne(ie(a),s).mul(.5).add(.5),x=Z(.05,.95,w),M=y.mul(x).mul(this.uRippleStrength).mul(n).mul(u);return p(M)});tangentToObject=g(([e=p(0)])=>{const t=p(1,0,0),s=p(0,0,-1),o=p(0,1,0);return e.x.mul(t).add(e.y.mul(s)).add(e.z.mul(o))});objectToWorld=g(([e=p(0)])=>ie(qe.mul(e)));sampleTangentNormal=g(([e=G(0)])=>{const t=_(c.waterNormal,e);return p(t.r.mul(2).sub(1),t.g.mul(2).sub(1),t.b.mul(2).sub(1))});computeNormal=g(()=>{const t=this.computeRipples().xz.mul(this.uRipplesScale),s=this.uTime.mul(.0025).add(t),o=v(D().mul(this.uScale1).add(s)),a=this.sampleTangentNormal(o),i=v(D().mul(this.uScale2).sub(s)),n=this.sampleTangentNormal(i),r=v(D().mul(this.uScale2.mul(this.uScale1)).add(s)),u=this.sampleTangentNormal(r),m=C(a,n,.5),h=C(m,u,.5),y=this.tangentToObject(h);return this.objectToWorld(y)});computeFresnelFactor=g(([e=p(0),t=p(0)])=>{const s=Xe(Je(f(1).sub(be(ne(t,e),0,1))));return this.uFresnelScale.mul(s)});computeReflectionColor=g(([e=p(0),t=p(0)])=>{const s=$e(t,e);return Qe(c.envMapTexture,s)});computeColorOpacity=g(()=>{const e=ne(N.xz.sub(pe.xz),N.xz.sub(pe.xz)),t=this.uMinDist,s=this.uMaxDist;return C(.05,.5,Z(t.mul(t),s.mul(s),e))});computeColor=g(()=>{const e=this.computeNormal(),t=ie(pe.sub(N)),s=this.computeReflectionColor(e,t),o=this.computeFresnelFactor(e,t),a=C(this.uBaseColor.rgb,s.rgb,o),i=this.computeColorOpacity();return F(a.rgb,i)});computePosition=g(()=>{const e=R(J.xz).add(Te).mul(.015),t=W(this.uTime.mul(e)).mul(this.uScaleOffset);return J.add(p(0,t,0))});createMaterial(){this.precision="lowp",this.transparent=!0,this.positionNode=this.computePosition(),this.colorNode=this.computeColor()}}const ws=20;class ys extends k{_noiseBuffer;constructor(){super(),this._noiseBuffer=oe(ws,"float"),this._noiseBuffer.setPBO(!0),this.precision="lowp",this.flatShading=!1;const e=$.computeMapUvByPosition(N.xz),t=de(e),s=R(b),o=_(c.noiseTexture,t),a=I(.5,o.r),i=f(1).sub(a),n=v(D().mul(3.6).add(s)),r=v(D().mul(1.5).add(s)),u=_(c.stoneDiffuse,n).mul(a),m=_(c.stoneMossyDiffuse,r).mul(i),h=u.add(m);this.colorNode=h.rgb;const y=_(c.stoneNormalAo,n).mul(a),w=_(c.stoneMossyNormalAo,r).mul(i),x=y.add(w);this.normalNode=new me(x.rgb,f(3)),this.aoNode=x.a}}class gs{constructor(){const e=c.realmModel.scene.getObjectByName("stone"),t=c.realmModel.scene.children.filter(({name:a})=>a.startsWith("stone_collider")),s=new ys,o=new ue(e.geometry,s,t.length);o.receiveShadow=!0,t.forEach((a,i)=>{o.setMatrixAt(i,a.matrix);const n=j.fixed().setTranslation(...a.position.toArray()).setRotation(a.quaternion),r=P.world.createRigidBody(n);a.geometry.computeBoundingBox();const u=a.geometry.boundingBox.max.x*a.scale.x,m=Y.ball(u).setRestitution(.15);P.world.createCollider(m,r)}),A.scene.add(o)}}const _s={uTime:l(0),uGrassTerrainColor:l(new O),uWaterSandColor:l(new O),uPathSandColor:l(new O)};class xs extends k{_uniforms;constructor(e){super(),this._uniforms={..._s,...e},this.createMaterial()}computeCausticsDiffuse=g(([e=G(0,0),t=f(0),s=p(0,0,0)])=>{const o=this._uniforms.uTime.mul(.1),a=f(20),i=e.mul(a),n=v(i.add(G(o,0))),r=v(i.add(G(0,o.negate()))),u=_(c.noiseTexture,n,1).g,m=_(c.noiseTexture,r,2).g,h=u.add(m),y=Z(-1,10,t),w=Ae(h,3).mul(f(1).sub(y)),x=p(.6,.8,1).mul(.3);return C(s,x,w)});computeWaterDiffuse=g(([e=f(0),t=G(0,0)])=>{const s=f(8),o=f(.001),a=Z(0,s.add(o),e),i=this._uniforms.uWaterSandColor,n=p(.35,.45,.55).mul(.65),r=this.computeCausticsDiffuse(t,e),u=Z(0,1.5,e),m=p(1,.9,.7).mul(.1).mul(u);return C(i,n,a).add(m).add(r)});createMaterial(){this.flatShading=!1;const e=$.computeMapUvByPosition(N.xz),t=de(e),s=_(c.terrainShadowAo,t.clamp());this.aoNode=s.g;const o=_(c.terrainTypeMap,t,2.5),a=o.g,i=o.b,r=f(1).sub(a).sub(i),u=_(c.sandNormal,v(t.mul(30))),m=v(t.mul(30)),y=_(c.grassNormal,m).dot(u).mul(.65),w=_(c.grassDiffuse,m),x=f(1).sub(w.a),M=this._uniforms.uGrassTerrainColor.mul(x).add(w).mul(a).mul(.85),B=this._uniforms.uPathSandColor.mul(1.2).mul(r),Q=de(N.y.negate()),te=this.computeWaterDiffuse(Q,t).mul(i),ae=M.add(B.mul(y)).add(te.mul(y).mul(.5));this.colorNode=ae.mul(s.r)}}class bs{constructor(e){const t=this.createFloor();t.material=e,A.scene.add(t)}createFloor(){const e=c.realmModel.scene.getObjectByName("floor");return e.receiveShadow=!0,this.createFloorPhysics(),e}getFloorDisplacementData(){const e=c.realmModel.scene.getObjectByName("heightfield"),t=e.geometry.attributes._displacement.array[0],s=e.geometry.attributes.position;e.geometry.boundingBox||e.geometry.computeBoundingBox();const o=e.geometry.boundingBox,a=s.count,i=Math.sqrt(a),n=o.max.x,r=new Float32Array(a);for(let u=0;u<a;u++){const m=s.array[u*3+0],h=s.array[u*3+1],y=s.array[u*3+2],w=Math.round((m/(n*2)+.5)*(i-1)),M=Math.round((y/(n*2)+.5)*(i-1))+w*i;r[M]=h}return{rowsCount:i,heights:r,displacement:t}}createFloorPhysics(){const e=this.getFloorDisplacementData(),{rowsCount:t,heights:s,displacement:o}=e,a=j.fixed().setTranslation(0,-o,0),i=P.world.createRigidBody(a),n=Y.heightfield(t-1,t-1,s,{x:U.MAP_SIZE,y:1,z:U.MAP_SIZE},lt.FIX_INTERNAL_EDGES).setFriction(1).setRestitution(.2);P.world.createCollider(n,i)}}class Ts{outerFloor;kintoun;kintounPosition=new E;constructor(e){this.outerFloor=this.createOuterFloorVisual(),this.outerFloor.material=e,this.kintoun=this.createKintoun(),A.scene.add(this.outerFloor)}createOuterFloorVisual(){const e=c.realmModel.scene.getObjectByName("outer_world");return e.receiveShadow=!0,e}createKintoun(){const e=j.kinematicPositionBased().setTranslation(0,-20,0),t=P.world.createRigidBody(e),s=2,o=Y.cuboid(s,U.HALF_FLOOR_THICKNESS,s).setFriction(1).setRestitution(.2);return P.world.createCollider(o,t),t}useKintoun(e){this.kintounPosition.copy(e).setY(-U.HALF_FLOOR_THICKNESS),this.kintoun.setTranslation(this.kintounPosition,!0)}update(e){const{player:t}=e,s=U.HALF_MAP_SIZE-Math.abs(t.position.x)<U.KINTOUN_ACTIVATION_THRESHOLD,o=U.HALF_MAP_SIZE-Math.abs(t.position.z)<U.KINTOUN_ACTIVATION_THRESHOLD;(s||o)&&this.useKintoun(t.position);const a=U.MAP_SIZE,i=Math.abs(t.position.x),n=Math.sign(t.position.x),r=Math.abs(t.position.z),u=Math.sign(t.position.z),m=i>a?i-a:0,h=r>a?r-a:0;this.outerFloor.position.set(m*n,0,h*u)}}class As{outerTerrain;uniforms={uTime:l(0),uGrassTerrainColor:l(new O().setRGB(.21,.26,.05)),uWaterSandColor:l(new O().setRGB(.54,.39,.2)),uPathSandColor:l(new O().setRGB(.65,.49,.27))};constructor(){const e=new xs(this.uniforms);new bs(e),this.outerTerrain=new Ts(e),H.on("update",this.update.bind(this)),this.debugTerrain()}debugTerrain(){const e=K.panel.addFolder({title:"⛰️ Terrain"});e.expanded=!1,e.addBinding(this.uniforms.uPathSandColor,"value",{label:"Path color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWaterSandColor,"value",{label:"Water bed color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGrassTerrainColor,"value",{label:"Grass terrain color",view:"color",color:{type:"float"}})}update(e){const{clock:t}=e;this.uniforms.uTime.value=t.getElapsedTime(),this.outerTerrain.update(e)}}const Ss=()=>({BLADE_WIDTH:.065,BLADE_HEIGHT:1.25,BLADE_BOUNDING_SPHERE_RADIUS:1.25,TILE_SIZE:150,TILE_HALF_SIZE:150/2,BLADES_PER_SIDE:550,COUNT:550*550,SPACING:150/550}),T=Ss(),Ie={uTime:l(0),uPlayerPosition:l(new E(0,0,0)),uCameraMatrix:l(new he),uBladeMinScale:l(.5),uBladeMaxScale:l(1.25),uTrailGrowthRate:l(.004),uTrailMinScale:l(.25),uTrailRaius:l(.65),uTrailRaiusSquared:l(.65*.65),uGlowRadius:l(2),uGlowRadiusSquared:l(4),uGlowFadeIn:l(.05),uGlowFadeOut:l(.01),uGlowColor:l(new O().setRGB(.49,.3,.07)),uBladeMaxBendAngle:l(Math.PI*.15),uWindStrength:l(.6),uBaseColor:l(new O().setRGB(.1,.1,.02)),uTipColor:l(new O().setRGB(.17,.16,.05)),uDelta:l(new X(0,0))};class Ls extends xe{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...Ie,...e},this._buffer1=oe(T.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=oe(T.COUNT,"vec4"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createGrassMaterial()}computeInit=g(()=>{const e=this._buffer1.element(b),t=ce(f(b).div(T.BLADES_PER_SIDE)),s=f(b).mod(T.BLADES_PER_SIDE),o=R(b.add(4321)),a=R(b.add(1234)),i=s.mul(T.SPACING).sub(T.TILE_HALF_SIZE).add(o.mul(T.SPACING*.5)),n=t.mul(T.SPACING).sub(T.TILE_HALF_SIZE).add(a.mul(T.SPACING*.5)),r=p(i,0,n).xz.add(T.TILE_HALF_SIZE).div(T.TILE_SIZE).abs(),u=_(c.noiseTexture,r),m=u.b.sub(.5).mul(30),h=u.g.sub(.5).mul(10);e.x=i.add(m),e.y=n.add(h);const w=p(e.x,0,e.y).xz.add(T.TILE_HALF_SIZE).div(T.TILE_SIZE),x=f(20),M=v(w.mul(x)),Q=_(c.noiseTexture,M,1).b.sub(.5).mul(f(Math.PI*2));e.z=Q;const ee=this._buffer2.element(b),te=this._uniforms.uBladeMaxScale.sub(this._uniforms.uBladeMinScale),ae=R(b.add(100)).mul(te).add(this._uniforms.uBladeMinScale);ee.x=ae,ee.y=ae})().compute(T.COUNT);computeVisibility=g(([e=p(0)])=>{const t=this._uniforms.uCameraMatrix.mul(F(e,1)),s=t.xyz.div(t.w),o=T.BLADE_BOUNDING_SPHERE_RADIUS,a=f(1);return I(a.negate().sub(o),s.x).mul(I(s.x,a.add(o))).mul(I(a.negate().sub(o),s.y)).mul(I(s.y,a.add(o))).mul(I(0,s.z)).mul(I(s.z,a))});computeBending=g(([e=F(0,0,0,0),t=p(0,0,0)])=>{const s=t.xz.add(this._uniforms.uTime.mul(.25)).mul(.5),o=v(s),i=_(c.noiseTexture,o,5).r.mul(this._uniforms.uWindStrength);return e.w.add(i.sub(e.w).mul(.1))});computeAlpha=g(([e=p(0)])=>{const t=$.computeMapUvByPosition(e.xz);return _(c.terrainTypeMap,t).g});computeTrailScale=g(([e=F(0),t=f(0)])=>{const s=e.x.add(this._uniforms.uTrailGrowthRate),o=f(1).sub(t),a=this._uniforms.uTrailMinScale.mul(t).add(s.mul(o));return tt(a,e.y)});computeTrailGlow=g(([e=F(0),t=f(0),s=f(0),o=f(0)])=>{const a=Z(this._uniforms.uGlowRadiusSquared,f(0),t),i=100,n=ce(le(this._uniforms.uDelta.x).mul(i)),r=ce(le(this._uniforms.uDelta.y).mul(i)),u=I(1,n.add(r)),m=a.mul(f(1).sub(s)).mul(o),h=st(u,e.w).mul(m),y=h.mul(this._uniforms.uGlowFadeIn),w=f(1).sub(h).mul(this._uniforms.uGlowFadeOut),x=f(1).sub(u).mul(this._uniforms.uGlowFadeOut).mul(e.w);return be(e.w.add(y).sub(w).sub(x),0,1)});computeUpdate=g(()=>{const e=this._buffer1.element(b),t=this._buffer2.element(b),s=se(e.x.sub(this._uniforms.uDelta.x).add(T.TILE_HALF_SIZE),T.TILE_SIZE).sub(T.TILE_HALF_SIZE),o=se(e.y.sub(this._uniforms.uDelta.y).add(T.TILE_HALF_SIZE),T.TILE_SIZE).sub(T.TILE_HALF_SIZE),a=p(s,0,o);e.x=s,e.y=o;const i=a.add(this._uniforms.uPlayerPosition),n=this.computeVisibility(i);t.z=n,Le(n,()=>{const r=G(this._uniforms.uDelta.x,this._uniforms.uDelta.y),u=a.xz.sub(r),m=u.dot(u),h=I(.1,f(1).sub(this._uniforms.uPlayerPosition.y)),y=I(m,this._uniforms.uTrailRaiusSquared).mul(h);t.x=this.computeTrailScale(t,y),t.z=this.computeAlpha(i),e.w=this.computeBending(e,i),t.w=this.computeTrailGlow(t,m,y,h)})})().compute(T.COUNT);computePosition=g(([e=F(0),t=F(0)])=>{const s=p(e.x,0,e.y),o=e.z,a=e.w,i=t.x,n=a.mul(D().y),u=fe(J,p(n,0,0)).mul(p(1,i,1)),m=fe(u,p(0,o,0)),h=R(b).mul(6.28),y=W(this._uniforms.uTime.mul(5).add(e.w).add(h)).mul(.1),w=D().y.mul(t.w),x=y.mul(w);return m.add(s).add(p(x))});computeDiffuseColor=g(([e=F(0)])=>{const t=Ae(D().y,1.5),s=C(this._uniforms.uBaseColor,this._uniforms.uTipColor,t),o=R(b).mul(.05).sub(.025),a=e.w;return C(s.add(o),this._uniforms.uGlowColor.mul(.5),a)});computeAO=g(([e=F(0)])=>{const t=le(W(e.z)).mul(.5);return Z(-2.5,1.25,D().y).mul(f(1).sub(t))});createGrassMaterial(){this.precision="lowp",this.side=we;const e=this._buffer1.element(b),t=this._buffer2.element(b);ot(t.z.equal(0)),this.positionNode=this.computePosition(e,t),this.opacityNode=t.z,this.alphaTest=.25,this.aoNode=this.computeAO(e),this.colorNode=this.computeDiffuseColor(t)}async updateAsync(){await V.renderer.computeAsync(this.computeUpdate)}}class Es{material;grassField;uniforms={...Ie,uDelta:l(new X(0,0)),uPlayerPosition:l(new E(0,0,0)),uCameraMatrix:l(new he),uTime:l(0)};constructor(){const e=this.createBladeGeometry();e.instanceCount=T.COUNT,this.material=new Ls(this.uniforms),this.grassField=new Se(e,this.material),A.scene.add(this.grassField),H.on("update",this.updateAsync.bind(this)),this.debugGrass()}debugGrass(){const e=K.panel.addFolder({title:"\uD83C\uDF31 Grass"});e.expanded=!1,e.addBinding(this.uniforms.uTipColor,"value",{label:"Tip Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGlowColor,"value",{label:"Glow Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uWindStrength,"value",{label:"Wind strength",min:0,max:Math.PI/2,step:.1})}createBladeGeometry(){const e=T.BLADE_WIDTH/2,t=e/2,s=T.BLADE_HEIGHT/2,o=new Float32Array([-e,0,0,e,0,0,-t,s*1,0,t,s*1,0,0,s*2,0]),a=new Float32Array([0,0,1,0,.25,s*1,.75,s*1,.5,s*2]),i=new Uint16Array([0,1,3,0,3,2,2,3,4]),r=25*Math.PI/180,u=Math.cos(r),m=Math.sin(r),y=15*Math.PI/180,w=Math.cos(y),x=Math.sin(y),M=new Float32Array([-u,m,0,u,m,0,-w,x,0,w,x,0,0,1,0]),B=new et;return B.setAttribute("position",new re(o,3)),B.setAttribute("uv",new re(a,2)),B.setIndex(new re(i,1)),B.setAttribute("normal",new re(M,3)),B}async updateAsync(e){const{player:t,clock:s}=e,o=t.position.x-this.grassField.position.x,a=t.position.z-this.grassField.position.z;this.uniforms.uDelta.value.set(o,a),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(A.camera.projectionMatrix).multiply(A.camera.matrixWorldInverse),this.uniforms.uTime.value=s.getElapsedTime(),this.grassField.position.copy(t.position).setY(0),await this.material.updateAsync()}}class Ps{uTime=l(0);constructor(){const e=c.realmModel.scene.getObjectByName("water_lilies");e.material=this.createMaterial(),A.scene.add(e),H.on("update",this.update.bind(this))}createMaterial(){const e=new k;e.precision="lowp",e.transparent=!0,e.map=c.waterLiliesTexture,e.alphaTest=.5,e.alphaMap=c.waterLiliesAlphaTexture;const t=this.uTime.mul(5e-4),s=N.x.mul(.1),o=_(c.noiseTexture,v(N.xz.add(t).mul(s))).b.mul(.5),a=W(o);return e.positionNode=J.add(a),e}update(e){const{clock:t}=e;this.uTime.value=t.getElapsedTime()}}class Is extends k{constructor(){super(),this.precision="lowp",this.flatShading=!1;const e=v(D().mul(7)),t=_(c.barkDiffuse,e);this.colorNode=t;const s=_(c.barkNormal,e);this.normalNode=new me(s)}}class Ms extends k{uTime=l(0);constructor(){super(),this.precision="lowp",this.flatShading=!1,this.transparent=!0,this.side=we;const e=$.computeMapUvByPosition(N.xz),t=_(c.noiseTexture,e),s=R(b.add(t.b)),o=_(c.canopyDiffuse,D()),a=C(p(.889,.095,0),p(1,.162,.009),.5),i=C(p(1,.254,.052),p(1,.767,.004),.5),n=C(a,i,s);this.colorNode=C(o.mul(1.25),n,t.b);const r=_(c.canopyNormal,D());this.normalNode=new me(r,f(2)),this.alphaTest=.9;const u=this.uTime.mul(t.r).add(Te).mul(7.5),m=W(u).mul(.015);this.positionNode=J.add(m),H.on("update",this.update.bind(this))}update(e){const{clock:t}=e;this.uTime.value=t.elapsedTime}}class Ns{constructor(){const e=c.realmModel.scene.getObjectByName("tree"),t=c.realmModel.scene.children.filter(({name:w})=>w.startsWith("tree_collider")),s=new Is,o=new Ms,[a,i]=e.children,n=new ue(a.geometry,s,t.length);n.receiveShadow=!0;const r=new ue(i.geometry,o,t.length),m=c.realmModel.scene.getObjectByName("base_tree_collider").geometry.boundingBox,h=m.max.x,y=m.max.y/2;t.forEach((w,x)=>{n.setMatrixAt(x,w.matrix),r.setMatrixAt(x,w.matrix);const M=j.fixed().setTranslation(...w.position.toArray()).setRotation(w.quaternion),B=P.world.createRigidBody(M),Q=h*w.scale.x,ee=y*w.scale.y,te=Y.capsule(ee,Q).setRestitution(.15);P.world.createCollider(te,B)}),A.scene.add(n,r)}}class vs{constructor(){new Es,new Ps,new Ns}}const Ds=()=>({FLOWER_WIDTH:1,FLOWER_HEIGHT:1,BLADE_BOUNDING_SPHERE_RADIUS:1,TILE_SIZE:150,TILE_HALF_SIZE:150/2,FLOWERS_PER_SIDE:10,COUNT:10*10,SPACING:150/10}),L=Ds();class Cs{flowerField;material;uniforms={...Me,uDelta:l(new X(0,0)),uPlayerPosition:l(new E(0,0,0)),uCameraMatrix:l(new he),uTime:l(0)};constructor(){const e=c.realmModel.scene.getObjectByName("flowers_plane");e.geometry.translate(0,.35,0),this.material=new Bs(this.uniforms),this.flowerField=new ue(e.geometry,this.material,L.COUNT),A.scene.add(this.flowerField),H.on("update",this.updateAsync.bind(this))}async updateAsync(e){const{player:t,clock:s}=e,o=t.position.x-this.flowerField.position.x,a=t.position.z-this.flowerField.position.z;this.uniforms.uDelta.value.set(o,a),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(A.camera.projectionMatrix).multiply(A.camera.matrixWorldInverse),this.uniforms.uTime.value=s.getElapsedTime(),this.flowerField.position.copy(t.position).setY(0),await this.material.updateAsync()}}const Me={uTime:l(0),uPlayerPosition:l(new E(0,0,0)),uCameraMatrix:l(new he),uFlowersMinScale:l(1),uFlowersMaxScale:l(1.25),uDelta:l(new X(0,0))};class Bs extends k{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...Me,...e},this._buffer1=oe(L.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=oe(L.COUNT,"float"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createFlowerMaterial()}computeInit=g(()=>{const e=this._buffer1.element(b),t=ce(f(b).div(L.FLOWERS_PER_SIDE)),s=f(b).mod(L.FLOWERS_PER_SIDE),o=R(b.add(4321)),a=R(b.add(1234)),i=s.mul(L.SPACING).sub(L.TILE_HALF_SIZE).add(o.mul(L.SPACING*.5)),n=t.mul(L.SPACING).sub(L.TILE_HALF_SIZE).add(a.mul(L.SPACING*.5)),r=p(i,0,n).xz.add(L.TILE_HALF_SIZE).div(L.TILE_SIZE).abs(),u=_(c.noiseTexture,r),m=C(u.r,u.b,.75),h=m.sub(.5).mul(100),y=m.sub(.5).mul(50);e.x=i.add(h),e.y=n.add(y);const w=u.b.sub(.5).mul(f(Math.PI*2));e.z=w;const x=this._buffer2.element(b),M=this._uniforms.uFlowersMaxScale.sub(this._uniforms.uFlowersMinScale),B=R(b.add(100)).mul(M).add(this._uniforms.uFlowersMinScale);x.assign(B)})().compute(L.COUNT);computeVisibility=g(([e=p(0)])=>{const t=this._uniforms.uCameraMatrix.mul(F(e,1)),s=t.xyz.div(t.w),o=L.BLADE_BOUNDING_SPHERE_RADIUS,a=f(1);return I(a.negate().sub(o),s.x).mul(I(s.x,a.add(o))).mul(I(a.negate().sub(o),s.y)).mul(I(s.y,a.add(o))).mul(I(0,s.z)).mul(I(s.z,a))});computeAlpha=g(([e=p(0)])=>{const t=$.computeMapUvByPosition(e.xz);return _(c.terrainTypeMap,t).g});computeUpdate=g(()=>{const e=this._buffer1.element(b),t=se(e.x.sub(this._uniforms.uDelta.x).add(L.TILE_HALF_SIZE),L.TILE_SIZE).sub(L.TILE_HALF_SIZE),s=se(e.y.sub(this._uniforms.uDelta.y).add(L.TILE_HALF_SIZE),L.TILE_SIZE).sub(L.TILE_HALF_SIZE);e.x=t,e.y=s;const a=p(e.x,0,e.y).add(this._uniforms.uPlayerPosition),i=this.computeVisibility(a);e.w=i,Le(i,()=>{e.w=this.computeAlpha(a)})})().compute(L.COUNT);computePosition=g(([e=F(0),t=f(0)])=>{const s=R(b),o=p(e.x,0,e.y),a=e.z,i=J.mul(p(t,1.5,t)),n=W(this._uniforms.uTime.mul(5).mul(s)).mul(.015);return fe(i,p(n,a.mul(2),n.mul(2))).add(o)});createFlowerMaterial(){this.precision="lowp";const e=this._buffer1.element(b),t=this._buffer2.element(b);this.positionNode=this.computePosition(e,t),this.opacityNode=e.w,this.alphaTest=.75;const s=se(f(b),2),o=f(1).sub(s),a=_(c.flowers1,D()).mul(s).mul(1.25),i=_(c.flowers2,D()).mul(o).mul(1.5),n=a.add(i);this.colorNode=n.mul(1.5)}async updateAsync(){await V.renderer.computeAsync(this.computeUpdate)}}const Rs=()=>Object.freeze({MAP_SIZE:256,HALF_MAP_SIZE:256/2,KINTOUN_ACTIVATION_THRESHOLD:2,HALF_FLOOR_THICKNESS:.3,OUTER_MAP_SIZE:256*3,OUTER_HALF_MAP_SIZE:256*1.5}),U=Rs();class Os{constructor(){new As,new hs,new ps,new vs,new gs,new Cs,new ds}}class Fs{computeMapUvByPosition=g(([e=G(0)])=>e.add(U.HALF_MAP_SIZE).div(U.MAP_SIZE));computeAtlasUv=g(([e=G(0),t=G(0),s=G(0)])=>s.mul(e).add(t))}const $=new Fs,Us=()=>({JUMP_BUFFER_DURATION_IN_SECONDS:.2,MAX_CONSECUTIVE_JUMPS:2,JUMP_CUT_MULTIPLIER:.25,FALL_MULTIPLIER:2.75,MAX_UPWARD_VELOCITY:6,LINEAR_DAMPING:.35,ANGULAR_DAMPING:.6,JUMP_IMPULSE:new E(0,75,0),LIN_VEL_STRENGTH:35,ANG_VEL_STRENGTH:25,RADIUS:.5,PLAYER_INITIAL_POSITION:new E(0,5,0),CAMERA_OFFSET:new E(0,11,17),CAMERA_LERP_FACTOR:7.5,UP:new E(0,1,0),DOWN:new E(0,-1,0),FORWARD:new E(0,0,-1)}),S=Us();class Gs{mesh;rigidBody;smoothedCameraPosition=new E;desiredCameraPosition=new E;smoothedCameraTarget=new E;desiredTargetPosition=new E;yawInRadians=0;prevYawInRadians=-1;yawQuaternion=new at;newLinVel=new E;newAngVel=new E;torqueAxis=new E;forwardVec=new E;isOnGround=!1;jumpCount=0;wasJumpHeld=!1;jumpBufferTimer=0;rayOrigin=new E;ray=new ct(this.rayOrigin,S.DOWN);uTime=l(0);uOffsetShadow=l(0);constructor(){this.mesh=this.createCharacterMesh(),A.scene.add(this.mesh),Ee.setTarget(this.mesh),this.rigidBody=P.world.createRigidBody(this.createRigidBodyDesc()),P.world.createCollider(this.createColliderDesc(),this.rigidBody),H.on("update",this.update.bind(this)),this.debugPlayer()}debugPlayer(){const e=K.panel.addFolder({title:"\uD83E\uDEA9 Player",expanded:!1});e.addBinding(S.CAMERA_OFFSET,"y",{label:"Main camera height"}),e.addBinding(S.CAMERA_OFFSET,"z",{label:"Main camera distance"})}createCharacterMesh(){const e=new it(S.RADIUS,2),t=new Hs({uTime:this.uTime,uOffsetShadow:this.uOffsetShadow}),s=new Se(e,t);return s.castShadow=!0,s.position.copy(S.PLAYER_INITIAL_POSITION),s}createRigidBodyDesc(){const{x:e,y:t,z:s}=S.PLAYER_INITIAL_POSITION;return j.dynamic().setTranslation(e,t,s).setLinearDamping(S.LINEAR_DAMPING).setAngularDamping(S.ANGULAR_DAMPING)}createColliderDesc(){return Y.ball(S.RADIUS).setRestitution(.2).setFriction(1).setMass(3)}update(e){const{clock:t}=e,s=t.getDelta();this.uTime.value=t.getElapsedTime(),this.prevYawInRadians!==this.yawInRadians&&(this.yawQuaternion.setFromAxisAngle(S.UP,this.yawInRadians),this.prevYawInRadians=this.yawInRadians),this.updateVerticalMovement(s),this.updateHorizontalMovement(s),this.updateCameraPosition(s)}updateVerticalMovement(e){const t=z.isKeyPressed(" ");this.isOnGround=this.checkIfGrounded(),this.isOnGround&&(this.jumpCount=0),t&&!this.wasJumpHeld?this.jumpBufferTimer=S.JUMP_BUFFER_DURATION_IN_SECONDS:this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),this.jumpBufferTimer>0&&this.canJump()&&(this.performJump(),this.jumpBufferTimer=0);const o=this.rigidBody.linvel();this.handleJumpCut(t,o),this.handleFastFall(e,o,P.world.gravity.y),this.clampUpwardVelocity(o),this.rigidBody.setLinvel(o,!0),this.wasJumpHeld=t}checkIfGrounded(){this.rayOrigin.copy(this.rigidBody.translation()),this.rayOrigin.y-=S.RADIUS+.01;const e=.2,t=P.world.castRay(this.ray,e,!0);return t?t.timeOfImpact*e<.01:!1}canJump(){return this.isOnGround?!0:this.jumpCount<S.MAX_CONSECUTIVE_JUMPS}performJump(){this.rigidBody.applyImpulse(S.JUMP_IMPULSE,!0),this.jumpCount+=1}handleJumpCut(e,t){!(!e&&this.wasJumpHeld)||t.y<=0||(t.y*=S.JUMP_CUT_MULTIPLIER)}handleFastFall(e,t,s){if(t.y>=0)return;const o=S.FALL_MULTIPLIER*Math.abs(s)*e;t.y-=o}clampUpwardVelocity(e){e.y<=S.MAX_UPWARD_VELOCITY||(e.y=S.MAX_UPWARD_VELOCITY)}updateHorizontalMovement(e){const t=z.isKeyPressed("w")||z.isKeyPressed("arrowup"),s=z.isKeyPressed("s")||z.isKeyPressed("arrowdown"),o=z.isKeyPressed("a")||z.isKeyPressed("arrowleft"),a=z.isKeyPressed("d")||z.isKeyPressed("arrowright"),i=2;o&&(this.yawInRadians+=i*e),a&&(this.yawInRadians-=i*e),this.forwardVec.copy(S.FORWARD).applyQuaternion(this.yawQuaternion),this.torqueAxis.crossVectors(S.UP,this.forwardVec).normalize(),this.newLinVel.copy(this.rigidBody.linvel()),this.newAngVel.copy(this.rigidBody.angvel());const n=S.LIN_VEL_STRENGTH*e,r=S.ANG_VEL_STRENGTH*e;t&&(this.newLinVel.addScaledVector(this.forwardVec,n),this.newAngVel.addScaledVector(this.torqueAxis,r)),s&&(this.newLinVel.addScaledVector(this.forwardVec,-n),this.newAngVel.addScaledVector(this.torqueAxis,-r)),this.rigidBody.setLinvel(this.newLinVel,!0),this.rigidBody.setAngvel(this.newAngVel,!0),this.syncMeshWithBody()}syncMeshWithBody(){this.mesh.position.copy(this.rigidBody.translation()),this.mesh.quaternion.copy(this.rigidBody.rotation())}updateCameraPosition(e){this.desiredCameraPosition.copy(S.CAMERA_OFFSET).applyQuaternion(this.yawQuaternion).add(this.mesh.position);const t=S.CAMERA_LERP_FACTOR*e;this.smoothedCameraPosition.lerp(this.desiredCameraPosition,t),this.desiredTargetPosition.copy(this.mesh.position),this.desiredTargetPosition.y+=1,this.smoothedCameraTarget.lerp(this.desiredTargetPosition,t),A.camera.position.copy(this.smoothedCameraPosition),A.camera.lookAt(this.smoothedCameraTarget)}get position(){return this.mesh.position}get yaw(){return this.yawInRadians}}class Hs extends k{_uniforms;constructor(e){super(),this._uniforms={...e},this.createMaterial()}createMaterial(){this.flatShading=!0,this.castShadowNode=p(.6);const e=$.computeMapUvByPosition(N.xz),t=de(e),s=Ee.getTerrainShadowFactor(t),o=_(c.noiseTexture,v(N.xz),3).r,a=W(this._uniforms.uTime.mul(2.5).add(o.mul(5))).mul(.05),i=f(-.15).add(a),n=f(1).sub(I(i,N.y)),r=f(1).sub(n),u=p(1),m=f(1).sub(Z(-1.5,1,N.y).mul(n)),h=C(p(1),p(.6,.8,1).mul(.75),m),y=u.mul(h).mul(n),x=u.mul(r).add(y);this.colorNode=x.mul(s)}}class ks{player;constructor(){this.player=new Gs,new Os}getSizes(){const e=window.innerWidth,t=window.innerHeight;return{width:e,height:t,dpr:Math.min(window.devicePixelRatio,1.5),aspect:e/t}}onResize(){const e=this.getSizes();A.camera.aspect=e.aspect,A.camera.updateProjectionMatrix(),V.renderer.setSize(e.width,e.height),V.renderer.setPixelRatio(e.dpr)}async startLoop(){await V.init();const t={clock:new nt(!0),player:this.player},s=async()=>{P.update(),H.emit("update",t),V.renderAsync()};new ResizeObserver(()=>{this.onResize()}).observe(document.body),V.renderer.setAnimationLoop(s)}}const zs=new Xt;zs.initAsync().then(()=>{new ks().startLoop()})});