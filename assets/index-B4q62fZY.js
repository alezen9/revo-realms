import{T as ge,D as fe,G as we,C as ye,L as _e,_ as Te,V as _,Q as Me,u as r,I as be,M as ie,a as Ae,t as T,f as L,p as U,s as ne,b as d,c as S,d as D,e as R,g as Pe,F as w,m as Q,h as I,v as B,i as u,j as N,n as V,k as Le,l as Ee,o as Ie,q as $,r as W,w as x,x as ve,y as Se,z as q,A as ee,B as Z,E as F,H as O,J as z,K as xe,N as ae,O as K,P as re,R as Ce,S as Ne,U as Fe,W as De,X as Be,Y as Re,Z as Oe,$ as Ue,a0 as Ge,a1 as ze,a2 as Ve,a3 as He,a4 as ke,a5 as We,a6 as Ze,a7 as le,a8 as ce,a9 as Ke,aa as H,ab as te,ac as P,ad as X,ae as k,af as je,ag as Y,ah as Je,ai as de,aj as qe,ak as Xe}from"./three-CTZ_HJUd.js";import{World as Ye,Ray as Qe,RigidBodyDesc as j,ColliderDesc as J,HeightFieldFlags as $e,__tla as __tla_0}from"./@dimforge-Tx9Ov1ko.js";import{P as et}from"./tweakpane-BXg6ZhiP.js";import{S as se}from"./stats-gl-C2M3amu4.js";Promise.all([(()=>{try{return __tla_0}catch{}})()]).then(async()=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=t(o);fetch(o.href,n)}})();const tt="/revo-realms/textures/noise/perlin_noise.webp",st="/revo-realms/textures/noise/random_noise.webp",ot="/revo-realms/textures/noise/voronoi_noise.webp",it="/revo-realms/models/realm.glb",nt="/revo-realms/textures/realm/water_grass_map.webp",at="/revo-realms/textures/realm/sand_nor.webp",rt="/revo-realms/textures/realm/leaf.webp",lt="/revo-realms/textures/environment/px.webp",ct="/revo-realms/textures/environment/nx.webp",dt="/revo-realms/textures/environment/py.webp",ut="/revo-realms/textures/environment/ny.webp",ht="/revo-realms/textures/environment/pz.webp",mt="/revo-realms/textures/environment/nz.webp";class pt{textureLoader;gltfLoader;cubeTextureLoader;perlinNoiseTexture;randomNoiseTexture;voronoiNoiseTexture;envMapTexture;floorGrassWaterMap;sandNormalTexture;leafTexture;npcsModel;realmModel;constructor(){const e=this.createLoadingManager();this.textureLoader=new ge(e);const t=new fe(e);t.setDecoderPath("/revo-realms/draco/"),this.gltfLoader=new we(e),this.gltfLoader.setDRACOLoader(t),this.cubeTextureLoader=new ye(e)}createLoadingManager(){const e=new _e;e.onStart=function(t,s,o){console.log("Started loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onLoad=function(){console.log("Loading complete!")},e.onProgress=function(t,s,o){console.log("Loading file: "+t+`.
Loaded `+s+" of "+o+" files.")},e.onError=function(t){console.log("There was an error loading "+t)}}async initAsync(){const e=await Promise.all([h.cubeTextureLoader.loadAsync([lt,ct,dt,ut,ht,mt]),this.textureLoader.loadAsync(tt),this.textureLoader.loadAsync(st),this.textureLoader.loadAsync(ot),this.gltfLoader.loadAsync(it),this.textureLoader.loadAsync(nt),this.textureLoader.loadAsync(at),this.textureLoader.loadAsync(rt)]);this.envMapTexture=e[0],this.perlinNoiseTexture=e[1],this.randomNoiseTexture=e[2],this.voronoiNoiseTexture=e[3],this.realmModel=e[4],this.floorGrassWaterMap=e[5],this.floorGrassWaterMap.flipY=!1,this.sandNormalTexture=e[6],this.leafTexture=e[7]}}const h=new pt;class gt{world;constructor(){}async init(){return Te(()=>import("./@dimforge-Tx9Ov1ko.js").then(async m=>{await m.__tla;return m}),[]).then(()=>{this.world=new Ye({x:0,y:-9.81,z:0})})}update(){this.world.step()}}const E=new gt;class ft{async initAsync(){await Promise.all([E.init(),h.initAsync()])}}class wt{mesh;rigidBody;inputManager;smoothedCameraPosition=new _;desiredCameraPosition=new _;smoothedCameraTarget=new _;desiredTargetPosition=new _;yawInRadians=0;prevYawInRadians=-1;yawQuaternion=new Me;JUMP_IMPULSE=5;JUMP_BUFFER_DURATION_IN_SECONDS=.2;MAX_CONSECUTIVE_JUMPS=2;JUMP_CUT_MULTIPLIER=.25;FALL_MULTIPLIER=2.75;MAX_UPWARD_VELOCITY=6;LINEAR_DAMPING=.25;ANGULAR_DAMPING=1;jumpImpulse=new _(0,this.JUMP_IMPULSE,0);LIN_VEL_STRENGTH=25;ANG_VEL_STRENGTH=25;newLinVel=new _;newAngVel=new _;torqueAxis=new _;forwardVec=new _;isOnGround=!1;jumpCount=0;wasJumpHeld=!1;jumpBufferTimer=0;RADIUS=.5;PLAYER_INITIAL_POSITION=new _(0,5,0);CAMERA_OFFSET=new _(0,13,16);CAMERA_LERP_FACTOR=7.5;UP=new _(0,1,0);DOWN=new _(0,-1,0);FORWARD=new _(0,0,-1);rayOrigin=new _;ray=new Qe(this.rayOrigin,this.DOWN);lighting;uTime=r(0);constructor(e){const{scene:t,inputManager:s,lighting:o}=e;this.inputManager=s,this.lighting=o,this.mesh=this.createCharacterMesh(),t.add(this.mesh),o.setTarget(this.mesh),this.rigidBody=E.world.createRigidBody(this.createRigidBodyDesc()),E.world.createCollider(this.createColliderDesc(),this.rigidBody)}createCharacterMesh(){const e=new be(this.RADIUS,3),t=new yt({uTime:this.uTime}),s=new ie(e,t);return s.castShadow=!0,s.position.copy(this.PLAYER_INITIAL_POSITION),s}createRigidBodyDesc(){const{x:e,y:t,z:s}=this.PLAYER_INITIAL_POSITION;return j.dynamic().setTranslation(e,t,s).setLinearDamping(this.LINEAR_DAMPING).setAngularDamping(this.ANGULAR_DAMPING)}createColliderDesc(){return J.ball(this.RADIUS).setRestitution(.2).setFriction(1)}update(e){const{clock:t,camera:s}=e,o=t.getDelta();this.uTime.value=t.getElapsedTime(),this.prevYawInRadians!==this.yawInRadians&&(this.yawQuaternion.setFromAxisAngle(this.UP,this.yawInRadians),this.prevYawInRadians=this.yawInRadians),this.updateVerticalMovement(o),this.updateHorizontalMovement(o),this.updateCameraPosition(s,o)}updateVerticalMovement(e){const t=this.inputManager.isKeyPressed(" ");this.isOnGround=this.checkIfGrounded(),this.isOnGround&&(this.jumpCount=0),t&&!this.wasJumpHeld?this.jumpBufferTimer=this.JUMP_BUFFER_DURATION_IN_SECONDS:this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),this.jumpBufferTimer>0&&this.canJump()&&(this.performJump(),this.jumpBufferTimer=0);const o=this.rigidBody.linvel();this.handleJumpCut(t,o),this.handleFastFall(e,o,E.world.gravity.y),this.clampUpwardVelocity(o),this.rigidBody.setLinvel(o,!0),this.wasJumpHeld=t}checkIfGrounded(){this.rayOrigin.copy(this.rigidBody.translation()),this.rayOrigin.y-=this.RADIUS+.01;const e=.2,t=E.world.castRay(this.ray,e,!0);return t?t.timeOfImpact*e<.01:!1}canJump(){return this.isOnGround?!0:this.jumpCount<this.MAX_CONSECUTIVE_JUMPS}performJump(){this.rigidBody.applyImpulse(this.jumpImpulse,!0),this.jumpCount+=1}handleJumpCut(e,t){!(!e&&this.wasJumpHeld)||t.y<=0||(t.y*=this.JUMP_CUT_MULTIPLIER)}handleFastFall(e,t,s){if(t.y>=0)return;const o=this.FALL_MULTIPLIER*Math.abs(s)*e;t.y-=o}clampUpwardVelocity(e){e.y<=this.MAX_UPWARD_VELOCITY||(e.y=this.MAX_UPWARD_VELOCITY)}updateHorizontalMovement(e){const t=this.inputManager.isKeyPressed("w")||this.inputManager.isKeyPressed("arrowup"),s=this.inputManager.isKeyPressed("s")||this.inputManager.isKeyPressed("arrowdown"),o=this.inputManager.isKeyPressed("a")||this.inputManager.isKeyPressed("arrowleft"),n=this.inputManager.isKeyPressed("d")||this.inputManager.isKeyPressed("arrowright"),i=2;o&&(this.yawInRadians+=i*e),n&&(this.yawInRadians-=i*e),this.forwardVec.copy(this.FORWARD).applyQuaternion(this.yawQuaternion),this.torqueAxis.crossVectors(this.UP,this.forwardVec).normalize(),this.newLinVel.copy(this.rigidBody.linvel()),this.newAngVel.copy(this.rigidBody.angvel());const a=this.LIN_VEL_STRENGTH*e,c=this.ANG_VEL_STRENGTH*e;t&&(this.newLinVel.addScaledVector(this.forwardVec,a),this.newAngVel.addScaledVector(this.torqueAxis,c)),s&&(this.newLinVel.addScaledVector(this.forwardVec,-a),this.newAngVel.addScaledVector(this.torqueAxis,-c)),this.rigidBody.setLinvel(this.newLinVel,!0),this.rigidBody.setAngvel(this.newAngVel,!0),this.syncMeshWithBody()}syncMeshWithBody(){this.mesh.position.copy(this.rigidBody.translation()),this.mesh.quaternion.copy(this.rigidBody.rotation())}updateCameraPosition(e,t){this.desiredCameraPosition.copy(this.CAMERA_OFFSET).applyQuaternion(this.yawQuaternion).add(this.mesh.position);const s=this.CAMERA_LERP_FACTOR*t;this.smoothedCameraPosition.lerp(this.desiredCameraPosition,s),this.desiredTargetPosition.copy(this.mesh.position),this.desiredTargetPosition.y+=1,this.smoothedCameraTarget.lerp(this.desiredTargetPosition,s),e.position.copy(this.smoothedCameraPosition),e.lookAt(this.smoothedCameraTarget)}get position(){return this.mesh.position}get yaw(){return this.yawInRadians}}class yt extends Ae{_uniforms;constructor(e){super(),this._uniforms={...e},this.createMaterial()}createMaterial(){this.flatShading=!0,this.roughness=.5;const e=T(h.perlinNoiseTexture,L(U.xz),3).r,t=ne(this._uniforms.uTime.mul(2.5).add(e.mul(5))).mul(.05),s=d(-.15).add(t),o=d(1).sub(S(s,U.y)),n=d(1).sub(o),i=D("silver"),a=i.mul(n),c=i.mul(1.5).mul(o),l=a.add(c);this.colorNode=l;const p=d(.9).mul(n),f=d(.65).mul(o);this.metalnessNode=p.add(f)}}class _t{panel;constructor(){this.panel=new et({title:"Revo Realms"}),this.panel.hidden=!0,this.panel.element.parentElement.style.zIndex="1",this.panel.element.parentElement.style.width="340px"}setVisibility(e){this.panel.hidden=!e}}const G=new _t,Tt={uTime:r(0),uWavesSpeed:r(.02),uWavesAmplitude:r(.02),uWavesFrequency:r(.64),uTroughColor:r(new R("#186691")),uSurfaceColor:r(new R("#9bd8c0")),uPeakColor:r(new R("#bbd8e0")),uPeakThreshold:r(.5),uPeakTransition:r(0),uTroughThreshold:r(-.23),uTroughTransition:r(.15),uFresnelScale:r(.8)};class Mt extends Pe{_uniforms;debugFolder;constructor(e){super(),this._uniforms={...Tt,...e},this.createWaterMaterial(),this.debugFolder=G.panel.addFolder({title:"\uD83C\uDF0A Water"});const t=!1;this.debugFolder.hidden=!t}computeElevation=w(([e=B(0,0)])=>{const t=this._uniforms.uTime.mul(this._uniforms.uWavesSpeed).mul(.1),s=Q(e.mul(this._uniforms.uWavesFrequency).add(t),1),o=T(h.randomNoiseTexture,s,.5).r,n=T(h.randomNoiseTexture,s,1.5).r;return I(o,n,.5).mul(this._uniforms.uWavesAmplitude).mul(.001)});computePosition=w(([e=d(0)])=>{const t=e.mul(10);return u(N.x,N.y.add(t),N.z)});computeNormal=w(([e=d(0)])=>{const t=d(.001),s=this.computeElevation(B(N.x.sub(t),N.z)),o=this.computeElevation(B(N.x,N.z.sub(t))),n=V(u(t,s.sub(e),0)),i=V(u(0,o.sub(e),t)),a=u(1e-4);return V(Le(n,i)).add(a)});computeFresnel=w(([e=x(u(0,0,0)),t=u(0,0,0)])=>{const s=Ee(Ie(d(1).sub($(W(t,e),0,1))));return this._uniforms.uFresnelScale.mul(s)});computeReflectionColor=w(([e=x(u(0,0,0)),t=u(0,0,0)])=>{let s=ve(t,e);return s.x=s.x.negate(),Se(h.envMapTexture,s)});computeColor=w(([e=x(u(0,0,0)),t=x(u(0,0,0)),s=x(u(0,0,0))])=>{const o=V(t.sub(q)),n=this.computeReflectionColor(e,o),i=this.computeFresnel(e,o),a=ee(t.y.sub(this._uniforms.uTroughThreshold).div(this._uniforms.uTroughTransition.mul(2))),c=I(this._uniforms.uTroughColor,this._uniforms.uSurfaceColor,a),l=ee(t.y.sub(this._uniforms.uPeakThreshold).div(this._uniforms.uPeakTransition.mul(2))),p=I(c,this._uniforms.uPeakColor,l),f=I(p,n.rgb,i),y=W(s.xz.sub(q.xz),s.xz.sub(q.xz)),b=10,A=55,C=I(0,1,Z(b*b,A*A,y));return F(f,C)});createWaterMaterial(){this.precision="lowp";const e=this.computeElevation(O()).mul(1e3),t=this.computePosition(e),s=this.computeNormal(e),o=x(t,"vPosition"),n=x(s,"vNormal"),i=x(U,"vWorldPosition"),a=this.computeColor(n,o,i);this.transparent=!0,this.colorNode=a,this.positionNode=t}debugWaves(){const e=this.debugFolder.addFolder({title:"Waves"});e.addBinding(this._uniforms.uWavesAmplitude,"value",{min:0,max:.1,label:"Amplitude"}),e.addBinding(this._uniforms.uWavesFrequency,"value",{min:.1,max:10,label:"Frequency"}),e.addBinding(this._uniforms.uWavesSpeed,"value",{min:0,max:1,label:"Speed"})}debugColor(){const e=this.debugFolder.addFolder({title:"Color"});e.addBinding(this._uniforms.uTroughColor,"value",{label:"Trough Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uSurfaceColor,"value",{label:"Surface Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakColor,"value",{label:"Peak Color",view:"color",color:{type:"float"}}),e.addBinding(this._uniforms.uPeakThreshold,"value",{min:0,max:.5,label:"Peak Threshold"}),e.addBinding(this._uniforms.uPeakTransition,"value",{min:0,max:.5,label:"Peak Transition"}),e.addBinding(this._uniforms.uTroughThreshold,"value",{min:-.5,max:0,label:"Trough Threshold"}),e.addBinding(this._uniforms.uTroughTransition,"value",{min:0,max:.5,label:"Trough Transition"})}debugFresnel(){this.debugFolder.addFolder({title:"Fresnel"}).addBinding(this._uniforms.uFresnelScale,"value",{min:0,max:1,label:"Scale"})}}const ue={uBaseColor:r(new R("#8c8c8c"))};class bt extends z{_uniforms;constructor(e){super(),this._uniforms={...ue,...e},this.createMaterial()}createMaterial(){this.flatShading=!1;const e=T(h.randomNoiseTexture,L(O().mul(1.5))).mul(.1),t=T(h.randomNoiseTexture,O().mul(.5)).mul(.05),s=e.add(t),o=this._uniforms.uBaseColor.add(s),n=$(W(xe,u(0,1,0)),.3,1),i=o.mul(n);this.colorNode=i}}class At{uniforms=ue;constructor(e){const{scene:t}=e,s=new bt(this.uniforms),o=h.realmModel.scene.children.filter(({name:i})=>i.endsWith("_statue"));o.forEach(i=>{i.material=s}),t.add(...o),h.realmModel.scene.children.filter(({name:i})=>i.startsWith("statue_collider")).forEach(i=>{const a=j.fixed().setTranslation(...i.position.toArray()).setRotation(i.quaternion),c=E.world.createRigidBody(a),l=.5*i.scale.x,p=.5*i.scale.y,f=.5*i.scale.z,y=J.cuboid(l,p,f).setRestitution(.2);E.world.createCollider(y,c)}),this.debugMonument()}debugMonument(){G.panel.addFolder({title:"\uD83D\uDDFD Monuments"}).addBinding(this.uniforms.uBaseColor,"value",{label:"Color",view:"color",color:{type:"float"}})}}const Pt=()=>Object.freeze({MAP_SIZE:256,HALF_MAP_SIZE:256/2,KINTOUN_ACTIVATION_THRESHOLD:2,HALF_FLOOR_THICKNESS:.3,OUTER_MAP_SIZE:256*3,OUTER_HALF_MAP_SIZE:256*1.5}),M=Pt();class Lt{scene;kintounRigidBody;kintounPosition=new _;outerFloorMesh;uTime=r(0);constructor(e){const{scene:t}=e;this.scene=t,this.createFloor(),this.createWater(),new At(e),this.outerFloorMesh=this.createOuterFloorVisual(),this.scene.add(this.outerFloorMesh),this.kintounRigidBody=this.createKintoun()}createOuterFloorVisual(){const e=h.realmModel.scene.getObjectByName("outer_world");return e.material=new vt,e}createFloor(){const e=h.realmModel.scene.getObjectByName("floor");delete e.geometry.attributes.normal,e.material=new It({uTime:this.uTime}),e.receiveShadow=!0,this.scene.add(e),this.createFloorPhysics()}createWater(){const e=h.realmModel.scene.getObjectByName("water");delete e.geometry.attributes.normal;const t=new Mt({uTime:this.uTime});e.material=t,this.scene.add(e)}getFloorDisplacementData(){const e=h.realmModel.scene.getObjectByName("heightfield"),t=e.geometry.attributes._displacement.array[0],s=e.geometry.attributes.position;e.geometry.boundingBox||e.geometry.computeBoundingBox();const o=e.geometry.boundingBox,n=s.count,i=Math.sqrt(n),a=o.max.x,c=new Float32Array(n);for(let l=0;l<n;l++){const p=s.array[l*3+0],f=s.array[l*3+1],y=s.array[l*3+2],b=Math.round((p/(a*2)+.5)*(i-1)),C=Math.round((y/(a*2)+.5)*(i-1))+b*i;c[C]=f}return{rowsCount:i,heights:c,displacement:t}}createFloorPhysics(){const e=this.getFloorDisplacementData(),{rowsCount:t,heights:s,displacement:o}=e,n=j.fixed().setTranslation(0,-o,0),i=E.world.createRigidBody(n),a=J.heightfield(t-1,t-1,s,{x:M.MAP_SIZE,y:1,z:M.MAP_SIZE},$e.FIX_INTERNAL_EDGES).setFriction(1).setRestitution(.2);E.world.createCollider(a,i)}createKintoun(){const e=j.kinematicPositionBased().setTranslation(0,-20,0),t=E.world.createRigidBody(e),s=2,o=J.cuboid(s,M.HALF_FLOOR_THICKNESS,s).setFriction(1).setRestitution(.2);return E.world.createCollider(o,t),t}useKintoun(e){this.kintounPosition.copy(e).setY(-M.HALF_FLOOR_THICKNESS),this.kintounRigidBody.setTranslation(this.kintounPosition,!0)}update(e){const{player:t,clock:s}=e;this.uTime.value=s.getElapsedTime();const o=M.HALF_MAP_SIZE-Math.abs(t.position.x)<M.KINTOUN_ACTIVATION_THRESHOLD,n=M.HALF_MAP_SIZE-Math.abs(t.position.z)<M.KINTOUN_ACTIVATION_THRESHOLD;(o||n)&&this.useKintoun(t.position);const i=M.MAP_SIZE,a=Math.abs(t.position.x),c=Math.sign(t.position.x),l=Math.abs(t.position.z),p=Math.sign(t.position.z),f=a>i?a-i:0,y=l>i?l-i:0;this.outerFloorMesh.position.set(f*c,0,y*p)}}const Et={uTime:r(0)};class It extends z{_uniforms;constructor(e){super(),this._uniforms={...Et,...e},this.createMaterial()}computeCausticsDiffuse=w(([e=B(0,0),t=u(0,0,0)])=>{const s=this._uniforms.uTime.mul(.1),o=d(15),n=e.mul(o),i=L(n.add(B(s,0))),a=L(n.add(B(0,s.negate()))),c=T(h.voronoiNoiseTexture,i,1).r,l=T(h.voronoiNoiseTexture,a,2).r,p=c.add(l),f=ae(p,3),y=u(1.2,1.2,.8).mul(.15);return I(t,y,f)});computeWaterDiffuse=w(([e=d(0),t=B(0,0)])=>{const s=d(5),o=d(.001),n=Z(0,s.add(o),e),i=D("#D8C098"),a=i.mul(.5),c=i.add(a.sub(i).mul(n)),l=this.computeCausticsDiffuse(t);return c.add(l)});createMaterial(){const e=U.xz.add(M.HALF_MAP_SIZE).div(M.MAP_SIZE),t=x(e),s=T(h.floorGrassWaterMap,t,2.5),o=s.g,n=s.b,a=d(1).sub(o).sub(n),c=T(h.randomNoiseTexture,e,2).r,l=I(D("#A3A16D"),D("#8C865A"),c).mul(o),p=I(D("#D8C098"),D("#B89A77"),c).mul(2.25).mul(a),f=x(U.y.negate()),b=this.computeWaterDiffuse(f,t).mul(n);this.colorNode=l.add(p).add(b);const A=L(e.mul(30)),C=L(e.mul(-30)),v=T(h.sandNormalTexture,A),me=T(h.sandNormalTexture,C),pe=K(me.rgb,u(1,0,0));this.normalNode=v.mul(pe)}}class vt extends z{constructor(){super(),this.createMaterial()}createMaterial(){const e=U.xz.add(M.HALF_MAP_SIZE).div(M.MAP_SIZE),t=L(e),s=T(h.randomNoiseTexture,t,2).r,o=I(D("#A3A16D"),D("#8C865A"),s),n=L(e.mul(30)),i=L(e.mul(15)),a=T(h.sandNormalTexture,n),c=T(h.sandNormalTexture,i),l=K(c.rgb,u(1,0,0));this.normalNode=a.mul(l),this.colorNode=o}}class oe{emitters=[];registerEmitter(e){this.emitters.push({position:r(e.position),hue:r(e.hue),intensity:r(e.intensity)})}material_computeSingleEmissiveLight=w(({position:e=u(0,0,0),hue:t=u(1,0,0),intensity:s=10})=>{const o=e.sub(U),n=o.length(),i=d(1).div(d(1).add(n.mul(.3).add(n.pow(2).mul(.5)))),a=.5,c=o.normalize(),l=re(0,W(Ce,c).mul(1-a).add(a));return t.mul(s).mul(l).mul(i)});material_computeEmissiveLight=w(()=>{let e=u(0);for(const t of this.emitters){const s=this.material_computeSingleEmissiveLight(t);e=e.add(s)}return e})}class St{directionalLight;ambientLight;emissive=new oe;LIGHT_POSITION_OFFSET=new _(10,20,10);constructor(e){this.emissive=new oe,this.directionalLight=this.setupDirectionalLighting(),e.add(this.directionalLight),this.ambientLight=this.setupAmbientLighting(),e.add(this.ambientLight),this.debugLight()}setupAmbientLighting(){const e=new Ne("white",.4);return e.intensity=.5,e.color.setRGB(1,.95,.6),e}setupDirectionalLighting(){const e=new Fe;return e.intensity=1,e.color.setRGB(1,.85,.73),e.position.copy(this.LIGHT_POSITION_OFFSET),e.target=new De,e.castShadow=!0,e.shadow.intensity=.75,e.shadow.mapSize.width=64,e.shadow.mapSize.height=64,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-.5,e.shadow.camera.right=.5,e.shadow.camera.top=.5,e.shadow.camera.bottom=-.5,e.shadow.bias=-.003,e}debugLight(){const e=G.panel.addFolder({title:"\uD83D\uDCA1 Light"});e.addBinding(this.directionalLight,"color",{label:"Directional Color",view:"color",color:{type:"float"}}),e.addBinding(this.directionalLight,"intensity",{min:0,max:1,label:"Directional intensity"}),e.addBinding(this.ambientLight,"color",{label:"Ambient Color",view:"color",color:{type:"float"}}),e.addBinding(this.ambientLight,"intensity",{min:0,max:1,label:"Ambient intensity"})}material_computeIllumination=w(()=>u(0));setTarget(e){this.directionalLight.target=e}update(e){const{player:t}=e;this.directionalLight.position.copy(t.position).add(this.LIGHT_POSITION_OFFSET)}}class xt{keysPressed;keyDownListeners;keyUpListeners;constructor(){this.keysPressed=new Set,this.keyDownListeners=new Map,this.keyUpListeners=new Map,window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this))}handleKeyDown(e){const t=e.key.toLowerCase();this.keysPressed.has(t)||(this.keysPressed.add(t),this.keyDownListeners.get(t)?.())}handleKeyUp(e){const t=e.key.toLowerCase();this.keysPressed.delete(t),this.keyUpListeners.get(t)?.()}isKeyPressed(e){return e==="*"?this.keysPressed.size>0:this.keysPressed.has(e.toLowerCase())}onKeyDown(e,t){this.keyDownListeners.set(e.toLowerCase(),t)}onKeyUp(e,t){this.keyUpListeners.set(e.toLowerCase(),t)}dispose(){window.removeEventListener("keydown",this.handleKeyDown.bind(this)),window.removeEventListener("keyup",this.handleKeyUp.bind(this))}}class Ct{stats;lastSecond=performance.now();drawCallsPanel;geometriesPanel;constructor(e){const t=new se({trackGPU:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,horizontal:!1,precision:2});e&&document.body.appendChild(t.dom),this.stats=t,this.drawCallsPanel=this.createNumberPanel("# DRAW CALLS","#fff","#333"),this.geometriesPanel=this.createNumberPanel("# GEOMETRIES","#ffdab9","#163843")}createNumberPanel(e,t,s){const o=this.stats.addPanel(new se.Panel(e,t,s));return o.update=n=>{const i=o.canvas.getContext("2d");if(!i)return;const{width:a,height:c}=o.canvas;i.clearRect(0,0,a,c),i.fillStyle=s,i.fillRect(0,0,a,c),i.fillStyle=t;const l=i.font;i.textAlign="left",i.textBaseline="top",i.fillText(o.name,4,4),i.font="bold 20px Arial",i.textAlign="center",i.textBaseline="middle",i.fillText(`${Math.round(n)}`,a/2,c/1.65),i.font=l},o}updateCustomPanels(e){const t=performance.now();if(t-this.lastSecond<1e3)return;const{render:s,memory:o}=e.info;this.drawCallsPanel.update(s.drawCalls,0),this.geometriesPanel.update(o.geometries,0),this.lastSecond=t}}class Nt{composer;constructor(e,t){this.composer=new Be(e.renderer);const s=Re(t.scene,t.renderCamera);s.setMRT(Oe({output:Ue,emissive:Ge}));const o=s.getTextureNode("output"),n=s.getTextureNode("emissive"),i=ze(n,.25,.1,.5),a=o.add(i);this.composer.outputNode=a,this.composer.needsUpdate=!0}}class Ft{renderer;canvas;monitoringManager;postprocessingManager;POSTPROCESSING_ENABLED=!1;MONITORING_ENABLED=!1;DEBUGGING_ENABLED=!1;constructor(){const e=document.createElement("canvas");e.classList.add("revo-realms"),document.body.appendChild(e),this.canvas=e;const t=new Ve({canvas:e,antialias:!0,trackTimestamp:!1});t.shadowMap.enabled=!0,t.shadowMap.type=He,t.toneMapping=ke,t.toneMappingExposure=1.5,this.renderer=t,this.monitoringManager=new Ct(this.MONITORING_ENABLED),G.setVisibility(this.DEBUGGING_ENABLED)}async init(e){this.postprocessingManager=new Nt(this,e),this.MONITORING_ENABLED&&await this.monitoringManager.stats.init(this.renderer)}async renderAsync(...e){this.MONITORING_ENABLED&&await this.renderer.resolveTimestampsAsync("compute"),this.POSTPROCESSING_ENABLED?await this.postprocessingManager.composer.renderAsync():await this.renderer.renderAsync(...e),this.MONITORING_ENABLED&&(this.monitoringManager.updateCustomPanels(this.renderer),await this.renderer.resolveTimestampsAsync("render"),this.monitoringManager.stats.update())}}class Dt{scene;camera;renderCamera;cameraHelper;controls;orbitControlsCamera;constructor(e){const t=new We;this.scene=t;const s=window.innerWidth,o=window.innerHeight,n=s/o,i=new Ze(45,n,.01,100);i.position.set(0,5,10),this.camera=i,t.add(i),this.renderCamera=i}debugScene(){if(!this.controls)return;G.panel.addFolder({title:"\uD83C\uDFA5 View"}).addBinding(this.controls,"enabled",{label:"Enable orbit controls"}).on("change",({value:t})=>{!this.cameraHelper||!this.orbitControlsCamera||(this.renderCamera=t?this.orbitControlsCamera:this.camera,this.cameraHelper.visible=t)})}update(){this.controls?.enabled&&this.controls.update()}}const Bt=()=>({BLADE_WIDTH:.15,BLADE_HEIGHT:1.25,BLADE_BOUNDING_SPHERE_RADIUS:1.25,TILE_SIZE:120,TILE_HALF_SIZE:120/2,BLADES_PER_SIDE:600,COUNT:600*600,SPACING:120/600}),g=Bt(),he={uTime:r(0),uPlayerPosition:r(new _(0,0,0)),uCameraMatrix:r(new le),uBladeMinScale:r(.5),uBladeMaxScale:r(1.25),uTrailGrowthRate:r(.004),uTrailMinScale:r(.1),uTrailRaius:r(.65),uTrailRaiusSquared:r(.65*.65),uGlowRadius:r(2),uGlowRadiusSquared:r(4),uGlowFadeIn:r(.05),uGlowFadeOut:r(.01),uGlowColor:r(new R().setRGB(1,.6,.1)),uBladeMaxBendAngle:r(Math.PI*.15),uBaseColor:r(new R().setRGB(.1,.2,0)),uTipColor:r(new R().setRGB(.8,.9,.2)),uDelta:r(new ce(0,0))};class Rt extends z{_uniforms;_buffer1;_buffer2;constructor(e){super(),this._uniforms={...he,...e},this._buffer1=te(g.COUNT,"vec4"),this._buffer1.setPBO(!0),this._buffer2=te(g.COUNT,"vec4"),this._buffer2.setPBO(!0),this.computeUpdate.onInit(({renderer:t})=>{t.computeAsync(this.computeInit)}),this.createGrassMaterial()}computeInit=w(()=>{const e=this._buffer1.element(P),t=X(d(P).div(g.BLADES_PER_SIDE)),s=d(P).mod(g.BLADES_PER_SIDE),o=k(P.add(4321)),n=k(P.add(1234)),i=s.mul(g.SPACING).sub(g.TILE_HALF_SIZE).add(o.mul(g.SPACING*.5)),a=t.mul(g.SPACING).sub(g.TILE_HALF_SIZE).add(n.mul(g.SPACING*.5)),c=u(i,0,a);e.x=i,e.y=a;const l=c.xz.add(g.TILE_HALF_SIZE).div(g.TILE_SIZE),p=d(2),f=L(l.mul(p)),b=T(h.randomNoiseTexture,f,1).r.sub(.5).mul(d(Math.PI*2));e.z=b;const A=this._buffer2.element(P),C=this._uniforms.uBladeMaxScale.sub(this._uniforms.uBladeMinScale),v=k(P.add(100)).mul(C).add(this._uniforms.uBladeMinScale);A.x=v,A.y=v})().compute(g.COUNT);computeVisibility=w(([e=u(0)])=>{const t=this._uniforms.uCameraMatrix.mul(F(e,1)),s=t.xyz.div(t.w),o=g.BLADE_BOUNDING_SPHERE_RADIUS,n=d(1);return S(n.negate().sub(o),s.x).mul(S(s.x,n.add(o))).mul(S(n.negate().sub(o),s.y)).mul(S(s.y,n.add(o))).mul(S(0,s.z)).mul(S(s.z,n))});computeBending=w(([e=F(0,0,0,0),t=u(0,0,0)])=>{const s=t.xz.add(this._uniforms.uTime.mul(.25)).mul(.5),o=L(s),i=T(h.perlinNoiseTexture,o,5).r.mul(.35);return e.w.add(i.sub(e.w).mul(.1))});computeAlpha=w(([e=u(0)])=>{const t=e.xz.add(M.HALF_MAP_SIZE).div(M.MAP_SIZE);return T(h.floorGrassWaterMap,t).g});computeTrailScale=w(([e=F(0),t=d(0)])=>{const s=e.x.add(this._uniforms.uTrailGrowthRate),o=d(1).sub(t),n=this._uniforms.uTrailMinScale.mul(t).add(s.mul(o));return je(n,e.y)});computeTrailGlow=w(([e=F(0),t=d(0),s=d(0),o=d(0)])=>{const n=Z(this._uniforms.uGlowRadiusSquared,d(0),t),i=100,a=X(Y(this._uniforms.uDelta.x).mul(i)),c=X(Y(this._uniforms.uDelta.y).mul(i)),l=S(1,a.add(c)),p=n.mul(d(1).sub(s)).mul(o),f=re(l,e.w).mul(p),y=f.mul(this._uniforms.uGlowFadeIn),b=d(1).sub(f).mul(this._uniforms.uGlowFadeOut),A=d(1).sub(l).mul(this._uniforms.uGlowFadeOut).mul(e.w);return $(e.w.add(y).sub(b).sub(A),0,1)});computeUpdate=w(()=>{const e=this._buffer1.element(P),t=this._buffer2.element(P),s=Q(e.x.sub(this._uniforms.uDelta.x).add(g.TILE_HALF_SIZE),g.TILE_SIZE).sub(g.TILE_HALF_SIZE),o=Q(e.y.sub(this._uniforms.uDelta.y).add(g.TILE_HALF_SIZE),g.TILE_SIZE).sub(g.TILE_HALF_SIZE),n=u(s,0,o);e.x=s,e.y=o;const i=n.add(this._uniforms.uPlayerPosition),a=this.computeVisibility(i);t.z=a,Je(a,()=>{const c=B(this._uniforms.uDelta.x,this._uniforms.uDelta.y),l=n.xz.sub(c),p=l.dot(l),f=S(.1,d(1).sub(this._uniforms.uPlayerPosition.y)),y=S(p,this._uniforms.uTrailRaiusSquared).mul(f);t.x=this.computeTrailScale(t,y),t.z=this.computeAlpha(i),e.w=this.computeBending(e,i),t.w=this.computeTrailGlow(t,p,y,f)})})().compute(g.COUNT);computePosition=w(([e=F(0),t=F(0)])=>{const s=u(e.x,0,e.y),o=e.z,n=e.w,i=t.x,a=n.mul(O().y),l=K(N,u(a,0,0)).mul(u(1,i,1));return K(l,u(0,o,0)).add(s)});computeDiffuseColor=w(([e=F(0)])=>{const t=ae(O().y,1.5),s=I(this._uniforms.uBaseColor,this._uniforms.uTipColor,t),o=k(P).mul(.05).sub(.025),n=e.w;return I(s.add(o),this._uniforms.uGlowColor,n)});computeAO=w(()=>{const e=Y(ne(this._buffer1.element(P).z)).mul(.5);return Z(-.75,1.25,O().y).mul(d(1).sub(e))});createGrassMaterial(){this.precision="lowp",this.side=de;const e=this._buffer1.element(P),t=this._buffer2.element(P);this.positionNode=this.computePosition(e,t),this.opacityNode=t.z,this.alphaTest=.25,this.aoNode=this.computeAO(),this.colorNode=this.computeDiffuseColor(t)}async updateAsync(e){const{renderer:t}=e;await t.computeAsync(this.computeUpdate)}}class Ot{material;grassField;uniforms={...he,uDelta:r(new ce(0,0)),uPlayerPosition:r(new _(0,0,0)),uCameraMatrix:r(new le),uTime:r(0)};constructor(e){const t=this.createBladeGeometry();t.instanceCount=g.COUNT,this.material=new Rt(this.uniforms),this.grassField=new ie(t,this.material),e.add(this.grassField)}debugGrass(){const e=G.panel.addFolder({title:"\uD83C\uDF31 Grass"});e.addBinding(this.uniforms.uTipColor,"value",{label:"Tip Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uBaseColor,"value",{label:"Base Color",view:"color",color:{type:"float"}}),e.addBinding(this.uniforms.uGlowColor,"value",{label:"Glow Color",view:"color",color:{type:"float"}})}createBladeGeometry(){const e=g.BLADE_WIDTH/2,t=e/2,s=g.BLADE_HEIGHT/2,o=new Float32Array([-e,0,0,e,0,0,-t,s*1,0,t,s*1,0,0,s*2,0]),n=new Float32Array([0,0,1,0,.25,s*1,.75,s*1,.5,s*2]),i=new Uint16Array([0,1,3,0,3,2,2,3,4]),c=25*Math.PI/180,l=Math.cos(c),p=Math.sin(c),y=15*Math.PI/180,b=Math.cos(y),A=Math.sin(y),C=new Float32Array([-l,p,0,l,p,0,-b,A,0,b,A,0,0,1,0]),v=new Ke;return v.setAttribute("position",new H(o,3)),v.setAttribute("uv",new H(n,2)),v.setIndex(new H(i,1)),v.setAttribute("normal",new H(C,3)),v}async updateAsync(e){const{player:t,camera:s,clock:o}=e,n=t.position.x-this.grassField.position.x,i=t.position.z-this.grassField.position.z;this.uniforms.uDelta.value.set(n,i),this.uniforms.uPlayerPosition.value.copy(t.position),this.uniforms.uCameraMatrix.value.copy(s.projectionMatrix).multiply(s.matrixWorldInverse),this.uniforms.uTime.value=o.getElapsedTime(),this.grassField.position.copy(t.position).setY(0),await this.material.updateAsync(e)}}class Ut{uniforms={uTime:r(0),uPlantColor:r(new R().setRGB(.4,.7,.35))};constructor(e){const t=h.realmModel.scene.getObjectByName("plant");t.geometry.computeVertexNormals(),t.material=new Gt(this.uniforms),t.position.set(0,0,-30);const s=h.realmModel.scene.children.filter(n=>n.name.startsWith("plant_placeholder")),o=new qe(t.geometry,t.material,s.length);for(let n=0;n<s.length;n++)o.setMatrixAt(n,s[n].matrix);e.add(o),this.debugPlants()}debugPlants(){G.panel.addFolder({title:"\uD83C\uDF3F Plants"}).addBinding(this.uniforms.uPlantColor,"value",{label:"Color",view:"color",color:{type:"float"}})}update(e){const{clock:t}=e;this.uniforms.uTime.value=t.getElapsedTime()}}class Gt extends z{_uniforms;constructor(e){super(),this._uniforms={...e},this.createMaterial()}computeDisplacement=w(()=>{const e=O().y.mul(.1),t=L(U.xz.add(this._uniforms.uTime.mul(.075))),s=T(h.perlinNoiseTexture,t,3).r.mul(1.5).mul(e);return N.add(u(0,s.negate(),0))});createMaterial(){this.transparent=!0,this.side=de,this.positionNode=this.computeDisplacement();const e=T(h.leafTexture,O());this.colorNode=e.mul(F(this._uniforms.uPlantColor,1)),this.aoNode=u(.5),this.alphaTest=.5}}class zt{rendererManager;sceneManager;inputManager;clock;player;realm;lighting;grass;plants;constructor(){this.rendererManager=new Ft,this.sceneManager=new Dt(this.rendererManager),this.inputManager=new xt,this.clock=new Xe(!1),this.plants=new Ut(this.sceneManager.scene),this.lighting=new St(this.sceneManager.scene),this.player=new wt({scene:this.sceneManager.scene,inputManager:this.inputManager,lighting:this.lighting}),this.realm=new Lt({scene:this.sceneManager.scene}),this.grass=new Ot(this.sceneManager.scene)}getSizes(){const e=window.innerWidth,t=window.innerHeight;return{width:e,height:t,dpr:Math.min(window.devicePixelRatio,1.5),aspect:e/t}}onResize(){const e=this.getSizes();this.sceneManager.camera.aspect=e.aspect,this.sceneManager.camera.updateProjectionMatrix(),this.rendererManager.renderer.setSize(e.width,e.height),this.rendererManager.renderer.setPixelRatio(e.dpr)}async startLoop(){await this.rendererManager.init(this.sceneManager),this.clock.start();const e={clock:this.clock,scene:this.sceneManager.scene,camera:this.sceneManager.camera,inputManager:this.inputManager,lighting:this.lighting,player:this.player,renderer:this.rendererManager.renderer},t=async()=>{E.update(),this.player.update(e),this.realm.update(e),this.lighting.update(e),this.plants.update(e),this.grass.updateAsync(e),await this.rendererManager.renderAsync(this.sceneManager.scene,this.sceneManager.renderCamera)};new ResizeObserver(()=>{this.onResize()}).observe(document.body),this.rendererManager.renderer.setAnimationLoop(t)}}const Vt=new ft;Vt.initAsync().then(()=>{new zt().startLoop()})});